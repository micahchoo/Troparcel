"use strict";var zi=Object.defineProperty;var Lc=Object.getOwnPropertyDescriptor;var $c=Object.getOwnPropertyNames;var Mc=Object.prototype.hasOwnProperty;var v=(s,e)=>()=>(s&&(e=s(s=0)),e);var E=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),Wi=(s,e)=>{for(var t in e)zi(s,t,{get:e[t],enumerable:!0})},Oc=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of $c(e))!Mc.call(s,n)&&n!==t&&zi(s,n,{get:()=>e[n],enumerable:!(i=Lc(e,n))||i.enumerable});return s};var _t=s=>Oc(zi({},"__esModule",{value:!0}),s);var F,Vs,P,Br,Zt=v(()=>{F=()=>new Map,Vs=s=>{let e=F();return s.forEach((t,i)=>{e.set(i,t)}),e},P=(s,e,t)=>{let i=s.get(e);return i===void 0&&s.set(e,i=t()),i},Br=(s,e)=>{for(let[t,i]of s)if(e(i,t))return!0;return!1}});var pe,Bs=v(()=>{pe=()=>new Set});var Ps,Pr,ue,Kr,qr,Qt,es=v(()=>{Ps=s=>s[s.length-1],Pr=(s,e)=>{for(let t=0;t<e.length;t++)s.push(e[t])},ue=Array.from,Kr=(s,e)=>{for(let t=0;t<s.length;t++)if(e(s[t],t,s))return!0;return!1},qr=(s,e)=>{let t=new Array(s);for(let i=0;i<s;i++)t[i]=e(i,t);return t},Qt=Array.isArray});var Hr={};Wi(Hr,{Observable:()=>We,ObservableV2:()=>ze});var ze,We,ts=v(()=>{Zt();Bs();es();ze=class{constructor(){this._observers=F()}on(e,t){return P(this._observers,e,pe).add(t),t}once(e,t){let i=(...n)=>{this.off(e,i),t(...n)};this.on(e,i)}off(e,t){let i=this._observers.get(e);i!==void 0&&(i.delete(t),i.size===0&&this._observers.delete(e))}emit(e,t){return ue((this._observers.get(e)||F()).values()).forEach(i=>i(...t))}destroy(){this._observers=F()}},We=class{constructor(){this._observers=F()}on(e,t){P(this._observers,e,pe).add(t)}once(e,t){let i=(...n)=>{this.off(e,i),t(...n)};this.on(e,i)}off(e,t){let i=this._observers.get(e);i!==void 0&&(i.delete(t),i.size===0&&this._observers.delete(e))}emit(e,t){return ue((this._observers.get(e)||F()).values()).forEach(i=>i(...t))}destroy(){this._observers=F()}}});var Q,bt,St,Ie,jp,zr,qs,Ge=v(()=>{Q=Math.floor,bt=Math.abs,St=(s,e)=>s<e?s:e,Ie=(s,e)=>s>e?s:e,jp=Number.isNaN,zr=Math.pow,qs=s=>s!==0?s<0:1/s<0});var Ji,Bp,Pp,Wr,Kp,qp,Yi=v(()=>{Ge();Ji=Number.MAX_SAFE_INTEGER,Bp=Number.MIN_SAFE_INTEGER,Pp=1<<31,Wr=Number.isInteger||(s=>typeof s=="number"&&isFinite(s)&&Q(s)===s),Kp=Number.isNaN,qp=Number.parseInt});var Xi,Hp,zp,Rc,Fc,Vc,jc,Zi,Bc,vt,Pc,Jr,kt,Yr,Tt=v(()=>{es();Xi=String.fromCharCode,Hp=String.fromCodePoint,zp=Xi(65535),Rc=s=>s.toLowerCase(),Fc=/^\s*/g,Vc=s=>s.replace(Fc,""),jc=/([A-Z])/g,Zi=(s,e)=>Vc(s.replace(jc,t=>`${e}${Rc(t)}`)),Bc=s=>{let e=unescape(encodeURIComponent(s)),t=e.length,i=new Uint8Array(t);for(let n=0;n<t;n++)i[n]=e.codePointAt(n);return i},vt=typeof TextEncoder<"u"?new TextEncoder:null,Pc=s=>vt.encode(s),Jr=vt?Pc:Bc,kt=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});kt&&kt.decode(new Uint8Array).length===1&&(kt=null);Yr=(s,e)=>qr(e,()=>s).join("")});var Je,$,zs,U,Kc,K,Ct,w,ns,Qi,qc,Hc,zc,ge,to,Nt,D,en,Wc,Gc,Jc,Zr,Yc,At,is,Qr,Ye,eo,Ut,Hs,rs=v(()=>{Ge();Yi();Tt();es();Je=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},$=()=>new Je,zs=s=>{let e=s.cpos;for(let t=0;t<s.bufs.length;t++)e+=s.bufs[t].length;return e},U=s=>{let e=new Uint8Array(zs(s)),t=0;for(let i=0;i<s.bufs.length;i++){let n=s.bufs[i];e.set(n,t),t+=n.length}return e.set(new Uint8Array(s.cbuf.buffer,0,s.cpos),t),e},Kc=(s,e)=>{let t=s.cbuf.length;t-s.cpos<e&&(s.bufs.push(new Uint8Array(s.cbuf.buffer,0,s.cpos)),s.cbuf=new Uint8Array(Ie(t,e)*2),s.cpos=0)},K=(s,e)=>{let t=s.cbuf.length;s.cpos===t&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(t*2),s.cpos=0),s.cbuf[s.cpos++]=e},Ct=K,w=(s,e)=>{for(;e>127;)K(s,128|127&e),e=Q(e/128);K(s,127&e)},ns=(s,e)=>{let t=qs(e);for(t&&(e=-e),K(s,(e>63?128:0)|(t?64:0)|63&e),e=Q(e/64);e>0;)K(s,(e>127?128:0)|127&e),e=Q(e/128)},Qi=new Uint8Array(3e4),qc=Qi.length/3,Hc=(s,e)=>{if(e.length<qc){let t=vt.encodeInto(e,Qi).written||0;w(s,t);for(let i=0;i<t;i++)K(s,Qi[i])}else D(s,Jr(e))},zc=(s,e)=>{let t=unescape(encodeURIComponent(e)),i=t.length;w(s,i);for(let n=0;n<i;n++)K(s,t.codePointAt(n))},ge=vt&&vt.encodeInto?Hc:zc,to=(s,e)=>Nt(s,U(e)),Nt=(s,e)=>{let t=s.cbuf.length,i=s.cpos,n=St(t-i,e.length),r=e.length-n;s.cbuf.set(e.subarray(0,n),i),s.cpos+=n,r>0&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(Ie(t*2,r)),s.cbuf.set(e.subarray(n)),s.cpos=r)},D=(s,e)=>{w(s,e.byteLength),Nt(s,e)},en=(s,e)=>{Kc(s,e);let t=new DataView(s.cbuf.buffer,s.cpos,e);return s.cpos+=e,t},Wc=(s,e)=>en(s,4).setFloat32(0,e,!1),Gc=(s,e)=>en(s,8).setFloat64(0,e,!1),Jc=(s,e)=>en(s,8).setBigInt64(0,e,!1),Zr=new DataView(new ArrayBuffer(4)),Yc=s=>(Zr.setFloat32(0,s),Zr.getFloat32(0)===s),At=(s,e)=>{switch(typeof e){case"string":K(s,119),ge(s,e);break;case"number":Wr(e)&&bt(e)<=2147483647?(K(s,125),ns(s,e)):Yc(e)?(K(s,124),Wc(s,e)):(K(s,123),Gc(s,e));break;case"bigint":K(s,122),Jc(s,e);break;case"object":if(e===null)K(s,126);else if(Qt(e)){K(s,117),w(s,e.length);for(let t=0;t<e.length;t++)At(s,e[t])}else if(e instanceof Uint8Array)K(s,116),D(s,e);else{K(s,118);let t=Object.keys(e);w(s,t.length);for(let i=0;i<t.length;i++){let n=t[i];ge(s,n),At(s,e[n])}}break;case"boolean":K(s,e?120:121);break;default:K(s,127)}},is=class extends Je{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&w(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}},Qr=s=>{s.count>0&&(ns(s.encoder,s.count===1?s.s:-s.s),s.count>1&&w(s.encoder,s.count-2))},Ye=class{constructor(){this.encoder=new Je,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Qr(this),this.count=1,this.s=e)}toUint8Array(){return Qr(this),U(this.encoder)}},eo=s=>{if(s.count>0){let e=s.diff*2+(s.count===1?0:1);ns(s.encoder,e),s.count>1&&w(s.encoder,s.count-2)}},Ut=class{constructor(){this.encoder=new Je,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(eo(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return eo(this),U(this.encoder)}},Hs=class{constructor(){this.sarr=[],this.s="",this.lensE=new Ye}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){let e=new Je;return this.sarr.push(this.s),this.s="",ge(e,this.sarr.join("")),Nt(e,this.lensE.toUint8Array()),U(e)}}});var me,de,X,tn=v(()=>{me=s=>new Error(s),de=()=>{throw me("Method unimplemented")},X=()=>{throw me("Unexpected case")}});var io,no,Et,M,sn,Xc,B,Xe,_,as,Zc,Qc,oe,nn,eh,th,sh,ih,Dt,os,Ze,Lt,Gs,$t=v(()=>{Ge();Yi();Tt();tn();io=me("Unexpected end of array"),no=me("Integer out of Range"),Et=class{constructor(e){this.arr=e,this.pos=0}},M=s=>new Et(s),sn=s=>s.pos!==s.arr.length,Xc=(s,e)=>{let t=new Uint8Array(s.arr.buffer,s.pos+s.arr.byteOffset,e);return s.pos+=e,t},B=s=>Xc(s,_(s)),Xe=s=>s.arr[s.pos++],_=s=>{let e=0,t=1,i=s.arr.length;for(;s.pos<i;){let n=s.arr[s.pos++];if(e=e+(n&127)*t,t*=128,n<128)return e;if(e>Ji)throw no}throw io},as=s=>{let e=s.arr[s.pos++],t=e&63,i=64,n=(e&64)>0?-1:1;if(!(e&128))return n*t;let r=s.arr.length;for(;s.pos<r;){if(e=s.arr[s.pos++],t=t+(e&127)*i,i*=128,e<128)return n*t;if(t>Ji)throw no}throw io},Zc=s=>{let e=_(s);if(e===0)return"";{let t=String.fromCodePoint(Xe(s));if(--e<100)for(;e--;)t+=String.fromCodePoint(Xe(s));else for(;e>0;){let i=e<1e4?e:1e4,n=s.arr.subarray(s.pos,s.pos+i);s.pos+=i,t+=String.fromCodePoint.apply(null,n),e-=i}return decodeURIComponent(escape(t))}},Qc=s=>kt.decode(B(s)),oe=kt?Qc:Zc,nn=(s,e)=>{let t=new DataView(s.arr.buffer,s.arr.byteOffset+s.pos,e);return s.pos+=e,t},eh=s=>nn(s,4).getFloat32(0,!1),th=s=>nn(s,8).getFloat64(0,!1),sh=s=>nn(s,8).getBigInt64(0,!1),ih=[s=>{},s=>null,as,eh,th,sh,s=>!1,s=>!0,oe,s=>{let e=_(s),t={};for(let i=0;i<e;i++){let n=oe(s);t[n]=Dt(s)}return t},s=>{let e=_(s),t=[];for(let i=0;i<e;i++)t.push(Dt(s));return t},B],Dt=s=>ih[127-Xe(s)](s),os=class extends Et{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),sn(this)?this.count=_(this)+1:this.count=-1),this.count--,this.s}},Ze=class extends Et{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=as(this);let e=qs(this.s);this.count=1,e&&(this.s=-this.s,this.count=_(this)+2)}return this.count--,this.s}},Lt=class extends Et{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){let e=as(this),t=e&1;this.diff=Q(e/2),this.count=1,t&&(this.count=_(this)+2)}return this.s+=this.diff,this.count--,this.s}},Gs=class{constructor(e){this.decoder=new Ze(e),this.str=oe(this.decoder),this.spos=0}read(){let e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}});var Js,Jp,ro,oo=v(()=>{Js=require("node:crypto"),Jp=Js.webcrypto.subtle,ro=Js.webcrypto.getRandomValues.bind(Js.webcrypto)});var rn,nh,ao,lo=v(()=>{oo();rn=()=>ro(new Uint32Array(1))[0],nh="10000000-1000-4000-8000"+-1e11,ao=()=>nh.replace(/[018]/g,s=>(s^rn()&15>>s/4).toString(16))});var ie,cs=v(()=>{ie=Date.now});var on,Zp,co=v(()=>{on=s=>new Promise(s),Zp=Promise.all.bind(Promise)});var an,ho=v(()=>{an=s=>s===void 0?null:s});var ln,uo,cn,Xs,fo,po,hn=v(()=>{ln=class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},uo=new ln,cn=!0;try{typeof localStorage<"u"&&localStorage&&(uo=localStorage,cn=!1)}catch{}Xs=uo,fo=s=>cn||addEventListener("storage",s),po=s=>cn||removeEventListener("storage",s)});var Zs,mo,un=v(()=>{Zs=Symbol("Equality"),mo=(s,e)=>s===e||!!s?.[Zs]?.(e)||!1});var wo,lh,_o,bo,hs,So,ch,dn,fn,hh,pn,Qs=v(()=>{un();wo=Object.assign,lh=Object.keys,_o=(s,e)=>{for(let t in s)e(s[t],t)},bo=(s,e)=>{let t=[];for(let i in s)t.push(e(s[i],i));return t},hs=s=>lh(s).length,So=s=>{for(let e in s)return!1;return!0},ch=(s,e)=>{for(let t in s)if(!e(s[t],t))return!1;return!0},dn=(s,e)=>Object.prototype.hasOwnProperty.call(s,e),fn=(s,e)=>s===e||hs(s)===hs(e)&&ch(s,(t,i)=>(t!==void 0||dn(e,i))&&mo(e[i],t)),hh=Object.freeze,pn=s=>{for(let e in s){let t=s[e];(typeof t=="object"||typeof t=="function")&&pn(s[e])}return hh(s)}});var us,mn,Mt,xo,ds=v(()=>{Qs();un();us=(s,e,t=0)=>{try{for(;t<s.length;t++)s[t](...e)}finally{t<s.length&&us(s,e,t+1)}},mn=s=>s,Mt=(s,e)=>{if(s===e)return!0;if(s==null||e==null||s.constructor!==e.constructor&&(s.constructor||Object)!==(e.constructor||Object))return!1;if(s[Zs]!=null)return s[Zs](e);switch(s.constructor){case ArrayBuffer:s=new Uint8Array(s),e=new Uint8Array(e);case Uint8Array:{if(s.byteLength!==e.byteLength)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;break}case Set:{if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;break}case Map:{if(s.size!==e.size)return!1;for(let t of s.keys())if(!e.has(t)||!Mt(s.get(t),e.get(t)))return!1;break}case void 0:case Object:if(hs(s)!==hs(e))return!1;for(let t in s)if(!dn(s,t)||!Mt(s[t],e[t]))return!1;break;case Array:if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!Mt(s[t],e[t]))return!1;break;default:return!1}return!0},xo=(s,e)=>e.includes(s)});var Ae,_n,Qp,ye,uh,dh,wn,fs,ko,eg,fh,vo,ps=v(()=>{Zt();Tt();ho();hn();ds();Ae=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",_n=typeof window<"u"&&typeof document<"u"&&!Ae,Qp=typeof navigator<"u"?/Mac/.test(navigator.platform):!1,uh=[],dh=()=>{if(ye===void 0)if(Ae){ye=F();let s=process.argv,e=null;for(let t=0;t<s.length;t++){let i=s[t];i[0]==="-"?(e!==null&&ye.set(e,""),e=i):e!==null?(ye.set(e,i),e=null):uh.push(i)}e!==null&&ye.set(e,"")}else typeof location=="object"?(ye=F(),(location.search||"?").slice(1).split("&").forEach(s=>{if(s.length!==0){let[e,t]=s.split("=");ye.set(`--${Zi(e,"-")}`,t),ye.set(`-${Zi(e,"-")}`,t)}})):ye=F();return ye},wn=s=>dh().has(s),fs=s=>Ae?an(process.env[s.toUpperCase().replaceAll("-","_")]):an(Xs.getItem(s)),ko=s=>wn("--"+s)||fs(s)!==null,eg=ko("production"),fh=Ae&&xo(process.env.FORCE_COLOR,["true","1","2"]),vo=fh||!wn("--no-colors")&&!ko("no-color")&&(!Ae||process.stdout.isTTY)&&(!Ae||wn("--color")||fs("COLORTERM")!==null||(fs("TERM")||"").includes("color"))});var To,ph,Io,gh,mh,yh,wh,Ao,Uo,Co,bn=v(()=>{Tt();ps();To=s=>new Uint8Array(s),ph=(s,e,t)=>new Uint8Array(s,e,t),Io=s=>new Uint8Array(s),gh=s=>{let e="";for(let t=0;t<s.byteLength;t++)e+=Xi(s[t]);return btoa(e)},mh=s=>Buffer.from(s.buffer,s.byteOffset,s.byteLength).toString("base64"),yh=s=>{let e=atob(s),t=To(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},wh=s=>{let e=Buffer.from(s,"base64");return ph(e.buffer,e.byteOffset,e.byteLength)},Ao=_n?gh:mh,Uo=_n?yh:wh,Co=s=>{let e=To(s.byteLength);return e.set(s),e}});var we,Eo=v(()=>{we=Symbol});var gs,ms,Sn,xn,kn,ys,vn,ws,Tn,Do,tg,In=v(()=>{Eo();cs();gs=we(),ms=we(),Sn=we(),xn=we(),kn=we(),ys=we(),vn=we(),ws=we(),Tn=we(),Do=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let e=[],t=[],i=0;for(;i<s.length;i++){let n=s[i];if(n===void 0)break;if(n.constructor===String||n.constructor===Number)e.push(n);else if(n.constructor===Object)break}for(i>0&&t.push(e.join(""));i<s.length;i++){let n=s[i];n instanceof Symbol||t.push(n)}return t},tg=ie()});var Sh,xh,Lo,ti,An,$o=v(()=>{ps();In();In();Sh={[gs]:"\x1B[1m",[ms]:"\x1B[2m",[Sn]:"\x1B[34m",[kn]:"\x1B[32m",[xn]:"\x1B[37m",[ys]:"\x1B[31m",[vn]:"\x1B[35m",[ws]:"\x1B[38;5;208m",[Tn]:"\x1B[0m"},xh=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let e=[],t=[],i=0;for(;i<s.length;i++){let n=s[i],r=Sh[n];if(r!==void 0)e.push(r);else{if(n===void 0)break;if(n.constructor===String||n.constructor===Number)e.push(n);else break}}for(i>0&&(e.push("\x1B[0m"),t.push(e.join("")));i<s.length;i++){let n=s[i];n instanceof Symbol||t.push(n)}return t},Lo=vo?xh:Do,ti=(...s)=>{console.log(...Lo(s))},An=(...s)=>{console.warn(...Lo(s))}});var Mo,Oo,si,Ro=v(()=>{Mo=s=>({[Symbol.iterator](){return this},next:s}),Oo=(s,e)=>Mo(()=>{let t;do t=s.next();while(!t.done&&!e(t.value));return t}),si=(s,e)=>Mo(()=>{let{done:t,value:i}=s.next();return{done:t,value:t?void 0:e(i)}})});var Pt={};Wi(Pt,{AbsolutePosition:()=>ci,AbstractConnector:()=>Cn,AbstractStruct:()=>Vt,AbstractType:()=>O,Array:()=>rt,ContentAny:()=>Be,ContentBinary:()=>ct,ContentDeleted:()=>jt,ContentDoc:()=>ht,ContentEmbed:()=>Ne,ContentFormat:()=>R,ContentJSON:()=>Ns,ContentString:()=>fe,ContentType:()=>le,Doc:()=>Ve,GC:()=>J,ID:()=>Ue,Item:()=>N,Map:()=>ot,PermanentUserData:()=>En,RelativePosition:()=>Rt,Skip:()=>q,Snapshot:()=>ks,Text:()=>Ft,Transaction:()=>ui,UndoManager:()=>On,UpdateDecoderV1:()=>ee,UpdateDecoderV2:()=>Z,UpdateEncoderV1:()=>be,UpdateEncoderV2:()=>ne,XmlElement:()=>lt,XmlFragment:()=>at,XmlHook:()=>Cs,XmlText:()=>wi,YArrayEvent:()=>pi,YEvent:()=>nt,YMapEvent:()=>gi,YTextEvent:()=>mi,YXmlEvent:()=>yi,applyUpdate:()=>qn,applyUpdateV2:()=>Si,cleanupYTextFormatting:()=>Ra,compareIDs:()=>Qe,compareRelativePositions:()=>Wh,convertUpdateFormatV1ToV2:()=>pu,convertUpdateFormatV2ToV1:()=>ba,createAbsolutePositionFromRelativePosition:()=>zh,createDeleteSet:()=>bi,createDeleteSetFromStructStore:()=>Bn,createDocFromSnapshot:()=>Qh,createID:()=>x,createRelativePositionFromJSON:()=>Fh,createRelativePositionFromTypeIndex:()=>jh,createSnapshot:()=>Yn,decodeRelativePosition:()=>qh,decodeSnapshot:()=>Yh,decodeSnapshotV2:()=>aa,decodeStateVector:()=>zn,decodeUpdate:()=>au,decodeUpdateV2:()=>pa,diffUpdate:()=>uu,diffUpdateV2:()=>Xn,emptySnapshot:()=>Xh,encodeRelativePosition:()=>Ph,encodeSnapshot:()=>Jh,encodeSnapshotV2:()=>oa,encodeStateAsUpdate:()=>Hn,encodeStateAsUpdateV2:()=>ia,encodeStateVector:()=>Gn,encodeStateVectorFromUpdate:()=>lu,encodeStateVectorFromUpdateV2:()=>ma,equalDeleteSets:()=>ta,equalSnapshots:()=>Gh,findIndexSS:()=>ae,findRootTypeKey:()=>Jn,getItem:()=>et,getItemCleanEnd:()=>$n,getItemCleanStart:()=>G,getState:()=>L,getTypeChildren:()=>wu,isDeleted:()=>ut,isParentOf:()=>xs,iterateDeletedStructs:()=>tt,logType:()=>Oh,logUpdate:()=>ou,logUpdateV2:()=>fa,mergeDeleteSets:()=>st,mergeUpdates:()=>ga,mergeUpdatesV2:()=>Ts,obfuscateUpdate:()=>du,obfuscateUpdateV2:()=>fu,parseUpdateMeta:()=>cu,parseUpdateMetaV2:()=>ya,readUpdate:()=>Dh,readUpdateV2:()=>Kn,relativePositionToJSON:()=>Rh,snapshot:()=>Zh,snapshotContainsUpdate:()=>tu,transact:()=>C,tryGc:()=>nu,typeListToArraySnapshot:()=>_u,typeMapGetAllSnapshot:()=>Da,typeMapGetSnapshot:()=>xu});function*ru(s){let e=_(s.restDecoder);for(let t=0;t<e;t++){let i=_(s.restDecoder),n=s.readClient(),r=_(s.restDecoder);for(let o=0;o<i;o++){let a=s.readInfo();if(a===10){let l=_(s.restDecoder);yield new q(x(n,r),l),r+=l}else if(31&a){let l=(a&192)===0,c=new N(x(n,r),null,(a&128)===128?s.readLeftID():null,null,(a&64)===64?s.readRightID():null,l?s.readParentInfo()?s.readString():s.readLeftID():null,l&&(a&32)===32?s.readString():null,ja(s,a));yield c,r+=c.length}else{let l=s.readLen();yield new J(x(n,r),l),r+=l}}}}var Cn,bs,Fe,tt,Ah,ut,jn,st,Ss,bi,Bn,_e,Ce,jo,ta,sa,Ve,it,ee,li,Z,je,be,Ot,ne,Uh,Pn,Ch,Nh,Eh,Kn,Dh,Si,qn,Lh,ia,Hn,na,zn,Wn,$h,Mh,Gn,Nn,Bo,Po,Ko,ra,Ue,Qe,x,qo,Ho,Jn,xs,Oh,En,Rt,Rh,Fh,ci,Vh,ii,jh,Bh,Ph,Kh,qh,Hh,zh,Wh,ks,Gh,oa,Jh,aa,Yh,Yn,Xh,Zh,Me,Dn,Qh,eu,tu,hi,Es,L,la,ae,su,et,Ln,G,$n,iu,ca,ui,zo,Wo,oi,ha,ua,nu,da,C,Mn,Go,Jo,On,Se,ou,fa,au,pa,vs,ga,ma,lu,ya,cu,hu,Ts,Xn,uu,wa,Oe,Zn,xi,_a,du,fu,pu,ba,Yo,nt,gu,H,Sa,Qn,Rn,mu,xa,yu,ki,Is,wu,vi,O,ka,va,_u,As,Ta,bu,Ia,di,Aa,Ua,Su,Ca,fi,er,tr,Na,Ea,xu,Da,ni,pi,rt,ku,gi,ot,vu,Re,Us,Xo,ri,La,Bt,$a,Ma,Un,Zo,Oa,Tu,Ra,Iu,Qo,mi,Ft,Au,_s,at,Uu,lt,Cu,yi,Cs,Nu,wi,Eu,Vt,Du,J,ct,Lu,jt,$u,Fa,ht,Mu,Ne,Ou,R,Ru,Ns,Fu,Vu,Be,ju,fe,Bu,Pu,Ku,qu,Hu,zu,Wu,Gu,Ju,le,Yu,Fn,sr,_i,ea,Va,N,ja,Xu,Zu,q,Ba,Pa,Kt=v(()=>{ts();es();Ge();Zt();rs();$t();lo();co();bn();tn();ds();ds();Bs();$o();cs();Tt();Ro();Qs();ps();Cn=class extends ze{constructor(e,t){super(),this.doc=e,this.awareness=t}},bs=class{constructor(e,t){this.clock=e,this.len=t}},Fe=class{constructor(){this.clients=new Map}},tt=(s,e,t)=>e.clients.forEach((i,n)=>{let r=s.doc.store.clients.get(n);if(r!=null){let o=r[r.length-1],a=o.id.clock+o.length;for(let l=0,c=i[l];l<i.length&&c.clock<a;c=i[++l])ca(s,r,c.clock,c.len,t)}}),Ah=(s,e)=>{let t=0,i=s.length-1;for(;t<=i;){let n=Q((t+i)/2),r=s[n],o=r.clock;if(o<=e){if(e<o+r.len)return n;t=n+1}else i=n-1}return null},ut=(s,e)=>{let t=s.clients.get(e.client);return t!==void 0&&Ah(t,e.clock)!==null},jn=s=>{s.clients.forEach(e=>{e.sort((n,r)=>n.clock-r.clock);let t,i;for(t=1,i=1;t<e.length;t++){let n=e[i-1],r=e[t];n.clock+n.len>=r.clock?n.len=Ie(n.len,r.clock+r.len-n.clock):(i<t&&(e[i]=r),i++)}e.length=i})},st=s=>{let e=new Fe;for(let t=0;t<s.length;t++)s[t].clients.forEach((i,n)=>{if(!e.clients.has(n)){let r=i.slice();for(let o=t+1;o<s.length;o++)Pr(r,s[o].clients.get(n)||[]);e.clients.set(n,r)}});return jn(e),e},Ss=(s,e,t,i)=>{P(s.clients,e,()=>[]).push(new bs(t,i))},bi=()=>new Fe,Bn=s=>{let e=bi();return s.clients.forEach((t,i)=>{let n=[];for(let r=0;r<t.length;r++){let o=t[r];if(o.deleted){let a=o.id.clock,l=o.length;if(r+1<t.length)for(let c=t[r+1];r+1<t.length&&c.deleted;c=t[++r+1])l+=c.length;n.push(new bs(a,l))}}n.length>0&&e.clients.set(i,n)}),e},_e=(s,e)=>{w(s.restEncoder,e.clients.size),ue(e.clients.entries()).sort((t,i)=>i[0]-t[0]).forEach(([t,i])=>{s.resetDsCurVal(),w(s.restEncoder,t);let n=i.length;w(s.restEncoder,n);for(let r=0;r<n;r++){let o=i[r];s.writeDsClock(o.clock),s.writeDsLen(o.len)}})},Ce=s=>{let e=new Fe,t=_(s.restDecoder);for(let i=0;i<t;i++){s.resetDsCurVal();let n=_(s.restDecoder),r=_(s.restDecoder);if(r>0){let o=P(e.clients,n,()=>[]);for(let a=0;a<r;a++)o.push(new bs(s.readDsClock(),s.readDsLen()))}}return e},jo=(s,e,t)=>{let i=new Fe,n=_(s.restDecoder);for(let r=0;r<n;r++){s.resetDsCurVal();let o=_(s.restDecoder),a=_(s.restDecoder),l=t.clients.get(o)||[],c=L(t,o);for(let h=0;h<a;h++){let u=s.readDsClock(),d=u+s.readDsLen();if(u<c){c<d&&Ss(i,o,c,d-c);let f=ae(l,u),p=l[f];for(!p.deleted&&p.id.clock<u&&(l.splice(f+1,0,_i(e,p,u-p.id.clock)),f++);f<l.length&&(p=l[f++],p.id.clock<d);)p.deleted||(d<p.id.clock+p.length&&l.splice(f,0,_i(e,p,d-p.id.clock)),p.delete(e))}else Ss(i,o,u,d-u)}}if(i.clients.size>0){let r=new ne;return w(r.restEncoder,0),_e(r,i),r.toUint8Array()}return null},ta=(s,e)=>{if(s.clients.size!==e.clients.size)return!1;for(let[t,i]of s.clients.entries()){let n=e.clients.get(t);if(n===void 0||i.length!==n.length)return!1;for(let r=0;r<i.length;r++){let o=i[r],a=n[r];if(o.clock!==a.clock||o.len!==a.len)return!1}}return!0},sa=rn,Ve=class s extends ze{constructor({guid:e=ao(),collectionid:t=null,gc:i=!0,gcFilter:n=()=>!0,meta:r=null,autoLoad:o=!1,shouldLoad:a=!0}={}){super(),this.gc=i,this.gcFilter=n,this.clientID=sa(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new hi,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=a,this.autoLoad=o,this.meta=r,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=on(c=>{this.on("load",()=>{this.isLoaded=!0,c(this)})});let l=()=>on(c=>{let h=u=>{(u===void 0||u===!0)&&(this.off("sync",h),c())};this.on("sync",h)});this.on("sync",c=>{c===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=c===void 0||c===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){let e=this._item;e!==null&&!this.shouldLoad&&C(e.parent.doc,t=>{t.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(ue(this.subdocs).map(e=>e.guid))}transact(e,t=null){return C(this,e,t)}get(e,t=O){let i=P(this.share,e,()=>{let r=new t;return r._integrate(this,null),r}),n=i.constructor;if(t!==O&&n!==t)if(n===O){let r=new t;r._map=i._map,i._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=r}),r._start=i._start;for(let o=r._start;o!==null;o=o.right)o.parent=r;return r._length=i._length,this.share.set(e,r),r._integrate(this,null),r}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return i}getArray(e=""){return this.get(e,rt)}getText(e=""){return this.get(e,Ft)}getMap(e=""){return this.get(e,ot)}getXmlElement(e=""){return this.get(e,lt)}getXmlFragment(e=""){return this.get(e,at)}toJSON(){let e={};return this.share.forEach((t,i)=>{e[i]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,ue(this.subdocs).forEach(t=>t.destroy());let e=this._item;if(e!==null){this._item=null;let t=e.content;t.doc=new s({guid:this.guid,...t.opts,shouldLoad:!1}),t.doc._item=e,C(e.parent.doc,i=>{let n=t.doc;e.deleted||i.subdocsAdded.add(n),i.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}},it=class{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return _(this.restDecoder)}readDsLen(){return _(this.restDecoder)}},ee=class extends it{readLeftID(){return x(_(this.restDecoder),_(this.restDecoder))}readRightID(){return x(_(this.restDecoder),_(this.restDecoder))}readClient(){return _(this.restDecoder)}readInfo(){return Xe(this.restDecoder)}readString(){return oe(this.restDecoder)}readParentInfo(){return _(this.restDecoder)===1}readTypeRef(){return _(this.restDecoder)}readLen(){return _(this.restDecoder)}readAny(){return Dt(this.restDecoder)}readBuf(){return Co(B(this.restDecoder))}readJSON(){return JSON.parse(oe(this.restDecoder))}readKey(){return oe(this.restDecoder)}},li=class{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=_(this.restDecoder),this.dsCurrVal}readDsLen(){let e=_(this.restDecoder)+1;return this.dsCurrVal+=e,e}},Z=class extends li{constructor(e){super(e),this.keys=[],_(e),this.keyClockDecoder=new Lt(B(e)),this.clientDecoder=new Ze(B(e)),this.leftClockDecoder=new Lt(B(e)),this.rightClockDecoder=new Lt(B(e)),this.infoDecoder=new os(B(e),Xe),this.stringDecoder=new Gs(B(e)),this.parentInfoDecoder=new os(B(e),Xe),this.typeRefDecoder=new Ze(B(e)),this.lenDecoder=new Ze(B(e))}readLeftID(){return new Ue(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ue(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Dt(this.restDecoder)}readBuf(){return B(this.restDecoder)}readJSON(){return Dt(this.restDecoder)}readKey(){let e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{let t=this.stringDecoder.read();return this.keys.push(t),t}}},je=class{constructor(){this.restEncoder=$()}toUint8Array(){return U(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){w(this.restEncoder,e)}writeDsLen(e){w(this.restEncoder,e)}},be=class extends je{writeLeftID(e){w(this.restEncoder,e.client),w(this.restEncoder,e.clock)}writeRightID(e){w(this.restEncoder,e.client),w(this.restEncoder,e.clock)}writeClient(e){w(this.restEncoder,e)}writeInfo(e){Ct(this.restEncoder,e)}writeString(e){ge(this.restEncoder,e)}writeParentInfo(e){w(this.restEncoder,e?1:0)}writeTypeRef(e){w(this.restEncoder,e)}writeLen(e){w(this.restEncoder,e)}writeAny(e){At(this.restEncoder,e)}writeBuf(e){D(this.restEncoder,e)}writeJSON(e){ge(this.restEncoder,JSON.stringify(e))}writeKey(e){ge(this.restEncoder,e)}},Ot=class{constructor(){this.restEncoder=$(),this.dsCurrVal=0}toUint8Array(){return U(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){let t=e-this.dsCurrVal;this.dsCurrVal=e,w(this.restEncoder,t)}writeDsLen(e){e===0&&X(),w(this.restEncoder,e-1),this.dsCurrVal+=e}},ne=class extends Ot{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ut,this.clientEncoder=new Ye,this.leftClockEncoder=new Ut,this.rightClockEncoder=new Ut,this.infoEncoder=new is(Ct),this.stringEncoder=new Hs,this.parentInfoEncoder=new is(Ct),this.typeRefEncoder=new Ye,this.lenEncoder=new Ye}toUint8Array(){let e=$();return w(e,0),D(e,this.keyClockEncoder.toUint8Array()),D(e,this.clientEncoder.toUint8Array()),D(e,this.leftClockEncoder.toUint8Array()),D(e,this.rightClockEncoder.toUint8Array()),D(e,U(this.infoEncoder)),D(e,this.stringEncoder.toUint8Array()),D(e,U(this.parentInfoEncoder)),D(e,this.typeRefEncoder.toUint8Array()),D(e,this.lenEncoder.toUint8Array()),Nt(e,U(this.restEncoder)),U(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){At(this.restEncoder,e)}writeBuf(e){D(this.restEncoder,e)}writeJSON(e){At(this.restEncoder,e)}writeKey(e){let t=this.keyMap.get(e);t===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}},Uh=(s,e,t,i)=>{i=Ie(i,e[0].id.clock);let n=ae(e,i);w(s.restEncoder,e.length-n),s.writeClient(t),w(s.restEncoder,i);let r=e[n];r.write(s,i-r.id.clock);for(let o=n+1;o<e.length;o++)e[o].write(s,0)},Pn=(s,e,t)=>{let i=new Map;t.forEach((n,r)=>{L(e,r)>n&&i.set(r,n)}),Es(e).forEach((n,r)=>{t.has(r)||i.set(r,0)}),w(s.restEncoder,i.size),ue(i.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{Uh(s,e.clients.get(n),n,r)})},Ch=(s,e)=>{let t=F(),i=_(s.restDecoder);for(let n=0;n<i;n++){let r=_(s.restDecoder),o=new Array(r),a=s.readClient(),l=_(s.restDecoder);t.set(a,{i:0,refs:o});for(let c=0;c<r;c++){let h=s.readInfo();switch(31&h){case 0:{let u=s.readLen();o[c]=new J(x(a,l),u),l+=u;break}case 10:{let u=_(s.restDecoder);o[c]=new q(x(a,l),u),l+=u;break}default:{let u=(h&192)===0,d=new N(x(a,l),null,(h&128)===128?s.readLeftID():null,null,(h&64)===64?s.readRightID():null,u?s.readParentInfo()?e.get(s.readString()):s.readLeftID():null,u&&(h&32)===32?s.readString():null,ja(s,h));o[c]=d,l+=d.length}}}}return t},Nh=(s,e,t)=>{let i=[],n=ue(t.keys()).sort((f,p)=>f-p);if(n.length===0)return null;let r=()=>{if(n.length===0)return null;let f=t.get(n[n.length-1]);for(;f.refs.length===f.i;)if(n.pop(),n.length>0)f=t.get(n[n.length-1]);else return null;return f},o=r();if(o===null)return null;let a=new hi,l=new Map,c=(f,p)=>{let g=l.get(f);(g==null||g>p)&&l.set(f,p)},h=o.refs[o.i++],u=new Map,d=()=>{for(let f of i){let p=f.id.client,g=t.get(p);g?(g.i--,a.clients.set(p,g.refs.slice(g.i)),t.delete(p),g.i=0,g.refs=[]):a.clients.set(p,[f]),n=n.filter(m=>m!==p)}i.length=0};for(;;){if(h.constructor!==q){let p=P(u,h.id.client,()=>L(e,h.id.client))-h.id.clock;if(p<0)i.push(h),c(h.id.client,h.id.clock-1),d();else{let g=h.getMissing(s,e);if(g!==null){i.push(h);let m=t.get(g)||{refs:[],i:0};if(m.refs.length===m.i)c(g,L(e,g)),d();else{h=m.refs[m.i++];continue}}else(p===0||p<h.length)&&(h.integrate(s,p),u.set(h.id.client,h.id.clock+h.length))}}if(i.length>0)h=i.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=r(),o===null)break;h=o.refs[o.i++]}}if(a.clients.size>0){let f=new ne;return Pn(f,a,new Map),w(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},Eh=(s,e)=>Pn(s,e.doc.store,e.beforeState),Kn=(s,e,t,i=new Z(s))=>C(e,n=>{n.local=!1;let r=!1,o=n.doc,a=o.store,l=Ch(i,o),c=Nh(n,a,l),h=a.pendingStructs;if(h){for(let[d,f]of h.missing)if(f<L(a,d)){r=!0;break}if(c){for(let[d,f]of c.missing){let p=h.missing.get(d);(p==null||p>f)&&h.missing.set(d,f)}h.update=Ts([h.update,c.update])}}else a.pendingStructs=c;let u=jo(i,n,a);if(a.pendingDs){let d=new Z(M(a.pendingDs));_(d.restDecoder);let f=jo(d,n,a);u&&f?a.pendingDs=Ts([u,f]):a.pendingDs=u||f}else a.pendingDs=u;if(r){let d=a.pendingStructs.update;a.pendingStructs=null,Si(n.doc,d)}},t,!1),Dh=(s,e,t)=>Kn(s,e,t,new ee(s)),Si=(s,e,t,i=Z)=>{let n=M(e);Kn(n,s,t,new i(n))},qn=(s,e,t)=>Si(s,e,t,ee),Lh=(s,e,t=new Map)=>{Pn(s,e.store,t),_e(s,Bn(e.store))},ia=(s,e=new Uint8Array([0]),t=new ne)=>{let i=zn(e);Lh(t,s,i);let n=[t.toUint8Array()];if(s.store.pendingDs&&n.push(s.store.pendingDs),s.store.pendingStructs&&n.push(Xn(s.store.pendingStructs.update,e)),n.length>1){if(t.constructor===be)return ga(n.map((r,o)=>o===0?r:ba(r)));if(t.constructor===ne)return Ts(n)}return n[0]},Hn=(s,e)=>ia(s,e,new be),na=s=>{let e=new Map,t=_(s.restDecoder);for(let i=0;i<t;i++){let n=_(s.restDecoder),r=_(s.restDecoder);e.set(n,r)}return e},zn=s=>na(new it(M(s))),Wn=(s,e)=>(w(s.restEncoder,e.size),ue(e.entries()).sort((t,i)=>i[0]-t[0]).forEach(([t,i])=>{w(s.restEncoder,t),w(s.restEncoder,i)}),s),$h=(s,e)=>Wn(s,Es(e.store)),Mh=(s,e=new Ot)=>(s instanceof Map?Wn(e,s):$h(e,s),e.toUint8Array()),Gn=s=>Mh(s,new je),Nn=class{constructor(){this.l=[]}},Bo=()=>new Nn,Po=(s,e)=>s.l.push(e),Ko=(s,e)=>{let t=s.l,i=t.length;s.l=t.filter(n=>e!==n),i===s.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},ra=(s,e,t)=>us(s.l,[e,t]),Ue=class{constructor(e,t){this.client=e,this.clock=t}},Qe=(s,e)=>s===e||s!==null&&e!==null&&s.client===e.client&&s.clock===e.clock,x=(s,e)=>new Ue(s,e),qo=(s,e)=>{w(s,e.client),w(s,e.clock)},Ho=s=>x(_(s),_(s)),Jn=s=>{for(let[e,t]of s.doc.share.entries())if(t===s)return e;throw X()},xs=(s,e)=>{for(;e!==null;){if(e.parent===s)return!0;e=e.parent._item}return!1},Oh=s=>{let e=[],t=s._start;for(;t;)e.push(t),t=t.right;console.log("Children: ",e),console.log("Children content: ",e.filter(i=>!i.deleted).map(i=>i.content))},En=class{constructor(e,t=e.getMap("users")){let i=new Map;this.yusers=t,this.doc=e,this.clients=new Map,this.dss=i;let n=(r,o)=>{let a=r.get("ds"),l=r.get("ids"),c=h=>this.clients.set(h,o);a.observe(h=>{h.changes.added.forEach(u=>{u.content.getContent().forEach(d=>{d instanceof Uint8Array&&this.dss.set(o,st([this.dss.get(o)||bi(),Ce(new it(M(d)))]))})})}),this.dss.set(o,st(a.map(h=>Ce(new it(M(h)))))),l.observe(h=>h.changes.added.forEach(u=>u.content.getContent().forEach(c))),l.forEach(c)};t.observe(r=>{r.keysChanged.forEach(o=>n(t.get(o),o))}),t.forEach(n)}setUserMapping(e,t,i,{filter:n=()=>!0}={}){let r=this.yusers,o=r.get(i);o||(o=new ot,o.set("ids",new rt),o.set("ds",new rt),r.set(i,o)),o.get("ids").push([t]),r.observe(a=>{setTimeout(()=>{let l=r.get(i);if(l!==o){o=l,this.clients.forEach((u,d)=>{i===u&&o.get("ids").push([d])});let c=new je,h=this.dss.get(i);h&&(_e(c,h),o.get("ds").push([c.toUint8Array()]))}},0)}),e.on("afterTransaction",a=>{setTimeout(()=>{let l=o.get("ds"),c=a.deleteSet;if(a.local&&c.clients.size>0&&n(a,c)){let h=new je;_e(h,c),l.push([h.toUint8Array()])}})})}getUserByClientId(e){return this.clients.get(e)||null}getUserByDeletedId(e){for(let[t,i]of this.dss.entries())if(ut(i,e))return t;return null}},Rt=class{constructor(e,t,i,n=0){this.type=e,this.tname=t,this.item=i,this.assoc=n}},Rh=s=>{let e={};return s.type&&(e.type=s.type),s.tname&&(e.tname=s.tname),s.item&&(e.item=s.item),s.assoc!=null&&(e.assoc=s.assoc),e},Fh=s=>new Rt(s.type==null?null:x(s.type.client,s.type.clock),s.tname??null,s.item==null?null:x(s.item.client,s.item.clock),s.assoc==null?0:s.assoc),ci=class{constructor(e,t,i=0){this.type=e,this.index=t,this.assoc=i}},Vh=(s,e,t=0)=>new ci(s,e,t),ii=(s,e,t)=>{let i=null,n=null;return s._item===null?n=Jn(s):i=x(s._item.id.client,s._item.id.clock),new Rt(i,n,e,t)},jh=(s,e,t=0)=>{let i=s._start;if(t<0){if(e===0)return ii(s,null,t);e--}for(;i!==null;){if(!i.deleted&&i.countable){if(i.length>e)return ii(s,x(i.id.client,i.id.clock+e),t);e-=i.length}if(i.right===null&&t<0)return ii(s,i.lastId,t);i=i.right}return ii(s,null,t)},Bh=(s,e)=>{let{type:t,tname:i,item:n,assoc:r}=e;if(n!==null)w(s,0),qo(s,n);else if(i!==null)Ct(s,1),ge(s,i);else if(t!==null)Ct(s,2),qo(s,t);else throw X();return ns(s,r),s},Ph=s=>{let e=$();return Bh(e,s),U(e)},Kh=s=>{let e=null,t=null,i=null;switch(_(s)){case 0:i=Ho(s);break;case 1:t=oe(s);break;case 2:e=Ho(s)}let n=sn(s)?as(s):0;return new Rt(e,t,i,n)},qh=s=>Kh(M(s)),Hh=(s,e)=>{let t=et(s,e),i=e.clock-t.id.clock;return{item:t,diff:i}},zh=(s,e,t=!0)=>{let i=e.store,n=s.item,r=s.type,o=s.tname,a=s.assoc,l=null,c=0;if(n!==null){if(L(i,n.client)<=n.clock)return null;let h=t?Fn(i,n):Hh(i,n),u=h.item;if(!(u instanceof N))return null;if(l=u.parent,l._item===null||!l._item.deleted){c=u.deleted||!u.countable?0:h.diff+(a>=0?0:1);let d=u.left;for(;d!==null;)!d.deleted&&d.countable&&(c+=d.length),d=d.left}}else{if(o!==null)l=e.get(o);else if(r!==null){if(L(i,r.client)<=r.clock)return null;let{item:h}=t?Fn(i,r):{item:et(i,r)};if(h instanceof N&&h.content instanceof le)l=h.content.type;else return null}else throw X();a>=0?c=l._length:c=0}return Vh(l,c,s.assoc)},Wh=(s,e)=>s===e||s!==null&&e!==null&&s.tname===e.tname&&Qe(s.item,e.item)&&Qe(s.type,e.type)&&s.assoc===e.assoc,ks=class{constructor(e,t){this.ds=e,this.sv=t}},Gh=(s,e)=>{let t=s.ds.clients,i=e.ds.clients,n=s.sv,r=e.sv;if(n.size!==r.size||t.size!==i.size)return!1;for(let[o,a]of n.entries())if(r.get(o)!==a)return!1;for(let[o,a]of t.entries()){let l=i.get(o)||[];if(a.length!==l.length)return!1;for(let c=0;c<a.length;c++){let h=a[c],u=l[c];if(h.clock!==u.clock||h.len!==u.len)return!1}}return!0},oa=(s,e=new Ot)=>(_e(e,s.ds),Wn(e,s.sv),e.toUint8Array()),Jh=s=>oa(s,new je),aa=(s,e=new li(M(s)))=>new ks(Ce(e),na(e)),Yh=s=>aa(s,new it(M(s))),Yn=(s,e)=>new ks(s,e),Xh=Yn(bi(),new Map),Zh=s=>Yn(Bn(s.store),Es(s.store)),Me=(s,e)=>e===void 0?!s.deleted:e.sv.has(s.id.client)&&(e.sv.get(s.id.client)||0)>s.id.clock&&!ut(e.ds,s.id),Dn=(s,e)=>{let t=P(s.meta,Dn,pe),i=s.doc.store;t.has(e)||(e.sv.forEach((n,r)=>{n<L(i,r)&&G(s,x(r,n))}),tt(s,e.ds,n=>{}),t.add(e))},Qh=(s,e,t=new Ve)=>{if(s.gc)throw new Error("Garbage-collection must be disabled in `originDoc`!");let{sv:i,ds:n}=e,r=new ne;return s.transact(o=>{let a=0;i.forEach(l=>{l>0&&a++}),w(r.restEncoder,a);for(let[l,c]of i){if(c===0)continue;c<L(s.store,l)&&G(o,x(l,c));let h=s.store.clients.get(l)||[],u=ae(h,c-1);w(r.restEncoder,u+1),r.writeClient(l),w(r.restEncoder,0);for(let d=0;d<=u;d++)h[d].write(r,0)}_e(r,n)}),Si(t,r.toUint8Array(),"snapshot"),t},eu=(s,e,t=Z)=>{let i=new t(M(e)),n=new Se(i,!1);for(let o=n.curr;o!==null;o=n.next())if((s.sv.get(o.id.client)||0)<o.id.clock+o.length)return!1;let r=st([s.ds,Ce(i)]);return ta(s.ds,r)},tu=(s,e)=>eu(s,e,ee),hi=class{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}},Es=s=>{let e=new Map;return s.clients.forEach((t,i)=>{let n=t[t.length-1];e.set(i,n.id.clock+n.length)}),e},L=(s,e)=>{let t=s.clients.get(e);if(t===void 0)return 0;let i=t[t.length-1];return i.id.clock+i.length},la=(s,e)=>{let t=s.clients.get(e.id.client);if(t===void 0)t=[],s.clients.set(e.id.client,t);else{let i=t[t.length-1];if(i.id.clock+i.length!==e.id.clock)throw X()}t.push(e)},ae=(s,e)=>{let t=0,i=s.length-1,n=s[i],r=n.id.clock;if(r===e)return i;let o=Q(e/(r+n.length-1)*i);for(;t<=i;){if(n=s[o],r=n.id.clock,r<=e){if(e<r+n.length)return o;t=o+1}else i=o-1;o=Q((t+i)/2)}throw X()},su=(s,e)=>{let t=s.clients.get(e.client);return t[ae(t,e.clock)]},et=su,Ln=(s,e,t)=>{let i=ae(e,t),n=e[i];return n.id.clock<t&&n instanceof N?(e.splice(i+1,0,_i(s,n,t-n.id.clock)),i+1):i},G=(s,e)=>{let t=s.doc.store.clients.get(e.client);return t[Ln(s,t,e.clock)]},$n=(s,e,t)=>{let i=e.clients.get(t.client),n=ae(i,t.clock),r=i[n];return t.clock!==r.id.clock+r.length-1&&r.constructor!==J&&i.splice(n+1,0,_i(s,r,t.clock-r.id.clock+1)),r},iu=(s,e,t)=>{let i=s.clients.get(e.id.client);i[ae(i,e.id.clock)]=t},ca=(s,e,t,i,n)=>{if(i===0)return;let r=t+i,o=Ln(s,e,t),a;do a=e[o++],r<a.id.clock+a.length&&Ln(s,e,r),n(a);while(o<e.length&&e[o].id.clock<r)},ui=class{constructor(e,t,i){this.doc=e,this.deleteSet=new Fe,this.beforeState=Es(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=i,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}},zo=(s,e)=>e.deleteSet.clients.size===0&&!Br(e.afterState,(t,i)=>e.beforeState.get(i)!==t)?!1:(jn(e.deleteSet),Eh(s,e),_e(s,e.deleteSet),!0),Wo=(s,e,t)=>{let i=e._item;(i===null||i.id.clock<(s.beforeState.get(i.id.client)||0)&&!i.deleted)&&P(s.changed,e,pe).add(t)},oi=(s,e)=>{let t=s[e],i=s[e-1],n=e;for(;n>0;t=i,i=s[--n-1]){if(i.deleted===t.deleted&&i.constructor===t.constructor&&i.mergeWith(t)){t instanceof N&&t.parentSub!==null&&t.parent._map.get(t.parentSub)===t&&t.parent._map.set(t.parentSub,i);continue}break}let r=e-n;return r&&s.splice(e+1-r,r),r},ha=(s,e,t)=>{for(let[i,n]of s.clients.entries()){let r=e.clients.get(i);for(let o=n.length-1;o>=0;o--){let a=n[o],l=a.clock+a.len;for(let c=ae(r,a.clock),h=r[c];c<r.length&&h.id.clock<l;h=r[++c]){let u=r[c];if(a.clock+a.len<=u.id.clock)break;u instanceof N&&u.deleted&&!u.keep&&t(u)&&u.gc(e,!1)}}}},ua=(s,e)=>{s.clients.forEach((t,i)=>{let n=e.clients.get(i);for(let r=t.length-1;r>=0;r--){let o=t[r],a=St(n.length-1,1+ae(n,o.clock+o.len-1));for(let l=a,c=n[l];l>0&&c.id.clock>=o.clock;c=n[l])l-=1+oi(n,l)}})},nu=(s,e,t)=>{ha(s,e,t),ua(s,e)},da=(s,e)=>{if(e<s.length){let t=s[e],i=t.doc,n=i.store,r=t.deleteSet,o=t._mergeStructs;try{jn(r),t.afterState=Es(t.doc.store),i.emit("beforeObserverCalls",[t,i]);let a=[];t.changed.forEach((l,c)=>a.push(()=>{(c._item===null||!c._item.deleted)&&c._callObserver(t,l)})),a.push(()=>{t.changedParentTypes.forEach((l,c)=>{c._dEH.l.length>0&&(c._item===null||!c._item.deleted)&&(l=l.filter(h=>h.target._item===null||!h.target._item.deleted),l.forEach(h=>{h.currentTarget=c,h._path=null}),l.sort((h,u)=>h.path.length-u.path.length),a.push(()=>{ra(c._dEH,l,t)}))}),a.push(()=>i.emit("afterTransaction",[t,i])),a.push(()=>{t._needFormattingCleanup&&Iu(t)})}),us(a,[])}finally{i.gc&&ha(r,n,i.gcFilter),ua(r,n),t.afterState.forEach((h,u)=>{let d=t.beforeState.get(u)||0;if(d!==h){let f=n.clients.get(u),p=Ie(ae(f,d),1);for(let g=f.length-1;g>=p;)g-=1+oi(f,g)}});for(let h=o.length-1;h>=0;h--){let{client:u,clock:d}=o[h].id,f=n.clients.get(u),p=ae(f,d);p+1<f.length&&oi(f,p+1)>1||p>0&&oi(f,p)}if(!t.local&&t.afterState.get(i.clientID)!==t.beforeState.get(i.clientID)&&(ti(ws,gs,"[yjs] ",ms,ys,"Changed the client-id because another client seems to be using it."),i.clientID=sa()),i.emit("afterTransactionCleanup",[t,i]),i._observers.has("update")){let h=new be;zo(h,t)&&i.emit("update",[h.toUint8Array(),t.origin,i,t])}if(i._observers.has("updateV2")){let h=new ne;zo(h,t)&&i.emit("updateV2",[h.toUint8Array(),t.origin,i,t])}let{subdocsAdded:a,subdocsLoaded:l,subdocsRemoved:c}=t;(a.size>0||c.size>0||l.size>0)&&(a.forEach(h=>{h.clientID=i.clientID,h.collectionid==null&&(h.collectionid=i.collectionid),i.subdocs.add(h)}),c.forEach(h=>i.subdocs.delete(h)),i.emit("subdocs",[{loaded:l,added:a,removed:c},i,t]),c.forEach(h=>h.destroy())),s.length<=e+1?(i._transactionCleanups=[],i.emit("afterAllTransactions",[i,s])):da(s,e+1)}}},C=(s,e,t=null,i=!0)=>{let n=s._transactionCleanups,r=!1,o=null;s._transaction===null&&(r=!0,s._transaction=new ui(s,t,i),n.push(s._transaction),n.length===1&&s.emit("beforeAllTransactions",[s]),s.emit("beforeTransaction",[s._transaction,s]));try{o=e(s._transaction)}finally{if(r){let a=s._transaction===n[0];s._transaction=null,a&&da(n,0)}}return o},Mn=class{constructor(e,t){this.insertions=t,this.deletions=e,this.meta=new Map}},Go=(s,e,t)=>{tt(s,t.deletions,i=>{i instanceof N&&e.scope.some(n=>n===s.doc||xs(n,i))&&sr(i,!1)})},Jo=(s,e,t)=>{let i=null,n=s.doc,r=s.scope;C(n,a=>{for(;e.length>0&&s.currStackItem===null;){let l=n.store,c=e.pop(),h=new Set,u=[],d=!1;tt(a,c.insertions,f=>{if(f instanceof N){if(f.redone!==null){let{item:p,diff:g}=Fn(l,f.id);g>0&&(p=G(a,x(p.id.client,p.id.clock+g))),f=p}!f.deleted&&r.some(p=>p===a.doc||xs(p,f))&&u.push(f)}}),tt(a,c.deletions,f=>{f instanceof N&&r.some(p=>p===a.doc||xs(p,f))&&!ut(c.insertions,f.id)&&h.add(f)}),h.forEach(f=>{d=Va(a,f,h,c.insertions,s.ignoreRemoteMapChanges,s)!==null||d});for(let f=u.length-1;f>=0;f--){let p=u[f];s.deleteFilter(p)&&(p.delete(a),d=!0)}s.currStackItem=d?c:null}a.changed.forEach((l,c)=>{l.has(null)&&c._searchMarker&&(c._searchMarker.length=0)}),i=a},s);let o=s.currStackItem;if(o!=null){let a=i.changedParentTypes;s.emit("stack-item-popped",[{stackItem:o,type:t,changedParentTypes:a,origin:s},s]),s.currStackItem=null}return o},On=class extends ze{constructor(e,{captureTimeout:t=500,captureTransaction:i=l=>!0,deleteFilter:n=()=>!0,trackedOrigins:r=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:a=Qt(e)?e[0].doc:e instanceof Ve?e:e.doc}={}){super(),this.scope=[],this.doc=a,this.addToScope(e),this.deleteFilter=n,r.add(this),this.trackedOrigins=r,this.captureTransaction=i,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=t,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(m=>l.changedParentTypes.has(m)||m===this.doc)||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;let c=this.undoing,h=this.redoing,u=c?this.redoStack:this.undoStack;c?this.stopCapturing():h||this.clear(!1,!0);let d=new Fe;l.afterState.forEach((m,y)=>{let b=l.beforeState.get(y)||0,S=m-b;S>0&&Ss(d,y,b,S)});let f=ie(),p=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&u.length>0&&!c&&!h){let m=u[u.length-1];m.deletions=st([m.deletions,l.deleteSet]),m.insertions=st([m.insertions,d])}else u.push(new Mn(l.deleteSet,d)),p=!0;!c&&!h&&(this.lastChange=f),tt(l,l.deleteSet,m=>{m instanceof N&&this.scope.some(y=>y===l.doc||xs(y,m))&&sr(m,!0)});let g=[{stackItem:u[u.length-1],origin:l.origin,type:c?"redo":"undo",changedParentTypes:l.changedParentTypes},this];p?this.emit("stack-item-added",g):this.emit("stack-item-updated",g)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(e){let t=new Set(this.scope);e=Qt(e)?e:[e],e.forEach(i=>{t.has(i)||(t.add(i),(i instanceof O?i.doc!==this.doc:i!==this.doc)&&An("[yjs#509] Not same Y.Doc"),this.scope.push(i))})}addTrackedOrigin(e){this.trackedOrigins.add(e)}removeTrackedOrigin(e){this.trackedOrigins.delete(e)}clear(e=!0,t=!0){(e&&this.canUndo()||t&&this.canRedo())&&this.doc.transact(i=>{e&&(this.undoStack.forEach(n=>Go(i,this,n)),this.undoStack=[]),t&&(this.redoStack.forEach(n=>Go(i,this,n)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:e,redoStackCleared:t}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let e;try{e=Jo(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}redo(){this.redoing=!0;let e;try{e=Jo(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}};Se=class{constructor(e,t){this.gen=ru(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===q);return this.curr}},ou=s=>fa(s,ee),fa=(s,e=Z)=>{let t=[],i=new e(M(s)),n=new Se(i,!1);for(let o=n.curr;o!==null;o=n.next())t.push(o);ti("Structs: ",t);let r=Ce(i);ti("DeleteSet: ",r)},au=s=>pa(s,ee),pa=(s,e=Z)=>{let t=[],i=new e(M(s)),n=new Se(i,!1);for(let r=n.curr;r!==null;r=n.next())t.push(r);return{structs:t,ds:Ce(i)}},vs=class{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}},ga=s=>Ts(s,ee,be),ma=(s,e=Ot,t=Z)=>{let i=new e,n=new Se(new t(M(s)),!1),r=n.curr;if(r!==null){let o=0,a=r.id.client,l=r.id.clock!==0,c=l?0:r.id.clock+r.length;for(;r!==null;r=n.next())a!==r.id.client&&(c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c)),a=r.id.client,c=0,l=r.id.clock!==0),r.constructor===q&&(l=!0),l||(c=r.id.clock+r.length);c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c));let h=$();return w(h,o),to(h,i.restEncoder),i.restEncoder=h,i.toUint8Array()}else return w(i.restEncoder,0),i.toUint8Array()},lu=s=>ma(s,je,ee),ya=(s,e=Z)=>{let t=new Map,i=new Map,n=new Se(new e(M(s)),!1),r=n.curr;if(r!==null){let o=r.id.client,a=r.id.clock;for(t.set(o,a);r!==null;r=n.next())o!==r.id.client&&(i.set(o,a),t.set(r.id.client,r.id.clock),o=r.id.client),a=r.id.clock+r.length;i.set(o,a)}return{from:t,to:i}},cu=s=>ya(s,ee),hu=(s,e)=>{if(s.constructor===J){let{client:t,clock:i}=s.id;return new J(x(t,i+e),s.length-e)}else if(s.constructor===q){let{client:t,clock:i}=s.id;return new q(x(t,i+e),s.length-e)}else{let t=s,{client:i,clock:n}=t.id;return new N(x(i,n+e),null,x(i,n+e-1),null,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e))}},Ts=(s,e=Z,t=ne)=>{if(s.length===1)return s[0];let i=s.map(h=>new e(M(h))),n=i.map(h=>new Se(h,!0)),r=null,o=new t,a=new vs(o);for(;n=n.filter(d=>d.curr!==null),n.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){let p=d.curr.id.clock-f.curr.id.clock;return p===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===q?1:-1:p}else return f.curr.id.client-d.curr.id.client}),n.length!==0;){let h=n[0],u=h.curr.id.client;if(r!==null){let d=h.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=r.struct.id.clock+r.struct.length&&d.id.client>=r.struct.id.client;)d=h.next(),f=!0;if(d===null||d.id.client!==u||f&&d.id.clock>r.struct.id.clock+r.struct.length)continue;if(u!==r.struct.id.client)Oe(a,r.struct,r.offset),r={struct:d,offset:0},h.next();else if(r.struct.id.clock+r.struct.length<d.id.clock)if(r.struct.constructor===q)r.struct.length=d.id.clock+d.length-r.struct.id.clock;else{Oe(a,r.struct,r.offset);let p=d.id.clock-r.struct.id.clock-r.struct.length;r={struct:new q(x(u,r.struct.id.clock+r.struct.length),p),offset:0}}else{let p=r.struct.id.clock+r.struct.length-d.id.clock;p>0&&(r.struct.constructor===q?r.struct.length-=p:d=hu(d,p)),r.struct.mergeWith(d)||(Oe(a,r.struct,r.offset),r={struct:d,offset:0},h.next())}}else r={struct:h.curr,offset:0},h.next();for(let d=h.curr;d!==null&&d.id.client===u&&d.id.clock===r.struct.id.clock+r.struct.length&&d.constructor!==q;d=h.next())Oe(a,r.struct,r.offset),r={struct:d,offset:0}}r!==null&&(Oe(a,r.struct,r.offset),r=null),Zn(a);let l=i.map(h=>Ce(h)),c=st(l);return _e(o,c),o.toUint8Array()},Xn=(s,e,t=Z,i=ne)=>{let n=zn(e),r=new i,o=new vs(r),a=new t(M(s)),l=new Se(a,!1);for(;l.curr;){let h=l.curr,u=h.id.client,d=n.get(u)||0;if(l.curr.constructor===q){l.next();continue}if(h.id.clock+h.length>d)for(Oe(o,h,Ie(d-h.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)Oe(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=d;)l.next()}Zn(o);let c=Ce(a);return _e(r,c),r.toUint8Array()},uu=(s,e)=>Xn(s,e,ee,be),wa=s=>{s.written>0&&(s.clientStructs.push({written:s.written,restEncoder:U(s.encoder.restEncoder)}),s.encoder.restEncoder=$(),s.written=0)},Oe=(s,e,t)=>{s.written>0&&s.currClient!==e.id.client&&wa(s),s.written===0&&(s.currClient=e.id.client,s.encoder.writeClient(e.id.client),w(s.encoder.restEncoder,e.id.clock+t)),e.write(s.encoder,t),s.written++},Zn=s=>{wa(s);let e=s.encoder.restEncoder;w(e,s.clientStructs.length);for(let t=0;t<s.clientStructs.length;t++){let i=s.clientStructs[t];w(e,i.written),Nt(e,i.restEncoder)}},xi=(s,e,t,i)=>{let n=new t(M(s)),r=new Se(n,!1),o=new i,a=new vs(o);for(let c=r.curr;c!==null;c=r.next())Oe(a,e(c),0);Zn(a);let l=Ce(n);return _e(o,l),o.toUint8Array()},_a=({formatting:s=!0,subdocs:e=!0,yxml:t=!0}={})=>{let i=0,n=F(),r=F(),o=F(),a=F();return a.set(null,null),l=>{switch(l.constructor){case J:case q:return l;case N:{let c=l,h=c.content;switch(h.constructor){case jt:break;case le:{if(t){let u=h.type;u instanceof lt&&(u.nodeName=P(r,u.nodeName,()=>"node-"+i)),u instanceof Cs&&(u.hookName=P(r,u.hookName,()=>"hook-"+i))}break}case Be:{let u=h;u.arr=u.arr.map(()=>i);break}case ct:{let u=h;u.content=new Uint8Array([i]);break}case ht:{let u=h;e&&(u.opts={},u.doc.guid=i+"");break}case Ne:{let u=h;u.embed={};break}case R:{let u=h;s&&(u.key=P(o,u.key,()=>i+""),u.value=P(a,u.value,()=>({i})));break}case Ns:{let u=h;u.arr=u.arr.map(()=>i);break}case fe:{let u=h;u.str=Yr(i%10+"",u.str.length);break}default:X()}return c.parentSub&&(c.parentSub=P(n,c.parentSub,()=>i+"")),i++,l}default:X()}}},du=(s,e)=>xi(s,_a(e),ee,be),fu=(s,e)=>xi(s,_a(e),Z,ne),pu=s=>xi(s,mn,ee,ne),ba=s=>xi(s,mn,Z,be),Yo="You must not compute changes after the event-handler fired.",nt=class{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=gu(this.currentTarget,this.target))}deletes(e){return ut(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw me(Yo);let e=new Map,t=this.target;this.transaction.changed.get(t).forEach(n=>{if(n!==null){let r=t._map.get(n),o,a;if(this.adds(r)){let l=r.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(r))if(l!==null&&this.deletes(l))o="delete",a=Ps(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",a=Ps(l.content.getContent())):(o="add",a=void 0)}else if(this.deletes(r))o="delete",a=Ps(r.content.getContent());else return;e.set(n,{action:o,oldValue:a})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw me(Yo);let t=this.target,i=pe(),n=pe(),r=[];if(e={added:i,deleted:n,delta:r,keys:this.keys},this.transaction.changed.get(t).has(null)){let a=null,l=()=>{a&&r.push(a)};for(let c=t._start;c!==null;c=c.right)c.deleted?this.deletes(c)&&!this.adds(c)&&((a===null||a.delete===void 0)&&(l(),a={delete:0}),a.delete+=c.length,n.add(c)):this.adds(c)?((a===null||a.insert===void 0)&&(l(),a={insert:[]}),a.insert=a.insert.concat(c.content.getContent()),i.add(c)):((a===null||a.retain===void 0)&&(l(),a={retain:0}),a.retain+=c.length);a!==null&&a.retain===void 0&&l()}this._changes=e}return e}},gu=(s,e)=>{let t=[];for(;e._item!==null&&e!==s;){if(e._item.parentSub!==null)t.unshift(e._item.parentSub);else{let i=0,n=e._item.parent._start;for(;n!==e._item&&n!==null;)!n.deleted&&n.countable&&(i+=n.length),n=n.right;t.unshift(i)}e=e._item.parent}return t},H=()=>{An("Invalid access: Add Yjs type to a document before reading data.")},Sa=80,Qn=0,Rn=class{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=Qn++}},mu=s=>{s.timestamp=Qn++},xa=(s,e,t)=>{s.p.marker=!1,s.p=e,e.marker=!0,s.index=t,s.timestamp=Qn++},yu=(s,e,t)=>{if(s.length>=Sa){let i=s.reduce((n,r)=>n.timestamp<r.timestamp?n:r);return xa(i,e,t),i}else{let i=new Rn(e,t);return s.push(i),i}},ki=(s,e)=>{if(s._start===null||e===0||s._searchMarker===null)return null;let t=s._searchMarker.length===0?null:s._searchMarker.reduce((r,o)=>bt(e-r.index)<bt(e-o.index)?r:o),i=s._start,n=0;for(t!==null&&(i=t.p,n=t.index,mu(t));i.right!==null&&n<e;){if(!i.deleted&&i.countable){if(e<n+i.length)break;n+=i.length}i=i.right}for(;i.left!==null&&n>e;)i=i.left,!i.deleted&&i.countable&&(n-=i.length);for(;i.left!==null&&i.left.id.client===i.id.client&&i.left.id.clock+i.left.length===i.id.clock;)i=i.left,!i.deleted&&i.countable&&(n-=i.length);return t!==null&&bt(t.index-n)<i.parent.length/Sa?(xa(t,i,n),t):yu(s._searchMarker,i,n)},Is=(s,e,t)=>{for(let i=s.length-1;i>=0;i--){let n=s[i];if(t>0){let r=n.p;for(r.marker=!1;r&&(r.deleted||!r.countable);)r=r.left,r&&!r.deleted&&r.countable&&(n.index-=r.length);if(r===null||r.marker===!0){s.splice(i,1);continue}n.p=r,r.marker=!0}(e<n.index||t>0&&e===n.index)&&(n.index=Ie(e,n.index+t))}},wu=s=>{s.doc??H();let e=s._start,t=[];for(;e;)t.push(e),e=e.right;return t},vi=(s,e,t)=>{let i=s,n=e.changedParentTypes;for(;P(n,s,()=>[]).push(t),s._item!==null;)s=s._item.parent;ra(i._eH,t,e)},O=class{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Bo(),this._dEH=Bo(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw de()}clone(){throw de()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){Po(this._eH,e)}observeDeep(e){Po(this._dEH,e)}unobserve(e){Ko(this._eH,e)}unobserveDeep(e){Ko(this._dEH,e)}toJSON(){}},ka=(s,e,t)=>{s.doc??H(),e<0&&(e=s._length+e),t<0&&(t=s._length+t);let i=t-e,n=[],r=s._start;for(;r!==null&&i>0;){if(r.countable&&!r.deleted){let o=r.content.getContent();if(o.length<=e)e-=o.length;else{for(let a=e;a<o.length&&i>0;a++)n.push(o[a]),i--;e=0}}r=r.right}return n},va=s=>{s.doc??H();let e=[],t=s._start;for(;t!==null;){if(t.countable&&!t.deleted){let i=t.content.getContent();for(let n=0;n<i.length;n++)e.push(i[n])}t=t.right}return e},_u=(s,e)=>{let t=[],i=s._start;for(;i!==null;){if(i.countable&&Me(i,e)){let n=i.content.getContent();for(let r=0;r<n.length;r++)t.push(n[r])}i=i.right}return t},As=(s,e)=>{let t=0,i=s._start;for(s.doc??H();i!==null;){if(i.countable&&!i.deleted){let n=i.content.getContent();for(let r=0;r<n.length;r++)e(n[r],t++,s)}i=i.right}},Ta=(s,e)=>{let t=[];return As(s,(i,n)=>{t.push(e(i,n,s))}),t},bu=s=>{let e=s._start,t=null,i=0;return{[Symbol.iterator](){return this},next:()=>{if(t===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};t=e.content.getContent(),i=0,e=e.right}let n=t[i++];return t.length<=i&&(t=null),{done:!1,value:n}}}},Ia=(s,e)=>{s.doc??H();let t=ki(s,e),i=s._start;for(t!==null&&(i=t.p,e-=t.index);i!==null;i=i.right)if(!i.deleted&&i.countable){if(e<i.length)return i.content.getContent()[e];e-=i.length}},di=(s,e,t,i)=>{let n=t,r=s.doc,o=r.clientID,a=r.store,l=t===null?e._start:t.right,c=[],h=()=>{c.length>0&&(n=new N(x(o,L(a,o)),n,n&&n.lastId,l,l&&l.id,e,null,new Be(c)),n.integrate(s,0),c=[])};i.forEach(u=>{if(u===null)c.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:c.push(u);break;default:switch(h(),u.constructor){case Uint8Array:case ArrayBuffer:n=new N(x(o,L(a,o)),n,n&&n.lastId,l,l&&l.id,e,null,new ct(new Uint8Array(u))),n.integrate(s,0);break;case Ve:n=new N(x(o,L(a,o)),n,n&&n.lastId,l,l&&l.id,e,null,new ht(u)),n.integrate(s,0);break;default:if(u instanceof O)n=new N(x(o,L(a,o)),n,n&&n.lastId,l,l&&l.id,e,null,new le(u)),n.integrate(s,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},Aa=()=>me("Length exceeded!"),Ua=(s,e,t,i)=>{if(t>e._length)throw Aa();if(t===0)return e._searchMarker&&Is(e._searchMarker,t,i.length),di(s,e,null,i);let n=t,r=ki(e,t),o=e._start;for(r!==null&&(o=r.p,t-=r.index,t===0&&(o=o.prev,t+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(t<=o.length){t<o.length&&G(s,x(o.id.client,o.id.clock+t));break}t-=o.length}return e._searchMarker&&Is(e._searchMarker,n,i.length),di(s,e,o,i)},Su=(s,e,t)=>{let n=(e._searchMarker||[]).reduce((r,o)=>o.index>r.index?o:r,{index:0,p:e._start}).p;if(n)for(;n.right;)n=n.right;return di(s,e,n,t)},Ca=(s,e,t,i)=>{if(i===0)return;let n=t,r=i,o=ki(e,t),a=e._start;for(o!==null&&(a=o.p,t-=o.index);a!==null&&t>0;a=a.right)!a.deleted&&a.countable&&(t<a.length&&G(s,x(a.id.client,a.id.clock+t)),t-=a.length);for(;i>0&&a!==null;)a.deleted||(i<a.length&&G(s,x(a.id.client,a.id.clock+i)),a.delete(s),i-=a.length),a=a.right;if(i>0)throw Aa();e._searchMarker&&Is(e._searchMarker,n,-r+i)},fi=(s,e,t)=>{let i=e._map.get(t);i!==void 0&&i.delete(s)},er=(s,e,t,i)=>{let n=e._map.get(t)||null,r=s.doc,o=r.clientID,a;if(i==null)a=new Be([i]);else switch(i.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:a=new Be([i]);break;case Uint8Array:a=new ct(i);break;case Ve:a=new ht(i);break;default:if(i instanceof O)a=new le(i);else throw new Error("Unexpected content type")}new N(x(o,L(r.store,o)),n,n&&n.lastId,null,null,e,t,a).integrate(s,0)},tr=(s,e)=>{s.doc??H();let t=s._map.get(e);return t!==void 0&&!t.deleted?t.content.getContent()[t.length-1]:void 0},Na=s=>{let e={};return s.doc??H(),s._map.forEach((t,i)=>{t.deleted||(e[i]=t.content.getContent()[t.length-1])}),e},Ea=(s,e)=>{s.doc??H();let t=s._map.get(e);return t!==void 0&&!t.deleted},xu=(s,e,t)=>{let i=s._map.get(e)||null;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;return i!==null&&Me(i,t)?i.content.getContent()[i.length-1]:void 0},Da=(s,e)=>{let t={};return s._map.forEach((i,n)=>{let r=i;for(;r!==null&&(!e.sv.has(r.id.client)||r.id.clock>=(e.sv.get(r.id.client)||0));)r=r.left;r!==null&&Me(r,e)&&(t[n]=r.content.getContent()[r.length-1])}),t},ni=s=>(s.doc??H(),Oo(s._map.entries(),e=>!e[1].deleted)),pi=class extends nt{},rt=class s extends O{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){let t=new s;return t.push(e),t}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return e.insert(0,this.toArray().map(t=>t instanceof O?t.clone():t)),e}get length(){return this.doc??H(),this._length}_callObserver(e,t){super._callObserver(e,t),vi(this,e,new pi(this,e))}insert(e,t){this.doc!==null?C(this.doc,i=>{Ua(i,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){this.doc!==null?C(this.doc,t=>{Su(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){this.doc!==null?C(this.doc,i=>{Ca(i,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return Ia(this,e)}toArray(){return va(this)}slice(e=0,t=this.length){return ka(this,e,t)}toJSON(){return this.map(e=>e instanceof O?e.toJSON():e)}map(e){return Ta(this,e)}forEach(e){As(this,e)}[Symbol.iterator](){return bu(this)}_write(e){e.writeTypeRef(Ku)}},ku=s=>new rt,gi=class extends nt{constructor(e,t,i){super(e,t),this.keysChanged=i}},ot=class s extends O{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((i,n)=>{this.set(n,i)}),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return this.forEach((t,i)=>{e.set(i,t instanceof O?t.clone():t)}),e}_callObserver(e,t){vi(this,e,new gi(this,e,t))}toJSON(){this.doc??H();let e={};return this._map.forEach((t,i)=>{if(!t.deleted){let n=t.content.getContent()[t.length-1];e[i]=n instanceof O?n.toJSON():n}}),e}get size(){return[...ni(this)].length}keys(){return si(ni(this),e=>e[0])}values(){return si(ni(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return si(ni(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??H(),this._map.forEach((t,i)=>{t.deleted||e(t.content.getContent()[t.length-1],i,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?C(this.doc,t=>{fi(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return this.doc!==null?C(this.doc,i=>{er(i,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return tr(this,e)}has(e){return Ea(this,e)}clear(){this.doc!==null?C(this.doc,e=>{this.forEach(function(t,i,n){fi(e,n,i)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(qu)}},vu=s=>new ot,Re=(s,e)=>s===e||typeof s=="object"&&typeof e=="object"&&s&&e&&fn(s,e),Us=class{constructor(e,t,i,n){this.left=e,this.right=t,this.index=i,this.currentAttributes=n}forward(){switch(this.right===null&&X(),this.right.content.constructor){case R:this.right.deleted||Bt(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}},Xo=(s,e,t)=>{for(;e.right!==null&&t>0;){switch(e.right.content.constructor){case R:e.right.deleted||Bt(e.currentAttributes,e.right.content);break;default:e.right.deleted||(t<e.right.length&&G(s,x(e.right.id.client,e.right.id.clock+t)),e.index+=e.right.length,t-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},ri=(s,e,t,i)=>{let n=new Map,r=i?ki(e,t):null;if(r){let o=new Us(r.p.left,r.p,r.index,n);return Xo(s,o,t-r.index)}else{let o=new Us(null,e._start,0,n);return Xo(s,o,t)}},La=(s,e,t,i)=>{for(;t.right!==null&&(t.right.deleted===!0||t.right.content.constructor===R&&Re(i.get(t.right.content.key),t.right.content.value));)t.right.deleted||i.delete(t.right.content.key),t.forward();let n=s.doc,r=n.clientID;i.forEach((o,a)=>{let l=t.left,c=t.right,h=new N(x(r,L(n.store,r)),l,l&&l.lastId,c,c&&c.id,e,null,new R(a,o));h.integrate(s,0),t.right=h,t.forward()})},Bt=(s,e)=>{let{key:t,value:i}=e;i===null?s.delete(t):s.set(t,i)},$a=(s,e)=>{for(;s.right!==null;){if(!(s.right.deleted||s.right.content.constructor===R&&Re(e[s.right.content.key]??null,s.right.content.value)))break;s.forward()}},Ma=(s,e,t,i)=>{let n=s.doc,r=n.clientID,o=new Map;for(let a in i){let l=i[a],c=t.currentAttributes.get(a)??null;if(!Re(c,l)){o.set(a,c);let{left:h,right:u}=t;t.right=new N(x(r,L(n.store,r)),h,h&&h.lastId,u,u&&u.id,e,null,new R(a,l)),t.right.integrate(s,0),t.forward()}}return o},Un=(s,e,t,i,n)=>{t.currentAttributes.forEach((d,f)=>{n[f]===void 0&&(n[f]=null)});let r=s.doc,o=r.clientID;$a(t,n);let a=Ma(s,e,t,n),l=i.constructor===String?new fe(i):i instanceof O?new le(i):new Ne(i),{left:c,right:h,index:u}=t;e._searchMarker&&Is(e._searchMarker,t.index,l.getLength()),h=new N(x(o,L(r.store,o)),c,c&&c.lastId,h,h&&h.id,e,null,l),h.integrate(s,0),t.right=h,t.index=u,t.forward(),La(s,e,t,a)},Zo=(s,e,t,i,n)=>{let r=s.doc,o=r.clientID;$a(t,n);let a=Ma(s,e,t,n);e:for(;t.right!==null&&(i>0||a.size>0&&(t.right.deleted||t.right.content.constructor===R));){if(!t.right.deleted)switch(t.right.content.constructor){case R:{let{key:l,value:c}=t.right.content,h=n[l];if(h!==void 0){if(Re(h,c))a.delete(l);else{if(i===0)break e;a.set(l,c)}t.right.delete(s)}else t.currentAttributes.set(l,c);break}default:i<t.right.length&&G(s,x(t.right.id.client,t.right.id.clock+i)),i-=t.right.length;break}t.forward()}if(i>0){let l="";for(;i>0;i--)l+=`
`;t.right=new N(x(o,L(r.store,o)),t.left,t.left&&t.left.lastId,t.right,t.right&&t.right.id,e,null,new fe(l)),t.right.integrate(s,0),t.forward()}La(s,e,t,a)},Oa=(s,e,t,i,n)=>{let r=e,o=F();for(;r&&(!r.countable||r.deleted);){if(!r.deleted&&r.content.constructor===R){let c=r.content;o.set(c.key,c)}r=r.right}let a=0,l=!1;for(;e!==r;){if(t===e&&(l=!0),!e.deleted){let c=e.content;switch(c.constructor){case R:{let{key:h,value:u}=c,d=i.get(h)??null;(o.get(h)!==c||d===u)&&(e.delete(s),a++,!l&&(n.get(h)??null)===u&&d!==u&&(d===null?n.delete(h):n.set(h,d))),!l&&!e.deleted&&Bt(n,c);break}}}e=e.right}return a},Tu=(s,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;let t=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===R){let i=e.content.key;t.has(i)?e.delete(s):t.add(i)}e=e.left}},Ra=s=>{let e=0;return C(s.doc,t=>{let i=s._start,n=s._start,r=F(),o=Vs(r);for(;n;){if(n.deleted===!1)switch(n.content.constructor){case R:Bt(o,n.content);break;default:e+=Oa(t,i,n,r,o),r=Vs(o),i=n;break}n=n.right}}),e},Iu=s=>{let e=new Set,t=s.doc;for(let[i,n]of s.afterState.entries()){let r=s.beforeState.get(i)||0;n!==r&&ca(s,t.store.clients.get(i),r,n,o=>{!o.deleted&&o.content.constructor===R&&o.constructor!==J&&e.add(o.parent)})}C(t,i=>{tt(s,s.deleteSet,n=>{if(n instanceof J||!n.parent._hasFormatting||e.has(n.parent))return;let r=n.parent;n.content.constructor===R?e.add(r):Tu(i,n)});for(let n of e)Ra(n)})},Qo=(s,e,t)=>{let i=t,n=Vs(e.currentAttributes),r=e.right;for(;t>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case le:case Ne:case fe:t<e.right.length&&G(s,x(e.right.id.client,e.right.id.clock+t)),t-=e.right.length,e.right.delete(s);break}e.forward()}r&&Oa(s,r,e.right,n,e.currentAttributes);let o=(e.left||e.right).parent;return o._searchMarker&&Is(o._searchMarker,e.index,-i+t),e},mi=class extends nt{constructor(e,t,i){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,i.forEach(n=>{n===null?this.childListChanged=!0:this.keysChanged.add(n)})}get changes(){if(this._changes===null){let e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){let e=this.target.doc,t=[];C(e,i=>{let n=new Map,r=new Map,o=this.target._start,a=null,l={},c="",h=0,u=0,d=()=>{if(a!==null){let f=null;switch(a){case"delete":u>0&&(f={delete:u}),u=0;break;case"insert":(typeof c=="object"||c.length>0)&&(f={insert:c},n.size>0&&(f.attributes={},n.forEach((p,g)=>{p!==null&&(f.attributes[g]=p)}))),c="";break;case"retain":h>0&&(f={retain:h},So(l)||(f.attributes=wo({},l))),h=0;break}f&&t.push(f),a=null}};for(;o!==null;){switch(o.content.constructor){case le:case Ne:this.adds(o)?this.deletes(o)||(d(),a="insert",c=o.content.getContent()[0],d()):this.deletes(o)?(a!=="delete"&&(d(),a="delete"),u+=1):o.deleted||(a!=="retain"&&(d(),a="retain"),h+=1);break;case fe:this.adds(o)?this.deletes(o)||(a!=="insert"&&(d(),a="insert"),c+=o.content.str):this.deletes(o)?(a!=="delete"&&(d(),a="delete"),u+=o.length):o.deleted||(a!=="retain"&&(d(),a="retain"),h+=o.length);break;case R:{let{key:f,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){let g=n.get(f)??null;Re(g,p)?p!==null&&o.delete(i):(a==="retain"&&d(),Re(p,r.get(f)??null)?delete l[f]:l[f]=p)}}else if(this.deletes(o)){r.set(f,p);let g=n.get(f)??null;Re(g,p)||(a==="retain"&&d(),l[f]=g)}else if(!o.deleted){r.set(f,p);let g=l[f];g!==void 0&&(Re(g,p)?g!==null&&o.delete(i):(a==="retain"&&d(),p===null?delete l[f]:l[f]=p))}o.deleted||(a==="insert"&&d(),Bt(n,o.content));break}}o=o.right}for(d();t.length>0;){let f=t[t.length-1];if(f.retain!==void 0&&f.attributes===void 0)t.pop();else break}}),this._delta=t}return this._delta}},Ft=class s extends O{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??H(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(i=>i())}catch(i){console.error(i)}this._pending=null}_copy(){return new s}clone(){let e=new s;return e.applyDelta(this.toDelta()),e}_callObserver(e,t){super._callObserver(e,t);let i=new mi(this,e,t);vi(this,e,i),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??H();let e="",t=this._start;for(;t!==null;)!t.deleted&&t.countable&&t.content.constructor===fe&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){this.doc!==null?C(this.doc,i=>{let n=new Us(null,this._start,0,new Map);for(let r=0;r<e.length;r++){let o=e[r];if(o.insert!==void 0){let a=!t&&typeof o.insert=="string"&&r===e.length-1&&n.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof a!="string"||a.length>0)&&Un(i,this,n,a,o.attributes||{})}else o.retain!==void 0?Zo(i,this,n,o.retain,o.attributes||{}):o.delete!==void 0&&Qo(i,n,o.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,i){this.doc??H();let n=[],r=new Map,o=this.doc,a="",l=this._start;function c(){if(a.length>0){let u={},d=!1;r.forEach((p,g)=>{d=!0,u[g]=p});let f={insert:a};d&&(f.attributes=u),n.push(f),a=""}}let h=()=>{for(;l!==null;){if(Me(l,e)||t!==void 0&&Me(l,t))switch(l.content.constructor){case fe:{let u=r.get("ychange");e!==void 0&&!Me(l,e)?(u===void 0||u.user!==l.id.client||u.type!=="removed")&&(c(),r.set("ychange",i?i("removed",l.id):{type:"removed"})):t!==void 0&&!Me(l,t)?(u===void 0||u.user!==l.id.client||u.type!=="added")&&(c(),r.set("ychange",i?i("added",l.id):{type:"added"})):u!==void 0&&(c(),r.delete("ychange")),a+=l.content.str;break}case le:case Ne:{c();let u={insert:l.content.getContent()[0]};if(r.size>0){let d={};u.attributes=d,r.forEach((f,p)=>{d[p]=f})}n.push(u);break}case R:Me(l,e)&&(c(),Bt(r,l.content));break}l=l.right}c()};return e||t?C(o,u=>{e&&Dn(u,e),t&&Dn(u,t),h()},"cleanup"):h(),n}insert(e,t,i){if(t.length<=0)return;let n=this.doc;n!==null?C(n,r=>{let o=ri(r,this,e,!i);i||(i={},o.currentAttributes.forEach((a,l)=>{i[l]=a})),Un(r,this,o,t,i)}):this._pending.push(()=>this.insert(e,t,i))}insertEmbed(e,t,i){let n=this.doc;n!==null?C(n,r=>{let o=ri(r,this,e,!i);Un(r,this,o,t,i||{})}):this._pending.push(()=>this.insertEmbed(e,t,i||{}))}delete(e,t){if(t===0)return;let i=this.doc;i!==null?C(i,n=>{Qo(n,ri(n,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,i){if(t===0)return;let n=this.doc;n!==null?C(n,r=>{let o=ri(r,this,e,!1);o.right!==null&&Zo(r,this,o,t,i)}):this._pending.push(()=>this.format(e,t,i))}removeAttribute(e){this.doc!==null?C(this.doc,t=>{fi(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){this.doc!==null?C(this.doc,i=>{er(i,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return tr(this,e)}getAttributes(){return Na(this)}_write(e){e.writeTypeRef(Hu)}},Au=s=>new Ft,_s=class{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??H()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(t)))do if(t=e.content.type,!e.deleted&&(t.constructor===lt||t.constructor===at)&&t._start!==null)e=t._start;else for(;e!==null;){let i=e.next;if(i!==null){e=i;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}},at=class s extends O{constructor(){super(),this._prelimContent=[]}get firstChild(){let e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return e.insert(0,this.toArray().map(t=>t instanceof O?t.clone():t)),e}get length(){return this.doc??H(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new _s(this,e)}querySelector(e){e=e.toUpperCase();let i=new _s(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e).next();return i.done?null:i.value}querySelectorAll(e){return e=e.toUpperCase(),ue(new _s(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){vi(this,e,new yi(this,t,e))}toString(){return Ta(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},i){let n=e.createDocumentFragment();return i!==void 0&&i._createAssociation(n,this),As(this,r=>{n.insertBefore(r.toDOM(e,t,i),null)}),n}insert(e,t){this.doc!==null?C(this.doc,i=>{Ua(i,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(this.doc!==null)C(this.doc,i=>{let n=e&&e instanceof O?e._item:e;di(i,this,n,t)});else{let i=this._prelimContent,n=e===null?0:i.findIndex(r=>r===e)+1;if(n===0&&e!==null)throw me("Reference item not found");i.splice(n,0,...t)}}delete(e,t=1){this.doc!==null?C(this.doc,i=>{Ca(i,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return va(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Ia(this,e)}slice(e=0,t=this.length){return ka(this,e,t)}forEach(e){As(this,e)}_write(e){e.writeTypeRef(Wu)}},Uu=s=>new at,lt=class s extends at{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){let e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){let e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((i,n)=>{this.setAttribute(n,i)}),this._prelimAttrs=null}_copy(){return new s(this.nodeName)}clone(){let e=new s(this.nodeName),t=this.getAttributes();return _o(t,(i,n)=>{e.setAttribute(n,i)}),e.insert(0,this.toArray().map(i=>i instanceof O?i.clone():i)),e}toString(){let e=this.getAttributes(),t=[],i=[];for(let a in e)i.push(a);i.sort();let n=i.length;for(let a=0;a<n;a++){let l=i[a];t.push(l+'="'+e[l]+'"')}let r=this.nodeName.toLocaleLowerCase(),o=t.length>0?" "+t.join(" "):"";return`<${r}${o}>${super.toString()}</${r}>`}removeAttribute(e){this.doc!==null?C(this.doc,t=>{fi(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){this.doc!==null?C(this.doc,i=>{er(i,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return tr(this,e)}hasAttribute(e){return Ea(this,e)}getAttributes(e){return e?Da(this,e):Na(this)}toDOM(e=document,t={},i){let n=e.createElement(this.nodeName),r=this.getAttributes();for(let o in r){let a=r[o];typeof a=="string"&&n.setAttribute(o,a)}return As(this,o=>{n.appendChild(o.toDOM(e,t,i))}),i!==void 0&&i._createAssociation(n,this),n}_write(e){e.writeTypeRef(zu),e.writeKey(this.nodeName)}},Cu=s=>new lt(s.readKey()),yi=class extends nt{constructor(e,t,i){super(e,i),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(n=>{n===null?this.childListChanged=!0:this.attributesChanged.add(n)})}},Cs=class s extends ot{constructor(e){super(),this.hookName=e}_copy(){return new s(this.hookName)}clone(){let e=new s(this.hookName);return this.forEach((t,i)=>{e.set(i,t)}),e}toDOM(e=document,t={},i){let n=t[this.hookName],r;return n!==void 0?r=n.createDom(this):r=document.createElement(this.hookName),r.setAttribute("data-yjs-hook",this.hookName),i!==void 0&&i._createAssociation(r,this),r}_write(e){e.writeTypeRef(Gu),e.writeKey(this.hookName)}},Nu=s=>new Cs(s.readKey()),wi=class s extends Ft{get nextSibling(){let e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){let e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new s}clone(){let e=new s;return e.applyDelta(this.toDelta()),e}toDOM(e=document,t,i){let n=e.createTextNode(this.toString());return i!==void 0&&i._createAssociation(n,this),n}toString(){return this.toDelta().map(e=>{let t=[];for(let n in e.attributes){let r=[];for(let o in e.attributes[n])r.push({key:o,value:e.attributes[n][o]});r.sort((o,a)=>o.key<a.key?-1:1),t.push({nodeName:n,attrs:r})}t.sort((n,r)=>n.nodeName<r.nodeName?-1:1);let i="";for(let n=0;n<t.length;n++){let r=t[n];i+=`<${r.nodeName}`;for(let o=0;o<r.attrs.length;o++){let a=r.attrs[o];i+=` ${a.key}="${a.value}"`}i+=">"}i+=e.insert;for(let n=t.length-1;n>=0;n--)i+=`</${t[n].nodeName}>`;return i}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(Ju)}},Eu=s=>new wi,Vt=class{constructor(e,t){this.id=e,this.length=t}get deleted(){throw de()}mergeWith(e){return!1}write(e,t,i){throw de()}integrate(e,t){throw de()}},Du=0,J=class extends Vt{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),la(e.doc.store,this)}write(e,t){e.writeInfo(Du),e.writeLen(this.length-t)}getMissing(e,t){return null}},ct=class s{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new s(this.content)}splice(e){throw de()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}},Lu=s=>new ct(s.readBuf()),jt=class s{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.len)}splice(e){let t=new s(this.len-e);return this.len=e,t}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){Ss(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}},$u=s=>new jt(s.readLen()),Fa=(s,e)=>new Ve({guid:s,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1}),ht=class s{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;let t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),e.meta!==null&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new s(Fa(this.doc.guid,this.opts))}splice(e){throw de()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}},Mu=s=>new ht(Fa(s.readString(),s.readAny())),Ne=class s{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new s(this.embed)}splice(e){throw de()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}},Ou=s=>new Ne(s.readJSON()),R=class s{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.key,this.value)}splice(e){throw de()}mergeWith(e){return!1}integrate(e,t){let i=t.parent;i._searchMarker=null,i._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}},Ru=s=>new R(s.readKey(),s.readJSON()),Ns=class s{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(e){let t=new s(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){let i=this.arr.length;e.writeLen(i-t);for(let n=t;n<i;n++){let r=this.arr[n];e.writeString(r===void 0?"undefined":JSON.stringify(r))}}getRef(){return 2}},Fu=s=>{let e=s.readLen(),t=[];for(let i=0;i<e;i++){let n=s.readString();n==="undefined"?t.push(void 0):t.push(JSON.parse(n))}return new Ns(t)},Vu=fs("node_env")==="development",Be=class s{constructor(e){this.arr=e,Vu&&pn(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(e){let t=new s(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){let i=this.arr.length;e.writeLen(i-t);for(let n=t;n<i;n++){let r=this.arr[n];e.writeAny(r)}}getRef(){return 8}},ju=s=>{let e=s.readLen(),t=[];for(let i=0;i<e;i++)t.push(s.readAny());return new Be(t)},fe=class s{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new s(this.str)}splice(e){let t=new s(this.str.slice(e));this.str=this.str.slice(0,e);let i=this.str.charCodeAt(e-1);return i>=55296&&i<=56319&&(this.str=this.str.slice(0,e-1)+"\uFFFD",t.str="\uFFFD"+t.str.slice(1)),t}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(t===0?this.str:this.str.slice(t))}getRef(){return 4}},Bu=s=>new fe(s.readString()),Pu=[ku,vu,Au,Cu,Uu,Nu,Eu],Ku=0,qu=1,Hu=2,zu=3,Wu=4,Gu=5,Ju=6,le=class s{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new s(this.type._copy())}splice(e){throw de()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;t!==null;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(i=>{i.deleted?i.id.clock<(e.beforeState.get(i.id.client)||0)&&e._mergeStructs.push(i):i.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;t!==null;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(i=>{for(;i!==null;)i.gc(e,!0),i=i.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}},Yu=s=>new le(Pu[s.readTypeRef()](s)),Fn=(s,e)=>{let t=e,i=0,n;do i>0&&(t=x(t.client,t.clock+i)),n=et(s,t),i=t.clock-n.id.clock,t=n.redone;while(t!==null&&n instanceof N);return{item:n,diff:i}},sr=(s,e)=>{for(;s!==null&&s.keep!==e;)s.keep=e,s=s.parent._item},_i=(s,e,t)=>{let{client:i,clock:n}=e.id,r=new N(x(i,n+t),e,x(i,n+t-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t));return e.deleted&&r.markDeleted(),e.keep&&(r.keep=!0),e.redone!==null&&(r.redone=x(e.redone.client,e.redone.clock+t)),e.right=r,r.right!==null&&(r.right.left=r),s._mergeStructs.push(r),r.parentSub!==null&&r.right===null&&r.parent._map.set(r.parentSub,r),e.length=t,r},ea=(s,e)=>Kr(s,t=>ut(t.deletions,e)),Va=(s,e,t,i,n,r)=>{let o=s.doc,a=o.store,l=o.clientID,c=e.redone;if(c!==null)return G(s,c);let h=e.parent._item,u=null,d;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!t.has(h)||Va(s,h,t,i,n,r)===null))return null;for(;h.redone!==null;)h=G(s,h.redone)}let f=h===null?e.parent:h.content.type;if(e.parentSub===null){for(u=e.left,d=e;u!==null;){let y=u;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:G(s,y.redone);if(y!==null&&y.parent._item===h){u=y;break}u=u.left}for(;d!==null;){let y=d;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:G(s,y.redone);if(y!==null&&y.parent._item===h){d=y;break}d=d.right}}else if(d=null,e.right&&!n){for(u=e;u!==null&&u.right!==null&&(u.right.redone||ut(i,u.right.id)||ea(r.undoStack,u.right.id)||ea(r.redoStack,u.right.id));)for(u=u.right;u.redone;)u=G(s,u.redone);if(u&&u.right!==null)return null}else u=f._map.get(e.parentSub)||null;let p=L(a,l),g=x(l,p),m=new N(g,u,u&&u.lastId,d,d&&d.id,f,e.parentSub,e.content.copy());return e.redone=g,sr(m,!0),m.integrate(s,0),m},N=class s extends Vt{constructor(e,t,i,n,r,o,a,l){super(e,l.getLength()),this.origin=i,this.left=t,this.right=n,this.rightOrigin=r,this.parent=o,this.parentSub=a,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(e){(this.info&8)>0!==e&&(this.info^=8)}get marker(){return(this.info&8)>0}get keep(){return(this.info&1)>0}set keep(e){this.keep!==e&&(this.info^=1)}get countable(){return(this.info&2)>0}get deleted(){return(this.info&4)>0}set deleted(e){this.deleted!==e&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=L(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=L(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ue&&this.id.client!==this.parent.client&&this.parent.clock>=L(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=$n(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=G(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===J||this.right&&this.right.constructor===J)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===s?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===s&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ue){let i=et(t,this.parent);i.constructor===J?this.parent=null:this.parent=i.content.type}return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=$n(e,e.doc.store,x(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let i=this.left,n;if(i!==null)n=i.right;else if(this.parentSub!==null)for(n=this.parent._map.get(this.parentSub)||null;n!==null&&n.left!==null;)n=n.left;else n=this.parent._start;let r=new Set,o=new Set;for(;n!==null&&n!==this.right;){if(o.add(n),r.add(n),Qe(this.origin,n.origin)){if(n.id.client<this.id.client)i=n,r.clear();else if(Qe(this.rightOrigin,n.rightOrigin))break}else if(n.origin!==null&&o.has(et(e.doc.store,n.origin)))r.has(et(e.doc.store,n.origin))||(i=n,r.clear());else break;n=n.right}this.left=i}if(this.left!==null){let i=this.left.right;this.right=i,this.left.right=this}else{let i;if(this.parentSub!==null)for(i=this.parent._map.get(this.parentSub)||null;i!==null&&i.left!==null;)i=i.left;else i=this.parent._start,this.parent._start=this;this.right=i}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),la(e.doc.store,this),this.content.integrate(e,this),Wo(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new J(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:x(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&Qe(e.origin,this.lastId)&&this.right===e&&Qe(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){let t=this.parent._searchMarker;return t&&t.forEach(i=>{i.p===e&&(i.p=this,!this.deleted&&this.countable&&(i.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){let t=this.parent;this.countable&&this.parentSub===null&&(t._length-=this.length),this.markDeleted(),Ss(e.deleteSet,this.id.client,this.id.clock,this.length),Wo(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw X();this.content.gc(e),t?iu(e,this,new J(this.id,this.length)):this.content=new jt(this.length)}write(e,t){let i=t>0?x(this.id.client,this.id.clock+t-1):this.origin,n=this.rightOrigin,r=this.parentSub,o=this.content.getRef()&31|(i===null?0:128)|(n===null?0:64)|(r===null?0:32);if(e.writeInfo(o),i!==null&&e.writeLeftID(i),n!==null&&e.writeRightID(n),i===null&&n===null){let a=this.parent;if(a._item!==void 0){let l=a._item;if(l===null){let c=Jn(a);e.writeParentInfo(!0),e.writeString(c)}else e.writeParentInfo(!1),e.writeLeftID(l.id)}else a.constructor===String?(e.writeParentInfo(!0),e.writeString(a)):a.constructor===Ue?(e.writeParentInfo(!1),e.writeLeftID(a)):X();r!==null&&e.writeString(r)}this.content.write(e,t)}},ja=(s,e)=>Xu[e&31](s),Xu=[()=>{X()},$u,Fu,Lu,Bu,Ou,Ru,Yu,ju,Mu,()=>{X()}],Zu=10,q=class extends Vt{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){X()}write(e,t){e.writeInfo(Zu),w(e.restEncoder,this.length-t)}getMissing(e,t){return null}},Ba=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},Pa="__ $YJS$ __";Ba[Pa]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Ba[Pa]=!0});var Ka,ir,Qu,nr,qa,Ha,dt,za=v(()=>{Zt();Bs();bn();hn();Ka=new Map,ir=class{constructor(e){this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&this.onmessage!==null&&this.onmessage({data:Uo(t.newValue||"")}),fo(this._onChange)}postMessage(e){Xs.setItem(this.room,Ao(Io(e)))}close(){po(this._onChange)}},Qu=typeof BroadcastChannel>"u"?ir:BroadcastChannel,nr=s=>P(Ka,s,()=>{let e=pe(),t=new Qu(s);return t.onmessage=i=>e.forEach(n=>n(i.data,"broadcastchannel")),{bc:t,subs:e}}),qa=(s,e)=>(nr(s).subs.add(e),e),Ha=(s,e)=>{let t=nr(s),i=t.subs.delete(e);return i&&t.subs.size===0&&(t.bc.close(),Ka.delete(s)),i},dt=(s,e,t=null)=>{let i=nr(s);i.bc.postMessage(e),i.subs.forEach(n=>n(e,t))}});var Wa,Ti,Ga,Ii,rr,td,Ja,Ya,sd,Xa,Za=v(()=>{rs();$t();Kt();Wa=0,Ti=1,Ga=2,Ii=(s,e)=>{w(s,Wa);let t=Gn(e);D(s,t)},rr=(s,e,t)=>{w(s,Ti),D(s,Hn(e,t))},td=(s,e,t)=>rr(e,t,B(s)),Ja=(s,e,t,i)=>{try{qn(e,B(s),t)}catch(n){i?.(n),console.error("Caught error while handling a Yjs update",n)}},Ya=(s,e)=>{w(s,Ga),D(s,e)},sd=Ja,Xa=(s,e,t,i,n)=>{let r=_(s);switch(r){case Wa:td(s,e,t);break;case Ti:Ja(s,t,i,n);break;case Ga:sd(s,t,i,n);break;default:throw new Error("Unknown message type")}return r}});var nd,Qa,el=v(()=>{$t();nd=0,Qa=(s,e,t)=>{switch(_(s)){case nd:t(e,oe(s))}}});var or,Ai,Ui,qt,tl,sl=v(()=>{rs();$t();cs();Ge();ts();ds();or=3e4,Ai=class extends We{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let t=ie();this.getLocalState()!==null&&or/2<=t-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let i=[];this.meta.forEach((n,r)=>{r!==this.clientID&&or<=t-n.lastUpdated&&this.states.has(r)&&i.push(r)}),i.length>0&&Ui(this,i,"timeout")},Q(or/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){let t=this.clientID,i=this.meta.get(t),n=i===void 0?0:i.clock+1,r=this.states.get(t);e===null?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:n,lastUpdated:ie()});let o=[],a=[],l=[],c=[];e===null?c.push(t):r==null?e!=null&&o.push(t):(a.push(t),Mt(r,e)||l.push(t)),(o.length>0||l.length>0||c.length>0)&&this.emit("change",[{added:o,updated:l,removed:c},"local"]),this.emit("update",[{added:o,updated:a,removed:c},"local"])}setLocalStateField(e,t){let i=this.getLocalState();i!==null&&this.setLocalState({...i,[e]:t})}getStates(){return this.states}},Ui=(s,e,t)=>{let i=[];for(let n=0;n<e.length;n++){let r=e[n];if(s.states.has(r)){if(s.states.delete(r),r===s.clientID){let o=s.meta.get(r);s.meta.set(r,{clock:o.clock+1,lastUpdated:ie()})}i.push(r)}}i.length>0&&(s.emit("change",[{added:[],updated:[],removed:i},t]),s.emit("update",[{added:[],updated:[],removed:i},t]))},qt=(s,e,t=s.states)=>{let i=e.length,n=$();w(n,i);for(let r=0;r<i;r++){let o=e[r],a=t.get(o)||null,l=s.meta.get(o).clock;w(n,o),w(n,l),ge(n,JSON.stringify(a))}return U(n)},tl=(s,e,t)=>{let i=M(e),n=ie(),r=[],o=[],a=[],l=[],c=_(i);for(let h=0;h<c;h++){let u=_(i),d=_(i),f=JSON.parse(oe(i)),p=s.meta.get(u),g=s.states.get(u),m=p===void 0?0:p.clock;(m<d||m===d&&f===null&&s.states.has(u))&&(f===null?u===s.clientID&&s.getLocalState()!=null?d++:s.states.delete(u):s.states.set(u,f),s.meta.set(u,{clock:d,lastUpdated:n}),p===void 0&&f!==null?r.push(u):p!==void 0&&f===null?l.push(u):f!==null&&(Mt(f,g)||a.push(u),o.push(u)))}(r.length>0||a.length>0||l.length>0)&&s.emit("change",[{added:r,updated:a,removed:l},t]),(r.length>0||o.length>0||l.length>0)&&s.emit("update",[{added:r,updated:o,removed:l},t])}});var il,nl=v(()=>{Qs();il=s=>bo(s,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&")});var cl={};Wi(cl,{WebsocketProvider:()=>lr,messageAuth:()=>ol,messageAwareness:()=>ft,messageQueryAwareness:()=>cr,messageSync:()=>Pe});var Pe,cr,ft,ol,Ds,rl,ld,al,ll,ar,lr,hl=v(()=>{za();cs();rs();$t();Za();el();sl();ts();Ge();nl();ps();Pe=0,cr=3,ft=1,ol=2,Ds=[];Ds[Pe]=(s,e,t,i,n)=>{w(s,Pe);let r=Xa(e,s,t.doc,t);i&&r===Ti&&!t.synced&&(t.synced=!0)};Ds[cr]=(s,e,t,i,n)=>{w(s,ft),D(s,qt(t.awareness,Array.from(t.awareness.getStates().keys())))};Ds[ft]=(s,e,t,i,n)=>{tl(t.awareness,B(e),t)};Ds[ol]=(s,e,t,i,n)=>{Qa(e,t.doc,(r,o)=>ld(t,o))};rl=3e4,ld=(s,e)=>console.warn(`Permission denied to access ${s.url}.
${e}`),al=(s,e,t)=>{let i=M(e),n=$(),r=_(i),o=s.messageHandlers[r];return o?o(n,i,s,t,r):console.error("Unable to compute message"),n},ll=s=>{if(s.shouldConnect&&s.ws===null){let e=new s._WS(s.url);e.binaryType="arraybuffer",s.ws=e,s.wsconnecting=!0,s.wsconnected=!1,s.synced=!1,e.onmessage=t=>{s.wsLastMessageReceived=ie();let i=al(s,new Uint8Array(t.data),!0);zs(i)>1&&e.send(U(i))},e.onerror=t=>{s.emit("connection-error",[t,s])},e.onclose=t=>{s.emit("connection-close",[t,s]),s.ws=null,s.wsconnecting=!1,s.wsconnected?(s.wsconnected=!1,s.synced=!1,Ui(s.awareness,Array.from(s.awareness.getStates().keys()).filter(i=>i!==s.doc.clientID),s),s.emit("status",[{status:"disconnected"}])):s.wsUnsuccessfulReconnects++,setTimeout(ll,St(zr(2,s.wsUnsuccessfulReconnects)*100,s.maxBackoffTime),s)},e.onopen=()=>{s.wsLastMessageReceived=ie(),s.wsconnecting=!1,s.wsconnected=!0,s.wsUnsuccessfulReconnects=0,s.emit("status",[{status:"connected"}]);let t=$();if(w(t,Pe),Ii(t,s.doc),e.send(U(t)),s.awareness.getLocalState()!==null){let i=$();w(i,ft),D(i,qt(s.awareness,[s.doc.clientID])),e.send(U(i))}},s.emit("status",[{status:"connecting"}])}},ar=(s,e)=>{let t=s.ws;s.wsconnected&&t&&t.readyState===t.OPEN&&t.send(e),s.bcconnected&&dt(s.bcChannel,e,s)},lr=class extends We{constructor(e,t,i,{connect:n=!0,awareness:r=new Ai(i),params:o={},WebSocketPolyfill:a=WebSocket,resyncInterval:l=-1,maxBackoffTime:c=2500,disableBc:h=!1}={}){for(super();e[e.length-1]==="/";)e=e.slice(0,e.length-1);let u=il(o);this.maxBackoffTime=c,this.bcChannel=e+"/"+t,this.url=e+"/"+t+(u.length===0?"":"?"+u),this.roomname=t,this.doc=i,this._WS=a,this.awareness=r,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Ds.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,l>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){let d=$();w(d,Pe),Ii(d,i),this.ws.send(U(d))}},l)),this._bcSubscriber=(d,f)=>{if(f!==this){let p=al(this,new Uint8Array(d),!1);zs(p)>1&&dt(this.bcChannel,U(p),this)}},this._updateHandler=(d,f)=>{if(f!==this){let p=$();w(p,Pe),Ya(p,d),ar(this,U(p))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:d,updated:f,removed:p},g)=>{let m=d.concat(f).concat(p),y=$();w(y,ft),D(y,qt(r,m)),ar(this,U(y))},this._exitHandler=()=>{Ui(this.awareness,[i.clientID],"app closed")},Ae&&typeof process<"u"&&process.on("exit",this._exitHandler),r.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&rl<ie()-this.wsLastMessageReceived&&this.ws.close()},rl/10),n&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),Ae&&typeof process<"u"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(qa(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);let e=$();w(e,Pe),Ii(e,this.doc),dt(this.bcChannel,U(e),this);let t=$();w(t,Pe),rr(t,this.doc),dt(this.bcChannel,U(t),this);let i=$();w(i,cr),dt(this.bcChannel,U(i),this);let n=$();w(n,ft),D(n,qt(this.awareness,[this.doc.clientID])),dt(this.bcChannel,U(n),this)}disconnectBc(){let e=$();w(e,ft),D(e,qt(this.awareness,[this.doc.clientID],new Map)),ar(this,U(e)),this.bcconnected&&(Ha(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(ll(this),this.connectBc())}}});var dl=E((lg,ul)=>{"use strict";function pt(s){if(!(this instanceof pt))return new pt(s);s=s||{},this.concurrency=s.concurrency||1/0,this.pending=0,this.jobs=[],this.cbs=[],this._done=hd.bind(this)}var cd=["push","unshift","splice"];cd.forEach(function(s){pt.prototype[s]=function(){var e=Array.prototype[s].apply(this.jobs,arguments);return this._run(),e}});Object.defineProperty(pt.prototype,"length",{get:function(){return this.pending+this.jobs.length}});pt.prototype._run=function(){if(this.pending!==this.concurrency){if(this.jobs.length){var s=this.jobs.shift();this.pending++,s(this._done),this._run()}if(this.pending===0)for(;this.cbs.length!==0;){var e=this.cbs.pop();process.nextTick(e)}}};pt.prototype.onDone=function(s){typeof s=="function"&&(this.cbs.push(s),this._run())};function hd(){this.pending--,this._run()}ul.exports=pt});var gt=E((cg,fl)=>{"use strict";fl.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}}});var Ni=E((hg,hr)=>{"use strict";var{EMPTY_BUFFER:ud}=gt();function pl(s,e){if(s.length===0)return ud;if(s.length===1)return s[0];let t=Buffer.allocUnsafe(e);for(var i=0,n=0;n<s.length;n++){let r=s[n];r.copy(t,i),i+=r.length}return t}function gl(s,e,t,i,n){for(var r=0;r<n;r++)t[i+r]=s[r]^e[r&3]}function ml(s,e){let t=s.length;for(var i=0;i<t;i++)s[i]^=e[i&3]}function yl(s){return s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}function Ci(s){if(Ci.readOnly=!0,Buffer.isBuffer(s))return s;var e;return s instanceof ArrayBuffer?e=Buffer.from(s):ArrayBuffer.isView(s)?e=dd(s):(e=Buffer.from(s),Ci.readOnly=!1),e}function dd(s){let e=Buffer.from(s.buffer);return s.byteLength!==s.buffer.byteLength?e.slice(s.byteOffset,s.byteOffset+s.byteLength):e}try{let s=require("bufferutil"),e=s.BufferUtil||s;hr.exports={concat:pl,mask(t,i,n,r,o){o<48?gl(t,i,n,r,o):e.mask(t,i,n,r,o)},toArrayBuffer:yl,toBuffer:Ci,unmask(t,i){t.length<32?ml(t,i):e.unmask(t,i)}}}catch{hr.exports={concat:pl,mask:gl,toArrayBuffer:yl,toBuffer:Ci,unmask:ml}}});var $s=E((ug,xl)=>{"use strict";var fd=dl(),Ls=require("zlib"),wl=Ni(),{kStatusCode:_l,NOOP:pd}=gt(),gd=Buffer.from([0,0,255,255]),md=Buffer.from([0]),Di=Symbol("permessage-deflate"),Ee=Symbol("total-length"),bl=Symbol("callback"),Ke=Symbol("buffers"),ur=Symbol("error"),Ei,dr=class{constructor(e,t,i){if(this._maxPayload=i|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ei){let n=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Ei=new fd({concurrency:n})}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate&&(this._deflate.close(),this._deflate=null)}acceptAsServer(e){let t=this._options,i=e.find(n=>!(t.serverNoContextTakeover===!1&&n.server_no_context_takeover||n.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>n.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!n.client_max_window_bits));if(!i)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(i.server_no_context_takeover=!0),t.clientNoContextTakeover&&(i.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(i.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?i.client_max_window_bits=t.clientMaxWindowBits:(i.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete i.client_max_window_bits,i}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(i=>{var n=t[i];if(n.length>1)throw new Error(`Parameter "${i}" must have only a single value`);if(n=n[0],i==="client_max_window_bits"){if(n!==!0){let r=+n;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${i}": ${n}`);n=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${i}": ${n}`)}else if(i==="server_max_window_bits"){let r=+n;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${i}": ${n}`);n=r}else if(i==="client_no_context_takeover"||i==="server_no_context_takeover"){if(n!==!0)throw new TypeError(`Invalid value for parameter "${i}": ${n}`)}else throw new Error(`Unknown parameter "${i}"`);t[i]=n})}),e}decompress(e,t,i){Ei.push(n=>{this._decompress(e,t,(r,o)=>{n(),i(r,o)})})}compress(e,t,i){Ei.push(n=>{this._compress(e,t,(r,o)=>{n(),i(r,o)})})}_decompress(e,t,i){let n=this._isServer?"client":"server";if(!this._inflate){let r=`${n}_max_window_bits`,o=typeof this.params[r]!="number"?Ls.Z_DEFAULT_WINDOWBITS:this.params[r];this._inflate=Ls.createInflateRaw(Object.assign({},this._options.zlibInflateOptions,{windowBits:o})),this._inflate[Di]=this,this._inflate[Ee]=0,this._inflate[Ke]=[],this._inflate.on("error",wd),this._inflate.on("data",Sl)}this._inflate[bl]=i,this._inflate.write(e),t&&this._inflate.write(gd),this._inflate.flush(()=>{let r=this._inflate[ur];if(r){this._inflate.close(),this._inflate=null,i(r);return}let o=wl.concat(this._inflate[Ke],this._inflate[Ee]);t&&this.params[`${n}_no_context_takeover`]?(this._inflate.close(),this._inflate=null):(this._inflate[Ee]=0,this._inflate[Ke]=[]),i(null,o)})}_compress(e,t,i){if(!e||e.length===0){process.nextTick(i,null,md);return}let n=this._isServer?"server":"client";if(!this._deflate){let r=`${n}_max_window_bits`,o=typeof this.params[r]!="number"?Ls.Z_DEFAULT_WINDOWBITS:this.params[r];this._deflate=Ls.createDeflateRaw(Object.assign({},this._options.zlibDeflateOptions,{windowBits:o})),this._deflate[Ee]=0,this._deflate[Ke]=[],this._deflate.on("error",pd),this._deflate.on("data",yd)}this._deflate.write(e),this._deflate.flush(Ls.Z_SYNC_FLUSH,()=>{if(this._deflate){var r=wl.concat(this._deflate[Ke],this._deflate[Ee]);t&&(r=r.slice(0,r.length-4)),t&&this.params[`${n}_no_context_takeover`]?(this._deflate.close(),this._deflate=null):(this._deflate[Ee]=0,this._deflate[Ke]=[]),i(null,r)}})}};xl.exports=dr;function yd(s){this[Ke].push(s),this[Ee]+=s.length}function Sl(s){if(this[Ee]+=s.length,this[Di]._maxPayload<1||this[Ee]<=this[Di]._maxPayload){this[Ke].push(s);return}this[ur]=new RangeError("Max payload size exceeded"),this[ur][_l]=1009,this.removeListener("data",Sl),this.reset()}function wd(s){this[Di]._inflate=null,s[_l]=1007,this[bl](s)}});var vl=E((dg,kl)=>{"use strict";var Ht=class{constructor(e,t){this.target=t,this.type=e}},fr=class extends Ht{constructor(e,t){super("message",t),this.data=e}},pr=class extends Ht{constructor(e,t,i){super("close",i),this.wasClean=i._closeFrameReceived&&i._closeFrameSent,this.reason=t,this.code=e}},gr=class extends Ht{constructor(e){super("open",e)}},mr=class extends Ht{constructor(e,t){super("error",t),this.message=e.message,this.error=e}},_d={addEventListener(s,e){if(typeof e!="function")return;function t(o){e.call(this,new fr(o,this))}function i(o,a){e.call(this,new pr(o,a,this))}function n(o){e.call(this,new mr(o,this))}function r(){e.call(this,new gr(this))}s==="message"?(t._listener=e,this.on(s,t)):s==="close"?(i._listener=e,this.on(s,i)):s==="error"?(n._listener=e,this.on(s,n)):s==="open"?(r._listener=e,this.on(s,r)):this.on(s,e)},removeEventListener(s,e){let t=this.listeners(s);for(var i=0;i<t.length;i++)(t[i]===e||t[i]._listener===e)&&this.removeListener(s,t[i])}};kl.exports=_d});var yr=E((fg,Tl)=>{"use strict";var Ms=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function xe(s,e,t){Object.prototype.hasOwnProperty.call(s,e)?s[e].push(t):s[e]=[t]}function bd(s){let e={};if(s===void 0||s==="")return e;for(var t={},i=!1,n=!1,r=!1,o,a,l=-1,c=-1,h=0;h<s.length;h++){let f=s.charCodeAt(h);if(o===void 0)if(c===-1&&Ms[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);let p=s.slice(l,c);f===44?(xe(e,p,t),t={}):o=p,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(c===-1&&Ms[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h),xe(t,s.slice(l,c),!0),f===44&&(xe(e,o,t),t={},o=void 0),l=c=-1}else if(f===61&&l!==-1&&c===-1)a=s.slice(l,h),l=c=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(n){if(Ms[f]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:i||(i=!0),n=!1}else if(r)if(Ms[f]===1)l===-1&&(l=h);else if(f===34&&l!==-1)r=!1,c=h;else if(f===92)n=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(f===34&&s.charCodeAt(h-1)===61)r=!0;else if(c===-1&&Ms[f]===1)l===-1&&(l=h);else if(l!==-1&&(f===32||f===9))c===-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);var u=s.slice(l,c);i&&(u=u.replace(/\\/g,""),i=!1),xe(t,a,u),f===44&&(xe(e,o,t),t={},o=void 0),a=void 0,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`)}if(l===-1||r)throw new SyntaxError("Unexpected end of input");c===-1&&(c=h);let d=s.slice(l,c);return o===void 0?xe(e,d,{}):(a===void 0?xe(t,d,!0):i?xe(t,a,d.replace(/\\/g,"")):xe(t,a,d),xe(e,o,t)),e}function Sd(s){return Object.keys(s).map(e=>{var t=s[e];return Array.isArray(t)||(t=[t]),t.map(i=>[e].concat(Object.keys(i).map(n=>{var r=i[n];return Array.isArray(r)||(r=[r]),r.map(o=>o===!0?n:`${n}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}Tl.exports={format:Sd,parse:bd}});var wr=E(Li=>{"use strict";try{let s=require("utf-8-validate");Li.isValidUTF8=typeof s=="object"?s.Validation.isValidUTF8:s}catch{Li.isValidUTF8=()=>!0}Li.isValidStatusCode=s=>s>=1e3&&s<=1013&&s!==1004&&s!==1005&&s!==1006||s>=3e3&&s<=4999});var xr=E((gg,El)=>{"use strict";var{Writable:xd}=require("stream"),Il=$s(),{BINARY_TYPES:kd,EMPTY_BUFFER:vd,kStatusCode:Td,kWebSocket:Id}=gt(),{concat:_r,toArrayBuffer:Ad,unmask:Ud}=Ni(),{isValidStatusCode:Cd,isValidUTF8:Al}=wr(),Os=0,Ul=1,Cl=2,Nl=3,br=4,Nd=5,Sr=class extends xd{constructor(e,t,i){super(),this._binaryType=e||kd[0],this[Id]=void 0,this._extensions=t||{},this._maxPayload=i|0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=Os,this._loop=!1}_write(e,t,i){if(this._opcode===8&&this._state==Os)return i();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(i)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let i=this._buffers[0];return this._buffers[0]=i.slice(e),i.slice(0,e)}let t=Buffer.allocUnsafe(e);do{let i=this._buffers[0];e>=i.length?this._buffers.shift().copy(t,t.length-e):(i.copy(t,t.length-e,0,e),this._buffers[0]=i.slice(e)),e-=i.length}while(e>0);return t}startLoop(e){var t;this._loop=!0;do switch(this._state){case Os:t=this.getInfo();break;case Ul:t=this.getPayloadLength16();break;case Cl:t=this.getPayloadLength64();break;case Nl:this.getMask();break;case br:t=this.getData(e);break;default:this._loop=!1;return}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let e=this.consume(2);if(e[0]&48)return this._loop=!1,z(RangeError,"RSV2 and RSV3 must be clear",!0,1002);let t=(e[0]&64)===64;if(t&&!this._extensions[Il.extensionName])return this._loop=!1,z(RangeError,"RSV1 must be clear",!0,1002);if(this._fin=(e[0]&128)===128,this._opcode=e[0]&15,this._payloadLength=e[1]&127,this._opcode===0){if(t)return this._loop=!1,z(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,z(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,z(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._compressed=t}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,z(RangeError,"FIN must be set",!0,1002);if(t)return this._loop=!1,z(RangeError,"RSV1 must be clear",!0,1002);if(this._payloadLength>125)return this._loop=!1,z(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002)}else return this._loop=!1,z(RangeError,`invalid opcode ${this._opcode}`,!0,1002);if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(e[1]&128)===128,this._payloadLength===126)this._state=Ul;else if(this._payloadLength===127)this._state=Cl;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,z(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009)):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,z(RangeError,"Max payload size exceeded",!1,1009);this._masked?this._state=Nl:this._state=br}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=br}getData(e){var t=vd;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&Ud(t,this._mask)}if(this._opcode>7)return this.controlMessage(t);if(this._compressed){this._state=Nd,this.decompress(t,e);return}return t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage()}decompress(e,t){this._extensions[Il.extensionName].decompress(e,this._fin,(n,r)=>{if(n)return t(n);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(z(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(r)}let o=this.dataMessage();if(o)return t(o);this.startLoop(t)})}dataMessage(){if(this._fin){let t=this._messageLength,i=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){var e;this._binaryType==="nodebuffer"?e=_r(i,t):this._binaryType==="arraybuffer"?e=Ad(_r(i,t)):e=i,this.emit("message",e)}else{let n=_r(i,t);if(!Al(n))return this._loop=!1,z(Error,"invalid UTF-8 sequence",!0,1007);this.emit("message",n.toString())}}this._state=Os}controlMessage(e){if(this._opcode===8)if(this._loop=!1,e.length===0)this.emit("conclude",1005,""),this.end();else{if(e.length===1)return z(RangeError,"invalid payload length 1",!0,1002);{let t=e.readUInt16BE(0);if(!Cd(t))return z(RangeError,`invalid status code ${t}`,!0,1002);let i=e.slice(2);if(!Al(i))return z(Error,"invalid UTF-8 sequence",!0,1007);this.emit("conclude",t,i.toString()),this.end()}}else this._opcode===9?this.emit("ping",e):this.emit("pong",e);this._state=Os}};El.exports=Sr;function z(s,e,t,i){let n=new s(t?`Invalid WebSocket frame: ${e}`:e);return Error.captureStackTrace(n,z),n[Td]=i,n}});var vr=E((mg,$l)=>{"use strict";var{randomBytes:Ed}=require("crypto"),Dl=$s(),{EMPTY_BUFFER:Dd}=gt(),{isValidStatusCode:Ld}=wr(),{mask:Ll,toBuffer:De}=Ni(),kr=class s{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let i=t.mask&&t.readOnly;var n=t.mask?6:2,r=e.length;e.length>=65536?(n+=8,r=127):e.length>125&&(n+=2,r=126);let o=Buffer.allocUnsafe(i?e.length+n:n);if(o[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(o[0]|=64),o[1]=r,r===126?o.writeUInt16BE(e.length,2):r===127&&(o.writeUInt32BE(0,2),o.writeUInt32BE(e.length,6)),!t.mask)return[o,e];let a=Ed(4);return o[1]|=128,o[n-4]=a[0],o[n-3]=a[1],o[n-2]=a[2],o[n-1]=a[3],i?(Ll(e,a,o,n,e.length),[o]):(Ll(e,a,e,0,e.length),[o,e])}close(e,t,i,n){var r;if(e===void 0)r=Dd;else{if(typeof e!="number"||!Ld(e))throw new TypeError("First argument must be a valid error code number");t===void 0||t===""?(r=Buffer.allocUnsafe(2),r.writeUInt16BE(e,0)):(r=Buffer.allocUnsafe(2+Buffer.byteLength(t)),r.writeUInt16BE(e,0),r.write(t,2))}this._deflating?this.enqueue([this.doClose,r,i,n]):this.doClose(r,i,n)}doClose(e,t,i){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),i)}ping(e,t,i){let n=De(e);this._deflating?this.enqueue([this.doPing,n,t,De.readOnly,i]):this.doPing(n,t,De.readOnly,i)}doPing(e,t,i,n){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:i}),n)}pong(e,t,i){let n=De(e);this._deflating?this.enqueue([this.doPong,n,t,De.readOnly,i]):this.doPong(n,t,De.readOnly,i)}doPong(e,t,i,n){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:i}),n)}send(e,t,i){let n=De(e),r=this._extensions[Dl.extensionName];var o=t.binary?2:1,a=t.compress;if(this._firstFragment?(this._firstFragment=!1,a&&r&&(a=n.length>=r._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),r){let l={fin:t.fin,rsv1:a,opcode:o,mask:t.mask,readOnly:De.readOnly};this._deflating?this.enqueue([this.dispatch,n,this._compress,l,i]):this.dispatch(n,this._compress,l,i)}else this.sendFrame(s.frame(n,{fin:t.fin,rsv1:!1,opcode:o,mask:t.mask,readOnly:De.readOnly}),i)}dispatch(e,t,i,n){if(!t){this.sendFrame(s.frame(e,i),n);return}let r=this._extensions[Dl.extensionName];this._deflating=!0,r.compress(e,i.fin,(o,a)=>{this._deflating=!1,i.readOnly=!1,this.sendFrame(s.frame(a,i),n),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[1].length,e[0].apply(this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};$l.exports=kr});var Ar=E((yg,Hl)=>{"use strict";var $d=require("events"),Ml=require("crypto"),Md=require("https"),Od=require("http"),Rd=require("net"),Fd=require("tls"),zt=require("url"),qe=$s(),Vl=vl(),Ol=yr(),Vd=xr(),jd=vr(),{BINARY_TYPES:Rl,EMPTY_BUFFER:Tr,GUID:Bd,kStatusCode:Pd,kWebSocket:te,NOOP:jl}=gt(),$i=["CONNECTING","OPEN","CLOSING","CLOSED"],Ir=[8,13],Kd=30*1e3,se=class s extends $d{constructor(e,t,i){super(),this.readyState=s.CONNECTING,this.protocol="",this._binaryType=Rl[0],this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._closeCode=1006,this._extensions={},this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):typeof t=="object"&&t!==null&&(i=t,t=void 0),Bl(this,e,t,i)):this._isServer=!0}get CONNECTING(){return s.CONNECTING}get CLOSING(){return s.CLOSING}get CLOSED(){return s.CLOSED}get OPEN(){return s.OPEN}get binaryType(){return this._binaryType}set binaryType(e){Rl.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?(this._socket.bufferSize||0)+this._sender._bufferedBytes:0}get extensions(){return Object.keys(this._extensions).join()}setSocket(e,t,i){let n=new Vd(this._binaryType,this._extensions,i);this._sender=new jd(e,this._extensions),this._receiver=n,this._socket=e,n[te]=this,e[te]=this,n.on("conclude",zd),n.on("drain",Wd),n.on("error",Gd),n.on("message",Jd),n.on("ping",Yd),n.on("pong",Xd),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Pl),e.on("data",Mi),e.on("end",Kl),e.on("error",ql),this.readyState=s.OPEN,this.emit("open")}emitClose(){if(this.readyState=s.CLOSED,!this._socket){this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[qe.extensionName]&&this._extensions[qe.extensionName].cleanup(),this._receiver.removeAllListeners(),this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Le(this,this._req,"WebSocket was closed before the connection was established");if(this.readyState===s.CLOSING){this._closeFrameSent&&this._closeFrameReceived&&this._socket.end();return}this.readyState=s.CLOSING,this._sender.close(e,t,!this._isServer,i=>{i||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),Kd)}}ping(e,t,i){if(typeof e=="function"?(i=e,e=t=void 0):typeof t=="function"&&(i=t,t=void 0),this.readyState!==s.OPEN){let n=new Error(`WebSocket is not open: readyState ${this.readyState} (${$i[this.readyState]})`);if(i)return i(n);throw n}typeof e=="number"&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.ping(e||Tr,t,i)}pong(e,t,i){if(typeof e=="function"?(i=e,e=t=void 0):typeof t=="function"&&(i=t,t=void 0),this.readyState!==s.OPEN){let n=new Error(`WebSocket is not open: readyState ${this.readyState} (${$i[this.readyState]})`);if(i)return i(n);throw n}typeof e=="number"&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.pong(e||Tr,t,i)}send(e,t,i){if(typeof t=="function"&&(i=t,t={}),this.readyState!==s.OPEN){let r=new Error(`WebSocket is not open: readyState ${this.readyState} (${$i[this.readyState]})`);if(i)return i(r);throw r}typeof e=="number"&&(e=e.toString());let n=Object.assign({binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0},t);this._extensions[qe.extensionName]||(n.compress=!1),this._sender.send(e||Tr,n,i)}terminate(){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Le(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this.readyState=s.CLOSING,this._socket.destroy())}}};$i.forEach((s,e)=>{se[s]=e});["open","error","close","message"].forEach(s=>{Object.defineProperty(se.prototype,`on${s}`,{get(){let e=this.listeners(s);for(var t=0;t<e.length;t++)if(e[t]._listener)return e[t]._listener},set(e){let t=this.listeners(s);for(var i=0;i<t.length;i++)t[i]._listener&&this.removeListener(s,t[i]);this.addEventListener(s,e)}})});se.prototype.addEventListener=Vl.addEventListener;se.prototype.removeEventListener=Vl.removeEventListener;Hl.exports=se;function Bl(s,e,t,i){let n=Object.assign({protocolVersion:Ir[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10},i,{createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,auth:void 0,host:void 0,path:void 0,port:void 0});if(!Ir.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${Ir.join(", ")})`);var r;typeof e=="object"&&e.href!==void 0?(r=e,s.url=e.href):(r=zt.URL?new zt.URL(e):zt.parse(e),s.url=e);let o=r.protocol==="ws+unix:";if(!r.host&&(!o||!r.pathname))throw new Error(`Invalid URL: ${s.url}`);let a=r.protocol==="wss:"||r.protocol==="https:",l=a?443:80,c=Ml.randomBytes(16).toString("base64"),h=a?Md.get:Od.get,u=r.search?`${r.pathname||"/"}${r.search}`:r.pathname||"/";var d;if(n.createConnection=a?Hd:qd,n.defaultPort=n.defaultPort||l,n.port=r.port||l,n.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,n.headers=Object.assign({"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":c,Connection:"Upgrade",Upgrade:"websocket"},n.headers),n.path=u,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(d=new qe(n.perMessageDeflate!==!0?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=Ol.format({[qe.extensionName]:d.offer()})),t&&(n.headers["Sec-WebSocket-Protocol"]=t),n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),r.auth?n.auth=r.auth:(r.username||r.password)&&(n.auth=`${r.username}:${r.password}`),o){let p=u.split(":");n.socketPath=p[0],n.path=p[1]}var f=s._req=h(n);n.timeout&&f.on("timeout",()=>{Le(s,f,"Opening handshake has timed out")}),f.on("error",p=>{s._req.aborted||(f=s._req=null,s.readyState=se.CLOSING,s.emit("error",p),s.emitClose())}),f.on("response",p=>{let g=p.headers.location,m=p.statusCode;if(g&&n.followRedirects&&m>=300&&m<400){if(++s._redirects>n.maxRedirects){Le(s,f,"Maximum redirects exceeded");return}f.abort();let y=zt.URL?new zt.URL(g,e):zt.resolve(e,g);Bl(s,y,t,i)}else s.emit("unexpected-response",f,p)||Le(s,f,`Unexpected server response: ${p.statusCode}`)}),f.on("upgrade",(p,g,m)=>{if(s.emit("upgrade",p),s.readyState!==se.CONNECTING)return;f=s._req=null;let y=Ml.createHash("sha1").update(c+Bd).digest("base64");if(p.headers["sec-websocket-accept"]!==y){Le(s,g,"Invalid Sec-WebSocket-Accept header");return}let b=p.headers["sec-websocket-protocol"],S=(t||"").split(/, */);var k;if(!t&&b?k="Server sent a subprotocol but none was requested":t&&!b?k="Server sent no subprotocol":b&&!S.includes(b)&&(k="Server sent an invalid subprotocol"),k){Le(s,g,k);return}if(b&&(s.protocol=b),d)try{let T=Ol.parse(p.headers["sec-websocket-extensions"]);T[qe.extensionName]&&(d.accept(T[qe.extensionName]),s._extensions[qe.extensionName]=d)}catch{Le(s,g,"Invalid Sec-WebSocket-Extensions header");return}s.setSocket(g,m,n.maxPayload)})}function qd(s){return s.protocolVersion&&(s.path=s.socketPath),Rd.connect(s)}function Hd(s){return s.path=void 0,s.servername=s.servername||s.host,Fd.connect(s)}function Le(s,e,t){s.readyState=se.CLOSING;let i=new Error(t);Error.captureStackTrace(i,Le),e.setHeader?(e.abort(),e.once("abort",s.emitClose.bind(s)),s.emit("error",i)):(e.destroy(i),e.once("error",s.emit.bind(s,"error")),e.once("close",s.emitClose.bind(s)))}function zd(s,e){let t=this[te];t._socket.removeListener("data",Mi),t._socket.resume(),t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=s,s===1005?t.close():t.close(s,e)}function Wd(){this[te]._socket.resume()}function Gd(s){let e=this[te];e._socket.removeListener("data",Mi),e.readyState=se.CLOSING,e._closeCode=s[Pd],e.emit("error",s),e._socket.destroy()}function Fl(){this[te].emitClose()}function Jd(s){this[te].emit("message",s)}function Yd(s){let e=this[te];e.pong(s,!e._isServer,jl),e.emit("ping",s)}function Xd(s){this[te].emit("pong",s)}function Pl(){let s=this[te];this.removeListener("close",Pl),this.removeListener("end",Kl),s.readyState=se.CLOSING,s._socket.read(),s._receiver.end(),this.removeListener("data",Mi),this[te]=void 0,clearTimeout(s._closeTimer),s._receiver._writableState.finished||s._receiver._writableState.errorEmitted?s.emitClose():(s._receiver.on("error",Fl),s._receiver.on("finish",Fl))}function Mi(s){this[te]._receiver.write(s)||this.pause()}function Kl(){let s=this[te];s.readyState=se.CLOSING,s._receiver.end(),this.end()}function ql(){let s=this[te];this.removeListener("error",ql),this.on("error",jl),s.readyState=se.CLOSING,this.destroy()}});var Gl=E((wg,Wl)=>{"use strict";var Zd=require("events"),Qd=require("crypto"),Ri=require("http"),mt=$s(),zl=yr(),ef=Ar(),{GUID:tf}=gt(),sf=/^[+/0-9A-Za-z]{22}==$/,Ur=class extends Zd{constructor(e,t){if(super(),e=Object.assign({maxPayload:100*1024*1024,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null},e),e.port==null&&!e.server&&!e.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');e.port!=null?(this._server=Ri.createServer((i,n)=>{let r=Ri.STATUS_CODES[426];n.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),n.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server&&(this._removeListeners=nf(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,n,r)=>{this.handleUpgrade(i,n,r,o=>{this.emit("connection",o,i)})}})),e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this.clients)for(let i of this.clients)i.terminate();let t=this._server;if(t&&(this._removeListeners(),this._removeListeners=this._server=null,this.options.port!=null)){t.close(()=>this.emit("close"));return}process.nextTick(rf,this)}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,i,n){t.on("error",Cr);let r=e.headers["sec-websocket-key"]!==void 0?e.headers["sec-websocket-key"].trim():!1,o=e.headers.upgrade,a=+e.headers["sec-websocket-version"],l={};if(e.method!=="GET"||o===void 0||o.toLowerCase()!=="websocket"||!r||!sf.test(r)||a!==8&&a!==13||!this.shouldHandle(e))return Oi(t,400);if(this.options.perMessageDeflate){let c=new mt(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let h=zl.parse(e.headers["sec-websocket-extensions"]);h[mt.extensionName]&&(c.accept(h[mt.extensionName]),l[mt.extensionName]=c)}catch{return Oi(t,400)}}if(this.options.verifyClient){let c={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.connection.authorized||e.connection.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(c,(h,u,d,f)=>{if(!h)return Oi(t,u||401,d,f);this.completeUpgrade(r,l,e,t,i,n)});return}if(!this.options.verifyClient(c))return Oi(t,401)}this.completeUpgrade(r,l,e,t,i,n)}completeUpgrade(e,t,i,n,r,o){if(!n.readable||!n.writable)return n.destroy();let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Qd.createHash("sha1").update(e+tf).digest("base64")}`],c=new ef(null);var h=i.headers["sec-websocket-protocol"];if(h&&(h=h.split(",").map(of),this.options.handleProtocols?h=this.options.handleProtocols(h,i):h=h[0],h&&(l.push(`Sec-WebSocket-Protocol: ${h}`),c.protocol=h)),t[mt.extensionName]){let u=t[mt.extensionName].params,d=zl.format({[mt.extensionName]:[u]});l.push(`Sec-WebSocket-Extensions: ${d}`),c._extensions=t}this.emit("headers",l,i),n.write(l.concat(`\r
`).join(`\r
`)),n.removeListener("error",Cr),c.setSocket(n,r,this.options.maxPayload),this.clients&&(this.clients.add(c),c.on("close",()=>this.clients.delete(c))),o(c)}};Wl.exports=Ur;function nf(s,e){for(let t of Object.keys(e))s.on(t,e[t]);return function(){for(let i of Object.keys(e))s.removeListener(i,e[i])}}function rf(s){s.emit("close")}function Cr(){this.destroy()}function Oi(s,e,t,i){s.writable&&(t=t||Ri.STATUS_CODES[e],i=Object.assign({Connection:"close","Content-type":"text/html","Content-Length":Buffer.byteLength(t)},i),s.write(`HTTP/1.1 ${e} ${Ri.STATUS_CODES[e]}\r
`+Object.keys(i).map(n=>`${n}: ${i[n]}`).join(`\r
`)+`\r
\r
`+t)),s.removeListener("error",Cr),s.destroy()}function of(s){return s.trim()}});var Yl=E((_g,Jl)=>{"use strict";var Fi=Ar();Fi.Server=Gl();Fi.Receiver=xr();Fi.Sender=vr();Jl.exports=Fi});var Zl=E((bg,Xl)=>{"use strict";var af=require("http"),Nr=class{constructor(e=2019,t=null){this.port=e,this.host="127.0.0.1",this.logger=t}async ping(){try{let e=await this.get("/");return e&&e.status==="ok"}catch{return!1}}async getProjectInfo(){return this.get("/")}async getItems(e={}){let t=new URLSearchParams;e.q&&t.set("q",e.q),e.tag&&t.set("tag",e.tag),e.sort&&t.set("sort",e.sort);let i=t.toString();return this.get(`/project/items${i?"?"+i:""}`)}async getItem(e){return this.get(`/project/items/${e}`)}async getPhotos(e){return this.get(`/project/items/${e}/photos`)}async getItemTags(e){return this.get(`/project/items/${e}/tags`)}async getMetadata(e){return this.get(`/project/data/${e}`)}async saveMetadata(e,t){return this.postJson(`/project/data/${e}`,t)}async getTags(){return this.get("/project/tags")}async createTag(e,t=null,i=null){return this.post("/project/tags",{name:e,color:t,item:i})}async deleteTags(e){let t=new URLSearchParams;for(let i of e)t.append("id",i);return this.request("DELETE",`/project/tags?${t.toString()}`)}async addTagsToItem(e,t){return this.post(`/project/items/${e}/tags`,{tag:t})}async removeTagsFromItem(e,t){let i=new URLSearchParams;for(let n of t)i.append("tag",n);return this.request("DELETE",`/project/items/${e}/tags?${i.toString()}`)}async getNote(e,t="html"){return this.get(`/project/notes/${e}?format=${t}`)}async createNote(e){return this.postJson("/project/notes",e)}async updateNote(e,t){return this.putJson(`/project/notes/${e}`,t)}async deleteNote(e){return this.request("DELETE",`/project/notes/${e}`)}async getPhoto(e){return this.get(`/project/photos/${e}`)}async getSelection(e){return this.get(`/project/selections/${e}`)}async createSelection(e){return this.postJson("/project/selections",e)}async updateSelection(e,t){return this.putJson(`/project/selections/${e}`,t)}async deleteSelection(e){return this.request("DELETE",`/project/selections/${e}`)}async getTranscription(e,t="json"){return this.get(`/project/transcriptions/${e}?format=${t}`)}async getItemTranscriptions(e){return this.get(`/project/items/${e}/transcriptions`)}async createTranscription(e){return this.postJson("/project/transcriptions",e)}async updateTranscription(e,t){return this.putJson(`/project/transcriptions/${e}`,t)}async deleteTranscription(e){return this.request("DELETE",`/project/transcriptions/${e}`)}async getLists(){return this.get("/project/lists")}async getList(e){return this.get(`/project/lists/${e}`)}async getListItems(e){return this.get(`/project/lists/${e}/items`)}async addItemsToList(e,t){return this.post(`/project/lists/${e}/items`,{item:t})}async removeItemsFromList(e,t){let i=new URLSearchParams;for(let n of t)i.append("item",n);return this.request("DELETE",`/project/lists/${e}/items?${i.toString()}`)}async importItems(e){if(e.file)throw new Error("File path import is blocked for security \u2014 use data parameter with JSON-LD");let t=new URLSearchParams;return e.data&&t.set("data",JSON.stringify(e.data)),e.list&&t.set("list",e.list),this.request("POST","/project/import",t.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async getVersion(){return this.get("/version")}async get(e){return this.request("GET",e)}async post(e,t){let i=new URLSearchParams;for(let[n,r]of Object.entries(t))if(r!=null)if(Array.isArray(r))for(let o of r)i.append(n,o);else i.set(n,r);return this.request("POST",e,i.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async postJson(e,t){return this.request("POST",e,JSON.stringify(t),{"Content-Type":"application/json"})}async putJson(e,t){return this.request("PUT",e,JSON.stringify(t),{"Content-Type":"application/json"})}request(e,t,i=null,n={},r=3){return this._doRequest(e,t,i,n,r,0)}_doRequest(e,t,i,n,r,o){return new Promise((a,l)=>{let c={hostname:this.host,port:this.port,path:t,method:e,headers:{Accept:"application/json",...n}};i&&(c.headers["Content-Length"]=Buffer.byteLength(i));let h=af.request(c,u=>{let d=[];u.on("data",f=>d.push(f)),u.on("end",()=>{let f=Buffer.concat(d).toString();if(u.statusCode>=400){let p=new Error(`API ${e} ${t}: ${u.statusCode}`);if(p.status=u.statusCode,p.body=f,p.sqliteBusy=f.includes("SQLITE_BUSY"),p.sqliteBusy&&r>0){let g=Math.min(1e3*Math.pow(2,o),8e3);this.logger&&this.logger.debug(`SQLITE_BUSY on ${e} ${t}, retry ${o+1} in ${g}ms`),setTimeout(()=>{this._doRequest(e,t,i,n,r-1,o+1).then(a,l)},g);return}l(p);return}if(!f||f.length===0){a(null);return}try{a(JSON.parse(f))}catch{l(new Error(`API ${e} ${t}: invalid JSON response`))}})});h.on("error",u=>{this.logger&&this.logger.debug(`API request failed: ${e} ${t}`,{error:u.message}),l(u)}),h.setTimeout(1e4,()=>{h.destroy(new Error(`API timeout: ${e} ${t}`))}),i&&h.write(i),h.end()})}};Xl.exports={ApiClient:Nr}});var ec=E((Sg,Ql)=>{"use strict";var Er=class{constructor(e,t){this.store=e,this.logger=t,this._suppressChangeDetection=!1}_getState(){return this.store.getState()}getAllItems(){let{items:e,photos:t}=this._getState(),i=[];for(let n of Object.keys(e)){let r=e[n];i.push({id:Number(n),template:r.template,photos:r.photos||[],lists:r.lists||[],tags:r.tags||[]})}return i}getItemFull(e){return this._buildItemFull(this._getState(),e)}getAllItemsFull(){let e=this._getState(),t=[];for(let i of Object.keys(e.items)){let n=this._buildItemFull(e,Number(i));n&&t.push(n)}return t}_buildItemFull(e,t){let i=e.items[t];if(!i)return null;let n={"@id":t,template:i.template,lists:i.lists||[]},r=e.metadata[t];if(r)for(let[l,c]of Object.entries(r))l!=="id"&&(typeof c=="object"&&c!==null?n[l]={"@value":c.text||"","@type":c.type||""}:c!=null&&(n[l]=c));let o=i.tags||[];n.tag=[];for(let l of o){let c=e.tags[l];c&&n.tag.push({id:l,name:c.name,color:c.color||null})}n.photo=[];let a=i.photos||[];for(let l of a){let c=e.photos[l];if(!c)continue;let h={"@id":l,checksum:c.checksum,note:[],selection:[],transcription:[],metadata:null},u=e.metadata[l];if(u){h.metadata={};for(let[d,f]of Object.entries(u))d!=="id"&&(h.metadata[d]=f)}for(let d of c.notes||[]){let f=e.notes[d];if(!f)continue;let p=this._noteStateToHtml(f);h.note.push({"@id":d,text:f.text||"",html:p,language:f.language||null,photo:l})}if(e.transcriptions)for(let d of c.transcriptions||[]){let f=e.transcriptions[d];f&&h.transcription.push(f)}for(let d of c.selections||[]){let f=e.selections[d];if(!f)continue;let p={"@id":d,x:f.x,y:f.y,width:f.width,height:f.height,angle:f.angle||0,note:[],metadata:null,transcription:[]},g=e.metadata[d];if(g){p.metadata={};for(let[m,y]of Object.entries(g))m!=="id"&&(p.metadata[m]=y)}for(let m of f.notes||[]){let y=e.notes[m];if(!y)continue;let b=this._noteStateToHtml(y);p.note.push({"@id":m,text:y.text||"",html:b,language:y.language||null,selection:d})}if(e.transcriptions)for(let m of f.transcriptions||[]){let y=e.transcriptions[m];y&&p.transcription.push(y)}h.selection.push(p)}n.photo.push(h)}return n}getAllTags(){let{tags:e}=this._getState();return Object.values(e||{}).map(t=>({id:t.id,name:t.name,color:t.color||null}))}getAllLists(){let{lists:e}=this._getState();return Object.values(e||{}).map(t=>({id:t.id,name:t.name,parent:t.parent||null}))}ping(){return!!this.store}async createSelection({photo:e,x:t,y:i,width:n,height:r,angle:o}){let a=new Set(Object.keys(this._getState().selections)),l=this.store.dispatch({type:"selection.create",payload:{photo:e,x:t,y:i,width:n,height:r,angle:o||0},meta:{cmd:"project"}});await this._waitForAction(l);let c=this._getState(),h=Object.keys(c.selections),u=[];for(let d of h)if(!a.has(d)){let f=c.selections[d];f&&f.photo===e&&u.push(d)}if(u.length>0){let d=u[u.length-1];return{id:Number(d),"@id":Number(d)}}return null}async createNote({photo:e,selection:t,html:i,language:n}){if(!e&&!t)return this.logger.warn("createNote: no photo or selection \u2014 skipping"),null;let r=new Set(Object.keys(this._getState().notes)),o={text:i||""};e&&(o.photo=e),t&&(o.selection=t),n&&(o.language=n);let a=this.store.dispatch({type:"note.create",payload:o,meta:{cmd:"project",history:"add"}});await this._waitForAction(a);let l=this._getState(),c=Object.keys(l.notes),h=[];for(let u of c)if(!r.has(u)){let d=l.notes[u];d&&(e&&d.photo===e||t&&d.selection===t)&&h.push(u)}if(h.length>0){let u=h[h.length-1];return{id:Number(u),"@id":Number(u)}}for(let u of c)if(!r.has(u))return{id:Number(u),"@id":Number(u)};return null}async updateNote(e,{html:t,language:i}){let r=this._getState().notes[e];if(!r)throw new Error(`Note ${e} not found in store`);let o=r.photo||void 0,a=r.selection||void 0,l=i||r.language||null,c=this._noteStateToHtml(r);try{await this.deleteNote(e)}catch{}let h;try{h=await this.createNote({photo:o,selection:a,html:t,language:l})}catch(u){this.logger.warn(`updateNote: create threw after delete for note ${e}`,{error:u.message});try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(d){throw this.logger.warn(`updateNote: restore also failed for note ${e}`,{error:d.message}),u}return h}if(!h){this.logger.warn(`updateNote: create returned null after delete, restoring original for note ${e}`);try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(u){throw this.logger.warn(`updateNote: restore also failed for note ${e}`,{error:u.message}),new Error(`updateNote: note ${e} deleted but both create and restore failed`)}if(!h)throw new Error(`updateNote: note ${e} deleted but both create and restore returned null`)}return h}async deleteNote(e){let t=this.store.dispatch({type:"note.delete",payload:[e],meta:{cmd:"project",history:"add"}});await this._waitForAction(t)}async addItemsToList(e,t){let i=this.store.dispatch({type:"list.item.add",payload:{id:e,items:Array.isArray(t)?t:[t]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}async removeItemsFromList(e,t){let i=this.store.dispatch({type:"list.item.remove",payload:{id:e,items:Array.isArray(t)?t:[t]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}subscribe(e){this._prevState=this._getState();let t=["items","photos","selections","notes","metadata","tags","lists"];return this.store.subscribe(()=>{if(this._suppressChangeDetection)return;let i=this._getState(),n=!1;for(let r of t)if(i[r]!==this._prevState[r]){n=!0;break}if(this._prevState=i,n)try{e()}catch(r){this.logger.warn(`subscribe callback error: ${String(r.message||r)}`)}})}suppressChanges(){this._suppressChangeDetection=!0}resumeChanges(){this._prevState=this._getState(),this._suppressChangeDetection=!1}_waitForAction(e,t=15e3){if(!e||!e.meta||!e.meta.seq)return Promise.resolve();let i=e.meta.seq;return new Promise((n,r)=>{let o=!1,a=setTimeout(()=>{o||(o=!0,l(),r(new Error(`waitForAction: ${e.type} seq=${i} timed out after ${t}ms`)))},t),l=this.store.subscribe(()=>{if(o)return;let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),n())});if(!o){let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),n())}})}_noteStateToHtml(e){return e.html?e.html:e.state&&e.state.doc?this._renderDoc(e.state.doc):e.text?`<p>${this._esc(e.text)}</p>`:""}_renderDoc(e){if(!e||!e.content||(typeof e.toJSON=="function"&&(e=e.toJSON()),!e.content))return"";let t=e.content;if(!Array.isArray(t))if(Array.isArray(t.content))t=t.content;else return"";return t.map(i=>this._renderNode(i)).join("")}_renderNode(e){if(!e)return"";typeof e.toJSON=="function"&&(e=e.toJSON());let t="";if(e.content){let n=e.content;Array.isArray(n)||(Array.isArray(n.content)?n=n.content:n=[]),t=n.map(r=>this._renderNode(r)).join("")}switch(typeof e.type=="string"?e.type:e.type&&e.type.name||""){case"paragraph":{let n=e.attrs&&e.attrs.align;return n&&n!=="left"?`<p style="text-align: ${n==="right"?"end":n}">${t}</p>`:`<p>${t}</p>`}case"blockquote":return`<blockquote>${t}</blockquote>`;case"ordered_list":return`<ol>${t}</ol>`;case"bullet_list":return`<ul>${t}</ul>`;case"list_item":return`<li>${t}</li>`;case"heading":{let n=e.attrs&&e.attrs.level||1;return`<h${n}>${t}</h${n}>`}case"horizontal_rule":return"<hr>";case"code_block":return`<pre><code>${t}</code></pre>`;case"hard_break":return'<span class="line-break"><br></span>';case"text":{let n=this._esc(e.text||"");if(e.marks)for(let r of e.marks)switch(typeof r.type=="string"?r.type:r.type&&r.type.name||""){case"bold":case"strong":n=`<strong>${n}</strong>`;break;case"italic":case"em":n=`<em>${n}</em>`;break;case"link":n=`<a href="${this._esc(r.attrs&&r.attrs.href||"")}">${n}</a>`;break;case"superscript":case"sup":n=`<sup>${n}</sup>`;break;case"subscript":case"sub":n=`<sub>${n}</sub>`;break;case"strikethrough":n=`<span style="text-decoration: line-through">${n}</span>`;break;case"underline":n=`<span style="text-decoration: underline">${n}</span>`;break;case"overline":n=`<span style="text-decoration: overline">${n}</span>`;break}return n}default:return t}}_esc(e){let t=String(e),i="";for(let n=0;n<t.length;n++){let r=t[n];switch(r){case"&":i+="&amp;";break;case"<":i+="&lt;";break;case">":i+="&gt;";break;case'"':i+="&quot;";break;case"'":i+="&#x27;";break;default:i+=r}}return i}};Ql.exports={StoreAdapter:Er}});var Gt=E((xg,ic)=>{"use strict";var Wt=require("crypto");function Rs(s,e=24){let t=[2166136261,16777619,668265261],i="";for(let n of t){let r=n;for(let o=0;o<s.length;o++)r^=s.charCodeAt(o),r=r*16777619>>>0;i+=(r>>>0).toString(16).padStart(8,"0")}return i.slice(0,e)}function tc(s){let e=sc(s);return e.length>0?lf(e):cf(s)}function sc(s){let e=[],t=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(t)||(t=[t]);for(let i of t){let n=i.checksum||i["https://tropy.org/v1/tropy#checksum"];n&&e.push(typeof n=="object"&&n["@value"]||String(n));let r=i.selection||i["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(r)||(r=[r]);for(let o of r){let a=o.checksum||o["https://tropy.org/v1/tropy#checksum"];a&&e.push(typeof a=="object"&&a["@value"]||String(a))}}return e}function lf(s){let e=s.slice().sort();return Wt.createHash("sha256").update(e.join(":")).digest("hex").slice(0,32)}function cf(s){let e=s.template||s["https://tropy.org/v1/tropy#template"]||"";typeof e=="object"&&(e=e["@id"]||"");let t=s["http://purl.org/dc/elements/1.1/title"]||s["http://purl.org/dc/terms/title"]||s.title||"";typeof t=="object"&&(t=t["@value"]||"");let i=s["http://purl.org/dc/elements/1.1/date"]||s["http://purl.org/dc/terms/date"]||s.date||"";typeof i=="object"&&(i=i["@value"]||"");let n=`${e}|${t}|${i}`;return n==="||"?null:Wt.createHash("sha256").update(n).digest("hex").slice(0,32)}function hf(s,e){let t=Math.round(e.x??0),i=Math.round(e.y??0),n=Math.round(e.width??e.w??0),r=Math.round(e.height??e.h??0);return Rs(`sel:${s}:${t}:${i}:${n}:${r}`)}function uf(s,e){let t=s.text||"",i=s.html||"",n=e||s.photo||s.selection||"orphan",r=i||t,o=r.slice(0,200),a=r.length>200?Rs(r,8):"";return Rs(`note:${n}:${o}:${a}`)}function df(s,e,t){let i=t?`${s}:${t}`:s;return Rs(`tx:${i}:${e}`)}function ff(s){let e=new Map;for(let t of s){let i=tc(t);i&&e.set(i,{localId:t["@id"]||t.id,item:t})}return e}function pf(s,e){return e.get(s)||null}function gf(s){let e=new Map,t=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(t)||(t=[t]);for(let i of t){let n=i["@id"]||i.id,r=i.checksum||i["https://tropy.org/v1/tropy#checksum"];n&&r&&(typeof r=="object"&&(r=r["@value"]||String(r)),e.set(n,String(r)))}return e}function mf(){return"n_"+Wt.randomUUID()}function yf(){return"s_"+Wt.randomUUID()}function wf(){return"t_"+Wt.randomUUID()}function _f(){return"l_"+Wt.randomUUID()}function bf(s,e){let t=Math.round(e.x??0),i=Math.round(e.y??0),n=Math.round(e.width??e.w??0),r=Math.round(e.height??e.h??0);return Rs(`selfp:${s}:${t}:${i}:${n}:${r}`)}ic.exports={computeIdentity:tc,extractChecksums:sc,buildIdentityIndex:ff,findLocalMatch:pf,computeSelectionKey:hf,computeNoteKey:uf,computeTranscriptionKey:df,generateNoteUUID:mf,generateSelectionUUID:yf,generateTranscriptionUUID:wf,generateListUUID:_f,computeSelectionFingerprint:bf,buildPhotoChecksumMap:gf}});var nc=E(Lr=>{"use strict";Object.defineProperty(Lr,"__esModule",{value:!0});Kt();var Sf=(ts(),_t(Hr)),Dr=class extends Sf.Observable{constructor(e){super(),this.yarray=e,this.doc=e.doc,this.map=new Map;{let t=e.toArray();this.doc.transact(()=>{for(let i=t.length-1;i>=0;i--){let n=t[i];this.map.has(n.key)?e.delete(i):this.map.set(n.key,n)}})}e.observe((t,i)=>{let n=new Map,r=Array.from(t.changes.added);t.changes.deleted.forEach(c=>{c.content.getContent().forEach(h=>{this.map.get(h.key)===h&&(this.map.delete(h.key),n.set(h.key,{action:"delete",oldValue:h.val}))})});let o=new Map;r.map(c=>c.content.getContent()).flat().forEach(c=>{o.set(c.key,c)});let a=new Set,l=e.toArray();this.doc.transact(c=>{for(let h=l.length-1;h>=0&&(o.size>0||a.size>0);h--){let u=l[h];if(a.has(u.key))a.delete(u.key),e.delete(h,1);else if(o.get(u.key)===u){let d=this.map.get(u.key);if(d)a.add(u.key),n.set(u.key,{action:"update",oldValue:d.val,newValue:u.val});else{let f=n.get(u.key);f&&f.action==="delete"?n.set(u.key,{action:"update",newValue:u.val,oldValue:f.oldValue}):n.set(u.key,{action:"add",newValue:u.val})}o.delete(u.key),this.map.set(u.key,u)}else o.has(u.key)&&(a.add(u.key),o.delete(u.key))}}),n.size>0&&this.emit("change",[n,i])})}set(e,t){this.doc.transact(i=>{this.map.has(e)&&this.delete(e),this.yarray.push([{key:e,val:t}])})}delete(e){let t=0;for(let i of this.yarray){if(i.key===e){this.yarray.delete(t);break}t++}}get(e){let t=this.map.get(e);return t&&t.val}has(e){return this.map.has(e)}};Lr.YKeyValue=Dr});var Pi=E((vg,uc)=>{"use strict";var V=(Kt(),_t(Pt)),{YKeyValue:xf}=nc(),ji=["metadata","tags","notes","photos","selections","selectionMeta","selectionNotes","transcriptions","lists","uuids","aliases"],Bi=["metadata","selectionMeta"],rc=new WeakMap;function ke(s){let e=rc.get(s);if(e)return e;let t=new xf(s);return rc.set(s,t),t}function W(s,e){return s.getMap("annotations").get(e)||null}function oc(s,e){let t=s.getMap("annotations"),i=t.get(e);return i||(i=new V.Map,t.set(e,i)),i}function Y(s,e,t){let i=oc(s,e);if(Bi.includes(t)){let r=i.get(t);return(!r||!(r instanceof V.Array))&&(r=new V.Array,i.set(t,r)),ke(r)}let n=i.get(t);return n||(n=new V.Map,i.set(t,n)),n}function kf(s,e){let t=s.getMap("annotations"),i=t.get(e),n=!i;n&&(i=new V.Map);let r={};for(let o of ji)if(Bi.includes(o)){let a=i.get(o);(!a||!(a instanceof V.Array))&&(a=new V.Array,i.set(o,a)),r[o]=ke(a)}else{let a=i.get(o);a||(a=new V.Map,i.set(o,a)),r[o]=a}return n&&t.set(e,i),r}function vf(s,e,t,i,n,r){Y(s,e,"metadata").set(t,{text:i.text||"",type:i.type||"http://www.w3.org/2001/XMLSchema#string",language:i.language||null,author:n,pushSeq:r||0})}function Tf(s,e){let t=W(s,e);if(!t)return{};let i=t.get("metadata");if(!i||!(i instanceof V.Array))return{};let n=ke(i),r={};return n.map.forEach((o,a)=>{r[a]=o}),r}function If(s,e,t,i,n){let r=Y(s,e,"tags"),o=r.get(t.name);(!o||o.deleted||t.color!==o.color)&&r.set(t.name,{name:t.name,color:t.color||null,author:i,pushSeq:n||0})}function Af(s,e,t,i,n){let r=Y(s,e,"tags"),o=r.get(t);o&&!o.deleted&&r.set(t,{...o,deleted:!0,author:i,pushSeq:n||0,deletedAt:Date.now()})}function $r(s,e){let t=W(s,e);if(!t)return[];let i=t.get("tags");if(!i)return[];let n=[];return i.forEach(r=>{n.push(r)}),n}function Uf(s,e){return $r(s,e).filter(t=>!t.deleted)}function Cf(s,e){return $r(s,e).filter(t=>t.deleted)}function Nf(s,e,t,i,n,r){Y(s,e,"notes").set(t,{uuid:t,text:i.text||"",html:i.html||"",language:i.language||null,photo:i.photo||null,selection:i.selection||null,author:n,pushSeq:r||0}),Fs(s,e,t,"note",i.photo||i.selection)}function Ef(s,e,t,i,n){let r=Y(s,e,"notes"),o=r.get(t);o&&!o.deleted&&r.set(t,{...o,deleted:!0,author:i,pushSeq:n||0,deletedAt:Date.now()})}function ac(s,e){let t=W(s,e);if(!t)return{};let i=t.get("notes");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function Df(s,e){let t=ac(s,e),i={};for(let[n,r]of Object.entries(t))r.deleted||(i[n]=r);return i}function Lf(s,e,t){let i=W(s,e);if(!i)return;let n=i.get("notes");n&&n.delete(t)}function $f(s,e,t,i,n,r,o){let a=Y(s,e,"photos"),l=a.get(t);l||(l=new V.Map,l.set("metadata",new V.Array),a.set(t,l));let c=l.get("metadata");(!c||!(c instanceof V.Array))&&(c=new V.Array,l.set("metadata",c)),ke(c).set(i,{text:n.text||"",type:n.type||"http://www.w3.org/2001/XMLSchema#string",language:n.language||null,author:r,pushSeq:o||0})}function Mf(s,e,t){let i=W(s,e);if(!i)return{};let n=i.get("photos");if(!n)return{};let r=n.get(t);if(!r)return{};let o=r.get("metadata");if(!o||!(o instanceof V.Array))return{};let a=ke(o),l={};return a.map.forEach((c,h)=>{l[h]=c}),l}function Of(s,e){let t=W(s,e);if(!t)return[];let i=t.get("photos");if(!i)return[];let n=[];return i.forEach((r,o)=>{n.push(o)}),n}function Rf(s,e,t,i,n,r){let o=Y(s,e,"selections"),a=i.x??0,l=i.y??0,c=i.width??i.w,h=i.height??i.h;!Number.isFinite(a)||!Number.isFinite(l)||c==null||h==null||!Number.isFinite(c)||!Number.isFinite(h)||c<=0||h<=0||(o.set(t,{uuid:t,x:a,y:l,w:c,h,angle:i.angle??0,photo:i.photo||null,author:n,pushSeq:r||0}),Fs(s,e,t,"selection",i.photo))}function Ff(s,e,t,i,n){let r=Y(s,e,"selections"),o=r.get(t);o&&!o.deleted&&r.set(t,{...o,deleted:!0,author:i,pushSeq:n||0,deletedAt:Date.now()})}function lc(s,e){let t=W(s,e);if(!t)return{};let i=t.get("selections");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function Vf(s,e){let t=lc(s,e),i={};for(let[n,r]of Object.entries(t))r.deleted||(i[n]=r);return i}function jf(s,e,t,i,n,r,o){let a=Y(s,e,"selectionMeta"),l=`${t}:${i}`;a.set(l,{text:n.text||"",type:n.type||"http://www.w3.org/2001/XMLSchema#string",language:n.language||null,author:r,pushSeq:o||0})}function Bf(s,e,t){let i=W(s,e);if(!i)return{};let n=i.get("selectionMeta");if(!n||!(n instanceof V.Array))return{};let r=ke(n),o=`${t}:`,a={};return r.map.forEach((l,c)=>{if(c.startsWith(o)){let h=c.slice(o.length);a[h]=l}}),a}function Pf(s,e,t,i,n,r,o){let a=Y(s,e,"selectionNotes"),l=`${t}:${i}`;a.set(l,{noteUUID:i,selUUID:t,text:n.text||"",html:n.html||"",language:n.language||null,author:r,pushSeq:o||0}),Fs(s,e,i,"selectionNote",t)}function Kf(s,e,t,i,n,r){let o=Y(s,e,"selectionNotes"),a=`${t}:${i}`,l=o.get(a);l&&!l.deleted&&o.set(a,{...l,deleted:!0,author:n,pushSeq:r||0,deletedAt:Date.now()})}function qf(s,e,t){let i=W(s,e);if(!i)return{};let n=i.get("selectionNotes");if(!n)return{};let r=`${t}:`,o={};return n.forEach((a,l)=>{l.startsWith(r)&&(a.deleted||(o[l]=a))}),o}function Hf(s,e){let t=W(s,e);if(!t)return{};let i=t.get("selectionNotes");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function zf(s,e,t){let i=W(s,e);if(!i)return;let n=i.get("selectionNotes");n&&n.delete(t)}function Wf(s,e,t,i,n,r){Y(s,e,"transcriptions").set(t,{uuid:t,text:i.text||"",data:i.data||null,photo:i.photo||null,selection:i.selection||null,author:n,pushSeq:r||0}),Fs(s,e,t,"transcription",i.photo||i.selection)}function Gf(s,e,t,i,n){let r=Y(s,e,"transcriptions"),o=r.get(t);o&&!o.deleted&&r.set(t,{...o,deleted:!0,author:i,pushSeq:n||0,deletedAt:Date.now()})}function cc(s,e){let t=W(s,e);if(!t)return{};let i=t.get("transcriptions");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function Jf(s,e){let t=cc(s,e),i={};for(let[n,r]of Object.entries(t))r.deleted||(i[n]=r);return i}function Yf(s,e,t,i,n,r){Y(s,e,"lists").set(t,{uuid:t,name:i,member:!0,author:n,pushSeq:r||0}),Fs(s,e,t,"list",i)}function Xf(s,e,t,i,n){let r=Y(s,e,"lists"),o=r.get(t);o&&!o.deleted&&r.set(t,{...o,member:!1,deleted:!0,author:i,pushSeq:n||0,deletedAt:Date.now()})}function hc(s,e){let t=W(s,e);if(!t)return{};let i=t.get("lists");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function Zf(s,e){let t=hc(s,e),i={};for(let[n,r]of Object.entries(t))!r.deleted&&r.member&&(i[n]=r);return i}function Fs(s,e,t,i,n){let r=Y(s,e,"uuids");r.has(t)||r.set(t,{type:i,localRef:n||null,author:null})}function Qf(s,e){let t=W(s,e);if(!t)return{};let i=t.get("uuids");if(!i)return{};let n={};return i.forEach((r,o)=>{n[o]=r}),n}function ep(s,e,t){let i=W(s,t);if(!i)return;let n=i.get("aliases");n||(n=new V.Map,i.set("aliases",n)),n.set(e,t)}function tp(s,e){let t=s.getMap("annotations"),i=null;return t.forEach((n,r)=>{if(i)return;let o=n.get("aliases");if(o){let a=o.get(e);a&&(i=a)}}),i}function sp(s,e){let t=s.getMap("annotations"),i=["tags","notes","selections","selectionNotes","transcriptions","lists"],n=0,r=0,o=e?Date.now()-e:null;return t.forEach(a=>{r++;for(let l of i){let c=a.get(l);if(!c)continue;let h=[];c.forEach((u,d)=>{u&&u.deleted&&(!o||!u.deletedAt||u.deletedAt<o)&&h.push(d)});for(let u of h)c.delete(u),n++}}),{items:r,purged:n}}function ip(s,e,t){let i=oc(s,e),n=t.join(",");i.get("checksums")!==n&&i.set("checksums",n)}function np(s,e){let t=W(s,e);if(!t)return[];let i=t.get("checksums");return i?i.split(",").filter(Boolean):[]}function rp(s){let t=s.getMap("room").get("schemaVersion");return{version:t||null,compatible:!t||t===4}}function op(s){s.getMap("room").set("schemaVersion",4)}function ap(s,e){let t=W(s,e);if(!t)return null;let i={};for(let n of ji)if(Bi.includes(n)){let r=t.get(n);if(!r||!(r instanceof V.Array)){i[n]={};continue}let o=ke(r),a={};o.map.forEach((l,c)=>{a[c]=l}),i[n]=a}else if(n==="photos"){let r=t.get(n),o={};r&&r.forEach((a,l)=>{let c=a.get("metadata"),h={};c&&c instanceof V.Array?ke(c).map.forEach((d,f)=>{h[f]=d}):c&&c.forEach((u,d)=>{h[d]=u}),o[l]={metadata:h}}),i[n]=o}else{let r=t.get(n);if(!r){i[n]={};continue}let o={};r.forEach((a,l)=>{o[l]=a}),i[n]=o}return i}function lp(s){let e=s.getMap("annotations"),t=[];return e.forEach((i,n)=>{t.push(n)}),t}function Vi(s){if(s&&typeof s=="object"){let{pushSeq:e,author:t,ts:i,...n}=s;return n}return s}function cp(s){let e=s.getMap("annotations"),t={};return e.forEach((i,n)=>{let r={};for(let o of ji)if(Bi.includes(o)){let a=i.get(o);if(!a||!(a instanceof V.Array)){r[o]={};continue}let l=ke(a),c={};l.map.forEach((h,u)=>{c[u]=Vi(h)}),r[o]=c}else if(o==="photos"){let a=i.get(o),l={};a&&a.forEach((c,h)=>{let u=c.get("metadata"),d={};u&&u instanceof V.Array?ke(u).map.forEach((p,g)=>{d[g]=Vi(p)}):u&&u.forEach((f,p)=>{d[p]=Vi(f)}),l[h]={metadata:d}}),r[o]=l}else{let a=i.get(o);if(!a){r[o]={};continue}let l={};a.forEach((c,h)=>{l[h]=Vi(c)}),r[o]=l}t[n]=r}),t}function hp(s,e){let t=s.getMap("room");for(let[i,n]of Object.entries(e))t.set(i,n)}function up(s){let e=s.getMap("room"),t={};return e.forEach((i,n)=>{t[n]=i}),t}function dp(s,e){let t=s.getMap("annotations"),i=n=>{let r=new Set;n.forEach(o=>{o.target===t&&o.changes.keys.forEach((a,l)=>{r.add(l)})}),r.size>0&&e(Array.from(r))};return t.observeDeep(i),()=>t.unobserveDeep(i)}function fp(s,e,t){let i=s.getMap("annotations"),n=(r,o)=>{if(t!=null&&o.origin===t)return;let a=[];for(let l of r){let c=l.path;if(c.length>=2){let h=c[0],u=c[1];a.push({identity:h,type:u,event:l})}else l.target===i&&l.changes.keys.forEach((h,u)=>{a.push({identity:u,type:"item",event:l})})}a.length>0&&e(a)};return i.observeDeep(n),()=>i.unobserveDeep(n)}uc.exports={ITEM_SECTIONS:ji,getItemAnnotations:kf,setMetadata:vf,getMetadata:Tf,setTag:If,removeTag:Af,getTags:$r,getActiveTags:Uf,getDeletedTags:Cf,setNote:Nf,removeNote:Ef,deleteNoteEntry:Lf,getNotes:ac,getActiveNotes:Df,setPhotoMetadata:$f,getPhotoMetadata:Mf,getAllPhotoChecksums:Of,setSelection:Rf,removeSelection:Ff,getSelections:lc,getActiveSelections:Vf,setSelectionMeta:jf,getSelectionMeta:Bf,setSelectionNote:Pf,removeSelectionNote:Kf,deleteSelectionNoteEntry:zf,getSelectionNotes:qf,getAllSelectionNotes:Hf,setTranscription:Wf,removeTranscription:Gf,getTranscriptions:cc,getActiveTranscriptions:Jf,setListMembership:Yf,removeListMembership:Xf,getLists:hc,getActiveLists:Zf,getUUIDRegistry:Qf,setAlias:ep,resolveAlias:tp,setItemChecksums:ip,getItemChecksums:np,checkSchemaVersion:rp,setSchemaVersion:op,getSnapshot:cp,getItemSnapshot:ap,getIdentities:lp,purgeTombstones:sp,setRoomConfig:hp,getRoomConfig:up,observeAnnotations:dp,observeAnnotationsDeep:fp}});var fc=E((Tg,dc)=>{"use strict";var Jt=require("fs"),Ki=require("path"),pp=require("os"),gp={maxBackups:10,maxNoteSize:1*1024*1024,maxMetadataSize:64*1024,tombstoneFloodThreshold:.5},Mr=class{constructor(e,t,i,n={}){this.room=e,this.api=t,this.logger=i,this.options={...gp,...n},this.backupDir=Ki.join(pp.homedir(),".troparcel","backups",this.sanitizeDir(e)),this._fileCounter=0}sanitizeDir(e){return e.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}async ensureDir(){await Jt.promises.mkdir(this.backupDir,{recursive:!0})}async saveSnapshot(e){await this.ensureDir();let t=new Date().toISOString().replace(/[:.]/g,"-");this._fileCounter++;let i=`${t}-${String(this._fileCounter).padStart(4,"0")}.json`,n=Ki.join(this.backupDir,i),r={room:this.room,timestamp:new Date().toISOString(),version:"4.0",items:e};return await Jt.promises.writeFile(n,JSON.stringify(r)),this.logger.info(`Backup saved: ${n}`,{items:e.length}),await this.pruneOldBackups(),n}async pruneOldBackups(){try{let t=(await Jt.promises.readdir(this.backupDir)).filter(n=>n.endsWith(".json")).sort(),i=[];for(;t.length>this.options.maxBackups;)i.push(t.shift());if(i.length>0){await Promise.allSettled(i.map(n=>Jt.promises.unlink(Ki.join(this.backupDir,n))));for(let n of i)this.logger.debug(`Pruned old backup: ${n}`)}}catch(e){this.logger.warn("Failed to prune backups",{error:e.message})}}async captureItemState(e,t){let i={identity:t,localId:e};try{i.metadata=await this.api.getMetadata(e)}catch(n){this.logger.warn(`captureItemState: failed to get metadata for ${e}`,{error:String(n.message||n)}),i.metadata=null}try{i.tags=await this.api.getItemTags(e)}catch(n){this.logger.warn(`captureItemState: failed to get tags for ${e}`,{error:String(n.message||n)}),i.tags=[]}i.photos=[];try{let n=await this.api.getPhotos(e);if(Array.isArray(n)){let r=n.map(a=>typeof a=="object"?a.id:a),o=await Promise.allSettled(r.map(a=>this.api.getPhoto(a)));for(let a of o)a.status==="fulfilled"&&a.value&&i.photos.push(a.value)}}catch(n){this.logger.warn(`captureItemState: failed to get photos for ${e}`,{error:String(n.message||n)})}return i}captureItemStateFromStore(e,t,i){let n=e.getItemFull(t);if(!n)return{identity:i,localId:t,metadata:null,tags:[],photos:[]};let r={},o=new Set(["id","photo","template","list","lists","tag","tags","photos","selections","notes","transcriptions"]);for(let[a,l]of Object.entries(n))a.startsWith("@")||a.startsWith("_")||o.has(a)||(r[a]=l);return{identity:i,localId:t,metadata:r,tags:n.tag||[],photos:n.photo||[]}}validateInbound(e,t,i){let n=[];if(t.notes)for(let[a,l]of Object.entries(t.notes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&n.push(`Note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.selectionNotes)for(let[a,l]of Object.entries(t.selectionNotes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&n.push(`Selection note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.transcriptions)for(let[a,l]of Object.entries(t.transcriptions)){if(l.deleted)continue;let c=(l.text||"").length+JSON.stringify(l.data||"").length;c>this.options.maxNoteSize&&n.push(`Transcription ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.metadata)for(let[a,l]of Object.entries(t.metadata)){let c=(l.text||"").length;c>this.options.maxMetadataSize&&n.push(`Metadata ${a} exceeds max size (${c} > ${this.options.maxMetadataSize})`)}let r=0,o=0;for(let a of["tags","notes","selectionNotes","selections","transcriptions","lists"]){let l=t[a];if(l&&typeof l=="object")for(let c of Object.values(l))r++,c&&c.deleted&&(!i||c.author!==i)&&o++}return r>0&&o/r>this.options.tombstoneFloodThreshold&&this.logger.info(`Tombstone ratio for ${e.slice(0,8)}: ${o}/${r} (${Math.round(o/r*100)}%) \u2014 not blocking`),{valid:n.length===0,warnings:n}}shouldOverwrite(e,t){return t&&t.deleted?!0:!((!t||!t.text)&&e&&e.text)}async rollback(e,t=null){let i=JSON.parse(await Jt.promises.readFile(e,"utf8")),n=0,r=[];for(let o of i.items){let a=[];try{if(o.metadata)try{await this.api.saveMetadata(o.localId,o.metadata)}catch(l){a.push(`metadata for ${o.localId}: ${l.message}`)}if(o.tags&&Array.isArray(o.tags))try{let l=o.tags.map(c=>c.id||c.tag_id).filter(Boolean);l.length>0&&await this.api.addTagsToItem(o.localId,l)}catch(l){a.push(`tags for ${o.localId}: ${l.message}`)}if(o.photos&&Array.isArray(o.photos))for(let l of o.photos){let c=l.notes||[];for(let u of c)try{let d=await this.api.getNote(u,"json");d&&d.html&&(t?await t.updateNote(u,{html:d.html}):this.logger.warn(`Rollback: note ${u} update skipped (no store adapter, HTTP PUT not supported)`))}catch(d){a.push(`note ${u}: ${d.message}`)}let h=l.selections||[];for(let u of h)this.logger.warn(`Rollback: selection ${u} update skipped (selection coordinate update not supported)`)}a.length>0&&(this.logger.warn(`Rollback: item ${o.localId} partially restored with ${a.length} error(s)`),r.push(...a)),n++}catch(l){r.push(`Failed to restore item ${o.localId}: ${l.message}`),r.push(...a)}}return this.logger.info(`Rollback complete: ${n} items restored`,{backup:e,errors:r.length}),{restored:n,errors:r}}listBackups(){try{return Jt.readdirSync(this.backupDir).filter(e=>e.endsWith(".json")).sort().reverse().map(e=>Ki.join(this.backupDir,e))}catch{return[]}}};dc.exports={BackupManager:Mr}});var yc=E((Ig,mc)=>{"use strict";var pc=require("crypto"),qi=require("fs"),Hi=require("path"),gc=require("os"),mp=(Kt(),_t(Pt)),yp=5e3,Or=5e4,yt=5e4,Rr=class{constructor(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes=new Map,this.appliedNoteKeys=new Set,this.appliedSelectionKeys=new Set,this.appliedTranscriptionKeys=new Set,this.noteIdToCrdtKey=new Map,this.crdtKeyToNoteId=new Map,this.txIdToCrdtKey=new Map,this.crdtKeyToTxId=new Map,this.selIdToCrdtKey=new Map,this.crdtKeyToSelId=new Map,this.listNameToCrdtKey=new Map,this.crdtKeyToListName=new Map,this._cachedAnnotationCount=0,this.failedNoteKeys=new Map,this._dirty=!1,this.pushSeq=0,this.pushedFieldValues=new Map,this.dismissedKeys=new Set}markDirty(){this._dirty=!0}get isDirty(){return this._dirty}nextPushSeq(){return++this.pushSeq}hasLocalEdit(e,t,i){let n=`${e}:${t}`,r=this.pushedFieldValues.get(n);return r?r!==i:!0}markFieldPushed(e,t,i){let n=`${e}:${t}`;this.pushedFieldValues.set(n,i)}hasCRDTChanged(e){let t;if(e instanceof Uint8Array)t=e;else if(e&&typeof e.store<"u")t=mp.encodeStateVector(e);else{let n=this.hashObject(e);return n===this.lastCRDTHash?!1:(this.lastCRDTHash=n,!0)}let i=pc.createHash("sha256").update(Buffer.from(t)).digest("hex").slice(0,16);return i===this.lastCRDTHash?!1:(this.lastCRDTHash=i,!0)}shouldBackup(e){let t=this.hashObject(e);return t===this.lastBackupHash?!1:(this.lastBackupHash=t,!0)}hasItemChanged(e,t){let i=this._fastHash(t);return{changed:this.pushedHashes.get(e)!==i,hash:i}}markPushed(e,t){this._evictIfNeeded(this.pushedHashes,yp),this.pushedHashes.set(e,t)}_fastHash(e){let t=JSON.stringify(e),i=2166136261;for(let n=0;n<t.length;n++)i^=t.charCodeAt(n),i=i*16777619>>>0;return i.toString(36)}getNoteKey(e,t){let i=String(e),n=this.noteIdToCrdtKey.get(i);return n||(this._evictIfNeeded(this.noteIdToCrdtKey,yt),this.noteIdToCrdtKey.set(i,t),this.crdtKeyToNoteId.set(t,i),this._dirty=!0,t)}mapAppliedNote(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToNoteId,yt),this.crdtKeyToNoteId.set(e,i),this.noteIdToCrdtKey.set(i,e),this._dirty=!0}getLocalNoteId(e){return this.crdtKeyToNoteId.get(e)||null}getTxKey(e,t){let i=String(e),n=this.txIdToCrdtKey.get(i);return n||(this._evictIfNeeded(this.txIdToCrdtKey,yt),this.txIdToCrdtKey.set(i,t),this.crdtKeyToTxId.set(t,i),t)}mapAppliedTranscription(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToTxId,yt),this.crdtKeyToTxId.set(e,i),this.txIdToCrdtKey.set(i,e)}getLocalTxId(e){return this.crdtKeyToTxId.get(e)||null}getSelectionKey(e,t){let i=String(e),n=this.selIdToCrdtKey.get(i);return n||(this._evictIfNeeded(this.selIdToCrdtKey,yt),this.selIdToCrdtKey.set(i,t),this.crdtKeyToSelId.set(t,i),this._dirty=!0,t)}mapAppliedSelection(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToSelId,yt),this.crdtKeyToSelId.set(e,i),this.selIdToCrdtKey.set(i,e),this._dirty=!0}getLocalSelId(e){return this.crdtKeyToSelId.get(e)||null}getListKey(e){return this.listNameToCrdtKey.get(e)||null}mapAppliedList(e,t){this._evictIfNeeded(this.listNameToCrdtKey,yt),this.listNameToCrdtKey.set(t,e),this.crdtKeyToListName.set(e,t),this._dirty=!0}getLocalListName(e){return this.crdtKeyToListName.get(e)||null}recoverFromCRDT(e,t,i){let n=i.getUUIDRegistry(e,t),r=0;for(let[o,a]of Object.entries(n))if(!(!a||!a.type))switch(a.type){case"note":a.localRef&&!this.crdtKeyToNoteId.has(o)&&(this.appliedNoteKeys.add(o),r++);break;case"selection":this.crdtKeyToSelId.has(o)||(this.appliedSelectionKeys.add(o),r++);break;case"transcription":this.crdtKeyToTxId.has(o)||(this.appliedTranscriptionKeys.add(o),r++);break;case"list":a.localRef&&!this.crdtKeyToListName.has(o)&&(this.mapAppliedList(o,a.localRef),r++);break}return r}updateAnnotationCount(e){this._cachedAnnotationCount=e}get annotationCount(){return this._cachedAnnotationCount}hashObject(e){let t=this._sortedStringify(e);return pc.createHash("sha256").update(t).digest("hex").slice(0,16)}_sortedStringify(e){return JSON.stringify(e,(t,i)=>{if(i&&typeof i=="object"&&!Array.isArray(i)){let n={};for(let r of Object.keys(i).sort())n[r]=i[r];return n}return i})}_evictIfNeeded(e,t){if(e.size<t)return;let i=Math.floor(t*.2),n=e.keys();for(let r=0;r<i;r++){let o=n.next();if(o.done)break;e.delete(o.value)}}pruneAppliedKeys(){this._truncateSetInPlace(this.appliedNoteKeys,Or),this._truncateSetInPlace(this.appliedSelectionKeys,Or),this._truncateSetInPlace(this.appliedTranscriptionKeys,Or)}_truncateSetInPlace(e,t){if(e.size<=t)return;let i=e.size-t,n=e.values();for(let r=0;r<i;r++){let o=n.next();if(o.done)break;e.delete(o.value)}}async persistToFile(e){if(e)try{let t=Hi.join(gc.homedir(),".troparcel","vault");await qi.promises.mkdir(t,{recursive:!0});let i=Hi.join(t,this._sanitizeRoom(e)+".json"),n=i+".tmp",r={version:4,timestamp:new Date().toISOString(),pushSeq:this.pushSeq,appliedNoteKeys:Array.from(this.appliedNoteKeys),appliedSelectionKeys:Array.from(this.appliedSelectionKeys),appliedTranscriptionKeys:Array.from(this.appliedTranscriptionKeys),failedNoteKeys:Array.from(this.failedNoteKeys.entries()).map(([o,a])=>({key:o,count:a})),noteMappings:Array.from(this.crdtKeyToNoteId.entries()).map(([o,a])=>[o,a]),txMappings:Array.from(this.crdtKeyToTxId.entries()).map(([o,a])=>[o,a]),selMappings:Array.from(this.crdtKeyToSelId.entries()).map(([o,a])=>[o,a]),listMappings:Array.from(this.crdtKeyToListName.entries()).map(([o,a])=>[o,a]),dismissedKeys:Array.from(this.dismissedKeys)};await qi.promises.writeFile(n,JSON.stringify(r)),await qi.promises.rename(n,i),this._dirty=!1}catch(t){throw t}}loadFromFile(e){if(!e)return!1;try{let t=Hi.join(gc.homedir(),".troparcel","vault"),i=Hi.join(t,this._sanitizeRoom(e)+".json"),n=qi.readFileSync(i,"utf8"),r=JSON.parse(n);if(r.version!==1&&r.version!==2&&r.version!==3&&r.version!==4)return!1;if(Array.isArray(r.appliedNoteKeys))for(let o of r.appliedNoteKeys)this.appliedNoteKeys.add(o);if(Array.isArray(r.appliedSelectionKeys))for(let o of r.appliedSelectionKeys)this.appliedSelectionKeys.add(o);if(Array.isArray(r.appliedTranscriptionKeys))for(let o of r.appliedTranscriptionKeys)this.appliedTranscriptionKeys.add(o);if(Array.isArray(r.failedNoteKeys))for(let o of r.failedNoteKeys)typeof o=="string"?this.failedNoteKeys.set(o,3):Array.isArray(o)?this.failedNoteKeys.set(o[0],o[1]||3):o&&o.key&&this.failedNoteKeys.set(o.key,o.count||3);if(Array.isArray(r.noteMappings))for(let[o,a]of r.noteMappings)this.crdtKeyToNoteId.set(o,String(a)),this.noteIdToCrdtKey.set(String(a),o);if(Array.isArray(r.txMappings))for(let[o,a]of r.txMappings)this.crdtKeyToTxId.set(o,String(a)),this.txIdToCrdtKey.set(String(a),o);if(Array.isArray(r.selMappings))for(let[o,a]of r.selMappings)this.crdtKeyToSelId.set(o,String(a)),this.selIdToCrdtKey.set(String(a),o);if(Array.isArray(r.listMappings))for(let[o,a]of r.listMappings)this.crdtKeyToListName.set(o,a),this.listNameToCrdtKey.set(a,o);if(typeof r.pushSeq=="number"&&(this.pushSeq=r.pushSeq),Array.isArray(r.dismissedKeys))for(let o of r.dismissedKeys)this.dismissedKeys.add(o);return!0}catch{return!1}}_sanitizeRoom(e){return e.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}clear(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes.clear(),this.appliedNoteKeys.clear(),this.appliedSelectionKeys.clear(),this.appliedTranscriptionKeys.clear(),this.noteIdToCrdtKey.clear(),this.crdtKeyToNoteId.clear(),this.txIdToCrdtKey.clear(),this.crdtKeyToTxId.clear(),this.selIdToCrdtKey.clear(),this.crdtKeyToSelId.clear(),this.listNameToCrdtKey.clear(),this.crdtKeyToListName.clear(),this._cachedAnnotationCount=0,this.failedNoteKeys.clear(),this.pushedFieldValues.clear(),this.dismissedKeys.clear(),this.pushSeq=0}};mc.exports={SyncVault:Rr}});var _c=E((Ag,wc)=>{"use strict";var A=Gt(),I=Pi();wc.exports={async pushLocal(s,e){let t=this._stableUserId,i=0,n=0,r=new Map;for(let o of s){let a=A.computeIdentity(o);a&&r.set(a,o)}for(let[o,a]of r){let l=this.vault.hasItemChanged(o,a);if(!l.changed){n++;continue}i++;let c=A.buildPhotoChecksumMap(a);try{let h={};this.doc.transact(()=>{let u=Array.from(c.values());u.length>0&&I.setItemChecksums(this.doc,o,u),this.pushMetadata(a,o,t,e),this.pushTags(a,o,t,e),h.noteKeys=this.pushNotes(a,o,t,c,e),this.pushPhotoMetadata(a,o,t,e),h.selectionKeys=this.pushSelections(a,o,t,c,e),h.transcriptionKeys=this.pushTranscriptions(a,o,t,c,e),this.options.syncLists&&this.pushLists(a,o,t,e),this.pushDeletions(a,o,t,c,h,e)},this.LOCAL_ORIGIN),this.saveItemSnapshot(a,o,c,h),this.vault.markPushed(o,l.hash),this._pushFailCounts&&this._pushFailCounts.has(o)&&this._pushFailCounts.delete(o)}catch(h){this.logger.warn(`Failed to push item ${o}`,{error:h.message});let u=this._pushFailCounts&&this._pushFailCounts.get(o)||0;this._pushFailCounts||(this._pushFailCounts=new Map),this._pushFailCounts.set(o,u+1),u+1>=3&&(this.vault.markPushed(o,l.hash),this._pushFailCounts.delete(o),this.logger.warn(`Item ${o} push permanently skipped after ${u+1} failures`))}}i>0?this._log(`pushed ${i} item(s) to CRDT`):this._debug(`pushLocal: ${n} item(s) unchanged`)},pushMetadata(s,e,t,i){if(!this.options.syncMetadata)return;let n=I.getMetadata(this.doc,e);for(let[r,o]of Object.entries(s)){if(r.startsWith("@")||r.startsWith("_")||["photo","template","list","lists","tag"].includes(r)||!r.includes(":")&&!r.includes("/"))continue;let a="",l="http://www.w3.org/2001/XMLSchema#string",c=null;typeof o=="string"?a=o:o&&typeof o=="object"?(a=o["@value"]||o.text||"",l=o["@type"]||o.type||l,c=o["@language"]||o.language||null):o!=null&&(a=String(o));let h=n[r];if(!(!a&&!h)){if(h){if(h.text===a&&h.type===l)continue;if(h.author!==t){let u=this.vault._fastHash(`${a}|${l}`);if(!this.vault.hasLocalEdit(e,r,u)){this._logConflict("metadata",e,r,{local:a?.slice(0,50),remote:h.text?.slice(0,50),remoteAuthor:h.author});continue}}}I.setMetadata(this.doc,e,r,{text:a,type:l,language:c},t,i),this.vault.markFieldPushed(e,r,this.vault._fastHash(`${a}|${l}`))}}},pushTags(s,e,t,i){if(!this.options.syncTags)return;let n=s.tag||s["https://tropy.org/v1/tropy#tag"]||[];Array.isArray(n)||(n=[n]);let r=I.getTags(this.doc,e),o=new Map(r.map(a=>[a.name,a]));for(let a of n){let l=typeof a=="string"?a:a.name||a["@value"]||"",c=typeof a=="object"?a.color:null;if(!l)continue;let h=o.get(l);if(h&&!h.deleted){if((h.color||null)===(c||null))continue;if(h.author!==t){let u=this.vault._fastHash(`tag:${l}:${c||""}`);if(!this.vault.hasLocalEdit(e,`tag:${l}`,u))continue}}h&&h.deleted&&h.author!==t||(I.setTag(this.doc,e,{name:l,color:c},t,i),this.vault.markFieldPushed(e,`tag:${l}`,this.vault._fastHash(`tag:${l}:${c||""}`)))}},pushNotes(s,e,t,i,n){if(!this.options.syncNotes)return{noteKeys:new Set,selectionNoteKeys:new Set};let r=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(r)||(r=[r]);let o=I.getNotes(this.doc,e),a=new Set,l=new Set;for(let c of r){let h=c.checksum||i.get(c["@id"]||c.id),u=c.note||c["https://tropy.org/v1/tropy#note"]||[];Array.isArray(u)||(u=[u]);for(let f of u){if(!f)continue;let p=f["@value"]||f.text||f["https://schema.org/text"]||"",g=f.html||f["https://tropy.org/v1/tropy#html"]||"";if(typeof p=="object"&&(p=p["@value"]||""),typeof g=="object"&&(g=g["@value"]||""),!this._isSyncedNote(p,g)&&(p||g)){let m=f["@id"]||f.id,y=m?this.vault.getNoteKey(m,A.generateNoteUUID()):A.generateNoteUUID();a.add(y);let b=o[y];if(b&&!b.deleted&&b.text===p&&b.html===g){this.vault.appliedNoteKeys.add(y);continue}if(b&&!b.deleted&&b.author!==t){let S=this.vault._fastHash(`note:${g||p}`);if(!this.vault.hasLocalEdit(e,`note:${y}`,S))continue}I.setNote(this.doc,e,y,{text:p,html:g,language:f.language||null,photo:h||null},t,n),this.vault.appliedNoteKeys.add(y),this.vault.markFieldPushed(e,`note:${y}`,this.vault._fastHash(`note:${g||p}`))}}let d=c.selection||c["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(d)||(d=[d]);for(let f of d){if(!f||!h)continue;let p=f["@id"]||f.id,g=p?this.vault.getSelectionKey(p,A.generateSelectionUUID()):A.computeSelectionFingerprint(h,f),m=f.note||f["https://tropy.org/v1/tropy#note"]||[];Array.isArray(m)||(m=[m]);let y=I.getSelectionNotes(this.doc,e,g);for(let b of m){if(!b)continue;let S=b["@value"]||b.text||b["https://schema.org/text"]||"",k=b.html||b["https://tropy.org/v1/tropy#html"]||"";if(typeof S=="object"&&(S=S["@value"]||""),typeof k=="object"&&(k=k["@value"]||""),!this._isSyncedNote(S,k)&&(S||k)){let T=b["@id"]||b.id,j=T?this.vault.getNoteKey(T,A.generateNoteUUID()):A.generateNoteUUID(),Te=`${g}:${j}`;l.add(Te);let wt=y[Te];if(wt&&wt.text===S&&wt.html===k){this.vault.appliedNoteKeys.add(Te);continue}if(wt&&!wt.deleted&&wt.author!==t){let Dc=this.vault._fastHash(`selnote:${k||S}`);if(!this.vault.hasLocalEdit(e,`selnote:${Te}`,Dc))continue}I.setSelectionNote(this.doc,e,g,j,{text:S,html:k,language:b.language||null},t,n),this.vault.appliedNoteKeys.add(Te)}}}}return this._cleanupStaleNotes(e,t,a,l),{noteKeys:a,selectionNoteKeys:l}},_cleanupStaleNotes(s,e,t,i){if(!this.options.syncDeletions)return;let n=this.previousSnapshot.get(s),r=n&&n.noteKeys?n.noteKeys:null,o=n&&n.selectionNoteKeys?n.selectionNoteKeys:null,a=I.getNotes(this.doc,s),l=0;for(let[h,u]of Object.entries(a))u.author===e&&(u.deleted||t.has(h)||r&&r.has(h)||(I.deleteNoteEntry(this.doc,s,h),l++));let c=I.getAllSelectionNotes(this.doc,s);for(let[h,u]of Object.entries(c))u.author===e&&(u.deleted||i.has(h)||o&&o.has(h)||(I.deleteSelectionNoteEntry(this.doc,s,h),l++));l>0&&this._log(`cleanupStaleNotes: removed ${l} stale entry(s) for ${s.slice(0,8)}`)},pushPhotoMetadata(s,e,t,i){if(!this.options.syncPhotoAdjustments)return;let n=s.photo||[];Array.isArray(n)||(n=[n]);for(let r of n){let o=r.checksum;if(!o||!r.metadata)continue;let a=I.getPhotoMetadata(this.doc,e,o);for(let[l,c]of Object.entries(r.metadata)){if(l==="id")continue;let h="",u="http://www.w3.org/2001/XMLSchema#string";typeof c=="object"&&c!==null?(h=c.text||"",u=c.type||u):c!=null&&(h=String(c));let d=a[l];if(!(!h&&!d)){if(d){if(d.text===h&&d.type===u)continue;if(d.author!==t){let f=this.vault._fastHash(`${h}|${u}`);if(!this.vault.hasLocalEdit(e,`photo:${o}:${l}`,f))continue}}I.setPhotoMetadata(this.doc,e,o,l,{text:h,type:u},t,i),this.vault.markFieldPushed(e,`photo:${o}:${l}`,this.vault._fastHash(`${h}|${u}`))}}}},pushSelections(s,e,t,i,n){if(!this.options.syncSelections)return new Set;let r=s.photo||[];Array.isArray(r)||(r=[r]);let o=I.getSelections(this.doc,e),a=new Set;for(let l of r){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.selection||[];Array.isArray(h)||(h=[h]);for(let u of h){if(!u)continue;let d=u["@id"]||u.id,f=d?this.vault.getSelectionKey(d,A.generateSelectionUUID()):A.generateSelectionUUID();a.add(f);let p=o[f],g=p&&!p.deleted&&p.x===u.x&&p.y===u.y&&p.w===u.width&&p.h===u.height&&(p.angle||0)===(u.angle||0),m=!1;if(p&&!p.deleted&&p.author!==t){let y=this.vault._fastHash(`sel:${u.x}:${u.y}:${u.width}:${u.height}`);m=!this.vault.hasLocalEdit(e,`sel:${f}`,y)}if(!g&&!m?(I.setSelection(this.doc,e,f,{x:u.x,y:u.y,width:u.width,height:u.height,angle:u.angle||0,photo:c},t,n),this.vault.appliedSelectionKeys.add(f),this.vault.markFieldPushed(e,`sel:${f}`,this.vault._fastHash(`sel:${u.x}:${u.y}:${u.width}:${u.height}`))):g&&this.vault.appliedSelectionKeys.add(f),u.metadata){let y=I.getSelectionMeta(this.doc,e,f);for(let[b,S]of Object.entries(u.metadata)){if(b==="id")continue;let k="",T="http://www.w3.org/2001/XMLSchema#string";typeof S=="object"&&S!==null?(k=S.text||"",T=S.type||T):S!=null&&(k=String(S));let j=y[b];if(!(!k&&!j)){if(j){if(j.text===k&&j.type===T)continue;if(j.author!==t){let Te=this.vault._fastHash(`${k}|${T}`);if(!this.vault.hasLocalEdit(e,`selmeta:${f}:${b}`,Te))continue}}I.setSelectionMeta(this.doc,e,f,b,{text:k,type:T},t,n),this.vault.markFieldPushed(e,`selmeta:${f}:${b}`,this.vault._fastHash(`${k}|${T}`))}}}}}return a},pushTranscriptions(s,e,t,i,n){if(!this.options.syncTranscriptions)return new Set;let r=s.photo||[];Array.isArray(r)||(r=[r]);let o=new Set,a=I.getTranscriptions(this.doc,e);for(let l of r){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.transcription||[];Array.isArray(h)||(h=[h]),h.forEach((d,f)=>{if(!d)return;let p=d["@id"]||d.id,g=p?this.vault.getTxKey(p,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();o.add(g),this.vault.appliedTranscriptionKeys.add(g);let m=a[g];if(!(m&&!m.deleted&&m.text===(d.text||""))){if(m&&!m.deleted&&m.author!==t){let y=this.vault._fastHash(`tx:${d.text||""}`);if(!this.vault.hasLocalEdit(e,`tx:${g}`,y))return}I.setTranscription(this.doc,e,g,{text:d.text||"",data:d.data||null,photo:c},t,n),this.vault.markFieldPushed(e,`tx:${g}`,this.vault._fastHash(`tx:${d.text||""}`))}});let u=l.selection||[];Array.isArray(u)||(u=[u]);for(let d of u){if(!d)continue;let f=d["@id"]||d.id,p=f?this.vault.getSelectionKey(f,A.generateSelectionUUID()):A.computeSelectionFingerprint(c,d),g=d.transcription||[];Array.isArray(g)||(g=[g]),g.forEach((m,y)=>{if(!m)return;let b=m["@id"]||m.id,S=b?this.vault.getTxKey(b,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();o.add(S),this.vault.appliedTranscriptionKeys.add(S);let k=a[S];if(!(k&&!k.deleted&&k.text===(m.text||""))){if(k&&!k.deleted&&k.author!==t){let T=this.vault._fastHash(`tx:${m.text||""}`);if(!this.vault.hasLocalEdit(e,`tx:${S}`,T))return}I.setTranscription(this.doc,e,S,{text:m.text||"",data:m.data||null,photo:c,selection:p},t,n),this.vault.markFieldPushed(e,`tx:${S}`,this.vault._fastHash(`tx:${m.text||""}`))}})}}return o},pushLists(s,e,t,i){let n=s.lists||[];if(!Array.isArray(n))return;let r=I.getLists(this.doc,e);for(let o of n){let a=this._listNameCache.get(o)||this._listNameCache.get(String(o));if(!a){this._debug(`pushLists: skipping list ${o} (name not in cache)`);continue}let l=this.vault.getListKey(a);if(!l){let h=Object.entries(r).find(([u,d])=>d.name===a&&!d.deleted);h?(l=h[0],this.vault.mapAppliedList(l,a)):(l=A.generateListUUID(),this.vault.mapAppliedList(l,a))}let c=r[l];if(!(c&&!c.deleted&&c.member)){if(c&&c.author!==t){let h=this.vault._fastHash(`list:${a}`);if(!this.vault.hasLocalEdit(e,`list:${l}`,h))continue}I.setListMembership(this.doc,e,l,a,t,i),this.vault.markFieldPushed(e,`list:${l}`,this.vault._fastHash(`list:${a}`))}}},async _refreshListNameCache(){if(!this.options.syncLists)return;let s=Date.now();if(!(s-this._listCacheRefreshedAt<5e3))try{let e=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(e)){this._listNameCache.clear();for(let t of e)t.id&&t.name&&(this._listNameCache.set(t.id,t.name),this._listNameCache.set(String(t.id),t.name));this._listCacheRefreshedAt=s}}catch(e){this.logger.warn("Failed to refresh list name cache",{error:e.message})}},_computeItemKeys(s,e){let t=new Set,i=new Set,n=new Set,r=new Set,o=new Set,a=s.photo||[];Array.isArray(a)||(a=[a]);for(let c of a){let h=c.checksum||e.get(c["@id"]||c.id),u=c.note||[];Array.isArray(u)||(u=[u]);for(let p of u){if(!p)continue;let g=p["@value"]||p.text||p["https://schema.org/text"]||"",m=p.html||p["https://tropy.org/v1/tropy#html"]||"";if(typeof g=="object"&&(g=g["@value"]||""),typeof m=="object"&&(m=m["@value"]||""),!this._isSyncedNote(g,m)&&(g||m)){let y=p["@id"]||p.id,b=y?this.vault.getNoteKey(y,A.generateNoteUUID()):A.generateNoteUUID();t.add(b)}}let d=c.transcription||[];Array.isArray(d)||(d=[d]),d.forEach((p,g)=>{if(!p)return;let m=p["@id"]||p.id,y=m?this.vault.getTxKey(m,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();n.add(y)});let f=c.selection||[];Array.isArray(f)||(f=[f]);for(let p of f){if(!p||!h)continue;let g=p["@id"]||p.id,m=g?this.vault.getSelectionKey(g,A.generateSelectionUUID()):A.generateSelectionUUID();i.add(m);let y=p.note||[];Array.isArray(y)||(y=[y]);for(let S of y){if(!S)continue;let k=S["@value"]||S.text||S["https://schema.org/text"]||"",T=S.html||S["https://tropy.org/v1/tropy#html"]||"";if(typeof k=="object"&&(k=k["@value"]||""),typeof T=="object"&&(T=T["@value"]||""),!this._isSyncedNote(k,T)&&(k||T)){let j=S["@id"]||S.id,Te=j?this.vault.getNoteKey(j,A.generateNoteUUID()):A.generateNoteUUID();r.add(`${m}:${Te}`)}}let b=p.transcription||[];Array.isArray(b)||(b=[b]),b.forEach((S,k)=>{if(!S)return;let T=S["@id"]||S.id,j=T?this.vault.getTxKey(T,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();n.add(j)})}}let l=s.lists||[];if(Array.isArray(l))for(let c of l){let h=this._listNameCache.get(c)||this._listNameCache.get(String(c));h&&o.add(h)}return{noteKeys:t,selectionKeys:i,transcriptionKeys:n,selectionNoteKeys:r,listNames:o}},saveItemSnapshot(s,e,t,i){let n=Array.from(this._resolveTagNames(s));if(i&&i.noteKeys&&i.selectionKeys&&i.transcriptionKeys){let r=this._resolveListNames(s);this.previousSnapshot.set(e,{tags:n,noteKeys:i.noteKeys.noteKeys,selectionNoteKeys:i.noteKeys.selectionNoteKeys,selectionKeys:i.selectionKeys,transcriptionKeys:i.transcriptionKeys,listNames:r})}else{let r=this._computeItemKeys(s,t);this.previousSnapshot.set(e,{tags:n,...r})}},_resolveListNames(s){let e=new Set,t=s.lists||[];if(Array.isArray(t))for(let i of t){let n=this._listNameCache.get(i)||this._listNameCache.get(String(i));n&&e.add(n)}return e},_resolveTagNames(s){return new Set((s.tag||[]).map(e=>typeof e=="string"?e:e.name||"").filter(Boolean))},pushDeletions(s,e,t,i,n,r){if(!this.options.syncDeletions)return;let o=this.previousSnapshot.get(e);if(!o)return;if(this.options.syncTags){let l=this._resolveTagNames(s);for(let c of o.tags)l.has(c)||I.removeTag(this.doc,e,c,t,r)}let a;if(n&&n.noteKeys&&n.selectionKeys&&n.transcriptionKeys){let l=this._resolveListNames(s);a={noteKeys:n.noteKeys.noteKeys,selectionNoteKeys:n.noteKeys.selectionNoteKeys,selectionKeys:n.selectionKeys,transcriptionKeys:n.transcriptionKeys,listNames:l}}else a=this._computeItemKeys(s,i);if(this.options.syncNotes&&o.noteKeys)for(let l of o.noteKeys)a.noteKeys.has(l)||I.removeNote(this.doc,e,l,t,r);if(this.options.syncSelections&&o.selectionKeys)for(let l of o.selectionKeys)a.selectionKeys.has(l)||I.removeSelection(this.doc,e,l,t,r);if(this.options.syncTranscriptions&&o.transcriptionKeys)for(let l of o.transcriptionKeys)a.transcriptionKeys.has(l)||I.removeTranscription(this.doc,e,l,t,r);if(this.options.syncNotes&&o.selectionNoteKeys){for(let l of o.selectionNoteKeys)if(!a.selectionNoteKeys.has(l)){let c=l.indexOf(":");if(c>0){let h=l.slice(0,c),u=l.slice(c+1);I.removeSelectionNote(this.doc,e,h,u,t,r)}}}if(o.listNames&&this.options.syncLists){for(let l of o.listNames)if(!a.listNames.has(l)){let c=this.vault.getListKey(l);c&&I.removeListMembership(this.doc,e,c,t,r)}}},_isSyncedNote(s,e){return e?!!(e.includes("<blockquote><p><em>troparcel:")||e.includes("<p><strong>[troparcel:")):!1},_expandJsonLdItem(s,e){if(!e)return s;let t={};for(let[i,n]of Object.entries(s)){if(i.startsWith("@")){t[i]=n;continue}if(i.includes("/")){t[i]=n;continue}if(["photo","template","list","lists","tag","note","selection","transcription","id","type"].includes(i)){t[i]=n;continue}if(i.includes(":")){let[o,a]=i.split(":",2),l=e[o];typeof l=="string"&&l.includes("/")?t[l+a]=n:t[i]=n;continue}let r=e[i];if(r){let o=typeof r=="string"?r:r["@id"]||null;if(o){typeof r=="object"&&r["@type"]&&typeof n=="string"?t[o]={"@value":n,"@type":r["@type"]}:t[o]=n;continue}}if(e["@vocab"]){t[e["@vocab"]+i]=n;continue}t[i]=n}return t},pushItems(s,e){if(!this.doc)return;let t=this._stableUserId,i=this.vault.nextPushSeq();this.doc.transact(()=>{for(let n of s){let r=e?this._expandJsonLdItem(n,e):n,o=A.computeIdentity(r);if(!o)continue;let a=A.buildPhotoChecksumMap(r);this.pushMetadata(r,o,t,i),this.pushTags(r,o,t,i),this.pushNotes(r,o,t,a,i),this.pushPhotoMetadata(r,o,t,i),this.pushSelections(r,o,t,a,i),this.pushTranscriptions(r,o,t,a,i),this.options.syncLists&&this.pushLists(r,o,t,i)}},this.LOCAL_ORIGIN)}}});var kc=E((Ug,xc)=>{"use strict";var wp=new Set(["p","br","em","i","strong","b","u","s","a","ul","ol","li","blockquote","hr","h1","h2","h3","h4","h5","h6","code","pre","sup","sub","span","div"]),_p=new Set(["script","style","iframe","object","embed","form","input","textarea","select","button","link","meta","base","applet","math","svg","template","noscript","xmp","listing","plaintext","noembed","noframes"]),bc={a:new Set(["href","title"]),"*":new Set(["class","style"])},bp={"text-decoration":new Set(["underline","overline","line-through","none"]),"text-align":new Set(["left","right","center","justify","end","start"])},Sp=new Set(["http:","https:","mailto:"]);function xp(s){if(!s||typeof s!="string")return"";let e="",t=0,i=s.length;for(;t<i;){let n=s.indexOf("<",t);if(n===-1){e+=s.slice(t);break}if(n>t&&(e+=s.slice(t,n)),s.slice(n,n+4)==="<!--"){let u=s.indexOf("-->",n+4);t=u===-1?i:u+3;continue}let r=kp(s,n);if(!r){e+="&lt;",t=n+1;continue}let{tagName:o,isClosing:a,isSelfClosing:l,attrs:c,end:h}=r;if(_p.has(o)&&!a){let u="</"+o,d=h,f=-1;for(;d<i;){let p=s.indexOf("</",d);if(p===-1)break;let g=s.slice(p+2,p+2+o.length+1);if(g.toLowerCase().startsWith(o)&&(g[o.length]===">"||/\s/.test(g[o.length]))){f=p;break}d=p+2}if(f!==-1){let p=s.indexOf(">",f);t=p===-1?i:p+1}else t=i;continue}if(!wp.has(o)){t=h;continue}if(a)e+=`</${o}>`;else{let u=vp(c,o);e+=`<${o}${u}${l?" /":""}>`}t=h}return e}function kp(s,e){let t=e+1,i=s.length;if(t>=i)return null;let n=!1;if(s[t]==="/"&&(n=!0,t++),t>=i||!/[a-zA-Z]/.test(s[t]))return null;let r=t;for(;t<i&&/[a-zA-Z0-9]/.test(s[t]);)t++;if(t-r>32)return null;let o=s.slice(r,t).toLowerCase();if(!o)return null;let a=[];if(n)for(;t<i&&s[t]!==">";)t++;else for(;t<i;){for(;t<i&&/\s/.test(s[t]);)t++;if(t>=i||s[t]===">"||s[t]==="/"&&t+1<i&&s[t+1]===">")break;let c=t;for(;t<i&&/[a-zA-Z0-9_\-:]/.test(s[t]);)t++;let h=s.slice(c,t).toLowerCase();if(!h){t++;continue}for(;t<i&&/\s/.test(s[t]);)t++;let u="";if(t<i&&s[t]==="="){for(t++;t<i&&/\s/.test(s[t]);)t++;if(t<i&&(s[t]==='"'||s[t]==="'")){let d=s[t];t++;let f=t;for(;t<i&&s[t]!==d;)t++;u=s.slice(f,t),t<i&&t++}else{let d=t;for(;t<i&&!/[\s>]/.test(s[t]);)t++;u=s.slice(d,t)}}a.push({name:h,value:u})}let l=!1;if(t<i&&s[t]==="/"&&(l=!0,t++),t<i&&s[t]===">")t++;else{let c=s.indexOf(">",t);t=c===-1?i:c+1}return{tagName:o,isClosing:n,isSelfClosing:l,attrs:a,end:t}}function vp(s,e){let t=bc[e]||new Set,i=bc["*"]||new Set,n="";for(let{name:r,value:o}of s){if(r.startsWith("on")||r.startsWith("data-")||!t.has(r)&&!i.has(r))continue;let a=Ip(o);if(!(r==="href"&&(a=Up(a),!a))){if(r==="style"){let l=Ap(a);if(!l)continue;n+=` style="${Sc(l)}"`;continue}n+=` ${r}="${Sc(a)}"`}}return n}var Tp={lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};function Ip(s){return s.replace(/&(?:#x([0-9a-fA-F]+)|#(\d+)|(lt|gt|amp|quot|apos));/g,(e,t,i,n)=>{if(t){let r=parseInt(t,16);return r>0&&r<1114111?String.fromCodePoint(r):""}if(i){let r=parseInt(i,10);return r>0&&r<1114111?String.fromCodePoint(r):""}return Tp[n]})}function Ap(s){if(!s)return"";let e=[];for(let t of s.split(";")){let i=t.trim();if(!i)continue;let n=i.indexOf(":");if(n<0)continue;let r=i.slice(0,n).trim().toLowerCase(),o=i.slice(n+1).trim().toLowerCase(),a=bp[r];a&&a.has(o)&&e.push(`${r}: ${o}`)}return e.join("; ")}function Up(s){if(!s)return"";let e=s.trim().replace(/[\x00-\x1f\x7f]/g,"");if(e=e.replace(/\s+/g,""),e.startsWith("//"))return"";if(e.startsWith("/")||e.startsWith("#")||e.startsWith("?"))return e;try{let t=new URL(e);return Sp.has(t.protocol)?e:""}catch{return/^[a-z][a-z0-9+.-]*:/i.test(e)?"":e}}function Sc(s){return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Cp(s){return!s||typeof s!="string"?"":s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}xc.exports={sanitizeHtml:xp,escapeHtml:Cp}});var Tc=E((Cg,vc)=>{"use strict";var He=Gt(),ce=Pi(),{sanitizeHtml:Fr,escapeHtml:Yt}=kc();vc.exports={_writeDelay(){return this.adapter?Promise.resolve():new Promise(s=>setTimeout(s,this.options.writeDelay))},_applyStrikethrough(s){return s.replace(/(<(?:p|li|h[1-6])>)/gi,'$1<span style="text-decoration: line-through">').replace(/(<\/(?:p|li|h[1-6])>)/gi,"</span>$1")},async applyRemoteAnnotations(s,e,t,i){let n=e.localId,r=this._stableUserId;this._debug(`applyAnnotations: item ${n}, identity ${s.slice(0,8)}...`);let o=this._applyStats,a=o?o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted:0;await this.applyMetadata(s,n,r,e.item),await this._writeDelay(),await this.applyTags(s,n,r,t,e.item),await this._writeDelay(),await this.applyNotes(s,e,r),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applyPhotoMetadata(s,e,r),await this._writeDelay()),await this.applySelections(s,e,r),await this._writeDelay(),await this.applySelectionNotes(s,e,r),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applySelectionMetadata(s,e,r),await this._writeDelay()),await this.applyTranscriptions(s,e,r),this.options.syncLists&&(await this._writeDelay(),await this.applyLists(s,e,r,i)),o&&(o.itemsProcessed++,o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted>a&&o.itemsChanged++)},async applyMetadata(s,e,t,i){if(!this.options.syncMetadata)return;let n=ce.getMetadata(this.doc,s),r={};for(let[a,l]of Object.entries(n)){if(l.author===t)continue;let c=i[a];if(c!=null){let h=typeof c=="object"?c["@value"]||c.text||"":String(c);if(h===(l.text||""))continue;let u=this.vault._fastHash(`${h}|${l.type||""}`);if(this.vault.hasLocalEdit(s,a,u))continue}r[a]={text:l.text,type:l.type}}let o=Object.keys(r);if(o.length>0)try{await this.api.saveMetadata(e,r),this._applyStats&&(this._applyStats.metadataUpdated+=o.length),this._debug(`metadata: ${o.length} field(s) on item ${e}`)}catch(a){this.logger.warn(`Failed to save metadata batch on ${e}`,{error:a.message})}},async applyTags(s,e,t,i,n){if(!this.options.syncTags)return;let r=new Set,o=n.tag||[];for(let c of o)c&&c.name&&r.add(c.name);let a=ce.getActiveTags(this.doc,s);for(let c of a){if(c.author===t||r.has(c.name))continue;let h=i.get(c.name);if(!h)try{let u=await this.api.createTag(c.name,c.color,[e]);r.add(c.name),u&&(u.id||u.tag_id)&&i.set(c.name,u),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag created: "${c.name}" on item ${e}`);continue}catch(u){this.logger.warn(`Failed to create tag "${c.name}"`,{error:u.message});continue}try{await this.api.addTagsToItem(e,[h.id||h.tag_id]),r.add(c.name),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag added: "${c.name}" on item ${e}`)}catch(u){this.logger.warn(`Failed to add tag "${c.name}" to item ${e}`,{error:u.message})}}if(!this.options.syncDeletions)return;let l=ce.getDeletedTags(this.doc,s);for(let c of l){if(c.author===t||!r.has(c.name)||this.vault.dismissedKeys.has(`tag:${c.name}:${s}`))continue;let h=i.get(c.name);if(h)try{await this.api.removeTagsFromItem(e,[h.id||h.tag_id])}catch(u){this.logger.warn(`Failed to remove tag "${c.name}" from item ${e}`,{error:u.message})}}},_buildExistingNoteTexts(s){let e=new Set;for(let t of s){if(t&&t.text){e.add(t.text.trim());let i=t.text.replace(/^troparcel:\s*[^\n]*\n?/,"").replace(/^\[(?:troparcel:)?[^\]]{1,80}\]\s*/,"").trim();i&&e.add(i)}if(t&&t.html){e.add(t.html.trim());let i=t.html.replace(/^<blockquote><p><em>troparcel:[^<]*<\/em><\/p><\/blockquote>/,"").replace(/^<p><strong>\[[^\]]*\]<\/strong><\/p>/,"").trim();i&&e.add(i)}}return e},async _applyRemoteNote(s,e,t,i,n,r){let o=e.html?Fr(e.html):`<p>${Yt(e.text)}</p>`;if(o=`<blockquote><p><em>troparcel: ${Yt(e.author||"unknown")}</em></p></blockquote>${o}`,i.has(o.trim()))return this.vault.appliedNoteKeys.add(s),this._applyStats&&this._applyStats.notesDeduped++,!1;let l=this.vault.getLocalNoteId(s);if(l)try{if(this.adapter){let c=await this.adapter.updateNote(l,{html:o});c&&(c.id||c["@id"])&&(this.vault.appliedNoteKeys.add(s),this.vault.mapAppliedNote(s,c.id||c["@id"]))}else await this.api.updateNote(l,{html:o}),this.vault.appliedNoteKeys.add(s);return this._applyStats&&this._applyStats.notesUpdated++,this._debug(`${r} updated: ${s.slice(0,8)}`),!0}catch(c){this.logger.warn(`${r} update failed for ${s.slice(0,8)}, falling through to create`,{error:String(c.message||c)})}try{let c,h={html:o,language:e.language,photo:t.photo||null,selection:t.selection||null};if(this.adapter?c=await this.adapter.createNote(h):c=await this.api.createNote(h),c&&(c.id||c["@id"]))return this.vault.mapAppliedNote(s,c.id||c["@id"]),this.vault.appliedNoteKeys.add(s),i.add(o.trim()),this._applyStats&&this._applyStats.notesCreated++,this._debug(`${r} created: ${s.slice(0,8)} by ${e.author}`),!0;this.logger.warn({...t,noteKey:s.slice(0,8),author:e.author},`${r}.create returned null`),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}catch(c){this.logger.warn(`Failed to create ${r}`,{error:c.message,...t,noteKey:s.slice(0,8)}),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}return!1},async applyNotes(s,e,t){if(!this.options.syncNotes)return;let i=e.localId,n=e.item.photo||[];Array.isArray(n)||(n=[n]);let r=[];for(let h of n)for(let u of h.note||[])r.push(u);let o=this._buildExistingNoteTexts(r),a=ce.getNotes(this.doc,s),l={},c={};for(let[h,u]of Object.entries(a))u.deleted?c[h]=u:l[h]=u;for(let[h,u]of Object.entries(l)){if(u.author===t||!u.html&&!u.text)continue;if(this.vault.appliedNoteKeys.has(h)){let f=this.vault.getLocalNoteId(h);if(f&&this.adapter)if(!this.adapter._getState().notes[f])this.vault.appliedNoteKeys.delete(h),this._debug(`note ${h.slice(0,8)}: local note ${f} deleted, allowing re-apply`);else continue;else continue}let d=null;if(u.photo){for(let f of n)if(f.checksum===u.photo){d=f["@id"]||f.id;break}if(!d)continue}else if(d=n[0]&&(n[0]["@id"]||n[0].id),!d)continue;await this._applyRemoteNote(h,u,{photo:Number(d)||null},o,t,"note")}for(let[h,u]of Object.entries(c)){if(u.author===t||this.vault.dismissedKeys.has(h))continue;let d=this.vault.getLocalNoteId(h);if(!d)continue;let f=Yt(u.author||"unknown"),p=u.html?Fr(u.html):u.text?`<p>${Yt(u.text)}</p>`:"",g=`<blockquote><p><em>troparcel: ${f} [retracted]</em></p></blockquote>${this._applyStrikethrough(p)}`;try{let m=!1;if(this.adapter){let y=await this.adapter.updateNote(d,{html:g});y&&(y.id||y["@id"])&&(this.vault.mapAppliedNote(h,y.id||y["@id"]),m=!0)}else this._debug(`note retraction skipped (no adapter) for ${h.slice(0,8)}`),this.vault.appliedNoteKeys.add(h);m&&(this.vault.appliedNoteKeys.add(h),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`note retracted: ${h.slice(0,8)} by ${u.author}`))}catch(m){this.logger.warn(`Failed to retract note ${h.slice(0,8)}`,{error:String(m.message||m)})}}},async applyPhotoMetadata(s,e,t){let i=e.item.photo||[];Array.isArray(i)||(i=[i]);for(let n of i){let r=n.checksum,o=n["@id"]||n.id;if(!r||!o)continue;let a=ce.getPhotoMetadata(this.doc,s,r),l=n.metadata||{},c={};for(let[u,d]of Object.entries(a)){if(d.author===t)continue;let f=l[u];if(f!=null){let p=typeof f=="object"?f["@value"]||f.text||"":String(f);if(p===(d.text||""))continue;let g=this.vault._fastHash(`${p}|${d.type||""}`);if(this.vault.hasLocalEdit(s,`photo:${r}:${u}`,g))continue}c[u]={text:d.text,type:d.type}}let h=Object.keys(c);if(h.length>0)try{await this.api.saveMetadata(o,c),this._applyStats&&(this._applyStats.metadataUpdated+=h.length)}catch(u){this.logger.warn("Failed to save photo metadata batch",{error:u.message})}}},async applySelections(s,e,t){if(!this.options.syncSelections)return;let i=ce.getActiveSelections(this.doc,s),n=e.item.photo||[];Array.isArray(n)||(n=[n]);let r=new Set;for(let o of n){if(!o.checksum)continue;let a=o.selection||[];Array.isArray(a)||(a=[a]);for(let l of a)l&&r.add(He.computeSelectionFingerprint(o.checksum,l))}for(let[o,a]of Object.entries(i)){if(a.author===t||this.vault.appliedSelectionKeys.has(o))continue;let l=Number(a.x),c=Number(a.y),h=Number(a.w),u=Number(a.h);if(!Number.isFinite(l)||!Number.isFinite(c)||!Number.isFinite(h)||!Number.isFinite(u)||h<=0||u<=0){this._log(`Skipping selection ${o}: invalid coordinates`,{x:l,y:c,w:h,h:u});continue}let d=null;for(let g of n)if(g.checksum===a.photo){d=g["@id"]||g.id;break}if(!d)continue;let f=He.computeSelectionFingerprint(a.photo,a);if(r.has(f)){for(let g of n){if(g.checksum!==a.photo)continue;let m=g.selection||[];Array.isArray(m)||(m=[m]);for(let y of m){if(!y)continue;if(He.computeSelectionFingerprint(g.checksum,y)===f){let S=y["@id"]||y.id;S&&this.vault.mapAppliedSelection(o,S);break}}}this.vault.appliedSelectionKeys.add(o)}else try{let g;if(this.adapter?g=await this.adapter.createSelection({photo:Number(d),x:l,y:c,width:h,height:u,angle:a.angle||0}):g=await this.api.createSelection({photo:Number(d),x:l,y:c,width:h,height:u,angle:a.angle||0}),g&&(g.id||g["@id"])){let m=g.id||g["@id"];this.vault.mapAppliedSelection(o,m)}this.vault.appliedSelectionKeys.add(o),this._applyStats&&this._applyStats.selectionsCreated++,this._debug(`selection created: ${o.slice(0,8)} on photo ${d}`)}catch(g){this.logger.warn(`Failed to create selection on photo ${d}`,{error:g.message})}}},async applySelectionNotes(s,e,t){if(!this.options.syncNotes)return;let i=e.item.photo||[];Array.isArray(i)||(i=[i]);let n=ce.getAllSelectionNotes(this.doc,s),r=new Map;for(let[o,a]of Object.entries(n)){if(!a.deleted)continue;let l=o.indexOf(":");if(l>0){let c=o.slice(0,l);r.has(c)||r.set(c,[]),r.get(c).push([o,a])}}for(let o of i){let a=o.checksum;if(!a)continue;let l=o.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=this._buildExistingNoteTexts(c.note||[]),u=c["@id"]||c.id,d=u?this.vault.getSelectionKey(u,He.generateSelectionUUID()):He.computeSelectionFingerprint(a,c),f=ce.getSelectionNotes(this.doc,s,d);for(let[g,m]of Object.entries(f))if(m.author!==t&&!(!m.html&&!m.text)){if(this.vault.appliedNoteKeys.has(g)){let y=this.vault.getLocalNoteId(g);if(y&&this.adapter)if(!this.adapter._getState().notes[y])this.vault.appliedNoteKeys.delete(g),this._debug(`sel note ${g.slice(0,8)}: local note ${y} deleted, allowing re-apply`);else continue;else continue}u&&await this._applyRemoteNote(g,m,{selection:Number(u)||null},h,t,"sel note")}let p=r.get(d)||[];for(let[g,m]of p){if(m.author===t||this.vault.dismissedKeys.has(g))continue;let y=this.vault.getLocalNoteId(g);if(!y)continue;let b=Yt(m.author||"unknown"),S=m.html?Fr(m.html):m.text?`<p>${Yt(m.text)}</p>`:"",k=`<blockquote><p><em>troparcel: ${b} [retracted]</em></p></blockquote>${this._applyStrikethrough(S)}`;try{let T=!1;if(this.adapter){let j=await this.adapter.updateNote(y,{html:k});j&&(j.id||j["@id"])&&(this.vault.mapAppliedNote(g,j.id||j["@id"]),T=!0)}else this._debug(`sel note retraction skipped (no adapter) for ${g.slice(0,8)}`),this.vault.appliedNoteKeys.add(g);T&&(this.vault.appliedNoteKeys.add(g),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`sel note retracted: ${g.slice(0,8)} by ${m.author}`))}catch(T){this.logger.warn(`Failed to retract sel note ${g.slice(0,8)}`,{error:String(T.message||T)})}}}}},async applySelectionMetadata(s,e,t){let i=e.item.photo||[];Array.isArray(i)||(i=[i]);for(let n of i){let r=n.checksum;if(!r)continue;let o=n.selection||[];Array.isArray(o)||(o=[o]);for(let a of o){if(!a)continue;let l=a["@id"]||a.id,c=l?this.vault.getSelectionKey(l,He.generateSelectionUUID()):He.computeSelectionFingerprint(r,a);if(!l)continue;let h=ce.getSelectionMeta(this.doc,s,c),u=a.metadata||{},d={};for(let[p,g]of Object.entries(h)){if(g.author===t)continue;let m=u[p];if(m!=null){let y=typeof m=="object"?m["@value"]||m.text||"":String(m);if(y===(g.text||""))continue;let b=this.vault._fastHash(`${y}|${g.type||""}`);if(this.vault.hasLocalEdit(s,`selmeta:${c}:${p}`,b))continue}d[p]={text:g.text,type:g.type}}let f=Object.keys(d);if(f.length>0)try{await this.api.saveMetadata(l,d),this._applyStats&&(this._applyStats.metadataUpdated+=f.length)}catch(p){this.logger.warn("Failed to save selection metadata",{error:p.message})}}}},async applyTranscriptions(s,e,t){if(!this.options.syncTranscriptions)return;let i=ce.getActiveTranscriptions(this.doc,s),n=e.item.photo||[];Array.isArray(n)||(n=[n]);let r=new Map,o=new Map;for(let a of n)if(a.checksum){r.set(a.checksum,a["@id"]||a.id);let l=a.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=c["@id"]||c.id;if(h){let u=this.vault.getSelectionKey(h,He.generateSelectionUUID());o.set(u,h)}}}for(let[a,l]of Object.entries(i)){if(l.author===t||!l.text&&!l.data||this.vault.appliedTranscriptionKeys.has(a))continue;let c=r.get(l.photo)||null;if(!c)continue;let h=l.selection&&o.get(l.selection)||null,u=this.vault.getLocalTxId(a);if(u)try{let d=null;try{d=await this.api.getTranscription(u)}catch{}try{await this.api.deleteTranscription(u)}catch(p){this.logger.warn(`Failed to delete transcription ${u}`,{error:String(p.message||p)})}let f=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});if(f&&(f.id||f["@id"]))this.vault.mapAppliedTranscription(a,f.id||f["@id"]),this.vault.appliedTranscriptionKeys.add(a);else if(d){this.logger.warn(`Transcription update returned null for ${a.slice(0,8)}, restoring original`);try{let p=await this.api.createTranscription({text:d.text||"",data:d.data||null,photo:Number(c)||null,selection:h?Number(h):null});p&&(p.id||p["@id"])&&this.vault.mapAppliedTranscription(a,p.id||p["@id"])}catch(p){this.logger.warn(`Transcription restore also failed for ${a.slice(0,8)}`,{error:String(p.message||p)})}}continue}catch(d){this.logger.warn(`Failed to update transcription ${a.slice(0,8)}`,{error:String(d.message||d)})}try{let d=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});d&&(d.id||d["@id"])&&(this.vault.mapAppliedTranscription(a,d.id||d["@id"]),this.vault.appliedTranscriptionKeys.add(a),this._applyStats&&this._applyStats.transcriptionsCreated++,this._debug(`transcription created: ${a.slice(0,8)} by ${l.author}`))}catch(d){this.logger.warn("Failed to create transcription",{error:d.message})}}},async applyLists(s,e,t,i){let n=ce.getActiveLists(this.doc,s),r=e.localId,o=new Set;for(let a of e.item.lists||[]){let l=this._listNameCache.get(a)||this._listNameCache.get(String(a));l&&o.add(l)}for(let[a,l]of Object.entries(n)){if(l.author===t)continue;let c=l.name||a;if(o.has(c))continue;this.vault.mapAppliedList(a,c);let h=i.get(c);if(h)try{this.adapter?await this.adapter.addItemsToList(h.id,[r]):await this.api.addItemsToList(h.id,[r]),o.add(c),this._applyStats&&this._applyStats.listsAdded++,this._debug(`list add: item ${r} \u2192 "${c}"`)}catch(u){this.logger.warn(`Failed to add item ${r} to list "${c}"`,{error:u.message})}}if(this.options.syncDeletions){let a=ce.getLists(this.doc,s);for(let[l,c]of Object.entries(a)){if(!c.deleted||c.author===t||this.vault.dismissedKeys.has(`list:${l}:${s}`))continue;let h=c.name||l,u=i.get(h);if(u)try{this.adapter?await this.adapter.removeItemsFromList(u.id,[r]):await this.api.removeItemsFromList(u.id,[r])}catch(d){this.logger.warn(`Failed to remove item ${r} from list "${h}"`,{error:d.message})}}}}}});var Ac=E((Eg,Ic)=>{"use strict";var Ng=Gt();Ic.exports={async _enrichAll(s){let e=[],t=5;for(let i=0;i<s.length;i+=t){let n=s.slice(i,i+t),r=await Promise.all(n.map(o=>this.enrichItem(o).catch(a=>(this.logger.warn(`Failed to enrich item ${o.id}`,{error:a.message}),null))));for(let o of r)o&&e.push(o)}return e},async enrichItem(s){let e={"@id":s.id,template:s.template,lists:s.lists||[]},[t,i]=await Promise.all([this.api.getMetadata(s.id).catch(()=>null),this.api.getItemTags(s.id).catch(()=>null)]);if(t)for(let[o,a]of Object.entries(t))o!=="id"&&(typeof a=="object"&&a!==null?e[o]={"@value":a.text||"","@type":a.type||""}:a!=null&&(e[o]=a));i&&Array.isArray(i)&&(e.tag=i.map(o=>({id:o.id||o.tag_id,name:o.name,color:o.color||null}))),e.photo=[];let n=s.photos||[],r=await Promise.all(n.map(o=>this.api.getPhoto(o).catch(()=>null)));for(let o of r){if(!o)continue;let a={"@id":o.id,checksum:o.checksum,note:[],selection:[],transcription:[],metadata:null},l=[];this.options.syncPhotoAdjustments&&l.push(this.api.getMetadata(o.id).catch(()=>null).then(d=>{a.metadata=d}));let c=o.notes||[];for(let d of c)l.push(this.api.getNote(d,"html").catch(()=>null).then(f=>{f!=null&&a.note.push({"@id":d,text:typeof f=="string"?f.replace(/<[^>]*>/g,""):"",html:typeof f=="string"?f:"",language:null,photo:o.id})}));let h=o.selections||[];for(let d of h)l.push(this._enrichSelection(d,o.checksum).then(f=>{f&&a.selection.push(f)}));let u=o.transcriptions||[];for(let d of u)l.push(this.api.getTranscription(d,"json").catch(()=>null).then(f=>{f&&a.transcription.push(f)}));await Promise.all(l),e.photo.push(a)}return e},async _enrichSelection(s,e){try{let t=await this.api.getSelection(s);if(!t)return null;let i={"@id":t.id,x:t.x,y:t.y,width:t.width,height:t.height,angle:t.angle||0,note:[],metadata:null,transcription:[]},n=[];n.push(this.api.getMetadata(s).catch(()=>null).then(a=>{i.metadata=a}));let r=t.notes||[];for(let a of r)n.push(this.api.getNote(a,"html").catch(()=>null).then(l=>{l!=null&&i.note.push({"@id":a,text:typeof l=="string"?l.replace(/<[^>]*>/g,""):"",html:typeof l=="string"?l:"",language:null,selection:t.id})}));let o=t.transcriptions||[];for(let a of o)n.push(this.api.getTranscription(a,"json").catch(()=>null).then(l=>{l&&i.transcription.push(l)}));return await Promise.all(n),i}catch(t){return this.logger.warn("Failed to enrich selection",{error:String(t)}),null}}}});var Nc=E((Dg,Cc)=>{"use strict";var Np=require("fs"),Uc=require("os"),Ep=(Kt(),_t(Pt)),{WebsocketProvider:Dp}=(hl(),_t(cl)),Lp=Yl(),{ApiClient:$p}=Zl(),{StoreAdapter:Mp}=ec(),ve=Gt(),he=Pi(),{BackupManager:Op}=fc(),{SyncVault:Rp}=yc(),Xt=class{constructor(e,t,i=null){this.options=e,this.logger=t,this.debug=e.debug===!0,this.doc=null,this.provider=null,this.api=new $p(e.apiPort,t),this.adapter=i?new Mp(i,t):null,this.backup=null,this.localIndex=new Map,this.previousSnapshot=new Map,this.safetyNetTimer=null,this.unsubscribe=null,this._storeUnsubscribe=null,this.fileWatcher=null,this.projectPath=null,this.state="idle",this.lastSync=null,this.peerCount=0,this._syncing=!1,this._paused=!1,this._consecutiveErrors=0,this._localDebounceTimer=null,this._remoteDebounceTimer=null,this._pendingRemoteIdentities=new Set,this.vault=new Rp,this.vault.loadFromFile(this.options.room),this._applyFailureCount=0,this._failedNoteKeys=new Set,this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._stopping=!1,this._remoteAnnotationsDirty=!0,this._syncLock=Promise.resolve(),this._lastWatcherEvent=0,this._watcherHealthTimer=null,this.LOCAL_ORIGIN="troparcel-local",this._listNameCache=new Map,this._listCacheRefreshedAt=0,this._stableUserId=e.userId||`${Uc.userInfo().username}@${Uc.hostname()}:${e.apiPort||2019}`}_log(e,t){t?this.logger.info(t,`[troparcel] ${e}`):this.logger.info(`[troparcel] ${e}`)}_debug(e,t){this.debug&&(t?this.logger.info(t,`[troparcel:debug] ${e}`):this.logger.info(`[troparcel:debug] ${e}`))}_formatAge(e){let t=Math.floor((Date.now()-e.getTime())/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:`${Math.floor(t/3600)}h ${Math.floor(t%3600/60)}m ago`}_resetApplyStats(){this._applyStats={notesCreated:0,notesDeduped:0,notesUpdated:0,notesRetracted:0,notesFailed:0,tagsAdded:0,tagsDeduped:0,selectionsCreated:0,selectionsDeduped:0,metadataUpdated:0,transcriptionsCreated:0,listsAdded:0,itemsProcessed:0,itemsChanged:0}}_logApplyStats(){let e=this._applyStats;if(!e)return;let t=[];e.notesCreated&&t.push(`${e.notesCreated} notes created`),e.notesUpdated&&t.push(`${e.notesUpdated} notes updated`),e.notesRetracted&&t.push(`${e.notesRetracted} notes retracted`),e.tagsAdded&&t.push(`${e.tagsAdded} tags added`),e.selectionsCreated&&t.push(`${e.selectionsCreated} selections created`),e.metadataUpdated&&t.push(`${e.metadataUpdated} metadata fields`),e.transcriptionsCreated&&t.push(`${e.transcriptionsCreated} transcriptions`),e.listsAdded&&t.push(`${e.listsAdded} list memberships`),e.notesFailed&&t.push(`${e.notesFailed} notes failed`),t.length>0?this._log(`applied: ${t.join(", ")} across ${e.itemsChanged}/${e.itemsProcessed} items`):this._debug(`applied: nothing changed across ${e.itemsProcessed} items`)}readAllItemsFull(){return this.adapter?this.adapter.getAllItemsFull():[]}_acquireLock(){let e,t=this._syncLock;return this._syncLock=new Promise(i=>{e=i}),t.then(()=>e)}async start(e={}){if(!(this.state==="connected"||this.state==="connecting")){this.state="connecting",this.logger.info({server:this.options.serverUrl,room:this.options.room,syncMode:this.options.syncMode},"Sync engine v5.0 (schema v4) starting");try{this.doc=new Ep.Doc;let t=Lp;if(this.provider=new Dp(this.options.serverUrl,this.options.room,this.doc,{connect:!0,params:this.options.roomToken?{token:this.options.roomToken}:{},maxBackoffTime:1e4,resyncInterval:3e4,WebSocketPolyfill:t}),this.provider.on("status",r=>{r.status==="connected"?this.logger.info(`[troparcel] connected to ${this.options.serverUrl}`):r.status==="disconnected"&&this.logger.info("[troparcel] disconnected from server, reconnecting...")}),this.provider.on("connection-error",r=>{this.logger.warn(`[troparcel] connection error: ${r.message||String(r)} \u2014 check that the Troparcel server is running`)}),this.provider.on("connection-close",r=>{r.code!==1e3&&this.logger.info(`[troparcel] connection closed (code: ${r.code}${r.reason?", "+r.reason:""}), reconnecting...`)}),await this.waitForConnection(),he.setSchemaVersion(this.doc),this.provider.awareness&&(this.provider.awareness.setLocalStateField("user",{userId:this._stableUserId,name:this._stableUserId,joinedAt:Date.now()}),this._awarenessHandler=({added:r,updated:o,removed:a})=>{this.peerCount=0,this.provider.awareness.getStates().forEach((l,c)=>{c!==this.doc.clientID&&l.user&&this.peerCount++})},this.provider.awareness.on("change",this._awarenessHandler)),this.backup=new Op(this.options.room,this.api,this.logger,{maxBackups:this.options.maxBackups,maxNoteSize:this.options.maxNoteSize,maxMetadataSize:this.options.maxMetadataSize,tombstoneFloodThreshold:this.options.tombstoneFloodThreshold}),this.options.syncMode==="auto"&&(this.unsubscribe=he.observeAnnotationsDeep(this.doc,r=>{this.handleRemoteChanges(r)},this.LOCAL_ORIGIN)),this._statusHandler=r=>{r.status==="connected"?(this.state="connected",this._log(`reconnected to room "${this.options.room}"`)):r.status==="disconnected"&&this.logger.warn("[troparcel] lost connection, will retry automatically")},this.provider.on("status",this._statusHandler),this.state="connected",this._log(`ready \u2014 room "${this.options.room}", client ${this.doc.clientID}`),!e.skipStartupDelay){let r=this.options.startupDelay;r>0&&await new Promise(o=>setTimeout(o,r))}this.options.clearTombstones&&this.purgeTombstones(),e.skipInitialSync||(await this.syncOnce(),this._log(`initial sync complete \u2014 ${this.localIndex.size} local items indexed, ${this.vault.annotationCount} shared items in CRDT, ${this.peerCount} peer(s) online`)),this.options.autoSync&&!e.skipInitialSync&&await this.startWatching();let i=this.options.safetyNetInterval*1e3;i>0&&(this.safetyNetTimer=setInterval(()=>{this._scheduleSafetyNet()},i)),this._statusLogCount=0;let n=this.debug?3e4:3e5;this._statusLogTimer=setInterval(()=>{this.state==="connected"&&(this._statusLogCount++,this._log(`sync active \u2014 room "${this.options.room}", ${this.peerCount} peer(s), ${this.localIndex.size} local / ${this.vault.annotationCount} shared items`+(this.lastSync?`, last sync ${this._formatAge(this.lastSync)}`:"")))},n)}catch(t){throw this.state="error",this.logger.error({error:t.message,stack:t.stack},"Sync engine failed to start"),t}}}_scheduleSafetyNet(){if(this._consecutiveErrors>0){let t=1-1/Math.min(Math.pow(2,this._consecutiveErrors),16);if(Math.random()<t){this._log(`Safety-net skipped (backoff: ${this._consecutiveErrors} errors)`);return}}this.syncOnce()}async _persistVault(e=!1){if(!(!e&&!this.vault.isDirty))try{await this.vault.persistToFile(this.options.room)}catch(t){this.logger.warn("vault persist failed",{error:t.message})}}async stop(){if(this._stopping=!0,await this._persistVault(!0),this.logger.info("Sync engine stopping"),this._storeUnsubscribe&&(this._storeUnsubscribe(),this._storeUnsubscribe=null),this.stopWatching(),this.safetyNetTimer&&(clearInterval(this.safetyNetTimer),this.safetyNetTimer=null),this._statusLogTimer&&(clearInterval(this._statusLogTimer),this._statusLogTimer=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this._localDebounceTimer&&(clearTimeout(this._localDebounceTimer),this._localDebounceTimer=null),this._remoteDebounceTimer&&(clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.provider&&this.provider.awareness)try{this._awarenessHandler&&(this.provider.awareness.off("change",this._awarenessHandler),this._awarenessHandler=null),this.provider.awareness.setLocalState(null)}catch(e){this._debug("Failed to clean up awareness",{error:e.message})}this.provider&&(this._statusHandler&&(this.provider.off("status",this._statusHandler),this._statusHandler=null),this.provider.destroy(),this.provider=null),this.doc&&(this.doc.destroy(),this.doc=null),this.localIndex.clear(),this.previousSnapshot.clear(),this._pendingRemoteIdentities.clear(),this._listNameCache.clear(),this.vault.clear(),this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._remoteAnnotationsDirty=!1,this.state="idle"}waitForConnection(){return new Promise((e,t)=>{if(this.provider.wsconnected){e();return}let i=r=>{r.status==="connected"&&(clearTimeout(n),this.provider.off("status",i),e())},n=setTimeout(()=>{this.provider.off("status",i),t(new Error("Connection timeout (15s)"))},15e3);this.provider.on("status",i)})}pause(){this._paused=!0,this._log("Sync paused")}resume(){this._paused=!1,this._log("Sync resumed")}async startWatching(){if(this.adapter){if(this._storeUnsubscribe)return;this._log("Using store.subscribe for change detection"),this._storeUnsubscribe=this.adapter.subscribe(()=>{this.handleLocalChange()});return}if(!this.fileWatcher){try{let e=await this.api.getProjectInfo();e&&e.project&&(this.projectPath=e.project,this._log(`Watching project file: ${this.projectPath}`))}catch(e){this._log("Could not get project path, file watching disabled",{error:e.message});return}this.projectPath&&(this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}}_startFileWatcher(){try{this.fileWatcher=Np.watch(this.projectPath,{persistent:!1},e=>{e==="change"&&(this._lastWatcherEvent=Date.now(),this.handleLocalChange())}),this.fileWatcher.on("error",e=>{this._debug("File watcher error",{error:e.message}),this._restartFileWatcher()})}catch(e){this._debug("Could not start file watcher",{error:e.message})}}_restartFileWatcher(){if(this.fileWatcher){try{this.fileWatcher.close()}catch(e){this.logger.warn("Failed to close file watcher",{error:String(e.message||e)})}this.fileWatcher=null}this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this.projectPath&&(this._log("Restarting file watcher"),this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}_checkWatcherHealth(){if(!this.fileWatcher)return;Date.now()-this._lastWatcherEvent>5*60*1e3&&(this.logger.info("File watcher silent for >5min, restarting"),this._restartFileWatcher())}stopWatching(){this.fileWatcher&&(this.fileWatcher.close(),this.fileWatcher=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null)}handleLocalChange(){if(!this._paused&&!this._stopping){if(this._applyingRemote){this._queuedLocalChange=!0,this._debug("handleLocalChange: queued (applying remote)");return}this._localDebounceTimer||this._debug("handleLocalChange: store change detected, debouncing"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this._debug("handleLocalChange: debounce fired"),this.syncOnce()},this.options.localDebounce)}}handleRemoteChanges(e){this._remoteAnnotationsDirty=!0;for(let t of e)this._pendingRemoteIdentities.add(t.identity);this._remoteDebounceTimer&&clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=setTimeout(()=>{this._remoteDebounceTimer=null,this.applyPendingRemote()},this.options.remoteDebounce)}async applyPendingRemote(){if(this._paused||this._pendingRemoteIdentities.size===0)return;if(this.localIndex.size===0){this._debug("applyPendingRemote: localIndex empty, deferring");return}let e=await this._acquireLock();try{let t=Array.from(this._pendingRemoteIdentities);this._pendingRemoteIdentities.clear();let i=null;try{i=this.adapter?this.adapter.getAllTags():await this.api.getTags()}catch(o){this.logger.warn("applyPendingRemote: failed to fetch tags",{error:String(o.message||o)})}let n=new Map;if(i&&Array.isArray(i))for(let o of i)n.set(o.name,o);let r=new Map;if(this.options.syncLists)try{let o=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(o))for(let a of o)r.set(a.name,a)}catch(o){this.logger.warn("applyPendingRemote: failed to fetch lists",{error:String(o.message||o)})}if(this.adapter){let o=this.readAllItemsFull();o.length>0&&(this.localIndex=ve.buildIdentityIndex(o))}await this._refreshListNameCache(),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();try{let o=new Set,a=new Set;for(let l of t){let c=ve.findLocalMatch(l,this.localIndex);if(c){if(a.add(l),o.add(c.localId),this.backup){let h=he.getItemSnapshot(this.doc,l);if(h){let u=this.backup.validateInbound(l,h,this._stableUserId);if(!u.valid){for(let d of u.warnings)this.logger.warn(`applyPendingRemote validation: ${d}`);continue}}}try{await this.applyRemoteAnnotations(l,c,n,r)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}for(let l of t){if(a.has(l))continue;let c=this._fuzzyMatchLocal(l);if(c&&!o.has(c.local.localId)){if(o.add(c.local.localId),this.backup){let h=he.getItemSnapshot(this.doc,l);if(h&&!this.backup.validateInbound(l,h,this._stableUserId).valid)continue}try{await this.applyRemoteAnnotations(l,c.local,n,r)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}finally{e()}}async syncOnce(){if(this.state!=="connected"||!this.doc||this._paused||this._stopping)return;if(this._syncing){this._syncRequested=!0;return}this._syncing=!0;let e=await this._acquireLock();if(this.state!=="connected"||!this.doc||this._paused||this._stopping){this._syncing=!1,e();return}let t=this.state;this.state="syncing";try{this._debug("syncOnce: starting cycle");let i;if(this.adapter){if(i=this.readAllItemsFull(),i.length===0){this._debug("syncOnce: no items in store"),this.state=t;return}this._debug(`syncOnce: got ${i.length} items from store`)}else{if(!await this.api.ping()){this._debug("syncOnce: API not reachable, skipping"),this.state=t;return}let c=await this.api.getItems();if(!c||!Array.isArray(c)){this._debug("syncOnce: no items from API"),this.state=t;return}this._debug(`syncOnce: got ${c.length} item summaries`),i=await this._enrichAll(c)}let n=new Set(this.localIndex.keys());if(this.localIndex=ve.buildIdentityIndex(i),this._debug(`syncOnce: ${i.length} items, ${this.localIndex.size} identities`),!this._remoteAnnotationsDirty&&n.size>0){for(let l of this.localIndex.keys())if(!n.has(l)){this._remoteAnnotationsDirty=!0,this._debug("syncOnce: new local identities detected, forcing apply");break}}await this._refreshListNameCache();let r=new Set,o=!1;if(this.options.syncMode==="auto"){let l=this.doc.getMap("annotations");if(this.vault.updateAnnotationCount(l.size),o=this._remoteAnnotationsDirty,o){if(this._debug("syncOnce: CRDT changed, applying remote"),r=await this.applyRemoteFromCRDT(),r.size>0){if(this.adapter){let c=new Set;for(let h of r){let u=this.localIndex.get(h);u&&c.add(u.localId)}i=i.map(h=>{let u=h["@id"]||h.id;return c.has(u)&&this.adapter.getItemFull(u)||h})}else{let c=await this.api.getItems();if(c&&Array.isArray(c)){let h=c.filter(u=>{let d=ve.computeIdentity({"@id":u.id,template:u.template,photo:[]});return d&&r.has(d)});if(h.length===0&&r.size>0)i=await this._enrichAll(c);else if(h.length>0){let u=await this._enrichAll(h),d=new Map;for(let f of u){let p=ve.computeIdentity(f);p&&d.set(p,f)}i=i.map(f=>{let p=ve.computeIdentity(f);return p&&d.has(p)?d.get(p):f})}}}this.localIndex=ve.buildIdentityIndex(i)}}else this._debug("syncOnce: CRDT unchanged, skip apply")}if(this.options.syncMode!=="pull"){let l=this.vault.nextPushSeq();this.adapter&&this.adapter.suppressChanges();try{await this.pushLocal(i,l)}finally{this.adapter&&this.adapter.resumeChanges()}}let a=!1;if(this._applyStats&&this._applyStats.notesFailed>0){let l=new Set(this._failedNoteKeys);this._failedNoteKeys.clear();let c=0;for(let u of l){let d=(this.vault.failedNoteKeys.get(u)||0)+1;this.vault.failedNoteKeys.set(u,d),d>=3&&(this.vault.appliedNoteKeys.add(u),this.vault.failedNoteKeys.delete(u),this._debug(`note key ${u.slice(0,8)} permanently given up after ${d} retries`),c++)}let h=this._applyStats.notesFailed-c;h>0&&(a=!0,this._debug(`apply had ${this._applyStats.notesFailed} note failures, ${h} will retry next cycle`))}else this._applyStats&&this._failedNoteKeys.clear();this.options.syncMode==="auto"&&!a&&(this._remoteAnnotationsDirty=!1),this.vault.pruneAppliedKeys(),this.vault.markDirty(),await this._persistVault(),this.vault._evictIfNeeded(this.previousSnapshot,5e3),this.lastSync=new Date,this._consecutiveErrors=0,this.state="connected",this._debug("syncOnce: cycle complete")}catch(i){this._consecutiveErrors++;let n=i instanceof Error?i.message:String(i||"");i&&(i.sqliteBusy||n.includes("SQLITE_BUSY"))?this.logger.warn({consecutiveErrors:this._consecutiveErrors},"Database busy, will back off"):this.logger.warn({error:n,stack:i&&i.stack},"Sync cycle failed"),this.state=t==="connected"?"connected":"error"}finally{this._syncing=!1,e();let i=this._queuedLocalChange||this._syncRequested;this._queuedLocalChange=!1,this._syncRequested=!1,i&&(this._debug("replaying queued sync trigger (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}_logConflict(e,t,i,n){this.logger.info({event:"conflict",type:e,identity:t.slice(0,8),field:i,...n},`[troparcel] Conflict: ${e} ${i} on ${t.slice(0,8)}`)}_fuzzyMatchLocal(e){if(this.localIndex.size===0||!this.doc)return null;let t=he.getItemChecksums(this.doc,e);if(t.length===0)return null;let i=new Set(t),n=null,r=0;for(let[o,a]of this.localIndex){let l=a.item.photo||[];Array.isArray(l)||(l=[l]);let c=new Set;for(let f of l)f.checksum&&c.add(f.checksum);if(c.size===0)continue;let h=0;for(let f of i)c.has(f)&&h++;if(h===0)continue;let u=new Set([...i,...c]).size,d=h/u;d>r&&d>=.5&&(r=d,n={local:a,localIdentity:o,checksumCount:h,score:d})}return n}async applyRemoteFromCRDT(){let e=he.getIdentities(this.doc),t=new Set;if(e.length===0)return this._log("applyRemote: CRDT snapshot is empty"),t;this._debug(`applyRemote: scanning ${e.length} CRDT items`);let i=this.adapter?this.adapter.getAllTags():await this.api.getTags(),n=new Map;if(i&&Array.isArray(i))for(let h of i)n.set(h.name,h);let r=new Map;if(this.options.syncLists)try{let h=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(h))for(let u of h)r.set(u.name||String(u.id),u)}catch(h){this.logger.warn("applyRemoteFromCRDT: failed to fetch lists",{error:String(h.message||h)})}this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges();let o=[],a=new Set,l=new Set;for(let h of e){let u=ve.findLocalMatch(h,this.localIndex);if(!u)continue;let d=he.getItemSnapshot(this.doc,h);if(!d)continue;let f=this.backup.validateInbound(h,d,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning for ${h.slice(0,8)}: ${p}`);this.logger.warn(`Skipping apply for ${h.slice(0,8)} \u2014 validation failed`);continue}o.push({itemIdentity:h,local:u}),a.add(h),l.add(u.localId)}let c=e.filter(h=>!a.has(h));for(let h of c){let u=this._fuzzyMatchLocal(h);if(!u){this._debug(`no fuzzy match for CRDT item ${h.slice(0,8)}`);continue}if(l.has(u.local.localId)){this._debug(`fuzzy skip: CRDT ${h.slice(0,8)} \u2192 local ${u.localIdentity.slice(0,8)} (already has exact match)`);continue}this._log(`fuzzy match: CRDT ${h.slice(0,8)} \u2192 local ${u.localIdentity.slice(0,8)} (merged item, ${u.checksumCount} shared photo(s))`);let d=he.getItemSnapshot(this.doc,h);if(!d)continue;this.backup.validateInbound(h,d,this._stableUserId).valid&&(o.push({itemIdentity:h,local:u.local}),l.add(u.local.localId))}if(o.length===0)return this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._debug("applyRemote: no matched items"),t;try{let h=[];for(let{local:u,itemIdentity:d}of o)try{let f=this.adapter?this.backup.captureItemStateFromStore(this.adapter,u.localId,d):await this.backup.captureItemState(u.localId,d);h.push(f)}catch(f){this.logger.warn(`applyRemoteFromCRDT: backup capture failed for ${d.slice(0,8)}`,{error:String(f.message||f)})}h.length>0&&this.vault.shouldBackup(h)&&await this.backup.saveSnapshot(h)}catch(h){this.logger.warn("Batch backup failed",{error:h.message})}this._resetApplyStats();try{for(let{itemIdentity:h,local:u}of o)try{await this.applyRemoteAnnotations(h,u,n,r),t.add(h)}catch(d){this.logger.warn(`Failed to apply remote for ${h}`,{error:d.message})}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}return t}async applyOnDemand(){if(!this.doc)return null;let e=await this._acquireLock();try{return await this._applyOnDemandInner()}finally{e()}}async _applyOnDemandInner(){let e=he.getIdentities(this.doc),t=this._stableUserId,i={},n=this.adapter?this.adapter.getAllTags():await this.api.getTags(),r=new Map;if(n&&Array.isArray(n))for(let h of n)r.set(h.name,h);let o=new Map;if(this.options.syncLists)try{let h=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(h))for(let u of h)o.set(u.name||String(u.id),u)}catch(h){this.logger.warn("applyOnDemand: failed to fetch lists",{error:String(h.message||h)})}for(let h of e){let u=he.getItemSnapshot(this.doc,h);if(u)for(let d of["metadata","tags","notes","selections","transcriptions","lists"]){let f=u[d];if(!(!f||typeof f!="object"))for(let p of Object.values(f))p&&p.author&&p.author!==t&&!p.deleted&&(i[p.author]||(i[p.author]={metadata:0,tags:0,notes:0,selections:0,transcriptions:0,lists:0}),i[p.author][d]++)}}for(let[h,u]of Object.entries(i)){let d=Object.entries(u).filter(([,f])=>f>0).map(([f,p])=>`${p} ${f}`);d.length>0&&this.logger.info(`${h}: ${d.join(", ")}`)}let a=[],l=[];for(let h of e){let u=ve.findLocalMatch(h,this.localIndex);if(!u)continue;let d=he.getItemSnapshot(this.doc,h);if(!d)continue;let f=this.backup.validateInbound(h,d,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning: ${p}`);continue}l.push(h);try{let p=this.adapter?this.backup.captureItemStateFromStore(this.adapter,u.localId,h):await this.backup.captureItemState(u.localId,h);a.push(p)}catch(p){this.logger.warn(`applyOnDemand: backup capture failed for ${h.slice(0,8)}`,{error:String(p.message||p)})}}a.length>0&&this.vault.shouldBackup(a)&&await this.backup.saveSnapshot(a),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();let c=0;try{for(let h of l){let u=ve.findLocalMatch(h,this.localIndex);if(u)try{await this.applyRemoteAnnotations(h,u,r,o),c++}catch(d){this.logger.warn(`Import: failed to apply ${h}`,{error:d.message})}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges()}return{applied:c,summary:i}}async rollback(e){return this.backup.rollback(e,this.adapter)}purgeTombstones(){this.doc&&(this.logger.info("Purging tombstones from CRDT"),this.doc.transact(()=>{let e=he.purgeTombstones(this.doc);this.logger.info(`Purged ${e.purged} tombstone(s) across ${e.items} item(s)`)},this.LOCAL_ORIGIN))}getStatus(){return{state:this.state,lastSync:this.lastSync,room:this.options.room,server:this.options.serverUrl,syncMode:this.options.syncMode,clientId:this.doc?this.doc.clientID:null,localItems:this.localIndex.size,crdtItems:this.vault.annotationCount,peerCount:this.peerCount,watching:this.fileWatcher!=null||this._storeUnsubscribe!=null,storeAvailable:this.adapter!=null,projectPath:this.projectPath,consecutiveErrors:this._consecutiveErrors}}};Object.assign(Xt.prototype,_c());Object.assign(Xt.prototype,Tc());Object.assign(Xt.prototype,Ac());Cc.exports={SyncEngine:Xt}});var{SyncEngine:Vr}=Nc(),Ec=Gt(),Fp=new Set(["auto","review","push","pull"]),jr=class{constructor(e,t){if(this.context=t,this.options=this.mergeOptions(e),this.engine=null,this._isPrefsWindow()){this.context.logger.info("Troparcel: skipping sync in prefs window");return}this.context.logger.info(`Troparcel v5.0 \u2014 server: ${this.options.serverUrl}, mode: ${this.options.syncMode}, user: ${this.options.userId||"(anonymous)"}`),this.options.autoSync?(this.context.logger.info("Troparcel: auto-sync enabled, waiting for project to load..."),this._waitForProjectAndStart()):this.context.logger.info("Troparcel: auto-sync disabled \u2014 use File > Export/Import to sync manually")}_isPrefsWindow(){try{let e=this.context.logger;if(e.chindings&&e.chindings.includes('"name":"prefs"'))return!0;if(typeof e.bindings=="function"){let t=e.bindings();if(t&&t.name==="prefs")return!0}}catch{}return!1}async _waitForProjectAndStart(){let e=Date.now(),t=this.options.startupDelay,i=500;for(;Date.now()-e<t;){try{let r=this.context.window&&this.context.window.store;if(r){let o=r.getState(),a=o&&o.project;if(a&&a.path){let c=Date.now()-e;this.context.logger.info(`Troparcel: store + project available after ${c}ms`),!this.options._roomExplicit&&a.name&&(this.options.room=a.name),this.options.projectPath=a.path;break}let l=Date.now()-e;l>2e3&&l%2e3<i&&this.context.logger.info(`Troparcel: store ready, waiting for project state (${l}ms)`)}}catch{}await new Promise(r=>setTimeout(r,i))}let n=null;try{n=this.context.window&&this.context.window.store}catch{}n||this.context.logger.info(`Troparcel: store not available after ${this.options.startupDelay}ms \u2014 starting sync with API fallback`),await this.startBackgroundSync()}mergeOptions(e){let t="",i=(e.syncMode||"auto").trim().toLowerCase();Fp.has(i)||(i="auto");let n=!!e.room;return{serverUrl:e.serverUrl||"ws://localhost:2468",room:e.room||t||"troparcel-default",userId:e.userId||"",roomToken:e.roomToken||"",apiPort:Number(e.apiPort)||2019,autoSync:e.autoSync!==!1,syncMode:i,syncMetadata:e.syncMetadata!==!1,syncTags:e.syncTags!==!1,syncNotes:e.syncNotes!==!1,syncSelections:e.syncSelections!==!1,syncTranscriptions:e.syncTranscriptions!==!1,syncPhotoAdjustments:e.syncPhotoAdjustments===!0||e.syncPhotoAdjustments==="true",syncLists:e.syncLists===!0||e.syncLists==="true",syncDeletions:e.syncDeletions===!0||e.syncDeletions==="true",clearTombstones:e.clearTombstones===!0||e.clearTombstones==="true",startupDelay:Number(e.startupDelay)||8e3,localDebounce:Number(e.localDebounce)||2e3,remoteDebounce:Number(e.remoteDebounce)||500,safetyNetInterval:Number(e.safetyNetInterval)||120,writeDelay:Number(e.writeDelay)||100,maxBackups:Number(e.maxBackups)||10,maxNoteSize:Number(e.maxNoteSize)||1048576,maxMetadataSize:Number(e.maxMetadataSize)||65536,tombstoneFloodThreshold:Number(e.tombstoneFloodThreshold)||.5,debug:e.debug===!0||e.debug==="true",_roomExplicit:n}}async startBackgroundSync(){if(this.engine)return;let e=null;try{e=this.context.window&&this.context.window.store}catch{}this.engine=new Vr(this.options,this.context.logger,e);try{await this.engine.start(),this.context.logger.info(`Troparcel: connected to room "${this.options.room}" (${e?"store":"API"} mode, sync: ${this.options.syncMode})`)}catch(t){let i=t.message||String(t);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.warn(`Troparcel: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running? Start it with: node server/index.js`):this.context.logger.warn(`Troparcel: sync failed to start \u2014 ${i}. Use File > Export/Import to sync manually.`),await this.engine.stop(),this.engine=null}}async export(e){if(this._isPrefsWindow())return;let t=Array.isArray(e)?e:e&&e["@graph"]||[],i=!Array.isArray(e)&&e?e["@context"]:null;if(t.length===0){this.context.logger.warn("Troparcel Export: no items selected \u2014 select items first, then File > Export > Troparcel");return}if(this.options.syncMode==="pull"){this.context.logger.warn('Troparcel Export: sync mode is "pull" \u2014 local changes are not shared in this mode');return}this.context.logger.info(`Troparcel Export: pushing ${t.length} item(s) to room "${this.options.room}"...`);try{if(this.engine&&this.engine.state==="connected"){this.engine.pushItems(t,i),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`);return}this.context.logger.info("Troparcel Export: connecting to server (no background sync active)...");let n=new Vr(this.options,this.context.logger);await n.start(),n.pushItems(t,i),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`),setTimeout(()=>{n.stop()},5e3)}catch(n){let r=n.message||String(n);r.includes("timeout")||r.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Export: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Export: failed \u2014 ${r}`)}}async import(e){if(!this._isPrefsWindow()){if(this.options.syncMode==="push"){this.context.logger.warn('Troparcel Import: sync mode is "push" \u2014 remote changes are not applied in this mode');return}this.context.logger.info(`Troparcel Import: pulling changes from room "${this.options.room}"...`),this.engine&&this.engine.pause();try{let t,i=!1;if(this.engine&&this.engine.state==="connected"?t=this.engine:(t=new Vr(this.options,this.context.logger),await t.start(),await new Promise(r=>setTimeout(r,3e3)),i=!0),!t.adapter&&!await t.api.ping()){this.context.logger.warn("Import: Tropy API not reachable"),i&&await t.stop();return}if(t.localIndex.size===0)if(t.adapter){let r=t.readAllItemsFull();t.localIndex=Ec.buildIdentityIndex(r)}else{let r=await t.api.getItems();if(r&&Array.isArray(r)){let o=[];for(let a of r)try{o.push(await t.enrichItem(a))}catch{}t.localIndex=Ec.buildIdentityIndex(o)}}let n=await t.applyOnDemand();n?this.context.logger.info(`Troparcel Import: done \u2014 applied changes to ${n.applied} item(s) from "${this.options.room}"`):this.context.logger.info("Troparcel Import: done \u2014 no pending changes to apply"),i&&await t.stop()}catch(t){let i=t.message||String(t);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Import: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Import: failed \u2014 ${i}`)}finally{this.engine&&this.engine.resume()}}}getStatus(){let e={...this.options};return e.roomToken&&(e.roomToken="***"),delete e._roomExplicit,{version:"5.0.0",options:e,engine:this.engine?this.engine.getStatus():null,backgroundSync:this.engine!=null}}async unload(){this.context.logger.info("Troparcel unloading"),this.engine&&(await this.engine.stop(),this.engine=null)}};module.exports=jr;
