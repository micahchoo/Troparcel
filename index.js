"use strict";var Fi=Object.defineProperty;var xc=Object.getOwnPropertyDescriptor;var kc=Object.getOwnPropertyNames;var Tc=Object.prototype.hasOwnProperty;var T=(s,t)=>()=>(s&&(t=s(s=0)),t);var E=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports),Dr=(s,t)=>{for(var e in t)Fi(s,e,{get:t[e],enumerable:!0})},vc=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of kc(t))!Tc.call(s,n)&&n!==e&&Fi(s,n,{get:()=>t[n],enumerable:!(i=xc(t,n))||i.enumerable});return s};var Us=s=>vc(Fi({},"__esModule",{value:!0}),s);var R,Es,B,Lr,qe=T(()=>{R=()=>new Map,Es=s=>{let t=R();return s.forEach((e,i)=>{t.set(i,e)}),t},B=(s,t,e)=>{let i=s.get(t);return i===void 0&&s.set(t,i=e()),i},Lr=(s,t)=>{for(let[e,i]of s)if(t(i,e))return!0;return!1}});var ut,Ls=T(()=>{ut=()=>new Set});var Ms,Mr,lt,$r,Or,ze,He=T(()=>{Ms=s=>s[s.length-1],Mr=(s,t)=>{for(let e=0;e<t.length;e++)s.push(t[e])},lt=Array.from,$r=(s,t)=>{for(let e=0;e<s.length;e++)if(t(s[e],e,s))return!0;return!1},Or=(s,t)=>{let e=new Array(s);for(let i=0;i<s;i++)e[i]=t(i,e);return e},ze=Array.isArray});var fe,pe,Os=T(()=>{qe();Ls();He();fe=class{constructor(){this._observers=R()}on(t,e){return B(this._observers,t,ut).add(e),e}once(t,e){let i=(...n)=>{this.off(t,i),e(...n)};this.on(t,i)}off(t,e){let i=this._observers.get(t);i!==void 0&&(i.delete(e),i.size===0&&this._observers.delete(t))}emit(t,e){return lt((this._observers.get(t)||R()).values()).forEach(i=>i(...e))}destroy(){this._observers=R()}},pe=class{constructor(){this._observers=R()}on(t,e){B(this._observers,t,ut).add(e)}once(t,e){let i=(...n)=>{this.off(t,i),e(...n)};this.on(t,i)}off(t,e){let i=this._observers.get(t);i!==void 0&&(i.delete(e),i.size===0&&this._observers.delete(t))}emit(t,e){return lt((this._observers.get(t)||R()).values()).forEach(i=>i(...e))}destroy(){this._observers=R()}}});var X,ge,me,St,xp,Rr,Rs,Kt=T(()=>{X=Math.floor,ge=Math.abs,me=(s,t)=>s<t?s:t,St=(s,t)=>s>t?s:t,xp=Number.isNaN,Rr=Math.pow,Rs=s=>s!==0?s<0:1/s<0});var Pi,kp,Tp,jr,vp,Ap,Ki=T(()=>{Kt();Pi=Number.MAX_SAFE_INTEGER,kp=Number.MIN_SAFE_INTEGER,Tp=1<<31,jr=Number.isInteger||(s=>typeof s=="number"&&isFinite(s)&&X(s)===s),vp=Number.isNaN,Ap=Number.parseInt});var qi,Ip,Cp,Ac,Ic,Cc,Nc,zi,Uc,_e,Ec,Fr,we,Vr,be=T(()=>{He();qi=String.fromCharCode,Ip=String.fromCodePoint,Cp=qi(65535),Ac=s=>s.toLowerCase(),Ic=/^\s*/g,Cc=s=>s.replace(Ic,""),Nc=/([A-Z])/g,zi=(s,t)=>Cc(s.replace(Nc,e=>`${t}${Ac(e)}`)),Uc=s=>{let t=unescape(encodeURIComponent(s)),e=t.length,i=new Uint8Array(e);for(let n=0;n<e;n++)i[n]=t.codePointAt(n);return i},_e=typeof TextEncoder<"u"?new TextEncoder:null,Ec=s=>_e.encode(s),Fr=_e?Ec:Uc,we=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});we&&we.decode(new Uint8Array).length===1&&(we=null);Vr=(s,t)=>Or(t,()=>s).join("")});var qt,L,Bs,A,Dc,F,Te,w,Je,Hi,Lc,Mc,$c,dt,Hr,ve,U,Wi,Oc,Rc,jc,Kr,Bc,xe,Ge,qr,zt,zr,ke,js,Ye=T(()=>{Kt();Ki();be();He();qt=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},L=()=>new qt,Bs=s=>{let t=s.cpos;for(let e=0;e<s.bufs.length;e++)t+=s.bufs[e].length;return t},A=s=>{let t=new Uint8Array(Bs(s)),e=0;for(let i=0;i<s.bufs.length;i++){let n=s.bufs[i];t.set(n,e),e+=n.length}return t.set(new Uint8Array(s.cbuf.buffer,0,s.cpos),e),t},Dc=(s,t)=>{let e=s.cbuf.length;e-s.cpos<t&&(s.bufs.push(new Uint8Array(s.cbuf.buffer,0,s.cpos)),s.cbuf=new Uint8Array(St(e,t)*2),s.cpos=0)},F=(s,t)=>{let e=s.cbuf.length;s.cpos===e&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(e*2),s.cpos=0),s.cbuf[s.cpos++]=t},Te=F,w=(s,t)=>{for(;t>127;)F(s,128|127&t),t=X(t/128);F(s,127&t)},Je=(s,t)=>{let e=Rs(t);for(e&&(t=-t),F(s,(t>63?128:0)|(e?64:0)|63&t),t=X(t/64);t>0;)F(s,(t>127?128:0)|127&t),t=X(t/128)},Hi=new Uint8Array(3e4),Lc=Hi.length/3,Mc=(s,t)=>{if(t.length<Lc){let e=_e.encodeInto(t,Hi).written||0;w(s,e);for(let i=0;i<e;i++)F(s,Hi[i])}else U(s,Fr(t))},$c=(s,t)=>{let e=unescape(encodeURIComponent(t)),i=e.length;w(s,i);for(let n=0;n<i;n++)F(s,e.codePointAt(n))},dt=_e&&_e.encodeInto?Mc:$c,Hr=(s,t)=>ve(s,A(t)),ve=(s,t)=>{let e=s.cbuf.length,i=s.cpos,n=me(e-i,t.length),r=t.length-n;s.cbuf.set(t.subarray(0,n),i),s.cpos+=n,r>0&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(St(e*2,r)),s.cbuf.set(t.subarray(n)),s.cpos=r)},U=(s,t)=>{w(s,t.byteLength),ve(s,t)},Wi=(s,t)=>{Dc(s,t);let e=new DataView(s.cbuf.buffer,s.cpos,t);return s.cpos+=t,e},Oc=(s,t)=>Wi(s,4).setFloat32(0,t,!1),Rc=(s,t)=>Wi(s,8).setFloat64(0,t,!1),jc=(s,t)=>Wi(s,8).setBigInt64(0,t,!1),Kr=new DataView(new ArrayBuffer(4)),Bc=s=>(Kr.setFloat32(0,s),Kr.getFloat32(0)===s),xe=(s,t)=>{switch(typeof t){case"string":F(s,119),dt(s,t);break;case"number":jr(t)&&ge(t)<=2147483647?(F(s,125),Je(s,t)):Bc(t)?(F(s,124),Oc(s,t)):(F(s,123),Rc(s,t));break;case"bigint":F(s,122),jc(s,t);break;case"object":if(t===null)F(s,126);else if(ze(t)){F(s,117),w(s,t.length);for(let e=0;e<t.length;e++)xe(s,t[e])}else if(t instanceof Uint8Array)F(s,116),U(s,t);else{F(s,118);let e=Object.keys(t);w(s,e.length);for(let i=0;i<e.length;i++){let n=e[i];dt(s,n),xe(s,t[n])}}break;case"boolean":F(s,t?120:121);break;default:F(s,127)}},Ge=class extends qt{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&w(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}},qr=s=>{s.count>0&&(Je(s.encoder,s.count===1?s.s:-s.s),s.count>1&&w(s.encoder,s.count-2))},zt=class{constructor(){this.encoder=new qt,this.s=0,this.count=0}write(t){this.s===t?this.count++:(qr(this),this.count=1,this.s=t)}toUint8Array(){return qr(this),A(this.encoder)}},zr=s=>{if(s.count>0){let t=s.diff*2+(s.count===1?0:1);Je(s.encoder,t),s.count>1&&w(s.encoder,s.count-2)}},ke=class{constructor(){this.encoder=new qt,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(zr(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return zr(this),A(this.encoder)}},js=class{constructor(){this.sarr=[],this.s="",this.lensE=new zt}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){let t=new qt;return this.sarr.push(this.s),this.s="",dt(t,this.sarr.join("")),ve(t,this.lensE.toUint8Array()),A(t)}}});var ft,ct,G,Gi=T(()=>{ft=s=>new Error(s),ct=()=>{throw ft("Method unimplemented")},G=()=>{throw ft("Unexpected case")}});var Gr,Jr,Ae,M,Ji,Fc,j,Ht,b,Ze,Vc,Pc,nt,Yi,Kc,qc,zc,Hc,Ie,Xe,Wt,Ce,Vs,Ne=T(()=>{Kt();Ki();be();Gi();Gr=ft("Unexpected end of array"),Jr=ft("Integer out of Range"),Ae=class{constructor(t){this.arr=t,this.pos=0}},M=s=>new Ae(s),Ji=s=>s.pos!==s.arr.length,Fc=(s,t)=>{let e=new Uint8Array(s.arr.buffer,s.pos+s.arr.byteOffset,t);return s.pos+=t,e},j=s=>Fc(s,b(s)),Ht=s=>s.arr[s.pos++],b=s=>{let t=0,e=1,i=s.arr.length;for(;s.pos<i;){let n=s.arr[s.pos++];if(t=t+(n&127)*e,e*=128,n<128)return t;if(t>Pi)throw Jr}throw Gr},Ze=s=>{let t=s.arr[s.pos++],e=t&63,i=64,n=(t&64)>0?-1:1;if(!(t&128))return n*e;let r=s.arr.length;for(;s.pos<r;){if(t=s.arr[s.pos++],e=e+(t&127)*i,i*=128,t<128)return n*e;if(e>Pi)throw Jr}throw Gr},Vc=s=>{let t=b(s);if(t===0)return"";{let e=String.fromCodePoint(Ht(s));if(--t<100)for(;t--;)e+=String.fromCodePoint(Ht(s));else for(;t>0;){let i=t<1e4?t:1e4,n=s.arr.subarray(s.pos,s.pos+i);s.pos+=i,e+=String.fromCodePoint.apply(null,n),t-=i}return decodeURIComponent(escape(e))}},Pc=s=>we.decode(j(s)),nt=we?Pc:Vc,Yi=(s,t)=>{let e=new DataView(s.arr.buffer,s.arr.byteOffset+s.pos,t);return s.pos+=t,e},Kc=s=>Yi(s,4).getFloat32(0,!1),qc=s=>Yi(s,8).getFloat64(0,!1),zc=s=>Yi(s,8).getBigInt64(0,!1),Hc=[s=>{},s=>null,Ze,Kc,qc,zc,s=>!1,s=>!0,nt,s=>{let t=b(s),e={};for(let i=0;i<t;i++){let n=nt(s);e[n]=Ie(s)}return e},s=>{let t=b(s),e=[];for(let i=0;i<t;i++)e.push(Ie(s));return e},j],Ie=s=>Hc[127-Ht(s)](s),Xe=class extends Ae{constructor(t,e){super(t),this.reader=e,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),Ji(this)?this.count=b(this)+1:this.count=-1),this.count--,this.s}},Wt=class extends Ae{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=Ze(this);let t=Rs(this.s);this.count=1,t&&(this.s=-this.s,this.count=b(this)+2)}return this.count--,this.s}},Ce=class extends Ae{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){let t=Ze(this),e=t&1;this.diff=X(t/2),this.count=1,e&&(this.count=b(this)+2)}return this.s+=this.diff,this.count--,this.s}},Vs=class{constructor(t){this.decoder=new Wt(t),this.str=nt(this.decoder),this.spos=0}read(){let t=this.spos+this.decoder.read(),e=this.str.slice(this.spos,t);return this.spos=t,e}}});var Ps,Ep,Yr,Xr=T(()=>{Ps=require("node:crypto"),Ep=Ps.webcrypto.subtle,Yr=Ps.webcrypto.getRandomValues.bind(Ps.webcrypto)});var Xi,Wc,Zr,Qr=T(()=>{Xr();Xi=()=>Yr(new Uint32Array(1))[0],Wc="10000000-1000-4000-8000"+-1e11,Zr=()=>Wc.replace(/[018]/g,s=>(s^Xi()&15>>s/4).toString(16))});var et,ts=T(()=>{et=Date.now});var Zi,Mp,to=T(()=>{Zi=s=>new Promise(s),Mp=Promise.all.bind(Promise)});var Qi,eo=T(()=>{Qi=s=>s===void 0?null:s});var tn,so,en,qs,io,no,sn=T(()=>{tn=class{constructor(){this.map=new Map}setItem(t,e){this.map.set(t,e)}getItem(t){return this.map.get(t)}},so=new tn,en=!0;try{typeof localStorage<"u"&&localStorage&&(so=localStorage,en=!1)}catch{}qs=so,io=s=>en||addEventListener("storage",s),no=s=>en||removeEventListener("storage",s)});var zs,oo,nn=T(()=>{zs=Symbol("Equality"),oo=(s,t)=>s===t||!!s?.[zs]?.(t)||!1});var lo,Xc,co,ho,es,uo,Zc,rn,on,Qc,an,Hs=T(()=>{nn();lo=Object.assign,Xc=Object.keys,co=(s,t)=>{for(let e in s)t(s[e],e)},ho=(s,t)=>{let e=[];for(let i in s)e.push(t(s[i],i));return e},es=s=>Xc(s).length,uo=s=>{for(let t in s)return!1;return!0},Zc=(s,t)=>{for(let e in s)if(!t(s[e],e))return!1;return!0},rn=(s,t)=>Object.prototype.hasOwnProperty.call(s,t),on=(s,t)=>s===t||es(s)===es(t)&&Zc(s,(e,i)=>(e!==void 0||rn(t,i))&&oo(t[i],e)),Qc=Object.freeze,an=s=>{for(let t in s){let e=s[t];(typeof e=="object"||typeof e=="function")&&an(s[t])}return Qc(s)}});var ss,cn,Ue,fo,is=T(()=>{Hs();nn();ss=(s,t,e=0)=>{try{for(;e<s.length;e++)s[e](...t)}finally{e<s.length&&ss(s,t,e+1)}},cn=s=>s,Ue=(s,t)=>{if(s===t)return!0;if(s==null||t==null||s.constructor!==t.constructor&&(s.constructor||Object)!==(t.constructor||Object))return!1;if(s[zs]!=null)return s[zs](t);switch(s.constructor){case ArrayBuffer:s=new Uint8Array(s),t=new Uint8Array(t);case Uint8Array:{if(s.byteLength!==t.byteLength)return!1;for(let e=0;e<s.length;e++)if(s[e]!==t[e])return!1;break}case Set:{if(s.size!==t.size)return!1;for(let e of s)if(!t.has(e))return!1;break}case Map:{if(s.size!==t.size)return!1;for(let e of s.keys())if(!t.has(e)||!Ue(s.get(e),t.get(e)))return!1;break}case void 0:case Object:if(es(s)!==es(t))return!1;for(let e in s)if(!rn(s,e)||!Ue(s[e],t[e]))return!1;break;case Array:if(s.length!==t.length)return!1;for(let e=0;e<s.length;e++)if(!Ue(s[e],t[e]))return!1;break;default:return!1}return!0},fo=(s,t)=>t.includes(s)});var xt,dn,$p,pt,th,eh,un,ns,po,Op,sh,go,rs=T(()=>{qe();be();eo();sn();is();xt=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",dn=typeof window<"u"&&typeof document<"u"&&!xt,$p=typeof navigator<"u"?/Mac/.test(navigator.platform):!1,th=[],eh=()=>{if(pt===void 0)if(xt){pt=R();let s=process.argv,t=null;for(let e=0;e<s.length;e++){let i=s[e];i[0]==="-"?(t!==null&&pt.set(t,""),t=i):t!==null?(pt.set(t,i),t=null):th.push(i)}t!==null&&pt.set(t,"")}else typeof location=="object"?(pt=R(),(location.search||"?").slice(1).split("&").forEach(s=>{if(s.length!==0){let[t,e]=s.split("=");pt.set(`--${zi(t,"-")}`,e),pt.set(`-${zi(t,"-")}`,e)}})):pt=R();return pt},un=s=>eh().has(s),ns=s=>xt?Qi(process.env[s.toUpperCase().replaceAll("-","_")]):Qi(qs.getItem(s)),po=s=>un("--"+s)||ns(s)!==null,Op=po("production"),sh=xt&&fo(process.env.FORCE_COLOR,["true","1","2"]),go=sh||!un("--no-colors")&&!po("no-color")&&(!xt||process.stdout.isTTY)&&(!xt||un("--color")||ns("COLORTERM")!==null||(ns("TERM")||"").includes("color"))});var mo,ih,yo,nh,rh,oh,ah,wo,_o,bo,fn=T(()=>{be();rs();mo=s=>new Uint8Array(s),ih=(s,t,e)=>new Uint8Array(s,t,e),yo=s=>new Uint8Array(s),nh=s=>{let t="";for(let e=0;e<s.byteLength;e++)t+=qi(s[e]);return btoa(t)},rh=s=>Buffer.from(s.buffer,s.byteOffset,s.byteLength).toString("base64"),oh=s=>{let t=atob(s),e=mo(t.length);for(let i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e},ah=s=>{let t=Buffer.from(s,"base64");return ih(t.buffer,t.byteOffset,t.byteLength)},wo=dn?nh:rh,_o=dn?oh:ah,bo=s=>{let t=mo(s.byteLength);return t.set(s),t}});var gt,xo=T(()=>{gt=Symbol});var os,as,pn,gn,mn,ls,yn,cs,wn,ko,Rp,_n=T(()=>{xo();ts();os=gt(),as=gt(),pn=gt(),gn=gt(),mn=gt(),ls=gt(),yn=gt(),cs=gt(),wn=gt(),ko=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let t=[],e=[],i=0;for(;i<s.length;i++){let n=s[i];if(n===void 0)break;if(n.constructor===String||n.constructor===Number)t.push(n);else if(n.constructor===Object)break}for(i>0&&e.push(t.join(""));i<s.length;i++){let n=s[i];n instanceof Symbol||e.push(n)}return e},Rp=et()});var hh,uh,To,Gs,bn,vo=T(()=>{rs();_n();_n();hh={[os]:"\x1B[1m",[as]:"\x1B[2m",[pn]:"\x1B[34m",[mn]:"\x1B[32m",[gn]:"\x1B[37m",[ls]:"\x1B[31m",[yn]:"\x1B[35m",[cs]:"\x1B[38;5;208m",[wn]:"\x1B[0m"},uh=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let t=[],e=[],i=0;for(;i<s.length;i++){let n=s[i],r=hh[n];if(r!==void 0)t.push(r);else{if(n===void 0)break;if(n.constructor===String||n.constructor===Number)t.push(n);else break}}for(i>0&&(t.push("\x1B[0m"),e.push(t.join("")));i<s.length;i++){let n=s[i];n instanceof Symbol||e.push(n)}return e},To=go?uh:ko,Gs=(...s)=>{console.log(...To(s))},bn=(...s)=>{console.warn(...To(s))}});var Ao,Io,Js,Co=T(()=>{Ao=s=>({[Symbol.iterator](){return this},next:s}),Io=(s,t)=>Ao(()=>{let e;do e=s.next();while(!e.done&&!t(e.value));return e}),Js=(s,t)=>Ao(()=>{let{done:e,value:i}=s.next();return{done:e,value:e?void 0:t(i)}})});var ks={};Dr(ks,{AbsolutePosition:()=>si,AbstractConnector:()=>xn,AbstractStruct:()=>Me,AbstractType:()=>$,Array:()=>te,ContentAny:()=>Rt,ContentBinary:()=>ne,ContentDeleted:()=>$e,ContentDoc:()=>re,ContentEmbed:()=>vt,ContentFormat:()=>O,ContentJSON:()=>Ss,ContentString:()=>ht,ContentType:()=>ot,Doc:()=>$t,GC:()=>H,ID:()=>kt,Item:()=>C,Map:()=>ee,PermanentUserData:()=>Tn,RelativePosition:()=>De,Skip:()=>V,Snapshot:()=>ps,Text:()=>Le,Transaction:()=>ni,UndoManager:()=>Nn,UpdateDecoderV1:()=>Z,UpdateDecoderV2:()=>J,UpdateEncoderV1:()=>yt,UpdateEncoderV2:()=>st,XmlElement:()=>ie,XmlFragment:()=>se,XmlHook:()=>bs,XmlText:()=>ui,YArrayEvent:()=>ai,YEvent:()=>Qt,YMapEvent:()=>li,YTextEvent:()=>ci,YXmlEvent:()=>hi,applyUpdate:()=>Rn,applyUpdateV2:()=>pi,cleanupYTextFormatting:()=>Ca,compareIDs:()=>Gt,compareRelativePositions:()=>Oh,convertUpdateFormatV1ToV2:()=>iu,convertUpdateFormatV2ToV1:()=>ua,createAbsolutePositionFromRelativePosition:()=>$h,createDeleteSet:()=>fi,createDeleteSetFromStructStore:()=>Mn,createDocFromSnapshot:()=>Ph,createID:()=>x,createRelativePositionFromJSON:()=>Ih,createRelativePositionFromTypeIndex:()=>Nh,createSnapshot:()=>Kn,decodeRelativePosition:()=>Lh,decodeSnapshot:()=>Bh,decodeSnapshotV2:()=>Zo,decodeStateVector:()=>Bn,decodeUpdate:()=>Yh,decodeUpdateV2:()=>ra,diffUpdate:()=>tu,diffUpdateV2:()=>qn,emptySnapshot:()=>Fh,encodeRelativePosition:()=>Eh,encodeSnapshot:()=>jh,encodeSnapshotV2:()=>Xo,encodeStateAsUpdate:()=>jn,encodeStateAsUpdateV2:()=>Go,encodeStateVector:()=>Vn,encodeStateVectorFromUpdate:()=>Xh,encodeStateVectorFromUpdateV2:()=>aa,equalDeleteSets:()=>Ho,equalSnapshots:()=>Rh,findIndexSS:()=>rt,findRootTypeKey:()=>Pn,getItem:()=>Jt,getItemCleanEnd:()=>In,getItemCleanStart:()=>z,getState:()=>D,getTypeChildren:()=>au,isDeleted:()=>oe,isParentOf:()=>fs,iterateDeletedStructs:()=>Yt,logType:()=>vh,logUpdate:()=>Jh,logUpdateV2:()=>na,mergeDeleteSets:()=>Xt,mergeUpdates:()=>oa,mergeUpdatesV2:()=>ms,obfuscateUpdate:()=>eu,obfuscateUpdateV2:()=>su,parseUpdateMeta:()=>Zh,parseUpdateMetaV2:()=>la,readUpdate:()=>Sh,readUpdateV2:()=>On,relativePositionToJSON:()=>Ah,snapshot:()=>Vh,snapshotContainsUpdate:()=>qh,transact:()=>I,tryGc:()=>Wh,typeListToArraySnapshot:()=>lu,typeMapGetAllSnapshot:()=>ka,typeMapGetSnapshot:()=>uu});function*Gh(s){let t=b(s.restDecoder);for(let e=0;e<t;e++){let i=b(s.restDecoder),n=s.readClient(),r=b(s.restDecoder);for(let o=0;o<i;o++){let a=s.readInfo();if(a===10){let l=b(s.restDecoder);yield new V(x(n,r),l),r+=l}else if(31&a){let l=(a&192)===0,c=new C(x(n,r),null,(a&128)===128?s.readLeftID():null,null,(a&64)===64?s.readRightID():null,l?s.readParentInfo()?s.readString():s.readLeftID():null,l&&(a&32)===32?s.readString():null,Ea(s,a));yield c,r+=c.length}else{let l=s.readLen();yield new H(x(n,r),l),r+=l}}}}var xn,us,Mt,Yt,mh,oe,Ln,Xt,ds,fi,Mn,mt,Tt,Eo,Ho,Wo,$t,Zt,Z,ei,J,Ot,yt,Ee,st,yh,$n,wh,_h,bh,On,Sh,pi,Rn,xh,Go,jn,Jo,Bn,Fn,kh,Th,Vn,kn,Do,Lo,Mo,Yo,kt,Gt,x,$o,Oo,Pn,fs,vh,Tn,De,Ah,Ih,si,Ch,Ys,Nh,Uh,Eh,Dh,Lh,Mh,$h,Oh,ps,Rh,Xo,jh,Zo,Bh,Kn,Fh,Vh,Et,vn,Ph,Kh,qh,ii,xs,D,Qo,rt,zh,Jt,An,z,In,Hh,ta,ni,Ro,jo,Qs,ea,sa,Wh,ia,I,Cn,Bo,Fo,Nn,wt,Jh,na,Yh,ra,gs,oa,aa,Xh,la,Zh,Qh,ms,qn,tu,ca,Dt,zn,gi,ha,eu,su,iu,ua,Vo,Qt,nu,P,da,Hn,Un,ru,fa,ou,mi,ys,au,yi,$,pa,ga,lu,ws,ma,cu,ya,ri,wa,_a,hu,ba,oi,Wn,Gn,Sa,xa,uu,ka,Xs,ai,te,du,li,ee,fu,Lt,_s,Po,Zs,Ta,Oe,va,Aa,Sn,Ko,Ia,pu,Ca,gu,qo,ci,Le,mu,hs,se,yu,ie,wu,hi,bs,_u,ui,bu,Me,Su,H,ne,xu,$e,ku,Na,re,Tu,vt,vu,O,Au,Ss,Iu,Cu,Rt,Nu,ht,Uu,Eu,Du,Lu,Mu,$u,Ou,Ru,ju,ot,Bu,En,Jn,di,zo,Ua,C,Ea,Fu,Vu,V,Da,La,Ts=T(()=>{Os();He();Kt();qe();Ye();Ne();Qr();to();fn();Gi();is();is();Ls();vo();ts();be();Co();Hs();rs();xn=class extends fe{constructor(t,e){super(),this.doc=t,this.awareness=e}},us=class{constructor(t,e){this.clock=t,this.len=e}},Mt=class{constructor(){this.clients=new Map}},Yt=(s,t,e)=>t.clients.forEach((i,n)=>{let r=s.doc.store.clients.get(n);if(r!=null){let o=r[r.length-1],a=o.id.clock+o.length;for(let l=0,c=i[l];l<i.length&&c.clock<a;c=i[++l])ta(s,r,c.clock,c.len,e)}}),mh=(s,t)=>{let e=0,i=s.length-1;for(;e<=i;){let n=X((e+i)/2),r=s[n],o=r.clock;if(o<=t){if(t<o+r.len)return n;e=n+1}else i=n-1}return null},oe=(s,t)=>{let e=s.clients.get(t.client);return e!==void 0&&mh(e,t.clock)!==null},Ln=s=>{s.clients.forEach(t=>{t.sort((n,r)=>n.clock-r.clock);let e,i;for(e=1,i=1;e<t.length;e++){let n=t[i-1],r=t[e];n.clock+n.len>=r.clock?n.len=St(n.len,r.clock+r.len-n.clock):(i<e&&(t[i]=r),i++)}t.length=i})},Xt=s=>{let t=new Mt;for(let e=0;e<s.length;e++)s[e].clients.forEach((i,n)=>{if(!t.clients.has(n)){let r=i.slice();for(let o=e+1;o<s.length;o++)Mr(r,s[o].clients.get(n)||[]);t.clients.set(n,r)}});return Ln(t),t},ds=(s,t,e,i)=>{B(s.clients,t,()=>[]).push(new us(e,i))},fi=()=>new Mt,Mn=s=>{let t=fi();return s.clients.forEach((e,i)=>{let n=[];for(let r=0;r<e.length;r++){let o=e[r];if(o.deleted){let a=o.id.clock,l=o.length;if(r+1<e.length)for(let c=e[r+1];r+1<e.length&&c.deleted;c=e[++r+1])l+=c.length;n.push(new us(a,l))}}n.length>0&&t.clients.set(i,n)}),t},mt=(s,t)=>{w(s.restEncoder,t.clients.size),lt(t.clients.entries()).sort((e,i)=>i[0]-e[0]).forEach(([e,i])=>{s.resetDsCurVal(),w(s.restEncoder,e);let n=i.length;w(s.restEncoder,n);for(let r=0;r<n;r++){let o=i[r];s.writeDsClock(o.clock),s.writeDsLen(o.len)}})},Tt=s=>{let t=new Mt,e=b(s.restDecoder);for(let i=0;i<e;i++){s.resetDsCurVal();let n=b(s.restDecoder),r=b(s.restDecoder);if(r>0){let o=B(t.clients,n,()=>[]);for(let a=0;a<r;a++)o.push(new us(s.readDsClock(),s.readDsLen()))}}return t},Eo=(s,t,e)=>{let i=new Mt,n=b(s.restDecoder);for(let r=0;r<n;r++){s.resetDsCurVal();let o=b(s.restDecoder),a=b(s.restDecoder),l=e.clients.get(o)||[],c=D(e,o);for(let h=0;h<a;h++){let u=s.readDsClock(),d=u+s.readDsLen();if(u<c){c<d&&ds(i,o,c,d-c);let f=rt(l,u),p=l[f];for(!p.deleted&&p.id.clock<u&&(l.splice(f+1,0,di(t,p,u-p.id.clock)),f++);f<l.length&&(p=l[f++],p.id.clock<d);)p.deleted||(d<p.id.clock+p.length&&l.splice(f,0,di(t,p,d-p.id.clock)),p.delete(t))}else ds(i,o,u,d-u)}}if(i.clients.size>0){let r=new st;return w(r.restEncoder,0),mt(r,i),r.toUint8Array()}return null},Ho=(s,t)=>{if(s.clients.size!==t.clients.size)return!1;for(let[e,i]of s.clients.entries()){let n=t.clients.get(e);if(n===void 0||i.length!==n.length)return!1;for(let r=0;r<i.length;r++){let o=i[r],a=n[r];if(o.clock!==a.clock||o.len!==a.len)return!1}}return!0},Wo=Xi,$t=class s extends fe{constructor({guid:t=Zr(),collectionid:e=null,gc:i=!0,gcFilter:n=()=>!0,meta:r=null,autoLoad:o=!1,shouldLoad:a=!0}={}){super(),this.gc=i,this.gcFilter=n,this.clientID=Wo(),this.guid=t,this.collectionid=e,this.share=new Map,this.store=new ii,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=a,this.autoLoad=o,this.meta=r,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=Zi(c=>{this.on("load",()=>{this.isLoaded=!0,c(this)})});let l=()=>Zi(c=>{let h=u=>{(u===void 0||u===!0)&&(this.off("sync",h),c())};this.on("sync",h)});this.on("sync",c=>{c===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=c===void 0||c===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){let t=this._item;t!==null&&!this.shouldLoad&&I(t.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(lt(this.subdocs).map(t=>t.guid))}transact(t,e=null){return I(this,t,e)}get(t,e=$){let i=B(this.share,t,()=>{let r=new e;return r._integrate(this,null),r}),n=i.constructor;if(e!==$&&n!==e)if(n===$){let r=new e;r._map=i._map,i._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=r}),r._start=i._start;for(let o=r._start;o!==null;o=o.right)o.parent=r;return r._length=i._length,this.share.set(t,r),r._integrate(this,null),r}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return i}getArray(t=""){return this.get(t,te)}getText(t=""){return this.get(t,Le)}getMap(t=""){return this.get(t,ee)}getXmlElement(t=""){return this.get(t,ie)}getXmlFragment(t=""){return this.get(t,se)}toJSON(){let t={};return this.share.forEach((e,i)=>{t[i]=e.toJSON()}),t}destroy(){this.isDestroyed=!0,lt(this.subdocs).forEach(e=>e.destroy());let t=this._item;if(t!==null){this._item=null;let e=t.content;e.doc=new s({guid:this.guid,...e.opts,shouldLoad:!1}),e.doc._item=t,I(t.parent.doc,i=>{let n=e.doc;t.deleted||i.subdocsAdded.add(n),i.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}},Zt=class{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return b(this.restDecoder)}readDsLen(){return b(this.restDecoder)}},Z=class extends Zt{readLeftID(){return x(b(this.restDecoder),b(this.restDecoder))}readRightID(){return x(b(this.restDecoder),b(this.restDecoder))}readClient(){return b(this.restDecoder)}readInfo(){return Ht(this.restDecoder)}readString(){return nt(this.restDecoder)}readParentInfo(){return b(this.restDecoder)===1}readTypeRef(){return b(this.restDecoder)}readLen(){return b(this.restDecoder)}readAny(){return Ie(this.restDecoder)}readBuf(){return bo(j(this.restDecoder))}readJSON(){return JSON.parse(nt(this.restDecoder))}readKey(){return nt(this.restDecoder)}},ei=class{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=b(this.restDecoder),this.dsCurrVal}readDsLen(){let t=b(this.restDecoder)+1;return this.dsCurrVal+=t,t}},J=class extends ei{constructor(t){super(t),this.keys=[],b(t),this.keyClockDecoder=new Ce(j(t)),this.clientDecoder=new Wt(j(t)),this.leftClockDecoder=new Ce(j(t)),this.rightClockDecoder=new Ce(j(t)),this.infoDecoder=new Xe(j(t),Ht),this.stringDecoder=new Vs(j(t)),this.parentInfoDecoder=new Xe(j(t),Ht),this.typeRefDecoder=new Wt(j(t)),this.lenDecoder=new Wt(j(t))}readLeftID(){return new kt(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new kt(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Ie(this.restDecoder)}readBuf(){return j(this.restDecoder)}readJSON(){return Ie(this.restDecoder)}readKey(){let t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{let e=this.stringDecoder.read();return this.keys.push(e),e}}},Ot=class{constructor(){this.restEncoder=L()}toUint8Array(){return A(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){w(this.restEncoder,t)}writeDsLen(t){w(this.restEncoder,t)}},yt=class extends Ot{writeLeftID(t){w(this.restEncoder,t.client),w(this.restEncoder,t.clock)}writeRightID(t){w(this.restEncoder,t.client),w(this.restEncoder,t.clock)}writeClient(t){w(this.restEncoder,t)}writeInfo(t){Te(this.restEncoder,t)}writeString(t){dt(this.restEncoder,t)}writeParentInfo(t){w(this.restEncoder,t?1:0)}writeTypeRef(t){w(this.restEncoder,t)}writeLen(t){w(this.restEncoder,t)}writeAny(t){xe(this.restEncoder,t)}writeBuf(t){U(this.restEncoder,t)}writeJSON(t){dt(this.restEncoder,JSON.stringify(t))}writeKey(t){dt(this.restEncoder,t)}},Ee=class{constructor(){this.restEncoder=L(),this.dsCurrVal=0}toUint8Array(){return A(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){let e=t-this.dsCurrVal;this.dsCurrVal=t,w(this.restEncoder,e)}writeDsLen(t){t===0&&G(),w(this.restEncoder,t-1),this.dsCurrVal+=t}},st=class extends Ee{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new ke,this.clientEncoder=new zt,this.leftClockEncoder=new ke,this.rightClockEncoder=new ke,this.infoEncoder=new Ge(Te),this.stringEncoder=new js,this.parentInfoEncoder=new Ge(Te),this.typeRefEncoder=new zt,this.lenEncoder=new zt}toUint8Array(){let t=L();return w(t,0),U(t,this.keyClockEncoder.toUint8Array()),U(t,this.clientEncoder.toUint8Array()),U(t,this.leftClockEncoder.toUint8Array()),U(t,this.rightClockEncoder.toUint8Array()),U(t,A(this.infoEncoder)),U(t,this.stringEncoder.toUint8Array()),U(t,A(this.parentInfoEncoder)),U(t,this.typeRefEncoder.toUint8Array()),U(t,this.lenEncoder.toUint8Array()),ve(t,A(this.restEncoder)),A(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){xe(this.restEncoder,t)}writeBuf(t){U(this.restEncoder,t)}writeJSON(t){xe(this.restEncoder,t)}writeKey(t){let e=this.keyMap.get(t);e===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(e)}},yh=(s,t,e,i)=>{i=St(i,t[0].id.clock);let n=rt(t,i);w(s.restEncoder,t.length-n),s.writeClient(e),w(s.restEncoder,i);let r=t[n];r.write(s,i-r.id.clock);for(let o=n+1;o<t.length;o++)t[o].write(s,0)},$n=(s,t,e)=>{let i=new Map;e.forEach((n,r)=>{D(t,r)>n&&i.set(r,n)}),xs(t).forEach((n,r)=>{e.has(r)||i.set(r,0)}),w(s.restEncoder,i.size),lt(i.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{yh(s,t.clients.get(n),n,r)})},wh=(s,t)=>{let e=R(),i=b(s.restDecoder);for(let n=0;n<i;n++){let r=b(s.restDecoder),o=new Array(r),a=s.readClient(),l=b(s.restDecoder);e.set(a,{i:0,refs:o});for(let c=0;c<r;c++){let h=s.readInfo();switch(31&h){case 0:{let u=s.readLen();o[c]=new H(x(a,l),u),l+=u;break}case 10:{let u=b(s.restDecoder);o[c]=new V(x(a,l),u),l+=u;break}default:{let u=(h&192)===0,d=new C(x(a,l),null,(h&128)===128?s.readLeftID():null,null,(h&64)===64?s.readRightID():null,u?s.readParentInfo()?t.get(s.readString()):s.readLeftID():null,u&&(h&32)===32?s.readString():null,Ea(s,h));o[c]=d,l+=d.length}}}}return e},_h=(s,t,e)=>{let i=[],n=lt(e.keys()).sort((f,p)=>f-p);if(n.length===0)return null;let r=()=>{if(n.length===0)return null;let f=e.get(n[n.length-1]);for(;f.refs.length===f.i;)if(n.pop(),n.length>0)f=e.get(n[n.length-1]);else return null;return f},o=r();if(o===null)return null;let a=new ii,l=new Map,c=(f,p)=>{let g=l.get(f);(g==null||g>p)&&l.set(f,p)},h=o.refs[o.i++],u=new Map,d=()=>{for(let f of i){let p=f.id.client,g=e.get(p);g?(g.i--,a.clients.set(p,g.refs.slice(g.i)),e.delete(p),g.i=0,g.refs=[]):a.clients.set(p,[f]),n=n.filter(y=>y!==p)}i.length=0};for(;;){if(h.constructor!==V){let p=B(u,h.id.client,()=>D(t,h.id.client))-h.id.clock;if(p<0)i.push(h),c(h.id.client,h.id.clock-1),d();else{let g=h.getMissing(s,t);if(g!==null){i.push(h);let y=e.get(g)||{refs:[],i:0};if(y.refs.length===y.i)c(g,D(t,g)),d();else{h=y.refs[y.i++];continue}}else(p===0||p<h.length)&&(h.integrate(s,p),u.set(h.id.client,h.id.clock+h.length))}}if(i.length>0)h=i.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=r(),o===null)break;h=o.refs[o.i++]}}if(a.clients.size>0){let f=new st;return $n(f,a,new Map),w(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},bh=(s,t)=>$n(s,t.doc.store,t.beforeState),On=(s,t,e,i=new J(s))=>I(t,n=>{n.local=!1;let r=!1,o=n.doc,a=o.store,l=wh(i,o),c=_h(n,a,l),h=a.pendingStructs;if(h){for(let[d,f]of h.missing)if(f<D(a,d)){r=!0;break}if(c){for(let[d,f]of c.missing){let p=h.missing.get(d);(p==null||p>f)&&h.missing.set(d,f)}h.update=ms([h.update,c.update])}}else a.pendingStructs=c;let u=Eo(i,n,a);if(a.pendingDs){let d=new J(M(a.pendingDs));b(d.restDecoder);let f=Eo(d,n,a);u&&f?a.pendingDs=ms([u,f]):a.pendingDs=u||f}else a.pendingDs=u;if(r){let d=a.pendingStructs.update;a.pendingStructs=null,pi(n.doc,d)}},e,!1),Sh=(s,t,e)=>On(s,t,e,new Z(s)),pi=(s,t,e,i=J)=>{let n=M(t);On(n,s,e,new i(n))},Rn=(s,t,e)=>pi(s,t,e,Z),xh=(s,t,e=new Map)=>{$n(s,t.store,e),mt(s,Mn(t.store))},Go=(s,t=new Uint8Array([0]),e=new st)=>{let i=Bn(t);xh(e,s,i);let n=[e.toUint8Array()];if(s.store.pendingDs&&n.push(s.store.pendingDs),s.store.pendingStructs&&n.push(qn(s.store.pendingStructs.update,t)),n.length>1){if(e.constructor===yt)return oa(n.map((r,o)=>o===0?r:ua(r)));if(e.constructor===st)return ms(n)}return n[0]},jn=(s,t)=>Go(s,t,new yt),Jo=s=>{let t=new Map,e=b(s.restDecoder);for(let i=0;i<e;i++){let n=b(s.restDecoder),r=b(s.restDecoder);t.set(n,r)}return t},Bn=s=>Jo(new Zt(M(s))),Fn=(s,t)=>(w(s.restEncoder,t.size),lt(t.entries()).sort((e,i)=>i[0]-e[0]).forEach(([e,i])=>{w(s.restEncoder,e),w(s.restEncoder,i)}),s),kh=(s,t)=>Fn(s,xs(t.store)),Th=(s,t=new Ee)=>(s instanceof Map?Fn(t,s):kh(t,s),t.toUint8Array()),Vn=s=>Th(s,new Ot),kn=class{constructor(){this.l=[]}},Do=()=>new kn,Lo=(s,t)=>s.l.push(t),Mo=(s,t)=>{let e=s.l,i=e.length;s.l=e.filter(n=>t!==n),i===s.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Yo=(s,t,e)=>ss(s.l,[t,e]),kt=class{constructor(t,e){this.client=t,this.clock=e}},Gt=(s,t)=>s===t||s!==null&&t!==null&&s.client===t.client&&s.clock===t.clock,x=(s,t)=>new kt(s,t),$o=(s,t)=>{w(s,t.client),w(s,t.clock)},Oo=s=>x(b(s),b(s)),Pn=s=>{for(let[t,e]of s.doc.share.entries())if(e===s)return t;throw G()},fs=(s,t)=>{for(;t!==null;){if(t.parent===s)return!0;t=t.parent._item}return!1},vh=s=>{let t=[],e=s._start;for(;e;)t.push(e),e=e.right;console.log("Children: ",t),console.log("Children content: ",t.filter(i=>!i.deleted).map(i=>i.content))},Tn=class{constructor(t,e=t.getMap("users")){let i=new Map;this.yusers=e,this.doc=t,this.clients=new Map,this.dss=i;let n=(r,o)=>{let a=r.get("ds"),l=r.get("ids"),c=h=>this.clients.set(h,o);a.observe(h=>{h.changes.added.forEach(u=>{u.content.getContent().forEach(d=>{d instanceof Uint8Array&&this.dss.set(o,Xt([this.dss.get(o)||fi(),Tt(new Zt(M(d)))]))})})}),this.dss.set(o,Xt(a.map(h=>Tt(new Zt(M(h)))))),l.observe(h=>h.changes.added.forEach(u=>u.content.getContent().forEach(c))),l.forEach(c)};e.observe(r=>{r.keysChanged.forEach(o=>n(e.get(o),o))}),e.forEach(n)}setUserMapping(t,e,i,{filter:n=()=>!0}={}){let r=this.yusers,o=r.get(i);o||(o=new ee,o.set("ids",new te),o.set("ds",new te),r.set(i,o)),o.get("ids").push([e]),r.observe(a=>{setTimeout(()=>{let l=r.get(i);if(l!==o){o=l,this.clients.forEach((u,d)=>{i===u&&o.get("ids").push([d])});let c=new Ot,h=this.dss.get(i);h&&(mt(c,h),o.get("ds").push([c.toUint8Array()]))}},0)}),t.on("afterTransaction",a=>{setTimeout(()=>{let l=o.get("ds"),c=a.deleteSet;if(a.local&&c.clients.size>0&&n(a,c)){let h=new Ot;mt(h,c),l.push([h.toUint8Array()])}})})}getUserByClientId(t){return this.clients.get(t)||null}getUserByDeletedId(t){for(let[e,i]of this.dss.entries())if(oe(i,t))return e;return null}},De=class{constructor(t,e,i,n=0){this.type=t,this.tname=e,this.item=i,this.assoc=n}},Ah=s=>{let t={};return s.type&&(t.type=s.type),s.tname&&(t.tname=s.tname),s.item&&(t.item=s.item),s.assoc!=null&&(t.assoc=s.assoc),t},Ih=s=>new De(s.type==null?null:x(s.type.client,s.type.clock),s.tname??null,s.item==null?null:x(s.item.client,s.item.clock),s.assoc==null?0:s.assoc),si=class{constructor(t,e,i=0){this.type=t,this.index=e,this.assoc=i}},Ch=(s,t,e=0)=>new si(s,t,e),Ys=(s,t,e)=>{let i=null,n=null;return s._item===null?n=Pn(s):i=x(s._item.id.client,s._item.id.clock),new De(i,n,t,e)},Nh=(s,t,e=0)=>{let i=s._start;if(e<0){if(t===0)return Ys(s,null,e);t--}for(;i!==null;){if(!i.deleted&&i.countable){if(i.length>t)return Ys(s,x(i.id.client,i.id.clock+t),e);t-=i.length}if(i.right===null&&e<0)return Ys(s,i.lastId,e);i=i.right}return Ys(s,null,e)},Uh=(s,t)=>{let{type:e,tname:i,item:n,assoc:r}=t;if(n!==null)w(s,0),$o(s,n);else if(i!==null)Te(s,1),dt(s,i);else if(e!==null)Te(s,2),$o(s,e);else throw G();return Je(s,r),s},Eh=s=>{let t=L();return Uh(t,s),A(t)},Dh=s=>{let t=null,e=null,i=null;switch(b(s)){case 0:i=Oo(s);break;case 1:e=nt(s);break;case 2:t=Oo(s)}let n=Ji(s)?Ze(s):0;return new De(t,e,i,n)},Lh=s=>Dh(M(s)),Mh=(s,t)=>{let e=Jt(s,t),i=t.clock-e.id.clock;return{item:e,diff:i}},$h=(s,t,e=!0)=>{let i=t.store,n=s.item,r=s.type,o=s.tname,a=s.assoc,l=null,c=0;if(n!==null){if(D(i,n.client)<=n.clock)return null;let h=e?En(i,n):Mh(i,n),u=h.item;if(!(u instanceof C))return null;if(l=u.parent,l._item===null||!l._item.deleted){c=u.deleted||!u.countable?0:h.diff+(a>=0?0:1);let d=u.left;for(;d!==null;)!d.deleted&&d.countable&&(c+=d.length),d=d.left}}else{if(o!==null)l=t.get(o);else if(r!==null){if(D(i,r.client)<=r.clock)return null;let{item:h}=e?En(i,r):{item:Jt(i,r)};if(h instanceof C&&h.content instanceof ot)l=h.content.type;else return null}else throw G();a>=0?c=l._length:c=0}return Ch(l,c,s.assoc)},Oh=(s,t)=>s===t||s!==null&&t!==null&&s.tname===t.tname&&Gt(s.item,t.item)&&Gt(s.type,t.type)&&s.assoc===t.assoc,ps=class{constructor(t,e){this.ds=t,this.sv=e}},Rh=(s,t)=>{let e=s.ds.clients,i=t.ds.clients,n=s.sv,r=t.sv;if(n.size!==r.size||e.size!==i.size)return!1;for(let[o,a]of n.entries())if(r.get(o)!==a)return!1;for(let[o,a]of e.entries()){let l=i.get(o)||[];if(a.length!==l.length)return!1;for(let c=0;c<a.length;c++){let h=a[c],u=l[c];if(h.clock!==u.clock||h.len!==u.len)return!1}}return!0},Xo=(s,t=new Ee)=>(mt(t,s.ds),Fn(t,s.sv),t.toUint8Array()),jh=s=>Xo(s,new Ot),Zo=(s,t=new ei(M(s)))=>new ps(Tt(t),Jo(t)),Bh=s=>Zo(s,new Zt(M(s))),Kn=(s,t)=>new ps(s,t),Fh=Kn(fi(),new Map),Vh=s=>Kn(Mn(s.store),xs(s.store)),Et=(s,t)=>t===void 0?!s.deleted:t.sv.has(s.id.client)&&(t.sv.get(s.id.client)||0)>s.id.clock&&!oe(t.ds,s.id),vn=(s,t)=>{let e=B(s.meta,vn,ut),i=s.doc.store;e.has(t)||(t.sv.forEach((n,r)=>{n<D(i,r)&&z(s,x(r,n))}),Yt(s,t.ds,n=>{}),e.add(t))},Ph=(s,t,e=new $t)=>{if(s.gc)throw new Error("Garbage-collection must be disabled in `originDoc`!");let{sv:i,ds:n}=t,r=new st;return s.transact(o=>{let a=0;i.forEach(l=>{l>0&&a++}),w(r.restEncoder,a);for(let[l,c]of i){if(c===0)continue;c<D(s.store,l)&&z(o,x(l,c));let h=s.store.clients.get(l)||[],u=rt(h,c-1);w(r.restEncoder,u+1),r.writeClient(l),w(r.restEncoder,0);for(let d=0;d<=u;d++)h[d].write(r,0)}mt(r,n)}),pi(e,r.toUint8Array(),"snapshot"),e},Kh=(s,t,e=J)=>{let i=new e(M(t)),n=new wt(i,!1);for(let o=n.curr;o!==null;o=n.next())if((s.sv.get(o.id.client)||0)<o.id.clock+o.length)return!1;let r=Xt([s.ds,Tt(i)]);return Ho(s.ds,r)},qh=(s,t)=>Kh(s,t,Z),ii=class{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}},xs=s=>{let t=new Map;return s.clients.forEach((e,i)=>{let n=e[e.length-1];t.set(i,n.id.clock+n.length)}),t},D=(s,t)=>{let e=s.clients.get(t);if(e===void 0)return 0;let i=e[e.length-1];return i.id.clock+i.length},Qo=(s,t)=>{let e=s.clients.get(t.id.client);if(e===void 0)e=[],s.clients.set(t.id.client,e);else{let i=e[e.length-1];if(i.id.clock+i.length!==t.id.clock)throw G()}e.push(t)},rt=(s,t)=>{let e=0,i=s.length-1,n=s[i],r=n.id.clock;if(r===t)return i;let o=X(t/(r+n.length-1)*i);for(;e<=i;){if(n=s[o],r=n.id.clock,r<=t){if(t<r+n.length)return o;e=o+1}else i=o-1;o=X((e+i)/2)}throw G()},zh=(s,t)=>{let e=s.clients.get(t.client);return e[rt(e,t.clock)]},Jt=zh,An=(s,t,e)=>{let i=rt(t,e),n=t[i];return n.id.clock<e&&n instanceof C?(t.splice(i+1,0,di(s,n,e-n.id.clock)),i+1):i},z=(s,t)=>{let e=s.doc.store.clients.get(t.client);return e[An(s,e,t.clock)]},In=(s,t,e)=>{let i=t.clients.get(e.client),n=rt(i,e.clock),r=i[n];return e.clock!==r.id.clock+r.length-1&&r.constructor!==H&&i.splice(n+1,0,di(s,r,e.clock-r.id.clock+1)),r},Hh=(s,t,e)=>{let i=s.clients.get(t.id.client);i[rt(i,t.id.clock)]=e},ta=(s,t,e,i,n)=>{if(i===0)return;let r=e+i,o=An(s,t,e),a;do a=t[o++],r<a.id.clock+a.length&&An(s,t,r),n(a);while(o<t.length&&t[o].id.clock<r)},ni=class{constructor(t,e,i){this.doc=t,this.deleteSet=new Mt,this.beforeState=xs(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=e,this.meta=new Map,this.local=i,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}},Ro=(s,t)=>t.deleteSet.clients.size===0&&!Lr(t.afterState,(e,i)=>t.beforeState.get(i)!==e)?!1:(Ln(t.deleteSet),bh(s,t),mt(s,t.deleteSet),!0),jo=(s,t,e)=>{let i=t._item;(i===null||i.id.clock<(s.beforeState.get(i.id.client)||0)&&!i.deleted)&&B(s.changed,t,ut).add(e)},Qs=(s,t)=>{let e=s[t],i=s[t-1],n=t;for(;n>0;e=i,i=s[--n-1]){if(i.deleted===e.deleted&&i.constructor===e.constructor&&i.mergeWith(e)){e instanceof C&&e.parentSub!==null&&e.parent._map.get(e.parentSub)===e&&e.parent._map.set(e.parentSub,i);continue}break}let r=t-n;return r&&s.splice(t+1-r,r),r},ea=(s,t,e)=>{for(let[i,n]of s.clients.entries()){let r=t.clients.get(i);for(let o=n.length-1;o>=0;o--){let a=n[o],l=a.clock+a.len;for(let c=rt(r,a.clock),h=r[c];c<r.length&&h.id.clock<l;h=r[++c]){let u=r[c];if(a.clock+a.len<=u.id.clock)break;u instanceof C&&u.deleted&&!u.keep&&e(u)&&u.gc(t,!1)}}}},sa=(s,t)=>{s.clients.forEach((e,i)=>{let n=t.clients.get(i);for(let r=e.length-1;r>=0;r--){let o=e[r],a=me(n.length-1,1+rt(n,o.clock+o.len-1));for(let l=a,c=n[l];l>0&&c.id.clock>=o.clock;c=n[l])l-=1+Qs(n,l)}})},Wh=(s,t,e)=>{ea(s,t,e),sa(s,t)},ia=(s,t)=>{if(t<s.length){let e=s[t],i=e.doc,n=i.store,r=e.deleteSet,o=e._mergeStructs;try{Ln(r),e.afterState=xs(e.doc.store),i.emit("beforeObserverCalls",[e,i]);let a=[];e.changed.forEach((l,c)=>a.push(()=>{(c._item===null||!c._item.deleted)&&c._callObserver(e,l)})),a.push(()=>{e.changedParentTypes.forEach((l,c)=>{c._dEH.l.length>0&&(c._item===null||!c._item.deleted)&&(l=l.filter(h=>h.target._item===null||!h.target._item.deleted),l.forEach(h=>{h.currentTarget=c,h._path=null}),l.sort((h,u)=>h.path.length-u.path.length),a.push(()=>{Yo(c._dEH,l,e)}))}),a.push(()=>i.emit("afterTransaction",[e,i])),a.push(()=>{e._needFormattingCleanup&&gu(e)})}),ss(a,[])}finally{i.gc&&ea(r,n,i.gcFilter),sa(r,n),e.afterState.forEach((h,u)=>{let d=e.beforeState.get(u)||0;if(d!==h){let f=n.clients.get(u),p=St(rt(f,d),1);for(let g=f.length-1;g>=p;)g-=1+Qs(f,g)}});for(let h=o.length-1;h>=0;h--){let{client:u,clock:d}=o[h].id,f=n.clients.get(u),p=rt(f,d);p+1<f.length&&Qs(f,p+1)>1||p>0&&Qs(f,p)}if(!e.local&&e.afterState.get(i.clientID)!==e.beforeState.get(i.clientID)&&(Gs(cs,os,"[yjs] ",as,ls,"Changed the client-id because another client seems to be using it."),i.clientID=Wo()),i.emit("afterTransactionCleanup",[e,i]),i._observers.has("update")){let h=new yt;Ro(h,e)&&i.emit("update",[h.toUint8Array(),e.origin,i,e])}if(i._observers.has("updateV2")){let h=new st;Ro(h,e)&&i.emit("updateV2",[h.toUint8Array(),e.origin,i,e])}let{subdocsAdded:a,subdocsLoaded:l,subdocsRemoved:c}=e;(a.size>0||c.size>0||l.size>0)&&(a.forEach(h=>{h.clientID=i.clientID,h.collectionid==null&&(h.collectionid=i.collectionid),i.subdocs.add(h)}),c.forEach(h=>i.subdocs.delete(h)),i.emit("subdocs",[{loaded:l,added:a,removed:c},i,e]),c.forEach(h=>h.destroy())),s.length<=t+1?(i._transactionCleanups=[],i.emit("afterAllTransactions",[i,s])):ia(s,t+1)}}},I=(s,t,e=null,i=!0)=>{let n=s._transactionCleanups,r=!1,o=null;s._transaction===null&&(r=!0,s._transaction=new ni(s,e,i),n.push(s._transaction),n.length===1&&s.emit("beforeAllTransactions",[s]),s.emit("beforeTransaction",[s._transaction,s]));try{o=t(s._transaction)}finally{if(r){let a=s._transaction===n[0];s._transaction=null,a&&ia(n,0)}}return o},Cn=class{constructor(t,e){this.insertions=e,this.deletions=t,this.meta=new Map}},Bo=(s,t,e)=>{Yt(s,e.deletions,i=>{i instanceof C&&t.scope.some(n=>n===s.doc||fs(n,i))&&Jn(i,!1)})},Fo=(s,t,e)=>{let i=null,n=s.doc,r=s.scope;I(n,a=>{for(;t.length>0&&s.currStackItem===null;){let l=n.store,c=t.pop(),h=new Set,u=[],d=!1;Yt(a,c.insertions,f=>{if(f instanceof C){if(f.redone!==null){let{item:p,diff:g}=En(l,f.id);g>0&&(p=z(a,x(p.id.client,p.id.clock+g))),f=p}!f.deleted&&r.some(p=>p===a.doc||fs(p,f))&&u.push(f)}}),Yt(a,c.deletions,f=>{f instanceof C&&r.some(p=>p===a.doc||fs(p,f))&&!oe(c.insertions,f.id)&&h.add(f)}),h.forEach(f=>{d=Ua(a,f,h,c.insertions,s.ignoreRemoteMapChanges,s)!==null||d});for(let f=u.length-1;f>=0;f--){let p=u[f];s.deleteFilter(p)&&(p.delete(a),d=!0)}s.currStackItem=d?c:null}a.changed.forEach((l,c)=>{l.has(null)&&c._searchMarker&&(c._searchMarker.length=0)}),i=a},s);let o=s.currStackItem;if(o!=null){let a=i.changedParentTypes;s.emit("stack-item-popped",[{stackItem:o,type:e,changedParentTypes:a,origin:s},s]),s.currStackItem=null}return o},Nn=class extends fe{constructor(t,{captureTimeout:e=500,captureTransaction:i=l=>!0,deleteFilter:n=()=>!0,trackedOrigins:r=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:a=ze(t)?t[0].doc:t instanceof $t?t:t.doc}={}){super(),this.scope=[],this.doc=a,this.addToScope(t),this.deleteFilter=n,r.add(this),this.trackedOrigins=r,this.captureTransaction=i,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=e,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(y=>l.changedParentTypes.has(y)||y===this.doc)||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;let c=this.undoing,h=this.redoing,u=c?this.redoStack:this.undoStack;c?this.stopCapturing():h||this.clear(!1,!0);let d=new Mt;l.afterState.forEach((y,m)=>{let _=l.beforeState.get(m)||0,S=y-_;S>0&&ds(d,m,_,S)});let f=et(),p=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&u.length>0&&!c&&!h){let y=u[u.length-1];y.deletions=Xt([y.deletions,l.deleteSet]),y.insertions=Xt([y.insertions,d])}else u.push(new Cn(l.deleteSet,d)),p=!0;!c&&!h&&(this.lastChange=f),Yt(l,l.deleteSet,y=>{y instanceof C&&this.scope.some(m=>m===l.doc||fs(m,y))&&Jn(y,!0)});let g=[{stackItem:u[u.length-1],origin:l.origin,type:c?"redo":"undo",changedParentTypes:l.changedParentTypes},this];p?this.emit("stack-item-added",g):this.emit("stack-item-updated",g)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){let e=new Set(this.scope);t=ze(t)?t:[t],t.forEach(i=>{e.has(i)||(e.add(i),(i instanceof $?i.doc!==this.doc:i!==this.doc)&&bn("[yjs#509] Not same Y.Doc"),this.scope.push(i))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,e=!0){(t&&this.canUndo()||e&&this.canRedo())&&this.doc.transact(i=>{t&&(this.undoStack.forEach(n=>Bo(i,this,n)),this.undoStack=[]),e&&(this.redoStack.forEach(n=>Bo(i,this,n)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:e}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=Fo(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=Fo(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}};wt=class{constructor(t,e){this.gen=Gh(t),this.curr=null,this.done=!1,this.filterSkips=e,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===V);return this.curr}},Jh=s=>na(s,Z),na=(s,t=J)=>{let e=[],i=new t(M(s)),n=new wt(i,!1);for(let o=n.curr;o!==null;o=n.next())e.push(o);Gs("Structs: ",e);let r=Tt(i);Gs("DeleteSet: ",r)},Yh=s=>ra(s,Z),ra=(s,t=J)=>{let e=[],i=new t(M(s)),n=new wt(i,!1);for(let r=n.curr;r!==null;r=n.next())e.push(r);return{structs:e,ds:Tt(i)}},gs=class{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}},oa=s=>ms(s,Z,yt),aa=(s,t=Ee,e=J)=>{let i=new t,n=new wt(new e(M(s)),!1),r=n.curr;if(r!==null){let o=0,a=r.id.client,l=r.id.clock!==0,c=l?0:r.id.clock+r.length;for(;r!==null;r=n.next())a!==r.id.client&&(c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c)),a=r.id.client,c=0,l=r.id.clock!==0),r.constructor===V&&(l=!0),l||(c=r.id.clock+r.length);c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c));let h=L();return w(h,o),Hr(h,i.restEncoder),i.restEncoder=h,i.toUint8Array()}else return w(i.restEncoder,0),i.toUint8Array()},Xh=s=>aa(s,Ot,Z),la=(s,t=J)=>{let e=new Map,i=new Map,n=new wt(new t(M(s)),!1),r=n.curr;if(r!==null){let o=r.id.client,a=r.id.clock;for(e.set(o,a);r!==null;r=n.next())o!==r.id.client&&(i.set(o,a),e.set(r.id.client,r.id.clock),o=r.id.client),a=r.id.clock+r.length;i.set(o,a)}return{from:e,to:i}},Zh=s=>la(s,Z),Qh=(s,t)=>{if(s.constructor===H){let{client:e,clock:i}=s.id;return new H(x(e,i+t),s.length-t)}else if(s.constructor===V){let{client:e,clock:i}=s.id;return new V(x(e,i+t),s.length-t)}else{let e=s,{client:i,clock:n}=e.id;return new C(x(i,n+t),null,x(i,n+t-1),null,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t))}},ms=(s,t=J,e=st)=>{if(s.length===1)return s[0];let i=s.map(h=>new t(M(h))),n=i.map(h=>new wt(h,!0)),r=null,o=new e,a=new gs(o);for(;n=n.filter(d=>d.curr!==null),n.sort((d,f)=>{if(d.curr.id.client===f.curr.id.client){let p=d.curr.id.clock-f.curr.id.clock;return p===0?d.curr.constructor===f.curr.constructor?0:d.curr.constructor===V?1:-1:p}else return f.curr.id.client-d.curr.id.client}),n.length!==0;){let h=n[0],u=h.curr.id.client;if(r!==null){let d=h.curr,f=!1;for(;d!==null&&d.id.clock+d.length<=r.struct.id.clock+r.struct.length&&d.id.client>=r.struct.id.client;)d=h.next(),f=!0;if(d===null||d.id.client!==u||f&&d.id.clock>r.struct.id.clock+r.struct.length)continue;if(u!==r.struct.id.client)Dt(a,r.struct,r.offset),r={struct:d,offset:0},h.next();else if(r.struct.id.clock+r.struct.length<d.id.clock)if(r.struct.constructor===V)r.struct.length=d.id.clock+d.length-r.struct.id.clock;else{Dt(a,r.struct,r.offset);let p=d.id.clock-r.struct.id.clock-r.struct.length;r={struct:new V(x(u,r.struct.id.clock+r.struct.length),p),offset:0}}else{let p=r.struct.id.clock+r.struct.length-d.id.clock;p>0&&(r.struct.constructor===V?r.struct.length-=p:d=Qh(d,p)),r.struct.mergeWith(d)||(Dt(a,r.struct,r.offset),r={struct:d,offset:0},h.next())}}else r={struct:h.curr,offset:0},h.next();for(let d=h.curr;d!==null&&d.id.client===u&&d.id.clock===r.struct.id.clock+r.struct.length&&d.constructor!==V;d=h.next())Dt(a,r.struct,r.offset),r={struct:d,offset:0}}r!==null&&(Dt(a,r.struct,r.offset),r=null),zn(a);let l=i.map(h=>Tt(h)),c=Xt(l);return mt(o,c),o.toUint8Array()},qn=(s,t,e=J,i=st)=>{let n=Bn(t),r=new i,o=new gs(r),a=new e(M(s)),l=new wt(a,!1);for(;l.curr;){let h=l.curr,u=h.id.client,d=n.get(u)||0;if(l.curr.constructor===V){l.next();continue}if(h.id.clock+h.length>d)for(Dt(o,h,St(d-h.id.clock,0)),l.next();l.curr&&l.curr.id.client===u;)Dt(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===u&&l.curr.id.clock+l.curr.length<=d;)l.next()}zn(o);let c=Tt(a);return mt(r,c),r.toUint8Array()},tu=(s,t)=>qn(s,t,Z,yt),ca=s=>{s.written>0&&(s.clientStructs.push({written:s.written,restEncoder:A(s.encoder.restEncoder)}),s.encoder.restEncoder=L(),s.written=0)},Dt=(s,t,e)=>{s.written>0&&s.currClient!==t.id.client&&ca(s),s.written===0&&(s.currClient=t.id.client,s.encoder.writeClient(t.id.client),w(s.encoder.restEncoder,t.id.clock+e)),t.write(s.encoder,e),s.written++},zn=s=>{ca(s);let t=s.encoder.restEncoder;w(t,s.clientStructs.length);for(let e=0;e<s.clientStructs.length;e++){let i=s.clientStructs[e];w(t,i.written),ve(t,i.restEncoder)}},gi=(s,t,e,i)=>{let n=new e(M(s)),r=new wt(n,!1),o=new i,a=new gs(o);for(let c=r.curr;c!==null;c=r.next())Dt(a,t(c),0);zn(a);let l=Tt(n);return mt(o,l),o.toUint8Array()},ha=({formatting:s=!0,subdocs:t=!0,yxml:e=!0}={})=>{let i=0,n=R(),r=R(),o=R(),a=R();return a.set(null,null),l=>{switch(l.constructor){case H:case V:return l;case C:{let c=l,h=c.content;switch(h.constructor){case $e:break;case ot:{if(e){let u=h.type;u instanceof ie&&(u.nodeName=B(r,u.nodeName,()=>"node-"+i)),u instanceof bs&&(u.hookName=B(r,u.hookName,()=>"hook-"+i))}break}case Rt:{let u=h;u.arr=u.arr.map(()=>i);break}case ne:{let u=h;u.content=new Uint8Array([i]);break}case re:{let u=h;t&&(u.opts={},u.doc.guid=i+"");break}case vt:{let u=h;u.embed={};break}case O:{let u=h;s&&(u.key=B(o,u.key,()=>i+""),u.value=B(a,u.value,()=>({i})));break}case Ss:{let u=h;u.arr=u.arr.map(()=>i);break}case ht:{let u=h;u.str=Vr(i%10+"",u.str.length);break}default:G()}return c.parentSub&&(c.parentSub=B(n,c.parentSub,()=>i+"")),i++,l}default:G()}}},eu=(s,t)=>gi(s,ha(t),Z,yt),su=(s,t)=>gi(s,ha(t),J,st),iu=s=>gi(s,cn,Z,st),ua=s=>gi(s,cn,J,yt),Vo="You must not compute changes after the event-handler fired.",Qt=class{constructor(t,e){this.target=t,this.currentTarget=t,this.transaction=e,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=nu(this.currentTarget,this.target))}deletes(t){return oe(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw ft(Vo);let t=new Map,e=this.target;this.transaction.changed.get(e).forEach(n=>{if(n!==null){let r=e._map.get(n),o,a;if(this.adds(r)){let l=r.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(r))if(l!==null&&this.deletes(l))o="delete",a=Ms(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",a=Ms(l.content.getContent())):(o="add",a=void 0)}else if(this.deletes(r))o="delete",a=Ms(r.content.getContent());else return;t.set(n,{action:o,oldValue:a})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw ft(Vo);let e=this.target,i=ut(),n=ut(),r=[];if(t={added:i,deleted:n,delta:r,keys:this.keys},this.transaction.changed.get(e).has(null)){let a=null,l=()=>{a&&r.push(a)};for(let c=e._start;c!==null;c=c.right)c.deleted?this.deletes(c)&&!this.adds(c)&&((a===null||a.delete===void 0)&&(l(),a={delete:0}),a.delete+=c.length,n.add(c)):this.adds(c)?((a===null||a.insert===void 0)&&(l(),a={insert:[]}),a.insert=a.insert.concat(c.content.getContent()),i.add(c)):((a===null||a.retain===void 0)&&(l(),a={retain:0}),a.retain+=c.length);a!==null&&a.retain===void 0&&l()}this._changes=t}return t}},nu=(s,t)=>{let e=[];for(;t._item!==null&&t!==s;){if(t._item.parentSub!==null)e.unshift(t._item.parentSub);else{let i=0,n=t._item.parent._start;for(;n!==t._item&&n!==null;)!n.deleted&&n.countable&&(i+=n.length),n=n.right;e.unshift(i)}t=t._item.parent}return e},P=()=>{bn("Invalid access: Add Yjs type to a document before reading data.")},da=80,Hn=0,Un=class{constructor(t,e){t.marker=!0,this.p=t,this.index=e,this.timestamp=Hn++}},ru=s=>{s.timestamp=Hn++},fa=(s,t,e)=>{s.p.marker=!1,s.p=t,t.marker=!0,s.index=e,s.timestamp=Hn++},ou=(s,t,e)=>{if(s.length>=da){let i=s.reduce((n,r)=>n.timestamp<r.timestamp?n:r);return fa(i,t,e),i}else{let i=new Un(t,e);return s.push(i),i}},mi=(s,t)=>{if(s._start===null||t===0||s._searchMarker===null)return null;let e=s._searchMarker.length===0?null:s._searchMarker.reduce((r,o)=>ge(t-r.index)<ge(t-o.index)?r:o),i=s._start,n=0;for(e!==null&&(i=e.p,n=e.index,ru(e));i.right!==null&&n<t;){if(!i.deleted&&i.countable){if(t<n+i.length)break;n+=i.length}i=i.right}for(;i.left!==null&&n>t;)i=i.left,!i.deleted&&i.countable&&(n-=i.length);for(;i.left!==null&&i.left.id.client===i.id.client&&i.left.id.clock+i.left.length===i.id.clock;)i=i.left,!i.deleted&&i.countable&&(n-=i.length);return e!==null&&ge(e.index-n)<i.parent.length/da?(fa(e,i,n),e):ou(s._searchMarker,i,n)},ys=(s,t,e)=>{for(let i=s.length-1;i>=0;i--){let n=s[i];if(e>0){let r=n.p;for(r.marker=!1;r&&(r.deleted||!r.countable);)r=r.left,r&&!r.deleted&&r.countable&&(n.index-=r.length);if(r===null||r.marker===!0){s.splice(i,1);continue}n.p=r,r.marker=!0}(t<n.index||e>0&&t===n.index)&&(n.index=St(t,n.index+e))}},au=s=>{s.doc??P();let t=s._start,e=[];for(;t;)e.push(t),t=t.right;return e},yi=(s,t,e)=>{let i=s,n=t.changedParentTypes;for(;B(n,s,()=>[]).push(e),s._item!==null;)s=s._item.parent;Yo(i._eH,e,t)},$=class{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Do(),this._dEH=Do(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,e){this.doc=t,this._item=e}_copy(){throw ct()}clone(){throw ct()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,e){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){Lo(this._eH,t)}observeDeep(t){Lo(this._dEH,t)}unobserve(t){Mo(this._eH,t)}unobserveDeep(t){Mo(this._dEH,t)}toJSON(){}},pa=(s,t,e)=>{s.doc??P(),t<0&&(t=s._length+t),e<0&&(e=s._length+e);let i=e-t,n=[],r=s._start;for(;r!==null&&i>0;){if(r.countable&&!r.deleted){let o=r.content.getContent();if(o.length<=t)t-=o.length;else{for(let a=t;a<o.length&&i>0;a++)n.push(o[a]),i--;t=0}}r=r.right}return n},ga=s=>{s.doc??P();let t=[],e=s._start;for(;e!==null;){if(e.countable&&!e.deleted){let i=e.content.getContent();for(let n=0;n<i.length;n++)t.push(i[n])}e=e.right}return t},lu=(s,t)=>{let e=[],i=s._start;for(;i!==null;){if(i.countable&&Et(i,t)){let n=i.content.getContent();for(let r=0;r<n.length;r++)e.push(n[r])}i=i.right}return e},ws=(s,t)=>{let e=0,i=s._start;for(s.doc??P();i!==null;){if(i.countable&&!i.deleted){let n=i.content.getContent();for(let r=0;r<n.length;r++)t(n[r],e++,s)}i=i.right}},ma=(s,t)=>{let e=[];return ws(s,(i,n)=>{e.push(t(i,n,s))}),e},cu=s=>{let t=s._start,e=null,i=0;return{[Symbol.iterator](){return this},next:()=>{if(e===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};e=t.content.getContent(),i=0,t=t.right}let n=e[i++];return e.length<=i&&(e=null),{done:!1,value:n}}}},ya=(s,t)=>{s.doc??P();let e=mi(s,t),i=s._start;for(e!==null&&(i=e.p,t-=e.index);i!==null;i=i.right)if(!i.deleted&&i.countable){if(t<i.length)return i.content.getContent()[t];t-=i.length}},ri=(s,t,e,i)=>{let n=e,r=s.doc,o=r.clientID,a=r.store,l=e===null?t._start:e.right,c=[],h=()=>{c.length>0&&(n=new C(x(o,D(a,o)),n,n&&n.lastId,l,l&&l.id,t,null,new Rt(c)),n.integrate(s,0),c=[])};i.forEach(u=>{if(u===null)c.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:c.push(u);break;default:switch(h(),u.constructor){case Uint8Array:case ArrayBuffer:n=new C(x(o,D(a,o)),n,n&&n.lastId,l,l&&l.id,t,null,new ne(new Uint8Array(u))),n.integrate(s,0);break;case $t:n=new C(x(o,D(a,o)),n,n&&n.lastId,l,l&&l.id,t,null,new re(u)),n.integrate(s,0);break;default:if(u instanceof $)n=new C(x(o,D(a,o)),n,n&&n.lastId,l,l&&l.id,t,null,new ot(u)),n.integrate(s,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},wa=()=>ft("Length exceeded!"),_a=(s,t,e,i)=>{if(e>t._length)throw wa();if(e===0)return t._searchMarker&&ys(t._searchMarker,e,i.length),ri(s,t,null,i);let n=e,r=mi(t,e),o=t._start;for(r!==null&&(o=r.p,e-=r.index,e===0&&(o=o.prev,e+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(e<=o.length){e<o.length&&z(s,x(o.id.client,o.id.clock+e));break}e-=o.length}return t._searchMarker&&ys(t._searchMarker,n,i.length),ri(s,t,o,i)},hu=(s,t,e)=>{let n=(t._searchMarker||[]).reduce((r,o)=>o.index>r.index?o:r,{index:0,p:t._start}).p;if(n)for(;n.right;)n=n.right;return ri(s,t,n,e)},ba=(s,t,e,i)=>{if(i===0)return;let n=e,r=i,o=mi(t,e),a=t._start;for(o!==null&&(a=o.p,e-=o.index);a!==null&&e>0;a=a.right)!a.deleted&&a.countable&&(e<a.length&&z(s,x(a.id.client,a.id.clock+e)),e-=a.length);for(;i>0&&a!==null;)a.deleted||(i<a.length&&z(s,x(a.id.client,a.id.clock+i)),a.delete(s),i-=a.length),a=a.right;if(i>0)throw wa();t._searchMarker&&ys(t._searchMarker,n,-r+i)},oi=(s,t,e)=>{let i=t._map.get(e);i!==void 0&&i.delete(s)},Wn=(s,t,e,i)=>{let n=t._map.get(e)||null,r=s.doc,o=r.clientID,a;if(i==null)a=new Rt([i]);else switch(i.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:a=new Rt([i]);break;case Uint8Array:a=new ne(i);break;case $t:a=new re(i);break;default:if(i instanceof $)a=new ot(i);else throw new Error("Unexpected content type")}new C(x(o,D(r.store,o)),n,n&&n.lastId,null,null,t,e,a).integrate(s,0)},Gn=(s,t)=>{s.doc??P();let e=s._map.get(t);return e!==void 0&&!e.deleted?e.content.getContent()[e.length-1]:void 0},Sa=s=>{let t={};return s.doc??P(),s._map.forEach((e,i)=>{e.deleted||(t[i]=e.content.getContent()[e.length-1])}),t},xa=(s,t)=>{s.doc??P();let e=s._map.get(t);return e!==void 0&&!e.deleted},uu=(s,t,e)=>{let i=s._map.get(t)||null;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;return i!==null&&Et(i,e)?i.content.getContent()[i.length-1]:void 0},ka=(s,t)=>{let e={};return s._map.forEach((i,n)=>{let r=i;for(;r!==null&&(!t.sv.has(r.id.client)||r.id.clock>=(t.sv.get(r.id.client)||0));)r=r.left;r!==null&&Et(r,t)&&(e[n]=r.content.getContent()[r.length-1])}),e},Xs=s=>(s.doc??P(),Io(s._map.entries(),t=>!t[1].deleted)),ai=class extends Qt{},te=class s extends ${constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){let e=new s;return e.push(t),e}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let t=new s;return t.insert(0,this.toArray().map(e=>e instanceof $?e.clone():e)),t}get length(){return this.doc??P(),this._length}_callObserver(t,e){super._callObserver(t,e),yi(this,t,new ai(this,t))}insert(t,e){this.doc!==null?I(this.doc,i=>{_a(i,this,t,e)}):this._prelimContent.splice(t,0,...e)}push(t){this.doc!==null?I(this.doc,e=>{hu(e,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,e=1){this.doc!==null?I(this.doc,i=>{ba(i,this,t,e)}):this._prelimContent.splice(t,e)}get(t){return ya(this,t)}toArray(){return ga(this)}slice(t=0,e=this.length){return pa(this,t,e)}toJSON(){return this.map(t=>t instanceof $?t.toJSON():t)}map(t){return ma(this,t)}forEach(t){ws(this,t)}[Symbol.iterator](){return cu(this)}_write(t){t.writeTypeRef(Du)}},du=s=>new te,li=class extends Qt{constructor(t,e,i){super(t,e),this.keysChanged=i}},ee=class s extends ${constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,e){super._integrate(t,e),this._prelimContent.forEach((i,n)=>{this.set(n,i)}),this._prelimContent=null}_copy(){return new s}clone(){let t=new s;return this.forEach((e,i)=>{t.set(i,e instanceof $?e.clone():e)}),t}_callObserver(t,e){yi(this,t,new li(this,t,e))}toJSON(){this.doc??P();let t={};return this._map.forEach((e,i)=>{if(!e.deleted){let n=e.content.getContent()[e.length-1];t[i]=n instanceof $?n.toJSON():n}}),t}get size(){return[...Xs(this)].length}keys(){return Js(Xs(this),t=>t[0])}values(){return Js(Xs(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Js(Xs(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??P(),this._map.forEach((e,i)=>{e.deleted||t(e.content.getContent()[e.length-1],i,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?I(this.doc,e=>{oi(e,this,t)}):this._prelimContent.delete(t)}set(t,e){return this.doc!==null?I(this.doc,i=>{Wn(i,this,t,e)}):this._prelimContent.set(t,e),e}get(t){return Gn(this,t)}has(t){return xa(this,t)}clear(){this.doc!==null?I(this.doc,t=>{this.forEach(function(e,i,n){oi(t,n,i)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Lu)}},fu=s=>new ee,Lt=(s,t)=>s===t||typeof s=="object"&&typeof t=="object"&&s&&t&&on(s,t),_s=class{constructor(t,e,i,n){this.left=t,this.right=e,this.index=i,this.currentAttributes=n}forward(){switch(this.right===null&&G(),this.right.content.constructor){case O:this.right.deleted||Oe(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}},Po=(s,t,e)=>{for(;t.right!==null&&e>0;){switch(t.right.content.constructor){case O:t.right.deleted||Oe(t.currentAttributes,t.right.content);break;default:t.right.deleted||(e<t.right.length&&z(s,x(t.right.id.client,t.right.id.clock+e)),t.index+=t.right.length,e-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},Zs=(s,t,e,i)=>{let n=new Map,r=i?mi(t,e):null;if(r){let o=new _s(r.p.left,r.p,r.index,n);return Po(s,o,e-r.index)}else{let o=new _s(null,t._start,0,n);return Po(s,o,e)}},Ta=(s,t,e,i)=>{for(;e.right!==null&&(e.right.deleted===!0||e.right.content.constructor===O&&Lt(i.get(e.right.content.key),e.right.content.value));)e.right.deleted||i.delete(e.right.content.key),e.forward();let n=s.doc,r=n.clientID;i.forEach((o,a)=>{let l=e.left,c=e.right,h=new C(x(r,D(n.store,r)),l,l&&l.lastId,c,c&&c.id,t,null,new O(a,o));h.integrate(s,0),e.right=h,e.forward()})},Oe=(s,t)=>{let{key:e,value:i}=t;i===null?s.delete(e):s.set(e,i)},va=(s,t)=>{for(;s.right!==null;){if(!(s.right.deleted||s.right.content.constructor===O&&Lt(t[s.right.content.key]??null,s.right.content.value)))break;s.forward()}},Aa=(s,t,e,i)=>{let n=s.doc,r=n.clientID,o=new Map;for(let a in i){let l=i[a],c=e.currentAttributes.get(a)??null;if(!Lt(c,l)){o.set(a,c);let{left:h,right:u}=e;e.right=new C(x(r,D(n.store,r)),h,h&&h.lastId,u,u&&u.id,t,null,new O(a,l)),e.right.integrate(s,0),e.forward()}}return o},Sn=(s,t,e,i,n)=>{e.currentAttributes.forEach((d,f)=>{n[f]===void 0&&(n[f]=null)});let r=s.doc,o=r.clientID;va(e,n);let a=Aa(s,t,e,n),l=i.constructor===String?new ht(i):i instanceof $?new ot(i):new vt(i),{left:c,right:h,index:u}=e;t._searchMarker&&ys(t._searchMarker,e.index,l.getLength()),h=new C(x(o,D(r.store,o)),c,c&&c.lastId,h,h&&h.id,t,null,l),h.integrate(s,0),e.right=h,e.index=u,e.forward(),Ta(s,t,e,a)},Ko=(s,t,e,i,n)=>{let r=s.doc,o=r.clientID;va(e,n);let a=Aa(s,t,e,n);t:for(;e.right!==null&&(i>0||a.size>0&&(e.right.deleted||e.right.content.constructor===O));){if(!e.right.deleted)switch(e.right.content.constructor){case O:{let{key:l,value:c}=e.right.content,h=n[l];if(h!==void 0){if(Lt(h,c))a.delete(l);else{if(i===0)break t;a.set(l,c)}e.right.delete(s)}else e.currentAttributes.set(l,c);break}default:i<e.right.length&&z(s,x(e.right.id.client,e.right.id.clock+i)),i-=e.right.length;break}e.forward()}if(i>0){let l="";for(;i>0;i--)l+=`
`;e.right=new C(x(o,D(r.store,o)),e.left,e.left&&e.left.lastId,e.right,e.right&&e.right.id,t,null,new ht(l)),e.right.integrate(s,0),e.forward()}Ta(s,t,e,a)},Ia=(s,t,e,i,n)=>{let r=t,o=R();for(;r&&(!r.countable||r.deleted);){if(!r.deleted&&r.content.constructor===O){let c=r.content;o.set(c.key,c)}r=r.right}let a=0,l=!1;for(;t!==r;){if(e===t&&(l=!0),!t.deleted){let c=t.content;switch(c.constructor){case O:{let{key:h,value:u}=c,d=i.get(h)??null;(o.get(h)!==c||d===u)&&(t.delete(s),a++,!l&&(n.get(h)??null)===u&&d!==u&&(d===null?n.delete(h):n.set(h,d))),!l&&!t.deleted&&Oe(n,c);break}}}t=t.right}return a},pu=(s,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;let e=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===O){let i=t.content.key;e.has(i)?t.delete(s):e.add(i)}t=t.left}},Ca=s=>{let t=0;return I(s.doc,e=>{let i=s._start,n=s._start,r=R(),o=Es(r);for(;n;){if(n.deleted===!1)switch(n.content.constructor){case O:Oe(o,n.content);break;default:t+=Ia(e,i,n,r,o),r=Es(o),i=n;break}n=n.right}}),t},gu=s=>{let t=new Set,e=s.doc;for(let[i,n]of s.afterState.entries()){let r=s.beforeState.get(i)||0;n!==r&&ta(s,e.store.clients.get(i),r,n,o=>{!o.deleted&&o.content.constructor===O&&o.constructor!==H&&t.add(o.parent)})}I(e,i=>{Yt(s,s.deleteSet,n=>{if(n instanceof H||!n.parent._hasFormatting||t.has(n.parent))return;let r=n.parent;n.content.constructor===O?t.add(r):pu(i,n)});for(let n of t)Ca(n)})},qo=(s,t,e)=>{let i=e,n=Es(t.currentAttributes),r=t.right;for(;e>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case ot:case vt:case ht:e<t.right.length&&z(s,x(t.right.id.client,t.right.id.clock+e)),e-=t.right.length,t.right.delete(s);break}t.forward()}r&&Ia(s,r,t.right,n,t.currentAttributes);let o=(t.left||t.right).parent;return o._searchMarker&&ys(o._searchMarker,t.index,-i+e),t},ci=class extends Qt{constructor(t,e,i){super(t,e),this.childListChanged=!1,this.keysChanged=new Set,i.forEach(n=>{n===null?this.childListChanged=!0:this.keysChanged.add(n)})}get changes(){if(this._changes===null){let t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){let t=this.target.doc,e=[];I(t,i=>{let n=new Map,r=new Map,o=this.target._start,a=null,l={},c="",h=0,u=0,d=()=>{if(a!==null){let f=null;switch(a){case"delete":u>0&&(f={delete:u}),u=0;break;case"insert":(typeof c=="object"||c.length>0)&&(f={insert:c},n.size>0&&(f.attributes={},n.forEach((p,g)=>{p!==null&&(f.attributes[g]=p)}))),c="";break;case"retain":h>0&&(f={retain:h},uo(l)||(f.attributes=lo({},l))),h=0;break}f&&e.push(f),a=null}};for(;o!==null;){switch(o.content.constructor){case ot:case vt:this.adds(o)?this.deletes(o)||(d(),a="insert",c=o.content.getContent()[0],d()):this.deletes(o)?(a!=="delete"&&(d(),a="delete"),u+=1):o.deleted||(a!=="retain"&&(d(),a="retain"),h+=1);break;case ht:this.adds(o)?this.deletes(o)||(a!=="insert"&&(d(),a="insert"),c+=o.content.str):this.deletes(o)?(a!=="delete"&&(d(),a="delete"),u+=o.length):o.deleted||(a!=="retain"&&(d(),a="retain"),h+=o.length);break;case O:{let{key:f,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){let g=n.get(f)??null;Lt(g,p)?p!==null&&o.delete(i):(a==="retain"&&d(),Lt(p,r.get(f)??null)?delete l[f]:l[f]=p)}}else if(this.deletes(o)){r.set(f,p);let g=n.get(f)??null;Lt(g,p)||(a==="retain"&&d(),l[f]=g)}else if(!o.deleted){r.set(f,p);let g=l[f];g!==void 0&&(Lt(g,p)?g!==null&&o.delete(i):(a==="retain"&&d(),p===null?delete l[f]:l[f]=p))}o.deleted||(a==="insert"&&d(),Oe(n,o.content));break}}o=o.right}for(d();e.length>0;){let f=e[e.length-1];if(f.retain!==void 0&&f.attributes===void 0)e.pop();else break}}),this._delta=e}return this._delta}},Le=class s extends ${constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??P(),this._length}_integrate(t,e){super._integrate(t,e);try{this._pending.forEach(i=>i())}catch(i){console.error(i)}this._pending=null}_copy(){return new s}clone(){let t=new s;return t.applyDelta(this.toDelta()),t}_callObserver(t,e){super._callObserver(t,e);let i=new ci(this,t,e);yi(this,t,i),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??P();let t="",e=this._start;for(;e!==null;)!e.deleted&&e.countable&&e.content.constructor===ht&&(t+=e.content.str),e=e.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:e=!0}={}){this.doc!==null?I(this.doc,i=>{let n=new _s(null,this._start,0,new Map);for(let r=0;r<t.length;r++){let o=t[r];if(o.insert!==void 0){let a=!e&&typeof o.insert=="string"&&r===t.length-1&&n.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof a!="string"||a.length>0)&&Sn(i,this,n,a,o.attributes||{})}else o.retain!==void 0?Ko(i,this,n,o.retain,o.attributes||{}):o.delete!==void 0&&qo(i,n,o.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,e,i){this.doc??P();let n=[],r=new Map,o=this.doc,a="",l=this._start;function c(){if(a.length>0){let u={},d=!1;r.forEach((p,g)=>{d=!0,u[g]=p});let f={insert:a};d&&(f.attributes=u),n.push(f),a=""}}let h=()=>{for(;l!==null;){if(Et(l,t)||e!==void 0&&Et(l,e))switch(l.content.constructor){case ht:{let u=r.get("ychange");t!==void 0&&!Et(l,t)?(u===void 0||u.user!==l.id.client||u.type!=="removed")&&(c(),r.set("ychange",i?i("removed",l.id):{type:"removed"})):e!==void 0&&!Et(l,e)?(u===void 0||u.user!==l.id.client||u.type!=="added")&&(c(),r.set("ychange",i?i("added",l.id):{type:"added"})):u!==void 0&&(c(),r.delete("ychange")),a+=l.content.str;break}case ot:case vt:{c();let u={insert:l.content.getContent()[0]};if(r.size>0){let d={};u.attributes=d,r.forEach((f,p)=>{d[p]=f})}n.push(u);break}case O:Et(l,t)&&(c(),Oe(r,l.content));break}l=l.right}c()};return t||e?I(o,u=>{t&&vn(u,t),e&&vn(u,e),h()},"cleanup"):h(),n}insert(t,e,i){if(e.length<=0)return;let n=this.doc;n!==null?I(n,r=>{let o=Zs(r,this,t,!i);i||(i={},o.currentAttributes.forEach((a,l)=>{i[l]=a})),Sn(r,this,o,e,i)}):this._pending.push(()=>this.insert(t,e,i))}insertEmbed(t,e,i){let n=this.doc;n!==null?I(n,r=>{let o=Zs(r,this,t,!i);Sn(r,this,o,e,i||{})}):this._pending.push(()=>this.insertEmbed(t,e,i||{}))}delete(t,e){if(e===0)return;let i=this.doc;i!==null?I(i,n=>{qo(n,Zs(n,this,t,!0),e)}):this._pending.push(()=>this.delete(t,e))}format(t,e,i){if(e===0)return;let n=this.doc;n!==null?I(n,r=>{let o=Zs(r,this,t,!1);o.right!==null&&Ko(r,this,o,e,i)}):this._pending.push(()=>this.format(t,e,i))}removeAttribute(t){this.doc!==null?I(this.doc,e=>{oi(e,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,e){this.doc!==null?I(this.doc,i=>{Wn(i,this,t,e)}):this._pending.push(()=>this.setAttribute(t,e))}getAttribute(t){return Gn(this,t)}getAttributes(){return Sa(this)}_write(t){t.writeTypeRef(Mu)}},mu=s=>new Le,hs=class{constructor(t,e=()=>!0){this._filter=e,this._root=t,this._currentNode=t._start,this._firstCall=!0,t.doc??P()}[Symbol.iterator](){return this}next(){let t=this._currentNode,e=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(e)))do if(e=t.content.type,!t.deleted&&(e.constructor===ie||e.constructor===se)&&e._start!==null)t=e._start;else for(;t!==null;){let i=t.next;if(i!==null){t=i;break}else t.parent===this._root?t=null:t=t.parent._item}while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}},se=class s extends ${constructor(){super(),this._prelimContent=[]}get firstChild(){let t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let t=new s;return t.insert(0,this.toArray().map(e=>e instanceof $?e.clone():e)),t}get length(){return this.doc??P(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new hs(this,t)}querySelector(t){t=t.toUpperCase();let i=new hs(this,n=>n.nodeName&&n.nodeName.toUpperCase()===t).next();return i.done?null:i.value}querySelectorAll(t){return t=t.toUpperCase(),lt(new hs(this,e=>e.nodeName&&e.nodeName.toUpperCase()===t))}_callObserver(t,e){yi(this,t,new hi(this,e,t))}toString(){return ma(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,e={},i){let n=t.createDocumentFragment();return i!==void 0&&i._createAssociation(n,this),ws(this,r=>{n.insertBefore(r.toDOM(t,e,i),null)}),n}insert(t,e){this.doc!==null?I(this.doc,i=>{_a(i,this,t,e)}):this._prelimContent.splice(t,0,...e)}insertAfter(t,e){if(this.doc!==null)I(this.doc,i=>{let n=t&&t instanceof $?t._item:t;ri(i,this,n,e)});else{let i=this._prelimContent,n=t===null?0:i.findIndex(r=>r===t)+1;if(n===0&&t!==null)throw ft("Reference item not found");i.splice(n,0,...e)}}delete(t,e=1){this.doc!==null?I(this.doc,i=>{ba(i,this,t,e)}):this._prelimContent.splice(t,e)}toArray(){return ga(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return ya(this,t)}slice(t=0,e=this.length){return pa(this,t,e)}forEach(t){ws(this,t)}_write(t){t.writeTypeRef(Ou)}},yu=s=>new se,ie=class s extends se{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){let t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){let t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,e){super._integrate(t,e),this._prelimAttrs.forEach((i,n)=>{this.setAttribute(n,i)}),this._prelimAttrs=null}_copy(){return new s(this.nodeName)}clone(){let t=new s(this.nodeName),e=this.getAttributes();return co(e,(i,n)=>{t.setAttribute(n,i)}),t.insert(0,this.toArray().map(i=>i instanceof $?i.clone():i)),t}toString(){let t=this.getAttributes(),e=[],i=[];for(let a in t)i.push(a);i.sort();let n=i.length;for(let a=0;a<n;a++){let l=i[a];e.push(l+'="'+t[l]+'"')}let r=this.nodeName.toLocaleLowerCase(),o=e.length>0?" "+e.join(" "):"";return`<${r}${o}>${super.toString()}</${r}>`}removeAttribute(t){this.doc!==null?I(this.doc,e=>{oi(e,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,e){this.doc!==null?I(this.doc,i=>{Wn(i,this,t,e)}):this._prelimAttrs.set(t,e)}getAttribute(t){return Gn(this,t)}hasAttribute(t){return xa(this,t)}getAttributes(t){return t?ka(this,t):Sa(this)}toDOM(t=document,e={},i){let n=t.createElement(this.nodeName),r=this.getAttributes();for(let o in r){let a=r[o];typeof a=="string"&&n.setAttribute(o,a)}return ws(this,o=>{n.appendChild(o.toDOM(t,e,i))}),i!==void 0&&i._createAssociation(n,this),n}_write(t){t.writeTypeRef($u),t.writeKey(this.nodeName)}},wu=s=>new ie(s.readKey()),hi=class extends Qt{constructor(t,e,i){super(t,i),this.childListChanged=!1,this.attributesChanged=new Set,e.forEach(n=>{n===null?this.childListChanged=!0:this.attributesChanged.add(n)})}},bs=class s extends ee{constructor(t){super(),this.hookName=t}_copy(){return new s(this.hookName)}clone(){let t=new s(this.hookName);return this.forEach((e,i)=>{t.set(i,e)}),t}toDOM(t=document,e={},i){let n=e[this.hookName],r;return n!==void 0?r=n.createDom(this):r=document.createElement(this.hookName),r.setAttribute("data-yjs-hook",this.hookName),i!==void 0&&i._createAssociation(r,this),r}_write(t){t.writeTypeRef(Ru),t.writeKey(this.hookName)}},_u=s=>new bs(s.readKey()),ui=class s extends Le{get nextSibling(){let t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){let t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new s}clone(){let t=new s;return t.applyDelta(this.toDelta()),t}toDOM(t=document,e,i){let n=t.createTextNode(this.toString());return i!==void 0&&i._createAssociation(n,this),n}toString(){return this.toDelta().map(t=>{let e=[];for(let n in t.attributes){let r=[];for(let o in t.attributes[n])r.push({key:o,value:t.attributes[n][o]});r.sort((o,a)=>o.key<a.key?-1:1),e.push({nodeName:n,attrs:r})}e.sort((n,r)=>n.nodeName<r.nodeName?-1:1);let i="";for(let n=0;n<e.length;n++){let r=e[n];i+=`<${r.nodeName}`;for(let o=0;o<r.attrs.length;o++){let a=r.attrs[o];i+=` ${a.key}="${a.value}"`}i+=">"}i+=t.insert;for(let n=e.length-1;n>=0;n--)i+=`</${e[n].nodeName}>`;return i}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(ju)}},bu=s=>new ui,Me=class{constructor(t,e){this.id=t,this.length=e}get deleted(){throw ct()}mergeWith(t){return!1}write(t,e,i){throw ct()}integrate(t,e){throw ct()}},Su=0,H=class extends Me{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),Qo(t.doc.store,this)}write(t,e){t.writeInfo(Su),t.writeLen(this.length-e)}getMissing(t,e){return null}},ne=class s{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new s(this.content)}splice(t){throw ct()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeBuf(this.content)}getRef(){return 3}},xu=s=>new ne(s.readBuf()),$e=class s{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.len)}splice(t){let e=new s(this.len-t);return this.len=t,e}mergeWith(t){return this.len+=t.len,!0}integrate(t,e){ds(t.deleteSet,e.id.client,e.id.clock,this.len),e.markDeleted()}delete(t){}gc(t){}write(t,e){t.writeLen(this.len-e)}getRef(){return 1}},ku=s=>new $e(s.readLen()),Na=(s,t)=>new $t({guid:s,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1}),re=class s{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;let e={};this.opts=e,t.gc||(e.gc=!1),t.autoLoad&&(e.autoLoad=!0),t.meta!==null&&(e.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new s(Na(this.doc.guid,this.opts))}splice(t){throw ct()}mergeWith(t){return!1}integrate(t,e){this.doc._item=e,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,e){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}},Tu=s=>new re(Na(s.readString(),s.readAny())),vt=class s{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new s(this.embed)}splice(t){throw ct()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeJSON(this.embed)}getRef(){return 5}},vu=s=>new vt(s.readJSON()),O=class s{constructor(t,e){this.key=t,this.value=e}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.key,this.value)}splice(t){throw ct()}mergeWith(t){return!1}integrate(t,e){let i=e.parent;i._searchMarker=null,i._hasFormatting=!0}delete(t){}gc(t){}write(t,e){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}},Au=s=>new O(s.readKey(),s.readJSON()),Ss=class s{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(t){let e=new s(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){let i=this.arr.length;t.writeLen(i-e);for(let n=e;n<i;n++){let r=this.arr[n];t.writeString(r===void 0?"undefined":JSON.stringify(r))}}getRef(){return 2}},Iu=s=>{let t=s.readLen(),e=[];for(let i=0;i<t;i++){let n=s.readString();n==="undefined"?e.push(void 0):e.push(JSON.parse(n))}return new Ss(e)},Cu=ns("node_env")==="development",Rt=class s{constructor(t){this.arr=t,Cu&&an(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(t){let e=new s(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){let i=this.arr.length;t.writeLen(i-e);for(let n=e;n<i;n++){let r=this.arr[n];t.writeAny(r)}}getRef(){return 8}},Nu=s=>{let t=s.readLen(),e=[];for(let i=0;i<t;i++)e.push(s.readAny());return new Rt(e)},ht=class s{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new s(this.str)}splice(t){let e=new s(this.str.slice(t));this.str=this.str.slice(0,t);let i=this.str.charCodeAt(t-1);return i>=55296&&i<=56319&&(this.str=this.str.slice(0,t-1)+"\uFFFD",e.str="\uFFFD"+e.str.slice(1)),e}mergeWith(t){return this.str+=t.str,!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeString(e===0?this.str:this.str.slice(e))}getRef(){return 4}},Uu=s=>new ht(s.readString()),Eu=[du,fu,mu,wu,yu,_u,bu],Du=0,Lu=1,Mu=2,$u=3,Ou=4,Ru=5,ju=6,ot=class s{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new s(this.type._copy())}splice(t){throw ct()}mergeWith(t){return!1}integrate(t,e){this.type._integrate(t.doc,e)}delete(t){let e=this.type._start;for(;e!==null;)e.deleted?e.id.clock<(t.beforeState.get(e.id.client)||0)&&t._mergeStructs.push(e):e.delete(t),e=e.right;this.type._map.forEach(i=>{i.deleted?i.id.clock<(t.beforeState.get(i.id.client)||0)&&t._mergeStructs.push(i):i.delete(t)}),t.changed.delete(this.type)}gc(t){let e=this.type._start;for(;e!==null;)e.gc(t,!0),e=e.right;this.type._start=null,this.type._map.forEach(i=>{for(;i!==null;)i.gc(t,!0),i=i.left}),this.type._map=new Map}write(t,e){this.type._write(t)}getRef(){return 7}},Bu=s=>new ot(Eu[s.readTypeRef()](s)),En=(s,t)=>{let e=t,i=0,n;do i>0&&(e=x(e.client,e.clock+i)),n=Jt(s,e),i=e.clock-n.id.clock,e=n.redone;while(e!==null&&n instanceof C);return{item:n,diff:i}},Jn=(s,t)=>{for(;s!==null&&s.keep!==t;)s.keep=t,s=s.parent._item},di=(s,t,e)=>{let{client:i,clock:n}=t.id,r=new C(x(i,n+e),t,x(i,n+e-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e));return t.deleted&&r.markDeleted(),t.keep&&(r.keep=!0),t.redone!==null&&(r.redone=x(t.redone.client,t.redone.clock+e)),t.right=r,r.right!==null&&(r.right.left=r),s._mergeStructs.push(r),r.parentSub!==null&&r.right===null&&r.parent._map.set(r.parentSub,r),t.length=e,r},zo=(s,t)=>$r(s,e=>oe(e.deletions,t)),Ua=(s,t,e,i,n,r)=>{let o=s.doc,a=o.store,l=o.clientID,c=t.redone;if(c!==null)return z(s,c);let h=t.parent._item,u=null,d;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!e.has(h)||Ua(s,h,e,i,n,r)===null))return null;for(;h.redone!==null;)h=z(s,h.redone)}let f=h===null?t.parent:h.content.type;if(t.parentSub===null){for(u=t.left,d=t;u!==null;){let m=u;for(;m!==null&&m.parent._item!==h;)m=m.redone===null?null:z(s,m.redone);if(m!==null&&m.parent._item===h){u=m;break}u=u.left}for(;d!==null;){let m=d;for(;m!==null&&m.parent._item!==h;)m=m.redone===null?null:z(s,m.redone);if(m!==null&&m.parent._item===h){d=m;break}d=d.right}}else if(d=null,t.right&&!n){for(u=t;u!==null&&u.right!==null&&(u.right.redone||oe(i,u.right.id)||zo(r.undoStack,u.right.id)||zo(r.redoStack,u.right.id));)for(u=u.right;u.redone;)u=z(s,u.redone);if(u&&u.right!==null)return null}else u=f._map.get(t.parentSub)||null;let p=D(a,l),g=x(l,p),y=new C(g,u,u&&u.lastId,d,d&&d.id,f,t.parentSub,t.content.copy());return t.redone=g,Jn(y,!0),y.integrate(s,0),y},C=class s extends Me{constructor(t,e,i,n,r,o,a,l){super(t,l.getLength()),this.origin=i,this.left=e,this.right=n,this.rightOrigin=r,this.parent=o,this.parentSub=a,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(t){(this.info&8)>0!==t&&(this.info^=8)}get marker(){return(this.info&8)>0}get keep(){return(this.info&1)>0}set keep(t){this.keep!==t&&(this.info^=1)}get countable(){return(this.info&2)>0}get deleted(){return(this.info&4)>0}set deleted(t){this.deleted!==t&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(t,e){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=D(e,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=D(e,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===kt&&this.id.client!==this.parent.client&&this.parent.clock>=D(e,this.parent.client))return this.parent.client;if(this.origin&&(this.left=In(t,e,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=z(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===H||this.right&&this.right.constructor===H)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===s?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===s&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===kt){let i=Jt(e,this.parent);i.constructor===H?this.parent=null:this.parent=i.content.type}return null}integrate(t,e){if(e>0&&(this.id.clock+=e,this.left=In(t,t.doc.store,x(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(e),this.length-=e),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let i=this.left,n;if(i!==null)n=i.right;else if(this.parentSub!==null)for(n=this.parent._map.get(this.parentSub)||null;n!==null&&n.left!==null;)n=n.left;else n=this.parent._start;let r=new Set,o=new Set;for(;n!==null&&n!==this.right;){if(o.add(n),r.add(n),Gt(this.origin,n.origin)){if(n.id.client<this.id.client)i=n,r.clear();else if(Gt(this.rightOrigin,n.rightOrigin))break}else if(n.origin!==null&&o.has(Jt(t.doc.store,n.origin)))r.has(Jt(t.doc.store,n.origin))||(i=n,r.clear());else break;n=n.right}this.left=i}if(this.left!==null){let i=this.left.right;this.right=i,this.left.right=this}else{let i;if(this.parentSub!==null)for(i=this.parent._map.get(this.parentSub)||null;i!==null&&i.left!==null;)i=i.left;else i=this.parent._start,this.parent._start=this;this.right=i}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Qo(t.doc.store,this),this.content.integrate(t,this),jo(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new H(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:x(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&Gt(t.origin,this.lastId)&&this.right===t&&Gt(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){let e=this.parent._searchMarker;return e&&e.forEach(i=>{i.p===t&&(i.p=this,!this.deleted&&this.countable&&(i.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){let e=this.parent;this.countable&&this.parentSub===null&&(e._length-=this.length),this.markDeleted(),ds(t.deleteSet,this.id.client,this.id.clock,this.length),jo(t,e,this.parentSub),this.content.delete(t)}}gc(t,e){if(!this.deleted)throw G();this.content.gc(t),e?Hh(t,this,new H(this.id,this.length)):this.content=new $e(this.length)}write(t,e){let i=e>0?x(this.id.client,this.id.clock+e-1):this.origin,n=this.rightOrigin,r=this.parentSub,o=this.content.getRef()&31|(i===null?0:128)|(n===null?0:64)|(r===null?0:32);if(t.writeInfo(o),i!==null&&t.writeLeftID(i),n!==null&&t.writeRightID(n),i===null&&n===null){let a=this.parent;if(a._item!==void 0){let l=a._item;if(l===null){let c=Pn(a);t.writeParentInfo(!0),t.writeString(c)}else t.writeParentInfo(!1),t.writeLeftID(l.id)}else a.constructor===String?(t.writeParentInfo(!0),t.writeString(a)):a.constructor===kt?(t.writeParentInfo(!1),t.writeLeftID(a)):G();r!==null&&t.writeString(r)}this.content.write(t,e)}},Ea=(s,t)=>Fu[t&31](s),Fu=[()=>{G()},ku,Iu,xu,Uu,vu,Au,Bu,Nu,Tu,()=>{G()}],Vu=10,V=class extends Me{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){G()}write(t,e){t.writeInfo(Vu),w(t.restEncoder,this.length-e)}getMissing(t,e){return null}},Da=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},La="__ $YJS$ __";Da[La]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Da[La]=!0});var Ma,Yn,Pu,Xn,$a,Oa,ae,Ra=T(()=>{qe();Ls();fn();sn();Ma=new Map,Yn=class{constructor(t){this.room=t,this.onmessage=null,this._onChange=e=>e.key===t&&this.onmessage!==null&&this.onmessage({data:_o(e.newValue||"")}),io(this._onChange)}postMessage(t){qs.setItem(this.room,wo(yo(t)))}close(){no(this._onChange)}},Pu=typeof BroadcastChannel>"u"?Yn:BroadcastChannel,Xn=s=>B(Ma,s,()=>{let t=ut(),e=new Pu(s);return e.onmessage=i=>t.forEach(n=>n(i.data,"broadcastchannel")),{bc:e,subs:t}}),$a=(s,t)=>(Xn(s).subs.add(t),t),Oa=(s,t)=>{let e=Xn(s),i=e.subs.delete(t);return i&&e.subs.size===0&&(e.bc.close(),Ma.delete(s)),i},ae=(s,t,e=null)=>{let i=Xn(s);i.bc.postMessage(t),i.subs.forEach(n=>n(t,e))}});var ja,wi,Ba,_i,Zn,qu,Fa,Va,zu,Pa,Ka=T(()=>{Ye();Ne();Ts();ja=0,wi=1,Ba=2,_i=(s,t)=>{w(s,ja);let e=Vn(t);U(s,e)},Zn=(s,t,e)=>{w(s,wi),U(s,jn(t,e))},qu=(s,t,e)=>Zn(t,e,j(s)),Fa=(s,t,e,i)=>{try{Rn(t,j(s),e)}catch(n){i?.(n),console.error("Caught error while handling a Yjs update",n)}},Va=(s,t)=>{w(s,Ba),U(s,t)},zu=Fa,Pa=(s,t,e,i,n)=>{let r=b(s);switch(r){case ja:qu(s,t,e);break;case wi:Fa(s,e,i,n);break;case Ba:zu(s,e,i,n);break;default:throw new Error("Unknown message type")}return r}});var Wu,qa,za=T(()=>{Ne();Wu=0,qa=(s,t,e)=>{switch(b(s)){case Wu:e(t,nt(s))}}});var Qn,bi,Si,Re,Ha,Wa=T(()=>{Ye();Ne();ts();Kt();Os();is();Qn=3e4,bi=class extends pe{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let e=et();this.getLocalState()!==null&&Qn/2<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let i=[];this.meta.forEach((n,r)=>{r!==this.clientID&&Qn<=e-n.lastUpdated&&this.states.has(r)&&i.push(r)}),i.length>0&&Si(this,i,"timeout")},X(Qn/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){let e=this.clientID,i=this.meta.get(e),n=i===void 0?0:i.clock+1,r=this.states.get(e);t===null?this.states.delete(e):this.states.set(e,t),this.meta.set(e,{clock:n,lastUpdated:et()});let o=[],a=[],l=[],c=[];t===null?c.push(e):r==null?t!=null&&o.push(e):(a.push(e),Ue(r,t)||l.push(e)),(o.length>0||l.length>0||c.length>0)&&this.emit("change",[{added:o,updated:l,removed:c},"local"]),this.emit("update",[{added:o,updated:a,removed:c},"local"])}setLocalStateField(t,e){let i=this.getLocalState();i!==null&&this.setLocalState({...i,[t]:e})}getStates(){return this.states}},Si=(s,t,e)=>{let i=[];for(let n=0;n<t.length;n++){let r=t[n];if(s.states.has(r)){if(s.states.delete(r),r===s.clientID){let o=s.meta.get(r);s.meta.set(r,{clock:o.clock+1,lastUpdated:et()})}i.push(r)}}i.length>0&&(s.emit("change",[{added:[],updated:[],removed:i},e]),s.emit("update",[{added:[],updated:[],removed:i},e]))},Re=(s,t,e=s.states)=>{let i=t.length,n=L();w(n,i);for(let r=0;r<i;r++){let o=t[r],a=e.get(o)||null,l=s.meta.get(o).clock;w(n,o),w(n,l),dt(n,JSON.stringify(a))}return A(n)},Ha=(s,t,e)=>{let i=M(t),n=et(),r=[],o=[],a=[],l=[],c=b(i);for(let h=0;h<c;h++){let u=b(i),d=b(i),f=JSON.parse(nt(i)),p=s.meta.get(u),g=s.states.get(u),y=p===void 0?0:p.clock;(y<d||y===d&&f===null&&s.states.has(u))&&(f===null?u===s.clientID&&s.getLocalState()!=null?d++:s.states.delete(u):s.states.set(u,f),s.meta.set(u,{clock:d,lastUpdated:n}),p===void 0&&f!==null?r.push(u):p!==void 0&&f===null?l.push(u):f!==null&&(Ue(f,g)||a.push(u),o.push(u)))}(r.length>0||a.length>0||l.length>0)&&s.emit("change",[{added:r,updated:a,removed:l},e]),(r.length>0||o.length>0||l.length>0)&&s.emit("update",[{added:r,updated:o,removed:l},e])}});var Ga,Ja=T(()=>{Hs();Ga=s=>ho(s,(t,e)=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&")});var tl={};Dr(tl,{WebsocketProvider:()=>er,messageAuth:()=>Xa,messageAwareness:()=>le,messageQueryAwareness:()=>sr,messageSync:()=>jt});var jt,sr,le,Xa,vs,Ya,Xu,Za,Qa,tr,er,el=T(()=>{Ra();ts();Ye();Ne();Ka();za();Wa();Os();Kt();Ja();rs();jt=0,sr=3,le=1,Xa=2,vs=[];vs[jt]=(s,t,e,i,n)=>{w(s,jt);let r=Pa(t,s,e.doc,e);i&&r===wi&&!e.synced&&(e.synced=!0)};vs[sr]=(s,t,e,i,n)=>{w(s,le),U(s,Re(e.awareness,Array.from(e.awareness.getStates().keys())))};vs[le]=(s,t,e,i,n)=>{Ha(e.awareness,j(t),e)};vs[Xa]=(s,t,e,i,n)=>{qa(t,e.doc,(r,o)=>Xu(e,o))};Ya=3e4,Xu=(s,t)=>console.warn(`Permission denied to access ${s.url}.
${t}`),Za=(s,t,e)=>{let i=M(t),n=L(),r=b(i),o=s.messageHandlers[r];return o?o(n,i,s,e,r):console.error("Unable to compute message"),n},Qa=s=>{if(s.shouldConnect&&s.ws===null){let t=new s._WS(s.url);t.binaryType="arraybuffer",s.ws=t,s.wsconnecting=!0,s.wsconnected=!1,s.synced=!1,t.onmessage=e=>{s.wsLastMessageReceived=et();let i=Za(s,new Uint8Array(e.data),!0);Bs(i)>1&&t.send(A(i))},t.onerror=e=>{s.emit("connection-error",[e,s])},t.onclose=e=>{s.emit("connection-close",[e,s]),s.ws=null,s.wsconnecting=!1,s.wsconnected?(s.wsconnected=!1,s.synced=!1,Si(s.awareness,Array.from(s.awareness.getStates().keys()).filter(i=>i!==s.doc.clientID),s),s.emit("status",[{status:"disconnected"}])):s.wsUnsuccessfulReconnects++,setTimeout(Qa,me(Rr(2,s.wsUnsuccessfulReconnects)*100,s.maxBackoffTime),s)},t.onopen=()=>{s.wsLastMessageReceived=et(),s.wsconnecting=!1,s.wsconnected=!0,s.wsUnsuccessfulReconnects=0,s.emit("status",[{status:"connected"}]);let e=L();if(w(e,jt),_i(e,s.doc),t.send(A(e)),s.awareness.getLocalState()!==null){let i=L();w(i,le),U(i,Re(s.awareness,[s.doc.clientID])),t.send(A(i))}},s.emit("status",[{status:"connecting"}])}},tr=(s,t)=>{let e=s.ws;s.wsconnected&&e&&e.readyState===e.OPEN&&e.send(t),s.bcconnected&&ae(s.bcChannel,t,s)},er=class extends pe{constructor(t,e,i,{connect:n=!0,awareness:r=new bi(i),params:o={},WebSocketPolyfill:a=WebSocket,resyncInterval:l=-1,maxBackoffTime:c=2500,disableBc:h=!1}={}){for(super();t[t.length-1]==="/";)t=t.slice(0,t.length-1);let u=Ga(o);this.maxBackoffTime=c,this.bcChannel=t+"/"+e,this.url=t+"/"+e+(u.length===0?"":"?"+u),this.roomname=e,this.doc=i,this._WS=a,this.awareness=r,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=vs.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,l>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){let d=L();w(d,jt),_i(d,i),this.ws.send(A(d))}},l)),this._bcSubscriber=(d,f)=>{if(f!==this){let p=Za(this,new Uint8Array(d),!1);Bs(p)>1&&ae(this.bcChannel,A(p),this)}},this._updateHandler=(d,f)=>{if(f!==this){let p=L();w(p,jt),Va(p,d),tr(this,A(p))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:d,updated:f,removed:p},g)=>{let y=d.concat(f).concat(p),m=L();w(m,le),U(m,Re(r,y)),tr(this,A(m))},this._exitHandler=()=>{Si(this.awareness,[i.clientID],"app closed")},xt&&typeof process<"u"&&process.on("exit",this._exitHandler),r.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&Ya<et()-this.wsLastMessageReceived&&this.ws.close()},Ya/10),n&&this.connect()}get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),xt&&typeof process<"u"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||($a(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);let t=L();w(t,jt),_i(t,this.doc),ae(this.bcChannel,A(t),this);let e=L();w(e,jt),Zn(e,this.doc),ae(this.bcChannel,A(e),this);let i=L();w(i,sr),ae(this.bcChannel,A(i),this);let n=L();w(n,le),U(n,Re(this.awareness,[this.doc.clientID])),ae(this.bcChannel,A(n),this)}disconnectBc(){let t=L();w(t,le),U(t,Re(this.awareness,[this.doc.clientID],new Map)),tr(this,A(t)),this.bcconnected&&(Oa(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(Qa(this),this.connectBc())}}});var il=E((qp,sl)=>{"use strict";function ce(s){if(!(this instanceof ce))return new ce(s);s=s||{},this.concurrency=s.concurrency||1/0,this.pending=0,this.jobs=[],this.cbs=[],this._done=Qu.bind(this)}var Zu=["push","unshift","splice"];Zu.forEach(function(s){ce.prototype[s]=function(){var t=Array.prototype[s].apply(this.jobs,arguments);return this._run(),t}});Object.defineProperty(ce.prototype,"length",{get:function(){return this.pending+this.jobs.length}});ce.prototype._run=function(){if(this.pending!==this.concurrency){if(this.jobs.length){var s=this.jobs.shift();this.pending++,s(this._done),this._run()}if(this.pending===0)for(;this.cbs.length!==0;){var t=this.cbs.pop();process.nextTick(t)}}};ce.prototype.onDone=function(s){typeof s=="function"&&(this.cbs.push(s),this._run())};function Qu(){this.pending--,this._run()}sl.exports=ce});var he=E((zp,nl)=>{"use strict";nl.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}}});var ki=E((Hp,ir)=>{"use strict";var{EMPTY_BUFFER:td}=he();function rl(s,t){if(s.length===0)return td;if(s.length===1)return s[0];let e=Buffer.allocUnsafe(t);for(var i=0,n=0;n<s.length;n++){let r=s[n];r.copy(e,i),i+=r.length}return e}function ol(s,t,e,i,n){for(var r=0;r<n;r++)e[i+r]=s[r]^t[r&3]}function al(s,t){let e=s.length;for(var i=0;i<e;i++)s[i]^=t[i&3]}function ll(s){return s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}function xi(s){if(xi.readOnly=!0,Buffer.isBuffer(s))return s;var t;return s instanceof ArrayBuffer?t=Buffer.from(s):ArrayBuffer.isView(s)?t=ed(s):(t=Buffer.from(s),xi.readOnly=!1),t}function ed(s){let t=Buffer.from(s.buffer);return s.byteLength!==s.buffer.byteLength?t.slice(s.byteOffset,s.byteOffset+s.byteLength):t}try{let s=require("bufferutil"),t=s.BufferUtil||s;ir.exports={concat:rl,mask(e,i,n,r,o){o<48?ol(e,i,n,r,o):t.mask(e,i,n,r,o)},toArrayBuffer:ll,toBuffer:xi,unmask(e,i){e.length<32?al(e,i):t.unmask(e,i)}}}catch{ir.exports={concat:rl,mask:ol,toArrayBuffer:ll,toBuffer:xi,unmask:al}}});var Is=E((Wp,fl)=>{"use strict";var sd=il(),As=require("zlib"),cl=ki(),{kStatusCode:hl,NOOP:id}=he(),nd=Buffer.from([0,0,255,255]),rd=Buffer.from([0]),vi=Symbol("permessage-deflate"),At=Symbol("total-length"),ul=Symbol("callback"),Bt=Symbol("buffers"),nr=Symbol("error"),Ti,rr=class{constructor(t,e,i){if(this._maxPayload=i|0,this._options=t||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!e,this._deflate=null,this._inflate=null,this.params=null,!Ti){let n=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Ti=new sd({concurrency:n})}}static get extensionName(){return"permessage-deflate"}offer(){let t={};return this._options.serverNoContextTakeover&&(t.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(t.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(t.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?t.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(t.client_max_window_bits=!0),t}accept(t){return t=this.normalizeParams(t),this.params=this._isServer?this.acceptAsServer(t):this.acceptAsClient(t),this.params}cleanup(){this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate&&(this._deflate.close(),this._deflate=null)}acceptAsServer(t){let e=this._options,i=t.find(n=>!(e.serverNoContextTakeover===!1&&n.server_no_context_takeover||n.server_max_window_bits&&(e.serverMaxWindowBits===!1||typeof e.serverMaxWindowBits=="number"&&e.serverMaxWindowBits>n.server_max_window_bits)||typeof e.clientMaxWindowBits=="number"&&!n.client_max_window_bits));if(!i)throw new Error("None of the extension offers can be accepted");return e.serverNoContextTakeover&&(i.server_no_context_takeover=!0),e.clientNoContextTakeover&&(i.client_no_context_takeover=!0),typeof e.serverMaxWindowBits=="number"&&(i.server_max_window_bits=e.serverMaxWindowBits),typeof e.clientMaxWindowBits=="number"?i.client_max_window_bits=e.clientMaxWindowBits:(i.client_max_window_bits===!0||e.clientMaxWindowBits===!1)&&delete i.client_max_window_bits,i}acceptAsClient(t){let e=t[0];if(this._options.clientNoContextTakeover===!1&&e.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!e.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(e.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&e.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return e}normalizeParams(t){return t.forEach(e=>{Object.keys(e).forEach(i=>{var n=e[i];if(n.length>1)throw new Error(`Parameter "${i}" must have only a single value`);if(n=n[0],i==="client_max_window_bits"){if(n!==!0){let r=+n;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${i}": ${n}`);n=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${i}": ${n}`)}else if(i==="server_max_window_bits"){let r=+n;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${i}": ${n}`);n=r}else if(i==="client_no_context_takeover"||i==="server_no_context_takeover"){if(n!==!0)throw new TypeError(`Invalid value for parameter "${i}": ${n}`)}else throw new Error(`Unknown parameter "${i}"`);e[i]=n})}),t}decompress(t,e,i){Ti.push(n=>{this._decompress(t,e,(r,o)=>{n(),i(r,o)})})}compress(t,e,i){Ti.push(n=>{this._compress(t,e,(r,o)=>{n(),i(r,o)})})}_decompress(t,e,i){let n=this._isServer?"client":"server";if(!this._inflate){let r=`${n}_max_window_bits`,o=typeof this.params[r]!="number"?As.Z_DEFAULT_WINDOWBITS:this.params[r];this._inflate=As.createInflateRaw(Object.assign({},this._options.zlibInflateOptions,{windowBits:o})),this._inflate[vi]=this,this._inflate[At]=0,this._inflate[Bt]=[],this._inflate.on("error",ad),this._inflate.on("data",dl)}this._inflate[ul]=i,this._inflate.write(t),e&&this._inflate.write(nd),this._inflate.flush(()=>{let r=this._inflate[nr];if(r){this._inflate.close(),this._inflate=null,i(r);return}let o=cl.concat(this._inflate[Bt],this._inflate[At]);e&&this.params[`${n}_no_context_takeover`]?(this._inflate.close(),this._inflate=null):(this._inflate[At]=0,this._inflate[Bt]=[]),i(null,o)})}_compress(t,e,i){if(!t||t.length===0){process.nextTick(i,null,rd);return}let n=this._isServer?"server":"client";if(!this._deflate){let r=`${n}_max_window_bits`,o=typeof this.params[r]!="number"?As.Z_DEFAULT_WINDOWBITS:this.params[r];this._deflate=As.createDeflateRaw(Object.assign({},this._options.zlibDeflateOptions,{windowBits:o})),this._deflate[At]=0,this._deflate[Bt]=[],this._deflate.on("error",id),this._deflate.on("data",od)}this._deflate.write(t),this._deflate.flush(As.Z_SYNC_FLUSH,()=>{if(this._deflate){var r=cl.concat(this._deflate[Bt],this._deflate[At]);e&&(r=r.slice(0,r.length-4)),e&&this.params[`${n}_no_context_takeover`]?(this._deflate.close(),this._deflate=null):(this._deflate[At]=0,this._deflate[Bt]=[]),i(null,r)}})}};fl.exports=rr;function od(s){this[Bt].push(s),this[At]+=s.length}function dl(s){if(this[At]+=s.length,this[vi]._maxPayload<1||this[At]<=this[vi]._maxPayload){this[Bt].push(s);return}this[nr]=new RangeError("Max payload size exceeded"),this[nr][hl]=1009,this.removeListener("data",dl),this.reset()}function ad(s){this[vi]._inflate=null,s[hl]=1007,this[ul](s)}});var gl=E((Gp,pl)=>{"use strict";var je=class{constructor(t,e){this.target=e,this.type=t}},or=class extends je{constructor(t,e){super("message",e),this.data=t}},ar=class extends je{constructor(t,e,i){super("close",i),this.wasClean=i._closeFrameReceived&&i._closeFrameSent,this.reason=e,this.code=t}},lr=class extends je{constructor(t){super("open",t)}},cr=class extends je{constructor(t,e){super("error",e),this.message=t.message,this.error=t}},ld={addEventListener(s,t){if(typeof t!="function")return;function e(o){t.call(this,new or(o,this))}function i(o,a){t.call(this,new ar(o,a,this))}function n(o){t.call(this,new cr(o,this))}function r(){t.call(this,new lr(this))}s==="message"?(e._listener=t,this.on(s,e)):s==="close"?(i._listener=t,this.on(s,i)):s==="error"?(n._listener=t,this.on(s,n)):s==="open"?(r._listener=t,this.on(s,r)):this.on(s,t)},removeEventListener(s,t){let e=this.listeners(s);for(var i=0;i<e.length;i++)(e[i]===t||e[i]._listener===t)&&this.removeListener(s,e[i])}};pl.exports=ld});var hr=E((Jp,ml)=>{"use strict";var Cs=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function _t(s,t,e){Object.prototype.hasOwnProperty.call(s,t)?s[t].push(e):s[t]=[e]}function cd(s){let t={};if(s===void 0||s==="")return t;for(var e={},i=!1,n=!1,r=!1,o,a,l=-1,c=-1,h=0;h<s.length;h++){let f=s.charCodeAt(h);if(o===void 0)if(c===-1&&Cs[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);let p=s.slice(l,c);f===44?(_t(t,p,e),e={}):o=p,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(c===-1&&Cs[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h),_t(e,s.slice(l,c),!0),f===44&&(_t(t,o,e),e={},o=void 0),l=c=-1}else if(f===61&&l!==-1&&c===-1)a=s.slice(l,h),l=c=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(n){if(Cs[f]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:i||(i=!0),n=!1}else if(r)if(Cs[f]===1)l===-1&&(l=h);else if(f===34&&l!==-1)r=!1,c=h;else if(f===92)n=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(f===34&&s.charCodeAt(h-1)===61)r=!0;else if(c===-1&&Cs[f]===1)l===-1&&(l=h);else if(l!==-1&&(f===32||f===9))c===-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);var u=s.slice(l,c);i&&(u=u.replace(/\\/g,""),i=!1),_t(e,a,u),f===44&&(_t(t,o,e),e={},o=void 0),a=void 0,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`)}if(l===-1||r)throw new SyntaxError("Unexpected end of input");c===-1&&(c=h);let d=s.slice(l,c);return o===void 0?_t(t,d,{}):(a===void 0?_t(e,d,!0):i?_t(e,a,d.replace(/\\/g,"")):_t(e,a,d),_t(t,o,e)),t}function hd(s){return Object.keys(s).map(t=>{var e=s[t];return Array.isArray(e)||(e=[e]),e.map(i=>[t].concat(Object.keys(i).map(n=>{var r=i[n];return Array.isArray(r)||(r=[r]),r.map(o=>o===!0?n:`${n}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}ml.exports={format:hd,parse:cd}});var ur=E(Ai=>{"use strict";try{let s=require("utf-8-validate");Ai.isValidUTF8=typeof s=="object"?s.Validation.isValidUTF8:s}catch{Ai.isValidUTF8=()=>!0}Ai.isValidStatusCode=s=>s>=1e3&&s<=1013&&s!==1004&&s!==1005&&s!==1006||s>=3e3&&s<=4999});var gr=E((Xp,xl)=>{"use strict";var{Writable:ud}=require("stream"),yl=Is(),{BINARY_TYPES:dd,EMPTY_BUFFER:fd,kStatusCode:pd,kWebSocket:gd}=he(),{concat:dr,toArrayBuffer:md,unmask:yd}=ki(),{isValidStatusCode:wd,isValidUTF8:wl}=ur(),Ns=0,_l=1,bl=2,Sl=3,fr=4,_d=5,pr=class extends ud{constructor(t,e,i){super(),this._binaryType=t||dd[0],this[gd]=void 0,this._extensions=e||{},this._maxPayload=i|0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=Ns,this._loop=!1}_write(t,e,i){if(this._opcode===8&&this._state==Ns)return i();this._bufferedBytes+=t.length,this._buffers.push(t),this.startLoop(i)}consume(t){if(this._bufferedBytes-=t,t===this._buffers[0].length)return this._buffers.shift();if(t<this._buffers[0].length){let i=this._buffers[0];return this._buffers[0]=i.slice(t),i.slice(0,t)}let e=Buffer.allocUnsafe(t);do{let i=this._buffers[0];t>=i.length?this._buffers.shift().copy(e,e.length-t):(i.copy(e,e.length-t,0,t),this._buffers[0]=i.slice(t)),t-=i.length}while(t>0);return e}startLoop(t){var e;this._loop=!0;do switch(this._state){case Ns:e=this.getInfo();break;case _l:e=this.getPayloadLength16();break;case bl:e=this.getPayloadLength64();break;case Sl:this.getMask();break;case fr:e=this.getData(t);break;default:this._loop=!1;return}while(this._loop);t(e)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48)return this._loop=!1,K(RangeError,"RSV2 and RSV3 must be clear",!0,1002);let e=(t[0]&64)===64;if(e&&!this._extensions[yl.extensionName])return this._loop=!1,K(RangeError,"RSV1 must be clear",!0,1002);if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(e)return this._loop=!1,K(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,K(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,K(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._compressed=e}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,K(RangeError,"FIN must be set",!0,1002);if(e)return this._loop=!1,K(RangeError,"RSV1 must be clear",!0,1002);if(this._payloadLength>125)return this._loop=!1,K(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002)}else return this._loop=!1,K(RangeError,`invalid opcode ${this._opcode}`,!0,1002);if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._payloadLength===126)this._state=_l;else if(this._payloadLength===127)this._state=bl;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),e=t.readUInt32BE(0);return e>Math.pow(2,21)-1?(this._loop=!1,K(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009)):(this._payloadLength=e*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,K(RangeError,"Max payload size exceeded",!1,1009);this._masked?this._state=Sl:this._state=fr}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=fr}getData(t){var e=fd;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}e=this.consume(this._payloadLength),this._masked&&yd(e,this._mask)}if(this._opcode>7)return this.controlMessage(e);if(this._compressed){this._state=_d,this.decompress(e,t);return}return e.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(e)),this.dataMessage()}decompress(t,e){this._extensions[yl.extensionName].decompress(t,this._fin,(n,r)=>{if(n)return e(n);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return e(K(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(r)}let o=this.dataMessage();if(o)return e(o);this.startLoop(e)})}dataMessage(){if(this._fin){let e=this._messageLength,i=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){var t;this._binaryType==="nodebuffer"?t=dr(i,e):this._binaryType==="arraybuffer"?t=md(dr(i,e)):t=i,this.emit("message",t)}else{let n=dr(i,e);if(!wl(n))return this._loop=!1,K(Error,"invalid UTF-8 sequence",!0,1007);this.emit("message",n.toString())}}this._state=Ns}controlMessage(t){if(this._opcode===8)if(this._loop=!1,t.length===0)this.emit("conclude",1005,""),this.end();else{if(t.length===1)return K(RangeError,"invalid payload length 1",!0,1002);{let e=t.readUInt16BE(0);if(!wd(e))return K(RangeError,`invalid status code ${e}`,!0,1002);let i=t.slice(2);if(!wl(i))return K(Error,"invalid UTF-8 sequence",!0,1007);this.emit("conclude",e,i.toString()),this.end()}}else this._opcode===9?this.emit("ping",t):this.emit("pong",t);this._state=Ns}};xl.exports=pr;function K(s,t,e,i){let n=new s(e?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(n,K),n[pd]=i,n}});var yr=E((Zp,vl)=>{"use strict";var{randomBytes:bd}=require("crypto"),kl=Is(),{EMPTY_BUFFER:Sd}=he(),{isValidStatusCode:xd}=ur(),{mask:Tl,toBuffer:It}=ki(),mr=class s{constructor(t,e){this._extensions=e||{},this._socket=t,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(t,e){let i=e.mask&&e.readOnly;var n=e.mask?6:2,r=t.length;t.length>=65536?(n+=8,r=127):t.length>125&&(n+=2,r=126);let o=Buffer.allocUnsafe(i?t.length+n:n);if(o[0]=e.fin?e.opcode|128:e.opcode,e.rsv1&&(o[0]|=64),o[1]=r,r===126?o.writeUInt16BE(t.length,2):r===127&&(o.writeUInt32BE(0,2),o.writeUInt32BE(t.length,6)),!e.mask)return[o,t];let a=bd(4);return o[1]|=128,o[n-4]=a[0],o[n-3]=a[1],o[n-2]=a[2],o[n-1]=a[3],i?(Tl(t,a,o,n,t.length),[o]):(Tl(t,a,t,0,t.length),[o,t])}close(t,e,i,n){var r;if(t===void 0)r=Sd;else{if(typeof t!="number"||!xd(t))throw new TypeError("First argument must be a valid error code number");e===void 0||e===""?(r=Buffer.allocUnsafe(2),r.writeUInt16BE(t,0)):(r=Buffer.allocUnsafe(2+Buffer.byteLength(e)),r.writeUInt16BE(t,0),r.write(e,2))}this._deflating?this.enqueue([this.doClose,r,i,n]):this.doClose(r,i,n)}doClose(t,e,i){this.sendFrame(s.frame(t,{fin:!0,rsv1:!1,opcode:8,mask:e,readOnly:!1}),i)}ping(t,e,i){let n=It(t);this._deflating?this.enqueue([this.doPing,n,e,It.readOnly,i]):this.doPing(n,e,It.readOnly,i)}doPing(t,e,i,n){this.sendFrame(s.frame(t,{fin:!0,rsv1:!1,opcode:9,mask:e,readOnly:i}),n)}pong(t,e,i){let n=It(t);this._deflating?this.enqueue([this.doPong,n,e,It.readOnly,i]):this.doPong(n,e,It.readOnly,i)}doPong(t,e,i,n){this.sendFrame(s.frame(t,{fin:!0,rsv1:!1,opcode:10,mask:e,readOnly:i}),n)}send(t,e,i){let n=It(t),r=this._extensions[kl.extensionName];var o=e.binary?2:1,a=e.compress;if(this._firstFragment?(this._firstFragment=!1,a&&r&&(a=n.length>=r._threshold),this._compress=a):(a=!1,o=0),e.fin&&(this._firstFragment=!0),r){let l={fin:e.fin,rsv1:a,opcode:o,mask:e.mask,readOnly:It.readOnly};this._deflating?this.enqueue([this.dispatch,n,this._compress,l,i]):this.dispatch(n,this._compress,l,i)}else this.sendFrame(s.frame(n,{fin:e.fin,rsv1:!1,opcode:o,mask:e.mask,readOnly:It.readOnly}),i)}dispatch(t,e,i,n){if(!e){this.sendFrame(s.frame(t,i),n);return}let r=this._extensions[kl.extensionName];this._deflating=!0,r.compress(t,i.fin,(o,a)=>{this._deflating=!1,i.readOnly=!1,this.sendFrame(s.frame(a,i),n),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let t=this._queue.shift();this._bufferedBytes-=t[1].length,t[0].apply(this,t.slice(1))}}enqueue(t){this._bufferedBytes+=t[1].length,this._queue.push(t)}sendFrame(t,e){t.length===2?(this._socket.cork(),this._socket.write(t[0]),this._socket.write(t[1],e),this._socket.uncork()):this._socket.write(t[0],e)}};vl.exports=mr});var br=E((Qp,Ol)=>{"use strict";var kd=require("events"),Al=require("crypto"),Td=require("https"),vd=require("http"),Ad=require("net"),Id=require("tls"),Be=require("url"),Ft=Is(),Ul=gl(),Il=hr(),Cd=gr(),Nd=yr(),{BINARY_TYPES:Cl,EMPTY_BUFFER:wr,GUID:Ud,kStatusCode:Ed,kWebSocket:Q,NOOP:El}=he(),Ii=["CONNECTING","OPEN","CLOSING","CLOSED"],_r=[8,13],Dd=30*1e3,tt=class s extends kd{constructor(t,e,i){super(),this.readyState=s.CONNECTING,this.protocol="",this._binaryType=Cl[0],this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._closeCode=1006,this._extensions={},this._receiver=null,this._sender=null,this._socket=null,t!==null?(this._isServer=!1,this._redirects=0,Array.isArray(e)?e=e.join(", "):typeof e=="object"&&e!==null&&(i=e,e=void 0),Dl(this,t,e,i)):this._isServer=!0}get CONNECTING(){return s.CONNECTING}get CLOSING(){return s.CLOSING}get CLOSED(){return s.CLOSED}get OPEN(){return s.OPEN}get binaryType(){return this._binaryType}set binaryType(t){Cl.includes(t)&&(this._binaryType=t,this._receiver&&(this._receiver._binaryType=t))}get bufferedAmount(){return this._socket?(this._socket.bufferSize||0)+this._sender._bufferedBytes:0}get extensions(){return Object.keys(this._extensions).join()}setSocket(t,e,i){let n=new Cd(this._binaryType,this._extensions,i);this._sender=new Nd(t,this._extensions),this._receiver=n,this._socket=t,n[Q]=this,t[Q]=this,n.on("conclude",$d),n.on("drain",Od),n.on("error",Rd),n.on("message",jd),n.on("ping",Bd),n.on("pong",Fd),t.setTimeout(0),t.setNoDelay(),e.length>0&&t.unshift(e),t.on("close",Ll),t.on("data",Ci),t.on("end",Ml),t.on("error",$l),this.readyState=s.OPEN,this.emit("open")}emitClose(){if(this.readyState=s.CLOSED,!this._socket){this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[Ft.extensionName]&&this._extensions[Ft.extensionName].cleanup(),this._receiver.removeAllListeners(),this.emit("close",this._closeCode,this._closeMessage)}close(t,e){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Ct(this,this._req,"WebSocket was closed before the connection was established");if(this.readyState===s.CLOSING){this._closeFrameSent&&this._closeFrameReceived&&this._socket.end();return}this.readyState=s.CLOSING,this._sender.close(t,e,!this._isServer,i=>{i||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),Dd)}}ping(t,e,i){if(typeof t=="function"?(i=t,t=e=void 0):typeof e=="function"&&(i=e,e=void 0),this.readyState!==s.OPEN){let n=new Error(`WebSocket is not open: readyState ${this.readyState} (${Ii[this.readyState]})`);if(i)return i(n);throw n}typeof t=="number"&&(t=t.toString()),e===void 0&&(e=!this._isServer),this._sender.ping(t||wr,e,i)}pong(t,e,i){if(typeof t=="function"?(i=t,t=e=void 0):typeof e=="function"&&(i=e,e=void 0),this.readyState!==s.OPEN){let n=new Error(`WebSocket is not open: readyState ${this.readyState} (${Ii[this.readyState]})`);if(i)return i(n);throw n}typeof t=="number"&&(t=t.toString()),e===void 0&&(e=!this._isServer),this._sender.pong(t||wr,e,i)}send(t,e,i){if(typeof e=="function"&&(i=e,e={}),this.readyState!==s.OPEN){let r=new Error(`WebSocket is not open: readyState ${this.readyState} (${Ii[this.readyState]})`);if(i)return i(r);throw r}typeof t=="number"&&(t=t.toString());let n=Object.assign({binary:typeof t!="string",mask:!this._isServer,compress:!0,fin:!0},e);this._extensions[Ft.extensionName]||(n.compress=!1),this._sender.send(t||wr,n,i)}terminate(){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Ct(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this.readyState=s.CLOSING,this._socket.destroy())}}};Ii.forEach((s,t)=>{tt[s]=t});["open","error","close","message"].forEach(s=>{Object.defineProperty(tt.prototype,`on${s}`,{get(){let t=this.listeners(s);for(var e=0;e<t.length;e++)if(t[e]._listener)return t[e]._listener},set(t){let e=this.listeners(s);for(var i=0;i<e.length;i++)e[i]._listener&&this.removeListener(s,e[i]);this.addEventListener(s,t)}})});tt.prototype.addEventListener=Ul.addEventListener;tt.prototype.removeEventListener=Ul.removeEventListener;Ol.exports=tt;function Dl(s,t,e,i){let n=Object.assign({protocolVersion:_r[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10},i,{createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,auth:void 0,host:void 0,path:void 0,port:void 0});if(!_r.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${_r.join(", ")})`);var r;typeof t=="object"&&t.href!==void 0?(r=t,s.url=t.href):(r=Be.URL?new Be.URL(t):Be.parse(t),s.url=t);let o=r.protocol==="ws+unix:";if(!r.host&&(!o||!r.pathname))throw new Error(`Invalid URL: ${s.url}`);let a=r.protocol==="wss:"||r.protocol==="https:",l=a?443:80,c=Al.randomBytes(16).toString("base64"),h=a?Td.get:vd.get,u=r.search?`${r.pathname||"/"}${r.search}`:r.pathname||"/";var d;if(n.createConnection=a?Md:Ld,n.defaultPort=n.defaultPort||l,n.port=r.port||l,n.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,n.headers=Object.assign({"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":c,Connection:"Upgrade",Upgrade:"websocket"},n.headers),n.path=u,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(d=new Ft(n.perMessageDeflate!==!0?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=Il.format({[Ft.extensionName]:d.offer()})),e&&(n.headers["Sec-WebSocket-Protocol"]=e),n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),r.auth?n.auth=r.auth:(r.username||r.password)&&(n.auth=`${r.username}:${r.password}`),o){let p=u.split(":");n.socketPath=p[0],n.path=p[1]}var f=s._req=h(n);n.timeout&&f.on("timeout",()=>{Ct(s,f,"Opening handshake has timed out")}),f.on("error",p=>{s._req.aborted||(f=s._req=null,s.readyState=tt.CLOSING,s.emit("error",p),s.emitClose())}),f.on("response",p=>{let g=p.headers.location,y=p.statusCode;if(g&&n.followRedirects&&y>=300&&y<400){if(++s._redirects>n.maxRedirects){Ct(s,f,"Maximum redirects exceeded");return}f.abort();let m=Be.URL?new Be.URL(g,t):Be.resolve(t,g);Dl(s,m,e,i)}else s.emit("unexpected-response",f,p)||Ct(s,f,`Unexpected server response: ${p.statusCode}`)}),f.on("upgrade",(p,g,y)=>{if(s.emit("upgrade",p),s.readyState!==tt.CONNECTING)return;f=s._req=null;let m=Al.createHash("sha1").update(c+Ud).digest("base64");if(p.headers["sec-websocket-accept"]!==m){Ct(s,g,"Invalid Sec-WebSocket-Accept header");return}let _=p.headers["sec-websocket-protocol"],S=(e||"").split(/, */);var k;if(!e&&_?k="Server sent a subprotocol but none was requested":e&&!_?k="Server sent no subprotocol":_&&!S.includes(_)&&(k="Server sent an invalid subprotocol"),k){Ct(s,g,k);return}if(_&&(s.protocol=_),d)try{let N=Il.parse(p.headers["sec-websocket-extensions"]);N[Ft.extensionName]&&(d.accept(N[Ft.extensionName]),s._extensions[Ft.extensionName]=d)}catch{Ct(s,g,"Invalid Sec-WebSocket-Extensions header");return}s.setSocket(g,y,n.maxPayload)})}function Ld(s){return s.protocolVersion&&(s.path=s.socketPath),Ad.connect(s)}function Md(s){return s.path=void 0,s.servername=s.servername||s.host,Id.connect(s)}function Ct(s,t,e){s.readyState=tt.CLOSING;let i=new Error(e);Error.captureStackTrace(i,Ct),t.setHeader?(t.abort(),t.once("abort",s.emitClose.bind(s)),s.emit("error",i)):(t.destroy(i),t.once("error",s.emit.bind(s,"error")),t.once("close",s.emitClose.bind(s)))}function $d(s,t){let e=this[Q];e._socket.removeListener("data",Ci),e._socket.resume(),e._closeFrameReceived=!0,e._closeMessage=t,e._closeCode=s,s===1005?e.close():e.close(s,t)}function Od(){this[Q]._socket.resume()}function Rd(s){let t=this[Q];t._socket.removeListener("data",Ci),t.readyState=tt.CLOSING,t._closeCode=s[Ed],t.emit("error",s),t._socket.destroy()}function Nl(){this[Q].emitClose()}function jd(s){this[Q].emit("message",s)}function Bd(s){let t=this[Q];t.pong(s,!t._isServer,El),t.emit("ping",s)}function Fd(s){this[Q].emit("pong",s)}function Ll(){let s=this[Q];this.removeListener("close",Ll),this.removeListener("end",Ml),s.readyState=tt.CLOSING,s._socket.read(),s._receiver.end(),this.removeListener("data",Ci),this[Q]=void 0,clearTimeout(s._closeTimer),s._receiver._writableState.finished||s._receiver._writableState.errorEmitted?s.emitClose():(s._receiver.on("error",Nl),s._receiver.on("finish",Nl))}function Ci(s){this[Q]._receiver.write(s)||this.pause()}function Ml(){let s=this[Q];s.readyState=tt.CLOSING,s._receiver.end(),this.end()}function $l(){let s=this[Q];this.removeListener("error",$l),this.on("error",El),s.readyState=tt.CLOSING,this.destroy()}});var Bl=E((tg,jl)=>{"use strict";var Vd=require("events"),Pd=require("crypto"),Ui=require("http"),ue=Is(),Rl=hr(),Kd=br(),{GUID:qd}=he(),zd=/^[+/0-9A-Za-z]{22}==$/,Sr=class extends Vd{constructor(t,e){if(super(),t=Object.assign({maxPayload:100*1024*1024,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null},t),t.port==null&&!t.server&&!t.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');t.port!=null?(this._server=Ui.createServer((i,n)=>{let r=Ui.STATUS_CODES[426];n.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),n.end(r)}),this._server.listen(t.port,t.host,t.backlog,e)):t.server&&(this._server=t.server),this._server&&(this._removeListeners=Hd(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,n,r)=>{this.handleUpgrade(i,n,r,o=>{this.emit("connection",o,i)})}})),t.perMessageDeflate===!0&&(t.perMessageDeflate={}),t.clientTracking&&(this.clients=new Set),this.options=t}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(t){if(t&&this.once("close",t),this.clients)for(let i of this.clients)i.terminate();let e=this._server;if(e&&(this._removeListeners(),this._removeListeners=this._server=null,this.options.port!=null)){e.close(()=>this.emit("close"));return}process.nextTick(Wd,this)}shouldHandle(t){if(this.options.path){let e=t.url.indexOf("?");if((e!==-1?t.url.slice(0,e):t.url)!==this.options.path)return!1}return!0}handleUpgrade(t,e,i,n){e.on("error",xr);let r=t.headers["sec-websocket-key"]!==void 0?t.headers["sec-websocket-key"].trim():!1,o=t.headers.upgrade,a=+t.headers["sec-websocket-version"],l={};if(t.method!=="GET"||o===void 0||o.toLowerCase()!=="websocket"||!r||!zd.test(r)||a!==8&&a!==13||!this.shouldHandle(t))return Ni(e,400);if(this.options.perMessageDeflate){let c=new ue(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let h=Rl.parse(t.headers["sec-websocket-extensions"]);h[ue.extensionName]&&(c.accept(h[ue.extensionName]),l[ue.extensionName]=c)}catch{return Ni(e,400)}}if(this.options.verifyClient){let c={origin:t.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(t.connection.authorized||t.connection.encrypted),req:t};if(this.options.verifyClient.length===2){this.options.verifyClient(c,(h,u,d,f)=>{if(!h)return Ni(e,u||401,d,f);this.completeUpgrade(r,l,t,e,i,n)});return}if(!this.options.verifyClient(c))return Ni(e,401)}this.completeUpgrade(r,l,t,e,i,n)}completeUpgrade(t,e,i,n,r,o){if(!n.readable||!n.writable)return n.destroy();let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Pd.createHash("sha1").update(t+qd).digest("base64")}`],c=new Kd(null);var h=i.headers["sec-websocket-protocol"];if(h&&(h=h.split(",").map(Gd),this.options.handleProtocols?h=this.options.handleProtocols(h,i):h=h[0],h&&(l.push(`Sec-WebSocket-Protocol: ${h}`),c.protocol=h)),e[ue.extensionName]){let u=e[ue.extensionName].params,d=Rl.format({[ue.extensionName]:[u]});l.push(`Sec-WebSocket-Extensions: ${d}`),c._extensions=e}this.emit("headers",l,i),n.write(l.concat(`\r
`).join(`\r
`)),n.removeListener("error",xr),c.setSocket(n,r,this.options.maxPayload),this.clients&&(this.clients.add(c),c.on("close",()=>this.clients.delete(c))),o(c)}};jl.exports=Sr;function Hd(s,t){for(let e of Object.keys(t))s.on(e,t[e]);return function(){for(let i of Object.keys(t))s.removeListener(i,t[i])}}function Wd(s){s.emit("close")}function xr(){this.destroy()}function Ni(s,t,e,i){s.writable&&(e=e||Ui.STATUS_CODES[t],i=Object.assign({Connection:"close","Content-type":"text/html","Content-Length":Buffer.byteLength(e)},i),s.write(`HTTP/1.1 ${t} ${Ui.STATUS_CODES[t]}\r
`+Object.keys(i).map(n=>`${n}: ${i[n]}`).join(`\r
`)+`\r
\r
`+e)),s.removeListener("error",xr),s.destroy()}function Gd(s){return s.trim()}});var Vl=E((eg,Fl)=>{"use strict";var Ei=br();Ei.Server=Bl();Ei.Receiver=gr();Ei.Sender=yr();Fl.exports=Ei});var Kl=E((sg,Pl)=>{"use strict";var Jd=require("http"),kr=class{constructor(t=2019,e=null){this.port=t,this.host="127.0.0.1",this.logger=e}async ping(){try{let t=await this.get("/");return t&&t.status==="ok"}catch{return!1}}async getProjectInfo(){return this.get("/")}async getItems(t={}){let e=new URLSearchParams;t.q&&e.set("q",t.q),t.tag&&e.set("tag",t.tag),t.sort&&e.set("sort",t.sort);let i=e.toString();return this.get(`/project/items${i?"?"+i:""}`)}async getItem(t){return this.get(`/project/items/${t}`)}async getPhotos(t){return this.get(`/project/items/${t}/photos`)}async getItemTags(t){return this.get(`/project/items/${t}/tags`)}async getMetadata(t){return this.get(`/project/data/${t}`)}async saveMetadata(t,e){return this.postJson(`/project/data/${t}`,e)}async getTags(){return this.get("/project/tags")}async createTag(t,e=null,i=null){return this.post("/project/tags",{name:t,color:e,item:i})}async deleteTags(t){let e=new URLSearchParams;for(let i of t)e.append("id",i);return this.request("DELETE",`/project/tags?${e.toString()}`)}async addTagsToItem(t,e){return this.post(`/project/items/${t}/tags`,{tag:e})}async removeTagsFromItem(t,e){let i=new URLSearchParams;for(let n of e)i.append("tag",n);return this.request("DELETE",`/project/items/${t}/tags?${i.toString()}`)}async getNote(t,e="html"){return this.get(`/project/notes/${t}?format=${e}`)}async createNote(t){return this.postJson("/project/notes",t)}async updateNote(t,e){return this.putJson(`/project/notes/${t}`,e)}async deleteNote(t){return this.request("DELETE",`/project/notes/${t}`)}async getPhoto(t){return this.get(`/project/photos/${t}`)}async getSelection(t){return this.get(`/project/selections/${t}`)}async createSelection(t){return this.postJson("/project/selections",t)}async updateSelection(t,e){return this.putJson(`/project/selections/${t}`,e)}async deleteSelection(t){return this.request("DELETE",`/project/selections/${t}`)}async getTranscription(t,e="json"){return this.get(`/project/transcriptions/${t}?format=${e}`)}async getItemTranscriptions(t){return this.get(`/project/items/${t}/transcriptions`)}async createTranscription(t){return this.postJson("/project/transcriptions",t)}async updateTranscription(t,e){return this.putJson(`/project/transcriptions/${t}`,e)}async deleteTranscription(t){return this.request("DELETE",`/project/transcriptions/${t}`)}async getLists(){return this.get("/project/lists")}async getList(t){return this.get(`/project/lists/${t}`)}async getListItems(t){return this.get(`/project/lists/${t}/items`)}async addItemsToList(t,e){return this.post(`/project/lists/${t}/items`,{item:e})}async removeItemsFromList(t,e){let i=new URLSearchParams;for(let n of e)i.append("item",n);return this.request("DELETE",`/project/lists/${t}/items?${i.toString()}`)}async importItems(t){if(t.file)throw new Error("File path import is blocked for security \u2014 use data parameter with JSON-LD");let e=new URLSearchParams;return t.data&&e.set("data",JSON.stringify(t.data)),t.list&&e.set("list",t.list),this.request("POST","/project/import",e.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async getVersion(){return this.get("/version")}async get(t){return this.request("GET",t)}async post(t,e){let i=new URLSearchParams;for(let[n,r]of Object.entries(e))if(r!=null)if(Array.isArray(r))for(let o of r)i.append(n,o);else i.set(n,r);return this.request("POST",t,i.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async postJson(t,e){return this.request("POST",t,JSON.stringify(e),{"Content-Type":"application/json"})}async putJson(t,e){return this.request("PUT",t,JSON.stringify(e),{"Content-Type":"application/json"})}request(t,e,i=null,n={},r=3){return this._doRequest(t,e,i,n,r,0)}_doRequest(t,e,i,n,r,o){return new Promise((a,l)=>{let c={hostname:this.host,port:this.port,path:e,method:t,headers:{Accept:"application/json",...n}};i&&(c.headers["Content-Length"]=Buffer.byteLength(i));let h=Jd.request(c,u=>{let d=[];u.on("data",f=>d.push(f)),u.on("end",()=>{let f=Buffer.concat(d).toString();if(u.statusCode>=400){let p=new Error(`API ${t} ${e}: ${u.statusCode}`);if(p.status=u.statusCode,p.body=f,p.sqliteBusy=f.includes("SQLITE_BUSY"),p.sqliteBusy&&r>0){let g=Math.min(1e3*Math.pow(2,o),8e3);this.logger&&this.logger.debug(`SQLITE_BUSY on ${t} ${e}, retry ${o+1} in ${g}ms`),setTimeout(()=>{this._doRequest(t,e,i,n,r-1,o+1).then(a,l)},g);return}l(p);return}if(!f||f.length===0){a(null);return}try{a(JSON.parse(f))}catch{l(new Error(`API ${t} ${e}: invalid JSON response`))}})});h.on("error",u=>{this.logger&&this.logger.debug(`API request failed: ${t} ${e}`,{error:u.message}),l(u)}),h.setTimeout(1e4,()=>{h.destroy(new Error(`API timeout: ${t} ${e}`))}),i&&h.write(i),h.end()})}};Pl.exports={ApiClient:kr}});var zl=E((ig,ql)=>{"use strict";var Tr=class{constructor(t,e){this.store=t,this.logger=e,this._suppressChangeDetection=!1}_getState(){return this.store.getState()}getAllItems(){let{items:t,photos:e}=this._getState(),i=[];for(let n of Object.keys(t)){let r=t[n];i.push({id:Number(n),template:r.template,photos:r.photos||[],lists:r.lists||[],tags:r.tags||[]})}return i}getItemFull(t){return this._buildItemFull(this._getState(),t)}getAllItemsFull(){let t=this._getState(),e=[];for(let i of Object.keys(t.items)){let n=this._buildItemFull(t,Number(i));n&&e.push(n)}return e}_buildItemFull(t,e){let i=t.items[e];if(!i)return null;let n={"@id":e,template:i.template,lists:i.lists||[]},r=t.metadata[e];if(r)for(let[l,c]of Object.entries(r))l!=="id"&&(typeof c=="object"&&c!==null?n[l]={"@value":c.text||"","@type":c.type||""}:c!=null&&(n[l]=c));let o=i.tags||[];n.tag=[];for(let l of o){let c=t.tags[l];c&&n.tag.push({id:l,name:c.name,color:c.color||null})}n.photo=[];let a=i.photos||[];for(let l of a){let c=t.photos[l];if(!c)continue;let h={"@id":l,checksum:c.checksum,note:[],selection:[],transcription:[],metadata:null},u=t.metadata[l];if(u){h.metadata={};for(let[d,f]of Object.entries(u))d!=="id"&&(h.metadata[d]=f)}for(let d of c.notes||[]){let f=t.notes[d];if(!f)continue;let p=this._noteStateToHtml(f);h.note.push({"@id":d,text:f.text||"",html:p,language:f.language||null,photo:l})}if(t.transcriptions)for(let d of c.transcriptions||[]){let f=t.transcriptions[d];f&&h.transcription.push(f)}for(let d of c.selections||[]){let f=t.selections[d];if(!f)continue;let p={"@id":d,x:f.x,y:f.y,width:f.width,height:f.height,angle:f.angle||0,note:[],metadata:null,transcription:[]},g=t.metadata[d];if(g){p.metadata={};for(let[y,m]of Object.entries(g))y!=="id"&&(p.metadata[y]=m)}for(let y of f.notes||[]){let m=t.notes[y];if(!m)continue;let _=this._noteStateToHtml(m);p.note.push({"@id":y,text:m.text||"",html:_,language:m.language||null,selection:d})}if(t.transcriptions)for(let y of f.transcriptions||[]){let m=t.transcriptions[y];m&&p.transcription.push(m)}h.selection.push(p)}n.photo.push(h)}return n}getAllTags(){let{tags:t}=this._getState();return Object.values(t||{}).map(e=>({id:e.id,name:e.name,color:e.color||null}))}getAllLists(){let{lists:t}=this._getState();return Object.values(t||{}).map(e=>({id:e.id,name:e.name,parent:e.parent||null}))}ping(){return!!this.store}async createSelection({photo:t,x:e,y:i,width:n,height:r,angle:o}){let a=new Set(Object.keys(this._getState().selections)),l=this.store.dispatch({type:"selection.create",payload:{photo:t,x:e,y:i,width:n,height:r,angle:o||0},meta:{cmd:"project"}});await this._waitForAction(l);let c=this._getState(),h=Object.keys(c.selections),u=[];for(let d of h)if(!a.has(d)){let f=c.selections[d];f&&f.photo===t&&u.push(d)}if(u.length>0){let d=u[u.length-1];return{id:Number(d),"@id":Number(d)}}return null}async createNote({photo:t,selection:e,html:i,language:n}){if(!t&&!e)return this.logger.warn("createNote: no photo or selection \u2014 skipping"),null;let r=new Set(Object.keys(this._getState().notes)),o={text:i||""};t&&(o.photo=t),e&&(o.selection=e),n&&(o.language=n);let a=this.store.dispatch({type:"note.create",payload:o,meta:{cmd:"project",history:"add"}});await this._waitForAction(a);let l=this._getState(),c=Object.keys(l.notes),h=[];for(let u of c)if(!r.has(u)){let d=l.notes[u];d&&(t&&d.photo===t||e&&d.selection===e)&&h.push(u)}if(h.length>0){let u=h[h.length-1];return{id:Number(u),"@id":Number(u)}}for(let u of c)if(!r.has(u))return{id:Number(u),"@id":Number(u)};return null}async updateNote(t,{html:e,language:i}){let r=this._getState().notes[t];if(!r)throw new Error(`Note ${t} not found in store`);let o=r.photo||void 0,a=r.selection||void 0,l=i||r.language||null,c=this._noteStateToHtml(r);try{await this.deleteNote(t)}catch{}let h;try{h=await this.createNote({photo:o,selection:a,html:e,language:l})}catch(u){this.logger.warn(`updateNote: create threw after delete for note ${t}`,{error:u.message});try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(d){throw this.logger.warn(`updateNote: restore also failed for note ${t}`,{error:d.message}),u}return h}if(!h){this.logger.warn(`updateNote: create returned null after delete, restoring original for note ${t}`);try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(u){throw this.logger.warn(`updateNote: restore also failed for note ${t}`,{error:u.message}),new Error(`updateNote: note ${t} deleted but both create and restore failed`)}if(!h)throw new Error(`updateNote: note ${t} deleted but both create and restore returned null`)}return h}async deleteNote(t){let e=this.store.dispatch({type:"note.delete",payload:[t],meta:{cmd:"project",history:"add"}});await this._waitForAction(e)}async addItemsToList(t,e){let i=this.store.dispatch({type:"list.item.add",payload:{id:t,items:Array.isArray(e)?e:[e]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}async removeItemsFromList(t,e){let i=this.store.dispatch({type:"list.item.remove",payload:{id:t,items:Array.isArray(e)?e:[e]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}subscribe(t){this._prevState=this._getState();let e=["items","photos","selections","notes","metadata","tags","lists"];return this.store.subscribe(()=>{if(this._suppressChangeDetection)return;let i=this._getState(),n=!1;for(let r of e)if(i[r]!==this._prevState[r]){n=!0;break}if(this._prevState=i,n)try{t()}catch(r){this.logger.warn(`subscribe callback error: ${String(r.message||r)}`)}})}suppressChanges(){this._suppressChangeDetection=!0}resumeChanges(){this._prevState=this._getState(),this._suppressChangeDetection=!1}_waitForAction(t,e=15e3){if(!t||!t.meta||!t.meta.seq)return Promise.resolve();let i=t.meta.seq;return new Promise((n,r)=>{let o=!1,a=setTimeout(()=>{o||(o=!0,l(),r(new Error(`waitForAction: ${t.type} seq=${i} timed out after ${e}ms`)))},e),l=this.store.subscribe(()=>{if(o)return;let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),n())});if(!o){let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),n())}})}_noteStateToHtml(t){return t.html?t.html:t.state&&t.state.doc?this._renderDoc(t.state.doc):t.text?`<p>${this._esc(t.text)}</p>`:""}_renderDoc(t){if(!t||!t.content||(typeof t.toJSON=="function"&&(t=t.toJSON()),!t.content))return"";let e=t.content;if(!Array.isArray(e))if(Array.isArray(e.content))e=e.content;else return"";return e.map(i=>this._renderNode(i)).join("")}_renderNode(t){if(!t)return"";typeof t.toJSON=="function"&&(t=t.toJSON());let e="";if(t.content){let n=t.content;Array.isArray(n)||(Array.isArray(n.content)?n=n.content:n=[]),e=n.map(r=>this._renderNode(r)).join("")}switch(typeof t.type=="string"?t.type:t.type&&t.type.name||""){case"paragraph":{let n=t.attrs&&t.attrs.align;return n&&n!=="left"?`<p style="text-align: ${n==="right"?"end":n}">${e}</p>`:`<p>${e}</p>`}case"blockquote":return`<blockquote>${e}</blockquote>`;case"ordered_list":return`<ol>${e}</ol>`;case"bullet_list":return`<ul>${e}</ul>`;case"list_item":return`<li>${e}</li>`;case"heading":{let n=t.attrs&&t.attrs.level||1;return`<h${n}>${e}</h${n}>`}case"horizontal_rule":return"<hr>";case"code_block":return`<pre><code>${e}</code></pre>`;case"hard_break":return'<span class="line-break"><br></span>';case"text":{let n=this._esc(t.text||"");if(t.marks)for(let r of t.marks)switch(typeof r.type=="string"?r.type:r.type&&r.type.name||""){case"bold":case"strong":n=`<strong>${n}</strong>`;break;case"italic":case"em":n=`<em>${n}</em>`;break;case"link":n=`<a href="${this._esc(r.attrs&&r.attrs.href||"")}">${n}</a>`;break;case"superscript":case"sup":n=`<sup>${n}</sup>`;break;case"subscript":case"sub":n=`<sub>${n}</sub>`;break;case"strikethrough":n=`<span style="text-decoration: line-through">${n}</span>`;break;case"underline":n=`<span style="text-decoration: underline">${n}</span>`;break;case"overline":n=`<span style="text-decoration: overline">${n}</span>`;break}return n}default:return e}}_esc(t){let e=String(t),i="";for(let n=0;n<e.length;n++){let r=e[n];switch(r){case"&":i+="&amp;";break;case"<":i+="&lt;";break;case">":i+="&gt;";break;case'"':i+="&quot;";break;case"'":i+="&#x27;";break;default:i+=r}}return i}};ql.exports={StoreAdapter:Tr}});var Fe=E((ng,Jl)=>{"use strict";var Hl=require("crypto");function Di(s,t=24){let e=[2166136261,16777619,668265261],i="";for(let n of e){let r=n;for(let o=0;o<s.length;o++)r^=s.charCodeAt(o),r=r*16777619>>>0;i+=(r>>>0).toString(16).padStart(8,"0")}return i.slice(0,t)}function Wl(s){let t=Gl(s);return t.length>0?Yd(t):Xd(s)}function Gl(s){let t=[],e=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(e)||(e=[e]);for(let i of e){let n=i.checksum||i["https://tropy.org/v1/tropy#checksum"];n&&t.push(typeof n=="object"&&n["@value"]||String(n));let r=i.selection||i["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(r)||(r=[r]);for(let o of r){let a=o.checksum||o["https://tropy.org/v1/tropy#checksum"];a&&t.push(typeof a=="object"&&a["@value"]||String(a))}}return t}function Yd(s){let t=s.slice().sort();return Hl.createHash("sha256").update(t.join(":")).digest("hex").slice(0,32)}function Xd(s){let t=s.template||s["https://tropy.org/v1/tropy#template"]||"";typeof t=="object"&&(t=t["@id"]||"");let e=s["http://purl.org/dc/elements/1.1/title"]||s["http://purl.org/dc/terms/title"]||s.title||"";typeof e=="object"&&(e=e["@value"]||"");let i=s["http://purl.org/dc/elements/1.1/date"]||s["http://purl.org/dc/terms/date"]||s.date||"";typeof i=="object"&&(i=i["@value"]||"");let n=`${t}|${e}|${i}`;return n==="||"?null:Hl.createHash("sha256").update(n).digest("hex").slice(0,32)}function Zd(s,t){let e=Math.round(t.x??0),i=Math.round(t.y??0),n=Math.round(t.width??t.w??0),r=Math.round(t.height??t.h??0);return Di(`sel:${s}:${e}:${i}:${n}:${r}`)}function Qd(s,t){let e=s.text||"",i=s.html||"",n=t||s.photo||s.selection||"orphan",r=i||e,o=r.slice(0,200),a=r.length>200?Di(r,8):"";return Di(`note:${n}:${o}:${a}`)}function tf(s,t,e){let i=e?`${s}:${e}`:s;return Di(`tx:${i}:${t}`)}function ef(s){let t=new Map;for(let e of s){let i=Wl(e);i&&t.set(i,{localId:e["@id"]||e.id,item:e})}return t}function sf(s,t){return t.get(s)||null}function nf(s){let t=new Map,e=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(e)||(e=[e]);for(let i of e){let n=i["@id"]||i.id,r=i.checksum||i["https://tropy.org/v1/tropy#checksum"];n&&r&&(typeof r=="object"&&(r=r["@value"]||String(r)),t.set(n,String(r)))}return t}Jl.exports={computeIdentity:Wl,extractChecksums:Gl,buildIdentityIndex:ef,findLocalMatch:sf,computeSelectionKey:Zd,computeNoteKey:Qd,computeTranscriptionKey:tf,buildPhotoChecksumMap:nf}});var Mi=E((rg,ec)=>{"use strict";var Nt=(Ts(),Us(ks)),Li=["metadata","tags","notes","photos","selections","selectionMeta","selectionNotes","transcriptions","lists"];function rf(s,t){let e=s.getMap("annotations"),i=e.get(t),n=!i;n&&(i=new Nt.Map);let r={};for(let o of Li){let a=i.get(o);a||(a=new Nt.Map,i.set(o,a)),r[o]=a}return n&&e.set(t,i),r}function Y(s,t,e){let i=s.getMap("annotations"),n=i.get(t);if(!n)return n=new Nt.Map,n.set(e,new Nt.Map),i.set(t,n),n.get(e);let r=n.get(e);return r||(r=new Nt.Map,n.set(e,r)),r}function of(s,t,e,i,n){Y(s,t,"metadata").set(e,{text:i.text||"",type:i.type||"http://www.w3.org/2001/XMLSchema#string",language:i.language||null,author:n,ts:Date.now()})}function af(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("metadata");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function lf(s,t,e,i){let n=Y(s,t,"tags"),r=n.get(e.name);(!r||r.deleted||e.color!==r.color)&&n.set(e.name,{name:e.name,color:e.color||null,author:i,ts:Date.now()})}function cf(s,t,e,i){let n=Y(s,t,"tags"),r=n.get(e);r&&!r.deleted&&n.set(e,{...r,deleted:!0,author:i,ts:Date.now()})}function vr(s,t){let i=s.getMap("annotations").get(t);if(!i)return[];let n=i.get("tags");if(!n)return[];let r=[];return n.forEach((o,a)=>{r.push(o)}),r}function hf(s,t){return vr(s,t).filter(e=>!e.deleted)}function uf(s,t){return vr(s,t).filter(e=>e.deleted)}function df(s,t,e,i,n){Y(s,t,"notes").set(e,{noteKey:e,text:i.text||"",html:i.html||"",language:i.language||null,photo:i.photo||null,selection:i.selection||null,author:n,ts:Date.now()})}function ff(s,t,e,i){let n=Y(s,t,"notes"),r=n.get(e);r&&!r.deleted&&n.set(e,{...r,deleted:!0,author:i,ts:Date.now()})}function Xl(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("notes");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function pf(s,t){let e=Xl(s,t),i={};for(let[n,r]of Object.entries(e))r.deleted||(i[n]=r);return i}function gf(s,t,e){let n=s.getMap("annotations").get(t);if(!n)return;let r=n.get("notes");r&&r.delete(e)}function mf(s,t,e,i,n,r){let o=Y(s,t,"photos"),a=o.get(e);a||(a=new Nt.Map,a.set("metadata",new Nt.Map),o.set(e,a));let l=a.get("metadata");l||(l=new Nt.Map,a.set("metadata",l)),l.set(i,{text:n.text||"",type:n.type||"http://www.w3.org/2001/XMLSchema#string",language:n.language||null,author:r,ts:Date.now()})}function yf(s,t,e){let n=s.getMap("annotations").get(t);if(!n)return{};let r=n.get("photos");if(!r)return{};let o=r.get(e);if(!o)return{};let a=o.get("metadata");if(!a)return{};let l={};return a.forEach((c,h)=>{l[h]=c}),l}function wf(s,t){let i=s.getMap("annotations").get(t);if(!i)return[];let n=i.get("photos");if(!n)return[];let r=[];return n.forEach((o,a)=>{r.push(a)}),r}function _f(s,t,e,i,n){let r=Y(s,t,"selections"),o=i.x??0,a=i.y??0,l=i.width??i.w,c=i.height??i.h;!Number.isFinite(o)||!Number.isFinite(a)||l==null||c==null||!Number.isFinite(l)||!Number.isFinite(c)||l<=0||c<=0||r.set(e,{selKey:e,x:o,y:a,w:l,h:c,angle:i.angle??0,photo:i.photo||null,author:n,ts:Date.now()})}function bf(s,t,e,i){let n=Y(s,t,"selections"),r=n.get(e);r&&!r.deleted&&n.set(e,{...r,deleted:!0,author:i,ts:Date.now()})}function Zl(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("selections");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function Sf(s,t){let e=Zl(s,t),i={};for(let[n,r]of Object.entries(e))r.deleted||(i[n]=r);return i}function xf(s,t,e,i,n,r){let o=Y(s,t,"selectionMeta"),a=`${e}:${i}`;o.set(a,{text:n.text||"",type:n.type||"http://www.w3.org/2001/XMLSchema#string",language:n.language||null,author:r,ts:Date.now()})}function kf(s,t,e){let n=s.getMap("annotations").get(t);if(!n)return{};let r=n.get("selectionMeta");if(!r)return{};let o=`${e}:`,a={};return r.forEach((l,c)=>{if(c.startsWith(o)){let h=c.slice(o.length);a[h]=l}}),a}function Tf(s,t,e,i,n,r){let o=Y(s,t,"selectionNotes"),a=`${e}:${i}`;o.set(a,{noteKey:i,selKey:e,text:n.text||"",html:n.html||"",language:n.language||null,author:r,ts:Date.now()})}function vf(s,t,e,i,n){let r=Y(s,t,"selectionNotes"),o=`${e}:${i}`,a=r.get(o);a&&!a.deleted&&r.set(o,{...a,deleted:!0,author:n,ts:Date.now()})}function Af(s,t,e){let n=s.getMap("annotations").get(t);if(!n)return{};let r=n.get("selectionNotes");if(!r)return{};let o=`${e}:`,a={};return r.forEach((l,c)=>{c.startsWith(o)&&(l.deleted||(a[c]=l))}),a}function If(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("selectionNotes");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function Cf(s,t,e){let n=s.getMap("annotations").get(t);if(!n)return;let r=n.get("selectionNotes");r&&r.delete(e)}function Nf(s,t,e,i,n){Y(s,t,"transcriptions").set(e,{txKey:e,text:i.text||"",data:i.data||null,photo:i.photo||null,selection:i.selection||null,author:n,ts:Date.now()})}function Uf(s,t,e,i){let n=Y(s,t,"transcriptions"),r=n.get(e);r&&!r.deleted&&n.set(e,{...r,deleted:!0,author:i,ts:Date.now()})}function Ql(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("transcriptions");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function Ef(s,t){let e=Ql(s,t),i={};for(let[n,r]of Object.entries(e))r.deleted||(i[n]=r);return i}function Df(s,t,e,i){Y(s,t,"lists").set(e,{name:e,member:!0,author:i,ts:Date.now()})}function Lf(s,t,e,i){let n=Y(s,t,"lists"),r=n.get(e);r&&!r.deleted&&n.set(e,{...r,member:!1,deleted:!0,author:i,ts:Date.now()})}function tc(s,t){let i=s.getMap("annotations").get(t);if(!i)return{};let n=i.get("lists");if(!n)return{};let r={};return n.forEach((o,a)=>{r[a]=o}),r}function Mf(s,t){let e=tc(s,t),i={};for(let[n,r]of Object.entries(e))!r.deleted&&r.member&&(i[n]=r);return i}function $f(s){let t=s.getMap("annotations"),e=["tags","notes","selections","selectionNotes","transcriptions","lists"],i=0,n=0;return t.forEach((r,o)=>{n++;for(let a of e){let l=r.get(a);if(!l)continue;let c=[];l.forEach((h,u)=>{h&&h.deleted&&c.push(u)});for(let h of c)l.delete(h),i++}}),{items:n,purged:i}}function Of(s,t,e){let i=s.getMap("annotations"),n=i.get(t);n||(n=new Nt.Map,i.set(t,n));let r=e.join(",");n.get("checksums")!==r&&n.set("checksums",r)}function Rf(s,t){let i=s.getMap("annotations").get(t);if(!i)return[];let n=i.get("checksums");return n?n.split(",").filter(Boolean):[]}function jf(s,t){let i=s.getMap("annotations").get(t);if(!i)return null;let n={};for(let r of Li){let o=i.get(r);if(!o){n[r]={};continue}if(r==="photos"){let a={};o.forEach((l,c)=>{let h=l.get("metadata"),u={};h&&h.forEach((d,f)=>{u[f]=d}),a[c]={metadata:u}}),n[r]=a}else{let a={};o.forEach((l,c)=>{a[c]=l}),n[r]=a}}return n}function Bf(s){let t=s.getMap("annotations"),e=[];return t.forEach((i,n)=>{e.push(n)}),e}function Yl(s){if(s&&typeof s=="object"){let{ts:t,author:e,...i}=s;return i}return s}function Ff(s){let t=s.getMap("annotations"),e={};return t.forEach((i,n)=>{let r={};for(let o of Li){let a=i.get(o);if(!a){r[o]={};continue}if(o==="photos"){let l={};a.forEach((c,h)=>{let u=c.get("metadata"),d={};u&&u.forEach((f,p)=>{d[p]=Yl(f)}),l[h]={metadata:d}}),r[o]=l}else{let l={};a.forEach((c,h)=>{l[h]=Yl(c)}),r[o]=l}}e[n]=r}),e}function Vf(s,t,e){s.getMap("users").set(String(t),{userId:e||`user-${t}`,name:e||`user-${t}`,joinedAt:Date.now(),lastSeen:Date.now()})}function Pf(s,t){s.getMap("users").delete(String(t))}function Kf(s,t){let e=s.getMap("users"),i=e.get(String(t));i&&e.set(String(t),{...i,lastSeen:Date.now()})}function qf(s){let t=s.getMap("users"),e=[];return t.forEach((i,n)=>{e.push({clientId:n,...i})}),e}function zf(s,t){let e=s.getMap("room");for(let[i,n]of Object.entries(t))e.set(i,n)}function Hf(s){let t=s.getMap("room"),e={};return t.forEach((i,n)=>{e[n]=i}),e}function Wf(s,t){let e=s.getMap("annotations"),i=n=>{let r=new Set;n.forEach(o=>{o.target===e&&o.changes.keys.forEach((a,l)=>{r.add(l)})}),r.size>0&&t(Array.from(r))};return e.observeDeep(i),()=>e.unobserveDeep(i)}function Gf(s,t,e){let i=s.getMap("annotations"),n=(r,o)=>{if(e!=null&&o.origin===e)return;let a=[];for(let l of r){let c=l.path;if(c.length>=2){let h=c[0],u=c[1];a.push({identity:h,type:u,event:l})}else l.target===i&&l.changes.keys.forEach((h,u)=>{a.push({identity:u,type:"item",event:l})})}a.length>0&&t(a)};return i.observeDeep(n),()=>i.unobserveDeep(n)}ec.exports={ITEM_SECTIONS:Li,getItemAnnotations:rf,setMetadata:of,getMetadata:af,setTag:lf,removeTag:cf,getTags:vr,getActiveTags:hf,getDeletedTags:uf,setNote:df,removeNote:ff,deleteNoteEntry:gf,getNotes:Xl,getActiveNotes:pf,setPhotoMetadata:mf,getPhotoMetadata:yf,getAllPhotoChecksums:wf,setSelection:_f,removeSelection:bf,getSelections:Zl,getActiveSelections:Sf,setSelectionMeta:xf,getSelectionMeta:kf,setSelectionNote:Tf,removeSelectionNote:vf,deleteSelectionNoteEntry:Cf,getSelectionNotes:Af,getAllSelectionNotes:If,setTranscription:Nf,removeTranscription:Uf,getTranscriptions:Ql,getActiveTranscriptions:Ef,setListMembership:Df,removeListMembership:Lf,getLists:tc,getActiveLists:Mf,setItemChecksums:Of,getItemChecksums:Rf,getSnapshot:Ff,getItemSnapshot:jf,getIdentities:Bf,purgeTombstones:$f,registerUser:Vf,deregisterUser:Pf,heartbeat:Kf,getUsers:qf,setRoomConfig:zf,getRoomConfig:Hf,observeAnnotations:Wf,observeAnnotationsDeep:Gf}});var ic=E((og,sc)=>{"use strict";var Ve=require("fs"),$i=require("path"),Jf=require("os"),Yf={maxBackups:10,maxNoteSize:1*1024*1024,maxMetadataSize:64*1024,tombstoneFloodThreshold:.5},Ar=class{constructor(t,e,i,n={}){this.room=t,this.api=e,this.logger=i,this.options={...Yf,...n},this.backupDir=$i.join(Jf.homedir(),".troparcel","backups",this.sanitizeDir(t)),this._fileCounter=0}sanitizeDir(t){return t.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}async ensureDir(){await Ve.promises.mkdir(this.backupDir,{recursive:!0})}async saveSnapshot(t){await this.ensureDir();let e=new Date().toISOString().replace(/[:.]/g,"-");this._fileCounter++;let i=`${e}-${String(this._fileCounter).padStart(4,"0")}.json`,n=$i.join(this.backupDir,i),r={room:this.room,timestamp:new Date().toISOString(),version:"3.1",items:t};return await Ve.promises.writeFile(n,JSON.stringify(r)),this.logger.info(`Backup saved: ${n}`,{items:t.length}),await this.pruneOldBackups(),n}async pruneOldBackups(){try{let e=(await Ve.promises.readdir(this.backupDir)).filter(n=>n.endsWith(".json")).sort(),i=[];for(;e.length>this.options.maxBackups;)i.push(e.shift());if(i.length>0){await Promise.allSettled(i.map(n=>Ve.promises.unlink($i.join(this.backupDir,n))));for(let n of i)this.logger.debug(`Pruned old backup: ${n}`)}}catch(t){this.logger.warn("Failed to prune backups",{error:t.message})}}async captureItemState(t,e){let i={identity:e,localId:t};try{i.metadata=await this.api.getMetadata(t)}catch(n){this.logger.warn(`captureItemState: failed to get metadata for ${t}`,{error:String(n.message||n)}),i.metadata=null}try{i.tags=await this.api.getItemTags(t)}catch(n){this.logger.warn(`captureItemState: failed to get tags for ${t}`,{error:String(n.message||n)}),i.tags=[]}i.photos=[];try{let n=await this.api.getPhotos(t);if(Array.isArray(n)){let r=n.map(a=>typeof a=="object"?a.id:a),o=await Promise.allSettled(r.map(a=>this.api.getPhoto(a)));for(let a of o)a.status==="fulfilled"&&a.value&&i.photos.push(a.value)}}catch(n){this.logger.warn(`captureItemState: failed to get photos for ${t}`,{error:String(n.message||n)})}return i}captureItemStateFromStore(t,e,i){let n=t.getItemFull(e);if(!n)return{identity:i,localId:e,metadata:null,tags:[],photos:[]};let r={},o=new Set(["id","photo","template","list","lists","tag","tags","photos","selections","notes","transcriptions"]);for(let[a,l]of Object.entries(n))a.startsWith("@")||a.startsWith("_")||o.has(a)||(r[a]=l);return{identity:i,localId:e,metadata:r,tags:n.tag||[],photos:n.photo||[]}}validateInbound(t,e,i){let n=[];if(e.notes)for(let[a,l]of Object.entries(e.notes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&n.push(`Note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(e.selectionNotes)for(let[a,l]of Object.entries(e.selectionNotes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&n.push(`Selection note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(e.transcriptions)for(let[a,l]of Object.entries(e.transcriptions)){if(l.deleted)continue;let c=(l.text||"").length+JSON.stringify(l.data||"").length;c>this.options.maxNoteSize&&n.push(`Transcription ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(e.metadata)for(let[a,l]of Object.entries(e.metadata)){let c=(l.text||"").length;c>this.options.maxMetadataSize&&n.push(`Metadata ${a} exceeds max size (${c} > ${this.options.maxMetadataSize})`)}let r=0,o=0;for(let a of["tags","notes","selectionNotes","selections","transcriptions","lists"]){let l=e[a];if(l&&typeof l=="object")for(let c of Object.values(l))r++,c&&c.deleted&&(!i||c.author!==i)&&o++}return r>0&&o/r>this.options.tombstoneFloodThreshold&&this.logger.info(`Tombstone ratio for ${t.slice(0,8)}: ${o}/${r} (${Math.round(o/r*100)}%) \u2014 not blocking`),{valid:n.length===0,warnings:n}}shouldOverwrite(t,e){return e&&e.deleted?!0:!((!e||!e.text)&&t&&t.text)}async rollback(t,e=null){let i=JSON.parse(await Ve.promises.readFile(t,"utf8")),n=0,r=[];for(let o of i.items){let a=[];try{if(o.metadata)try{await this.api.saveMetadata(o.localId,o.metadata)}catch(l){a.push(`metadata for ${o.localId}: ${l.message}`)}if(o.tags&&Array.isArray(o.tags))try{let l=o.tags.map(c=>c.id||c.tag_id).filter(Boolean);l.length>0&&await this.api.addTagsToItem(o.localId,l)}catch(l){a.push(`tags for ${o.localId}: ${l.message}`)}if(o.photos&&Array.isArray(o.photos))for(let l of o.photos){let c=l.notes||[];for(let u of c)try{let d=await this.api.getNote(u,"json");d&&d.html&&(e?await e.updateNote(u,{html:d.html}):this.logger.warn(`Rollback: note ${u} update skipped (no store adapter, HTTP PUT not supported)`))}catch(d){a.push(`note ${u}: ${d.message}`)}let h=l.selections||[];for(let u of h)this.logger.warn(`Rollback: selection ${u} update skipped (selection coordinate update not supported)`)}a.length>0&&(this.logger.warn(`Rollback: item ${o.localId} partially restored with ${a.length} error(s)`),r.push(...a)),n++}catch(l){r.push(`Failed to restore item ${o.localId}: ${l.message}`),r.push(...a)}}return this.logger.info(`Rollback complete: ${n} items restored`,{backup:t,errors:r.length}),{restored:n,errors:r}}listBackups(){try{return Ve.readdirSync(this.backupDir).filter(t=>t.endsWith(".json")).sort().reverse().map(t=>$i.join(this.backupDir,t))}catch{return[]}}};sc.exports={BackupManager:Ar}});var ac=E((ag,oc)=>{"use strict";var nc=require("crypto"),Oi=require("fs"),Ri=require("path"),rc=require("os"),Xf=(Ts(),Us(ks)),Zf=5e3,Ir=5e4,ji=5e4,Cr=class{constructor(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes=new Map,this.appliedNoteKeys=new Set,this.appliedSelectionKeys=new Set,this.appliedTranscriptionKeys=new Set,this.noteIdToCrdtKey=new Map,this.crdtKeyToNoteId=new Map,this.txIdToCrdtKey=new Map,this.crdtKeyToTxId=new Map,this._cachedAnnotationCount=0,this.failedNoteKeys=new Map,this._dirty=!1}markDirty(){this._dirty=!0}get isDirty(){return this._dirty}hasCRDTChanged(t){let e;if(t instanceof Uint8Array)e=t;else if(t&&typeof t.store<"u")e=Xf.encodeStateVector(t);else{let n=this.hashObject(t);return n===this.lastCRDTHash?!1:(this.lastCRDTHash=n,!0)}let i=nc.createHash("sha256").update(Buffer.from(e)).digest("hex").slice(0,16);return i===this.lastCRDTHash?!1:(this.lastCRDTHash=i,!0)}shouldBackup(t){let e=this.hashObject(t);return e===this.lastBackupHash?!1:(this.lastBackupHash=e,!0)}hasItemChanged(t,e){let i=this._fastHash(e);return{changed:this.pushedHashes.get(t)!==i,hash:i}}markPushed(t,e){this._evictIfNeeded(this.pushedHashes,Zf),this.pushedHashes.set(t,e)}_fastHash(t){let e=JSON.stringify(t),i=2166136261;for(let n=0;n<e.length;n++)i^=e.charCodeAt(n),i=i*16777619>>>0;return i.toString(36)}getNoteKey(t,e){let i=String(t),n=this.noteIdToCrdtKey.get(i);return n||(this._evictIfNeeded(this.noteIdToCrdtKey,ji),this.noteIdToCrdtKey.set(i,e),this.crdtKeyToNoteId.set(e,i),e)}mapAppliedNote(t,e){let i=String(e);this._evictIfNeeded(this.crdtKeyToNoteId,ji),this.crdtKeyToNoteId.set(t,i),this.noteIdToCrdtKey.set(i,t)}getLocalNoteId(t){return this.crdtKeyToNoteId.get(t)||null}getTxKey(t,e){let i=String(t),n=this.txIdToCrdtKey.get(i);return n||(this._evictIfNeeded(this.txIdToCrdtKey,ji),this.txIdToCrdtKey.set(i,e),this.crdtKeyToTxId.set(e,i),e)}mapAppliedTranscription(t,e){let i=String(e);this._evictIfNeeded(this.crdtKeyToTxId,ji),this.crdtKeyToTxId.set(t,i),this.txIdToCrdtKey.set(i,t)}getLocalTxId(t){return this.crdtKeyToTxId.get(t)||null}updateAnnotationCount(t){this._cachedAnnotationCount=t}get annotationCount(){return this._cachedAnnotationCount}hashObject(t){let e=this._sortedStringify(t);return nc.createHash("sha256").update(e).digest("hex").slice(0,16)}_sortedStringify(t){return JSON.stringify(t,(e,i)=>{if(i&&typeof i=="object"&&!Array.isArray(i)){let n={};for(let r of Object.keys(i).sort())n[r]=i[r];return n}return i})}_evictIfNeeded(t,e){if(t.size<e)return;let i=Math.floor(e*.2),n=t.keys();for(let r=0;r<i;r++){let o=n.next();if(o.done)break;t.delete(o.value)}}pruneAppliedKeys(){this._truncateSetInPlace(this.appliedNoteKeys,Ir),this._truncateSetInPlace(this.appliedSelectionKeys,Ir),this._truncateSetInPlace(this.appliedTranscriptionKeys,Ir)}_truncateSetInPlace(t,e){if(t.size<=e)return;let i=t.size-e,n=t.values();for(let r=0;r<i;r++){let o=n.next();if(o.done)break;t.delete(o.value)}}async persistToFile(t){if(t)try{let e=Ri.join(rc.homedir(),".troparcel","vault");await Oi.promises.mkdir(e,{recursive:!0});let i=Ri.join(e,this._sanitizeRoom(t)+".json"),n=i+".tmp",r={version:2,timestamp:new Date().toISOString(),appliedNoteKeys:Array.from(this.appliedNoteKeys),appliedSelectionKeys:Array.from(this.appliedSelectionKeys),appliedTranscriptionKeys:Array.from(this.appliedTranscriptionKeys),failedNoteKeys:Array.from(this.failedNoteKeys.entries()).map(([o,a])=>({key:o,count:a}))};await Oi.promises.writeFile(n,JSON.stringify(r)),await Oi.promises.rename(n,i),this._dirty=!1}catch(e){throw e}}loadFromFile(t){if(!t)return!1;try{let e=Ri.join(rc.homedir(),".troparcel","vault"),i=Ri.join(e,this._sanitizeRoom(t)+".json"),n=Oi.readFileSync(i,"utf8"),r=JSON.parse(n);if(r.version!==1&&r.version!==2)return!1;if(Array.isArray(r.appliedNoteKeys))for(let o of r.appliedNoteKeys)this.appliedNoteKeys.add(o);if(Array.isArray(r.appliedSelectionKeys))for(let o of r.appliedSelectionKeys)this.appliedSelectionKeys.add(o);if(Array.isArray(r.appliedTranscriptionKeys))for(let o of r.appliedTranscriptionKeys)this.appliedTranscriptionKeys.add(o);if(Array.isArray(r.failedNoteKeys))for(let o of r.failedNoteKeys)typeof o=="string"?this.failedNoteKeys.set(o,3):Array.isArray(o)?this.failedNoteKeys.set(o[0],o[1]||3):o&&o.key&&this.failedNoteKeys.set(o.key,o.count||3);return!0}catch{return!1}}_sanitizeRoom(t){return t.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}clear(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes.clear(),this.appliedNoteKeys.clear(),this.appliedSelectionKeys.clear(),this.appliedTranscriptionKeys.clear(),this.noteIdToCrdtKey.clear(),this.crdtKeyToNoteId.clear(),this.txIdToCrdtKey.clear(),this.crdtKeyToTxId.clear(),this._cachedAnnotationCount=0,this.failedNoteKeys.clear()}};oc.exports={SyncVault:Cr}});var cc=E((lg,lc)=>{"use strict";var W=Fe(),v=Mi();lc.exports={async pushLocal(s){let t=this._stableUserId;this._lastPushTs=this.lastSync?this.lastSync.getTime():0;let e=0,i=0;for(let n of s){let r=W.computeIdentity(n);if(!r)continue;let o=this.vault.hasItemChanged(r,n);if(!o.changed){i++;continue}e++;let a=W.buildPhotoChecksumMap(n);try{let l={};this.doc.transact(()=>{let c=Array.from(a.values());c.length>0&&v.setItemChecksums(this.doc,r,c),this.pushMetadata(n,r,t),this.pushTags(n,r,t),l.noteKeys=this.pushNotes(n,r,t,a),this.pushPhotoMetadata(n,r,t),l.selectionKeys=this.pushSelections(n,r,t,a),l.transcriptionKeys=this.pushTranscriptions(n,r,t,a),this.options.syncLists&&this.pushLists(n,r,t),this.pushDeletions(n,r,t,a,l)},this.LOCAL_ORIGIN),this.saveItemSnapshot(n,r,a,l),this.vault.markPushed(r,o.hash),this._pushFailCounts&&this._pushFailCounts.has(r)&&this._pushFailCounts.delete(r)}catch(l){this.logger.warn(`Failed to push item ${r}`,{error:l.message});let c=this._pushFailCounts&&this._pushFailCounts.get(r)||0;this._pushFailCounts||(this._pushFailCounts=new Map),this._pushFailCounts.set(r,c+1),c+1>=3&&(this.vault.markPushed(r,o.hash),this._pushFailCounts.delete(r),this.logger.warn(`Item ${r} push permanently skipped after ${c+1} failures`))}}e>0?this._log(`pushed ${e} item(s) to CRDT`):this._debug(`pushLocal: ${i} item(s) unchanged`)},pushMetadata(s,t,e){if(!this.options.syncMetadata)return;let i=v.getMetadata(this.doc,t),n=this._lastPushTs;for(let[r,o]of Object.entries(s)){if(r.startsWith("@")||r.startsWith("_")||["photo","template","list","lists","tag"].includes(r)||!r.includes(":")&&!r.includes("/"))continue;let a="",l="http://www.w3.org/2001/XMLSchema#string",c=null;typeof o=="string"?a=o:o&&typeof o=="object"?(a=o["@value"]||o.text||"",l=o["@type"]||o.type||l,c=o["@language"]||o.language||null):o!=null&&(a=String(o));let h=i[r];!a&&!h||h&&(h.text===a&&h.type===l||h.author!==e&&h.ts>n)||v.setMetadata(this.doc,t,r,{text:a,type:l,language:c},e)}},pushTags(s,t,e){if(!this.options.syncTags)return;let i=s.tag||s["https://tropy.org/v1/tropy#tag"]||[];Array.isArray(i)||(i=[i]);let n=this._lastPushTs,r=v.getTags(this.doc,t),o=new Map(r.map(a=>[a.name,a]));for(let a of i){let l=typeof a=="string"?a:a.name||a["@value"]||"",c=typeof a=="object"?a.color:null;if(!l)continue;let h=o.get(l);h&&!h.deleted&&((h.color||null)===(c||null)||h.author!==e&&h.ts>n)||h&&h.deleted&&h.author!==e&&h.ts>=n||v.setTag(this.doc,t,{name:l,color:c},e)}},pushNotes(s,t,e,i){if(!this.options.syncNotes)return{noteKeys:new Set,selectionNoteKeys:new Set};let n=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(n)||(n=[n]);let r=v.getNotes(this.doc,t),o=this._lastPushTs,a=new Set,l=new Set;for(let c of n){let h=c.checksum||i.get(c["@id"]||c.id),u=c.note||c["https://tropy.org/v1/tropy#note"]||[];Array.isArray(u)||(u=[u]);for(let f of u){if(!f)continue;let p=f["@value"]||f.text||f["https://schema.org/text"]||"",g=f.html||f["https://tropy.org/v1/tropy#html"]||"";if(typeof p=="object"&&(p=p["@value"]||""),typeof g=="object"&&(g=g["@value"]||""),!this._isSyncedNote(p,g)&&(p||g)){let y=W.computeNoteKey({text:p,html:g,photo:c["@id"]||c.id},h),m=f["@id"]||f.id,_=m?this.vault.getNoteKey(m,y):y;a.add(_);let S=r[_];if(S&&!S.deleted&&S.text===p&&S.html===g){this.vault.appliedNoteKeys.add(_);continue}if(S&&!S.deleted&&S.author!==e&&S.ts>o)continue;v.setNote(this.doc,t,_,{text:p,html:g,language:f.language||null,photo:h||null},e),this.vault.appliedNoteKeys.add(_)}}let d=c.selection||c["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(d)||(d=[d]);for(let f of d){if(!f||!h)continue;let p=W.computeSelectionKey(h,f),g=f.note||f["https://tropy.org/v1/tropy#note"]||[];Array.isArray(g)||(g=[g]);let y=v.getSelectionNotes(this.doc,t,p);for(let m of g){if(!m)continue;let _=m["@value"]||m.text||m["https://schema.org/text"]||"",S=m.html||m["https://tropy.org/v1/tropy#html"]||"";if(typeof _=="object"&&(_=_["@value"]||""),typeof S=="object"&&(S=S["@value"]||""),!this._isSyncedNote(_,S)&&(_||S)){let k=W.computeNoteKey({text:_,html:S,selection:f["@id"]||f.id},h),N=m["@id"]||m.id,Vt=N?this.vault.getNoteKey(N,k):k,de=`${p}:${Vt}`;l.add(de);let Pt=y[de];if(Pt&&Pt.text===_&&Pt.html===S){this.vault.appliedNoteKeys.add(de);continue}if(Pt&&!Pt.deleted&&Pt.author!==e&&Pt.ts>o)continue;v.setSelectionNote(this.doc,t,p,Vt,{text:_,html:S,language:m.language||null},e),this.vault.appliedNoteKeys.add(de)}}}}return this._cleanupStaleNotes(t,e,a,l),{noteKeys:a,selectionNoteKeys:l}},_cleanupStaleNotes(s,t,e,i){if(!this.options.syncDeletions)return;let n=v.getNotes(this.doc,s),r=0;for(let[a,l]of Object.entries(n))l.author===t&&(l.deleted||e.has(a)||(v.deleteNoteEntry(this.doc,s,a),r++));let o=v.getAllSelectionNotes(this.doc,s);for(let[a,l]of Object.entries(o))l.author===t&&(l.deleted||i.has(a)||(v.deleteSelectionNoteEntry(this.doc,s,a),r++));r>0&&this._log(`cleanupStaleNotes: removed ${r} stale entry(s) for ${s.slice(0,8)}`)},pushPhotoMetadata(s,t,e){if(!this.options.syncPhotoAdjustments)return;let i=this._lastPushTs,n=s.photo||[];Array.isArray(n)||(n=[n]);for(let r of n){let o=r.checksum;if(!o||!r.metadata)continue;let a=v.getPhotoMetadata(this.doc,t,o);for(let[l,c]of Object.entries(r.metadata)){if(l==="id")continue;let h="",u="http://www.w3.org/2001/XMLSchema#string";typeof c=="object"&&c!==null?(h=c.text||"",u=c.type||u):c!=null&&(h=String(c));let d=a[l];!h&&!d||d&&(d.text===h&&d.type===u||d.author!==e&&d.ts>i)||v.setPhotoMetadata(this.doc,t,o,l,{text:h,type:u},e)}}},pushSelections(s,t,e,i){if(!this.options.syncSelections)return new Set;let n=s.photo||[];Array.isArray(n)||(n=[n]);let r=v.getSelections(this.doc,t),o=this._lastPushTs,a=new Set;for(let l of n){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.selection||[];Array.isArray(h)||(h=[h]);for(let u of h){if(!u)continue;let d=W.computeSelectionKey(c,u);a.add(d);let f=r[d],p=f&&!f.deleted&&f.x===u.x&&f.y===u.y&&f.w===u.width&&f.h===u.height&&(f.angle||0)===(u.angle||0),g=f&&!f.deleted&&f.author!==e&&f.ts>o;if(!p&&!g?(v.setSelection(this.doc,t,d,{x:u.x,y:u.y,width:u.width,height:u.height,angle:u.angle||0,photo:c},e),this.vault.appliedSelectionKeys.add(d)):p&&this.vault.appliedSelectionKeys.add(d),u.metadata){let y=v.getSelectionMeta(this.doc,t,d);for(let[m,_]of Object.entries(u.metadata)){if(m==="id")continue;let S="",k="http://www.w3.org/2001/XMLSchema#string";typeof _=="object"&&_!==null?(S=_.text||"",k=_.type||k):_!=null&&(S=String(_));let N=y[m];!S&&!N||N&&(N.text===S&&N.type===k||N.author!==e&&N.ts>o)||v.setSelectionMeta(this.doc,t,d,m,{text:S,type:k},e)}}}}return a},pushTranscriptions(s,t,e,i){if(!this.options.syncTranscriptions)return new Set;let n=s.photo||[];Array.isArray(n)||(n=[n]);let r=new Set,o=v.getTranscriptions(this.doc,t),a=this._lastPushTs;for(let l of n){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.transcription||[];Array.isArray(h)||(h=[h]),h.forEach((d,f)=>{if(!d)return;let p=W.computeTranscriptionKey(c,f),g=d["@id"]||d.id,y=g?this.vault.getTxKey(g,p):p;r.add(y),this.vault.appliedTranscriptionKeys.add(y);let m=o[y];m&&!m.deleted&&m.text===(d.text||"")||m&&!m.deleted&&m.author!==e&&m.ts>a||v.setTranscription(this.doc,t,y,{text:d.text||"",data:d.data||null,photo:c},e)});let u=l.selection||[];Array.isArray(u)||(u=[u]);for(let d of u){if(!d)continue;let f=W.computeSelectionKey(c,d),p=d.transcription||[];Array.isArray(p)||(p=[p]),p.forEach((g,y)=>{if(!g)return;let m=W.computeTranscriptionKey(c,y,f),_=g["@id"]||g.id,S=_?this.vault.getTxKey(_,m):m;r.add(S),this.vault.appliedTranscriptionKeys.add(S);let k=o[S];k&&!k.deleted&&k.text===(g.text||"")||k&&!k.deleted&&k.author!==e&&k.ts>a||v.setTranscription(this.doc,t,S,{text:g.text||"",data:g.data||null,photo:c,selection:f},e)})}}return r},pushLists(s,t,e){let i=s.lists||[];if(!Array.isArray(i))return;let n=v.getLists(this.doc,t),r=this._lastPushTs;for(let o of i){let a=this._listNameCache.get(o)||this._listNameCache.get(String(o));if(!a){this._debug(`pushLists: skipping list ${o} (name not in cache)`);continue}let l=a,c=n[l];c&&!c.deleted&&c.member||c&&c.author!==e&&c.ts>r||v.setListMembership(this.doc,t,l,e)}},async _refreshListNameCache(){if(!this.options.syncLists)return;let s=Date.now();if(!(s-this._listCacheRefreshedAt<5e3))try{let t=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(t)){this._listNameCache.clear();for(let e of t)e.id&&e.name&&(this._listNameCache.set(e.id,e.name),this._listNameCache.set(String(e.id),e.name));this._listCacheRefreshedAt=s}}catch(t){this.logger.warn("Failed to refresh list name cache",{error:t.message})}},_computeItemKeys(s,t){let e=new Set,i=new Set,n=new Set,r=new Set,o=new Set,a=s.photo||[];Array.isArray(a)||(a=[a]);for(let c of a){let h=c.checksum||t.get(c["@id"]||c.id),u=c.note||[];Array.isArray(u)||(u=[u]);for(let p of u){if(!p)continue;let g=p["@value"]||p.text||p["https://schema.org/text"]||"",y=p.html||p["https://tropy.org/v1/tropy#html"]||"";if(typeof g=="object"&&(g=g["@value"]||""),typeof y=="object"&&(y=y["@value"]||""),!this._isSyncedNote(g,y)&&(g||y)){let m=W.computeNoteKey({text:g,html:y,photo:c["@id"]||c.id},h),_=p["@id"]||p.id,S=_?this.vault.getNoteKey(_,m):m;e.add(S)}}let d=c.transcription||[];Array.isArray(d)||(d=[d]),d.forEach((p,g)=>{if(!p)return;let y=W.computeTranscriptionKey(h,g),m=p["@id"]||p.id,_=m?this.vault.getTxKey(m,y):y;n.add(_)});let f=c.selection||[];Array.isArray(f)||(f=[f]);for(let p of f){if(!p||!h)continue;let g=W.computeSelectionKey(h,p);i.add(g);let y=p.note||[];Array.isArray(y)||(y=[y]);for(let _ of y){if(!_)continue;let S=_["@value"]||_.text||_["https://schema.org/text"]||"",k=_.html||_["https://tropy.org/v1/tropy#html"]||"";if(typeof S=="object"&&(S=S["@value"]||""),typeof k=="object"&&(k=k["@value"]||""),!this._isSyncedNote(S,k)&&(S||k)){let N=W.computeNoteKey({text:S,html:k,selection:p["@id"]||p.id},h),Vt=_["@id"]||_.id,de=Vt?this.vault.getNoteKey(Vt,N):N;r.add(`${g}:${de}`)}}let m=p.transcription||[];Array.isArray(m)||(m=[m]),m.forEach((_,S)=>{if(!_)return;let k=W.computeTranscriptionKey(h,S,g),N=_["@id"]||_.id,Vt=N?this.vault.getTxKey(N,k):k;n.add(Vt)})}}let l=s.lists||[];if(Array.isArray(l))for(let c of l){let h=this._listNameCache.get(c)||this._listNameCache.get(String(c));h&&o.add(h)}return{noteKeys:e,selectionKeys:i,transcriptionKeys:n,selectionNoteKeys:r,listNames:o}},saveItemSnapshot(s,t,e,i){let n=Array.from(this._resolveTagNames(s));if(i&&i.noteKeys&&i.selectionKeys&&i.transcriptionKeys){let r=this._resolveListNames(s);this.previousSnapshot.set(t,{tags:n,noteKeys:i.noteKeys.noteKeys,selectionNoteKeys:i.noteKeys.selectionNoteKeys,selectionKeys:i.selectionKeys,transcriptionKeys:i.transcriptionKeys,listNames:r})}else{let r=this._computeItemKeys(s,e);this.previousSnapshot.set(t,{tags:n,...r})}},_resolveListNames(s){let t=new Set,e=s.lists||[];if(Array.isArray(e))for(let i of e){let n=this._listNameCache.get(i)||this._listNameCache.get(String(i));n&&t.add(n)}return t},_resolveTagNames(s){return new Set((s.tag||[]).map(t=>typeof t=="string"?t:t.name||"").filter(Boolean))},pushDeletions(s,t,e,i,n){if(!this.options.syncDeletions)return;let r=this.previousSnapshot.get(t);if(!r)return;if(this.options.syncTags){let a=this._resolveTagNames(s);for(let l of r.tags)a.has(l)||v.removeTag(this.doc,t,l,e)}let o;if(n&&n.noteKeys&&n.selectionKeys&&n.transcriptionKeys){let a=this._resolveListNames(s);o={noteKeys:n.noteKeys.noteKeys,selectionNoteKeys:n.noteKeys.selectionNoteKeys,selectionKeys:n.selectionKeys,transcriptionKeys:n.transcriptionKeys,listNames:a}}else o=this._computeItemKeys(s,i);if(this.options.syncNotes&&r.noteKeys)for(let a of r.noteKeys)o.noteKeys.has(a)||v.removeNote(this.doc,t,a,e);if(this.options.syncSelections&&r.selectionKeys)for(let a of r.selectionKeys)o.selectionKeys.has(a)||v.removeSelection(this.doc,t,a,e);if(this.options.syncTranscriptions&&r.transcriptionKeys)for(let a of r.transcriptionKeys)o.transcriptionKeys.has(a)||v.removeTranscription(this.doc,t,a,e);if(this.options.syncNotes&&r.selectionNoteKeys){for(let a of r.selectionNoteKeys)if(!o.selectionNoteKeys.has(a)){let l=a.indexOf(":");if(l>0){let c=a.slice(0,l),h=a.slice(l+1);v.removeSelectionNote(this.doc,t,c,h,e)}}}if(r.listNames&&this.options.syncLists)for(let a of r.listNames)o.listNames.has(a)||v.removeListMembership(this.doc,t,a,e)},_isSyncedNote(s,t){return t?!!(t.includes("<blockquote><p><em>troparcel:")||t.includes("<p><strong>[troparcel:")):!1},pushItems(s){if(!this.doc)return;let t=this._stableUserId;this._lastPushTs=this.lastSync?this.lastSync.getTime():0,this.doc.transact(()=>{for(let e of s){let i=W.computeIdentity(e);if(!i)continue;let n=W.buildPhotoChecksumMap(e);this.pushMetadata(e,i,t),this.pushTags(e,i,t),this.pushNotes(e,i,t,n),this.pushPhotoMetadata(e,i,t),this.pushSelections(e,i,t,n),this.pushTranscriptions(e,i,t,n),this.options.syncLists&&this.pushLists(e,i,t)}},this.LOCAL_ORIGIN)}}});var fc=E((cg,dc)=>{"use strict";var Qf=new Set(["p","br","em","i","strong","b","u","s","a","ul","ol","li","blockquote","hr","h1","h2","h3","h4","h5","h6","code","pre","sup","sub","span","div"]),tp=new Set(["script","style","iframe","object","embed","form","input","textarea","select","button","link","meta","base","applet","math","svg","template","noscript","xmp","listing","plaintext","noembed","noframes"]),hc={a:new Set(["href","title"]),"*":new Set(["class","style"])},ep={"text-decoration":new Set(["underline","overline","line-through","none"]),"text-align":new Set(["left","right","center","justify","end","start"])},sp=new Set(["http:","https:","mailto:"]);function ip(s){if(!s||typeof s!="string")return"";let t="",e=0,i=s.length;for(;e<i;){let n=s.indexOf("<",e);if(n===-1){t+=s.slice(e);break}if(n>e&&(t+=s.slice(e,n)),s.slice(n,n+4)==="<!--"){let u=s.indexOf("-->",n+4);e=u===-1?i:u+3;continue}let r=np(s,n);if(!r){t+="&lt;",e=n+1;continue}let{tagName:o,isClosing:a,isSelfClosing:l,attrs:c,end:h}=r;if(tp.has(o)&&!a){let u="</"+o,d=h,f=-1;for(;d<i;){let p=s.indexOf("</",d);if(p===-1)break;let g=s.slice(p+2,p+2+o.length+1);if(g.toLowerCase().startsWith(o)&&(g[o.length]===">"||/\s/.test(g[o.length]))){f=p;break}d=p+2}if(f!==-1){let p=s.indexOf(">",f);e=p===-1?i:p+1}else e=i;continue}if(!Qf.has(o)){e=h;continue}if(a)t+=`</${o}>`;else{let u=rp(c,o);t+=`<${o}${u}${l?" /":""}>`}e=h}return t}function np(s,t){let e=t+1,i=s.length;if(e>=i)return null;let n=!1;if(s[e]==="/"&&(n=!0,e++),e>=i||!/[a-zA-Z]/.test(s[e]))return null;let r=e;for(;e<i&&/[a-zA-Z0-9]/.test(s[e]);)e++;if(e-r>32)return null;let o=s.slice(r,e).toLowerCase();if(!o)return null;let a=[];if(n)for(;e<i&&s[e]!==">";)e++;else for(;e<i;){for(;e<i&&/\s/.test(s[e]);)e++;if(e>=i||s[e]===">"||s[e]==="/"&&e+1<i&&s[e+1]===">")break;let c=e;for(;e<i&&/[a-zA-Z0-9_\-:]/.test(s[e]);)e++;let h=s.slice(c,e).toLowerCase();if(!h){e++;continue}for(;e<i&&/\s/.test(s[e]);)e++;let u="";if(e<i&&s[e]==="="){for(e++;e<i&&/\s/.test(s[e]);)e++;if(e<i&&(s[e]==='"'||s[e]==="'")){let d=s[e];e++;let f=e;for(;e<i&&s[e]!==d;)e++;u=s.slice(f,e),e<i&&e++}else{let d=e;for(;e<i&&!/[\s>]/.test(s[e]);)e++;u=s.slice(d,e)}}a.push({name:h,value:u})}let l=!1;if(e<i&&s[e]==="/"&&(l=!0,e++),e<i&&s[e]===">")e++;else{let c=s.indexOf(">",e);e=c===-1?i:c+1}return{tagName:o,isClosing:n,isSelfClosing:l,attrs:a,end:e}}function rp(s,t){let e=hc[t]||new Set,i=hc["*"]||new Set,n="";for(let{name:r,value:o}of s){if(r.startsWith("on")||r.startsWith("data-")||!e.has(r)&&!i.has(r))continue;let a=ap(o);if(!(r==="href"&&(a=cp(a),!a))){if(r==="style"){let l=lp(a);if(!l)continue;n+=` style="${uc(l)}"`;continue}n+=` ${r}="${uc(a)}"`}}return n}var op={lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};function ap(s){return s.replace(/&(?:#x([0-9a-fA-F]+)|#(\d+)|(lt|gt|amp|quot|apos));/g,(t,e,i,n)=>{if(e){let r=parseInt(e,16);return r>0&&r<1114111?String.fromCodePoint(r):""}if(i){let r=parseInt(i,10);return r>0&&r<1114111?String.fromCodePoint(r):""}return op[n]})}function lp(s){if(!s)return"";let t=[];for(let e of s.split(";")){let i=e.trim();if(!i)continue;let n=i.indexOf(":");if(n<0)continue;let r=i.slice(0,n).trim().toLowerCase(),o=i.slice(n+1).trim().toLowerCase(),a=ep[r];a&&a.has(o)&&t.push(`${r}: ${o}`)}return t.join("; ")}function cp(s){if(!s)return"";let t=s.trim().replace(/[\x00-\x1f\x7f]/g,"");if(t=t.replace(/\s+/g,""),t.startsWith("//"))return"";if(t.startsWith("/")||t.startsWith("#")||t.startsWith("?"))return t;try{let e=new URL(t);return sp.has(e.protocol)?t:""}catch{return/^[a-z][a-z0-9+.-]*:/i.test(t)?"":t}}function uc(s){return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function hp(s){return!s||typeof s!="string"?"":s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}dc.exports={sanitizeHtml:ip,escapeHtml:hp}});var gc=E((hg,pc)=>{"use strict";var Bi=Fe(),at=Mi(),{sanitizeHtml:Nr,escapeHtml:Pe}=fc();pc.exports={_writeDelay(){return this.adapter?Promise.resolve():new Promise(s=>setTimeout(s,this.options.writeDelay))},_applyStrikethrough(s){return s.replace(/(<(?:p|li|h[1-6])>)/gi,'$1<span style="text-decoration: line-through">').replace(/(<\/(?:p|li|h[1-6])>)/gi,"</span>$1")},async applyRemoteAnnotations(s,t,e,i){let n=t.localId,r=this._stableUserId;this._debug(`applyAnnotations: item ${n}, identity ${s.slice(0,8)}...`);let o=this._applyStats,a=o?o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted:0;await this.applyMetadata(s,n,r,t.item),await this._writeDelay(),await this.applyTags(s,n,r,e,t.item),await this._writeDelay(),await this.applyNotes(s,t,r),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applyPhotoMetadata(s,t,r),await this._writeDelay()),await this.applySelections(s,t,r),await this._writeDelay(),await this.applySelectionNotes(s,t,r),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applySelectionMetadata(s,t,r),await this._writeDelay()),await this.applyTranscriptions(s,t,r),this.options.syncLists&&(await this._writeDelay(),await this.applyLists(s,t,r,i)),o&&(o.itemsProcessed++,o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted>a&&o.itemsChanged++)},async applyMetadata(s,t,e,i){if(!this.options.syncMetadata)return;let n=at.getMetadata(this.doc,s),r=this.lastSync?this.lastSync.getTime():0,o={};for(let[l,c]of Object.entries(n)){if(c.author===e)continue;let h=i[l];h!=null&&((typeof h=="object"?h["@value"]||h.text||"":String(h))===(c.text||"")||c.ts&&c.ts<r)||(o[l]={text:c.text,type:c.type})}let a=Object.keys(o);if(a.length>0)try{await this.api.saveMetadata(t,o),this._applyStats&&(this._applyStats.metadataUpdated+=a.length),this._debug(`metadata: ${a.length} field(s) on item ${t}`)}catch(l){this.logger.warn(`Failed to save metadata batch on ${t}`,{error:l.message})}},async applyTags(s,t,e,i,n){if(!this.options.syncTags)return;let r=new Set,o=n.tag||[];for(let c of o)c&&c.name&&r.add(c.name);let a=at.getActiveTags(this.doc,s);for(let c of a){if(c.author===e||r.has(c.name))continue;let h=i.get(c.name);if(!h)try{let u=await this.api.createTag(c.name,c.color,[t]);r.add(c.name),u&&(u.id||u.tag_id)&&i.set(c.name,u),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag created: "${c.name}" on item ${t}`);continue}catch(u){this.logger.warn(`Failed to create tag "${c.name}"`,{error:u.message});continue}try{await this.api.addTagsToItem(t,[h.id||h.tag_id]),r.add(c.name),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag added: "${c.name}" on item ${t}`)}catch(u){this.logger.warn(`Failed to add tag "${c.name}" to item ${t}`,{error:u.message})}}if(!this.options.syncDeletions)return;let l=at.getDeletedTags(this.doc,s);for(let c of l){if(c.author===e||!r.has(c.name))continue;let h=i.get(c.name);if(h)try{await this.api.removeTagsFromItem(t,[h.id||h.tag_id])}catch(u){this.logger.warn(`Failed to remove tag "${c.name}" from item ${t}`,{error:u.message})}}},_buildExistingNoteTexts(s){let t=new Set;for(let e of s){if(e&&e.text){t.add(e.text.trim());let i=e.text.replace(/^troparcel:\s*[^\n]*\n?/,"").replace(/^\[(?:troparcel:)?[^\]]{1,80}\]\s*/,"").trim();i&&t.add(i)}if(e&&e.html){t.add(e.html.trim());let i=e.html.replace(/^<blockquote><p><em>troparcel:[^<]*<\/em><\/p><\/blockquote>/,"").replace(/^<p><strong>\[[^\]]*\]<\/strong><\/p>/,"").trim();i&&t.add(i)}}return t},async _applyRemoteNote(s,t,e,i,n,r){let o=t.html?Nr(t.html):`<p>${Pe(t.text)}</p>`;if(o=`<blockquote><p><em>troparcel: ${Pe(t.author||"unknown")}</em></p></blockquote>${o}`,i.has(o.trim()))return this.vault.appliedNoteKeys.add(s),this._applyStats&&this._applyStats.notesDeduped++,!1;let l=this.vault.getLocalNoteId(s);if(l)try{if(this.adapter){let c=await this.adapter.updateNote(l,{html:o});c&&(c.id||c["@id"])&&(this.vault.appliedNoteKeys.add(s),this.vault.mapAppliedNote(s,c.id||c["@id"]))}else await this.api.updateNote(l,{html:o}),this.vault.appliedNoteKeys.add(s);return this._applyStats&&this._applyStats.notesUpdated++,this._debug(`${r} updated: ${s.slice(0,8)}`),!0}catch(c){this.logger.warn(`${r} update failed for ${s.slice(0,8)}, falling through to create`,{error:String(c.message||c)})}try{let c,h={html:o,language:t.language,photo:e.photo||null,selection:e.selection||null};if(this.adapter?c=await this.adapter.createNote(h):c=await this.api.createNote(h),c&&(c.id||c["@id"]))return this.vault.mapAppliedNote(s,c.id||c["@id"]),this.vault.appliedNoteKeys.add(s),i.add(o.trim()),this._applyStats&&this._applyStats.notesCreated++,this._debug(`${r} created: ${s.slice(0,8)} by ${t.author}`),!0;this.logger.warn({...e,noteKey:s.slice(0,8),author:t.author},`${r}.create returned null`),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}catch(c){this.logger.warn(`Failed to create ${r}`,{error:c.message,...e,noteKey:s.slice(0,8)}),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}return!1},async applyNotes(s,t,e){if(!this.options.syncNotes)return;let i=t.localId,n=t.item.photo||[];Array.isArray(n)||(n=[n]);let r=[];for(let h of n)for(let u of h.note||[])r.push(u);let o=this._buildExistingNoteTexts(r),a=at.getNotes(this.doc,s),l={},c={};for(let[h,u]of Object.entries(a))u.deleted?c[h]=u:l[h]=u;for(let[h,u]of Object.entries(l)){if(u.author===e||!u.html&&!u.text)continue;if(this.vault.appliedNoteKeys.has(h)){let f=this.vault.getLocalNoteId(h);if(f&&this.adapter)if(!this.adapter._getState().notes[f])this.vault.appliedNoteKeys.delete(h),this._debug(`note ${h.slice(0,8)}: local note ${f} deleted, allowing re-apply`);else continue;else continue}let d=null;if(u.photo){for(let f of n)if(f.checksum===u.photo){d=f["@id"]||f.id;break}if(!d)continue}else if(d=n[0]&&(n[0]["@id"]||n[0].id),!d)continue;await this._applyRemoteNote(h,u,{photo:Number(d)||null},o,e,"note")}for(let[h,u]of Object.entries(c)){if(u.author===e)continue;let d=this.vault.getLocalNoteId(h);if(!d)continue;let f=Pe(u.author||"unknown"),p=u.html?Nr(u.html):u.text?`<p>${Pe(u.text)}</p>`:"",g=`<blockquote><p><em>troparcel: ${f} [retracted]</em></p></blockquote>${this._applyStrikethrough(p)}`;try{let y=!1;if(this.adapter){let m=await this.adapter.updateNote(d,{html:g});m&&(m.id||m["@id"])&&(this.vault.mapAppliedNote(h,m.id||m["@id"]),y=!0)}else this._debug(`note retraction skipped (no adapter) for ${h.slice(0,8)}`),this.vault.appliedNoteKeys.add(h);y&&(this.vault.appliedNoteKeys.add(h),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`note retracted: ${h.slice(0,8)} by ${u.author}`))}catch(y){this.logger.warn(`Failed to retract note ${h.slice(0,8)}`,{error:String(y.message||y)})}}},async applyPhotoMetadata(s,t,e){let i=t.item.photo||[];Array.isArray(i)||(i=[i]);let n=this.lastSync?this.lastSync.getTime():0;for(let r of i){let o=r.checksum,a=r["@id"]||r.id;if(!o||!a)continue;let l=at.getPhotoMetadata(this.doc,s,o),c=r.metadata||{},h={};for(let[d,f]of Object.entries(l)){if(f.author===e)continue;let p=c[d];p!=null&&((typeof p=="object"?p["@value"]||p.text||"":String(p))===(f.text||"")||f.ts&&f.ts<n)||(h[d]={text:f.text,type:f.type})}let u=Object.keys(h);if(u.length>0)try{await this.api.saveMetadata(a,h),this._applyStats&&(this._applyStats.metadataUpdated+=u.length)}catch(d){this.logger.warn("Failed to save photo metadata batch",{error:d.message})}}},async applySelections(s,t,e){if(!this.options.syncSelections)return;let i=at.getActiveSelections(this.doc,s),n=t.item.photo||[];Array.isArray(n)||(n=[n]);let r=new Set;for(let o of n){if(!o.checksum)continue;let a=o.selection||[];Array.isArray(a)||(a=[a]);for(let l of a)l&&r.add(Bi.computeSelectionKey(o.checksum,l))}for(let[o,a]of Object.entries(i)){if(a.author===e||this.vault.appliedSelectionKeys.has(o))continue;let l=Number(a.x),c=Number(a.y),h=Number(a.w),u=Number(a.h);if(!Number.isFinite(l)||!Number.isFinite(c)||!Number.isFinite(h)||!Number.isFinite(u)||h<=0||u<=0){this._log(`Skipping selection ${o}: invalid coordinates`,{x:l,y:c,w:h,h:u});continue}let d=null;for(let p of n)if(p.checksum===a.photo){d=p["@id"]||p.id;break}if(!d)continue;if(r.has(o))this.vault.appliedSelectionKeys.add(o);else try{this.adapter?await this.adapter.createSelection({photo:Number(d),x:l,y:c,width:h,height:u,angle:a.angle||0}):await this.api.createSelection({photo:Number(d),x:l,y:c,width:h,height:u,angle:a.angle||0}),this.vault.appliedSelectionKeys.add(o),this._applyStats&&this._applyStats.selectionsCreated++,this._debug(`selection created: ${o.slice(0,8)} on photo ${d}`)}catch(p){this.logger.warn(`Failed to create selection on photo ${d}`,{error:p.message})}}},async applySelectionNotes(s,t,e){if(!this.options.syncNotes)return;let i=t.item.photo||[];Array.isArray(i)||(i=[i]);let n=at.getAllSelectionNotes(this.doc,s),r=new Map;for(let[o,a]of Object.entries(n)){if(!a.deleted)continue;let l=o.indexOf(":");if(l>0){let c=o.slice(0,l);r.has(c)||r.set(c,[]),r.get(c).push([o,a])}}for(let o of i){let a=o.checksum;if(!a)continue;let l=o.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=this._buildExistingNoteTexts(c.note||[]),u=Bi.computeSelectionKey(a,c),d=at.getSelectionNotes(this.doc,s,u);for(let[p,g]of Object.entries(d)){if(g.author===e||!g.html&&!g.text)continue;if(this.vault.appliedNoteKeys.has(p)){let m=this.vault.getLocalNoteId(p);if(m&&this.adapter)if(!this.adapter._getState().notes[m])this.vault.appliedNoteKeys.delete(p),this._debug(`sel note ${p.slice(0,8)}: local note ${m} deleted, allowing re-apply`);else continue;else continue}let y=c["@id"]||c.id;y&&await this._applyRemoteNote(p,g,{selection:Number(y)||null},h,e,"sel note")}let f=r.get(u)||[];for(let[p,g]of f){if(g.author===e)continue;let y=this.vault.getLocalNoteId(p);if(!y)continue;let m=Pe(g.author||"unknown"),_=g.html?Nr(g.html):g.text?`<p>${Pe(g.text)}</p>`:"",S=`<blockquote><p><em>troparcel: ${m} [retracted]</em></p></blockquote>${this._applyStrikethrough(_)}`;try{let k=!1;if(this.adapter){let N=await this.adapter.updateNote(y,{html:S});N&&(N.id||N["@id"])&&(this.vault.mapAppliedNote(p,N.id||N["@id"]),k=!0)}else this._debug(`sel note retraction skipped (no adapter) for ${p.slice(0,8)}`),this.vault.appliedNoteKeys.add(p);k&&(this.vault.appliedNoteKeys.add(p),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`sel note retracted: ${p.slice(0,8)} by ${g.author}`))}catch(k){this.logger.warn(`Failed to retract sel note ${p.slice(0,8)}`,{error:String(k.message||k)})}}}}},async applySelectionMetadata(s,t,e){let i=t.item.photo||[];Array.isArray(i)||(i=[i]);let n=this.lastSync?this.lastSync.getTime():0;for(let r of i){let o=r.checksum;if(!o)continue;let a=r.selection||[];Array.isArray(a)||(a=[a]);for(let l of a){if(!l)continue;let c=Bi.computeSelectionKey(o,l),h=l["@id"]||l.id;if(!h)continue;let u=at.getSelectionMeta(this.doc,s,c),d=l.metadata||{},f={};for(let[g,y]of Object.entries(u)){if(y.author===e)continue;let m=d[g];m!=null&&((typeof m=="object"?m["@value"]||m.text||"":String(m))===(y.text||"")||y.ts&&y.ts<n)||(f[g]={text:y.text,type:y.type})}let p=Object.keys(f);if(p.length>0)try{await this.api.saveMetadata(h,f),this._applyStats&&(this._applyStats.metadataUpdated+=p.length)}catch(g){this.logger.warn("Failed to save selection metadata",{error:g.message})}}}},async applyTranscriptions(s,t,e){if(!this.options.syncTranscriptions)return;let i=at.getActiveTranscriptions(this.doc,s),n=t.item.photo||[];Array.isArray(n)||(n=[n]);let r=new Map,o=new Map;for(let a of n)if(a.checksum){r.set(a.checksum,a["@id"]||a.id);let l=a.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=Bi.computeSelectionKey(a.checksum,c);o.set(h,c["@id"]||c.id)}}for(let[a,l]of Object.entries(i)){if(l.author===e||!l.text&&!l.data||this.vault.appliedTranscriptionKeys.has(a))continue;let c=r.get(l.photo)||null;if(!c)continue;let h=l.selection&&o.get(l.selection)||null,u=this.vault.getLocalTxId(a);if(u)try{let d=null;try{d=await this.api.getTranscription(u)}catch{}try{await this.api.deleteTranscription(u)}catch(p){this.logger.warn(`Failed to delete transcription ${u}`,{error:String(p.message||p)})}let f=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});if(f&&(f.id||f["@id"]))this.vault.mapAppliedTranscription(a,f.id||f["@id"]),this.vault.appliedTranscriptionKeys.add(a);else if(d){this.logger.warn(`Transcription update returned null for ${a.slice(0,8)}, restoring original`);try{let p=await this.api.createTranscription({text:d.text||"",data:d.data||null,photo:Number(c)||null,selection:h?Number(h):null});p&&(p.id||p["@id"])&&this.vault.mapAppliedTranscription(a,p.id||p["@id"])}catch(p){this.logger.warn(`Transcription restore also failed for ${a.slice(0,8)}`,{error:String(p.message||p)})}}continue}catch(d){this.logger.warn(`Failed to update transcription ${a.slice(0,8)}`,{error:String(d.message||d)})}try{let d=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});d&&(d.id||d["@id"])&&(this.vault.mapAppliedTranscription(a,d.id||d["@id"]),this.vault.appliedTranscriptionKeys.add(a),this._applyStats&&this._applyStats.transcriptionsCreated++,this._debug(`transcription created: ${a.slice(0,8)} by ${l.author}`))}catch(d){this.logger.warn("Failed to create transcription",{error:d.message})}}},async applyLists(s,t,e,i){let n=at.getActiveLists(this.doc,s),r=t.localId,o=new Set;for(let a of t.item.lists||[]){let l=this._listNameCache.get(a)||this._listNameCache.get(String(a));l&&o.add(l)}for(let[a,l]of Object.entries(n)){if(l.author===e||o.has(a))continue;let c=i.get(a);if(c)try{this.adapter?await this.adapter.addItemsToList(c.id,[r]):await this.api.addItemsToList(c.id,[r]),o.add(a),this._applyStats&&this._applyStats.listsAdded++,this._debug(`list add: item ${r} \u2192 "${a}"`)}catch(h){this.logger.warn(`Failed to add item ${r} to list "${a}"`,{error:h.message})}}if(this.options.syncDeletions){let a=this.lastSync?this.lastSync.getTime():0,l=at.getLists(this.doc,s);for(let[c,h]of Object.entries(l)){if(!h.deleted||h.author===e||h.ts&&h.ts<=a)continue;let u=i.get(c);if(u)try{this.adapter?await this.adapter.removeItemsFromList(u.id,[r]):await this.api.removeItemsFromList(u.id,[r])}catch(d){this.logger.warn(`Failed to remove item ${r} from list "${c}"`,{error:d.message})}}}}}});var yc=E((dg,mc)=>{"use strict";var ug=Fe();mc.exports={async _enrichAll(s){let t=[],e=5;for(let i=0;i<s.length;i+=e){let n=s.slice(i,i+e),r=await Promise.all(n.map(o=>this.enrichItem(o).catch(a=>(this.logger.warn(`Failed to enrich item ${o.id}`,{error:a.message}),null))));for(let o of r)o&&t.push(o)}return t},async enrichItem(s){let t={"@id":s.id,template:s.template,lists:s.lists||[]},[e,i]=await Promise.all([this.api.getMetadata(s.id).catch(()=>null),this.api.getItemTags(s.id).catch(()=>null)]);if(e)for(let[o,a]of Object.entries(e))o!=="id"&&(typeof a=="object"&&a!==null?t[o]={"@value":a.text||"","@type":a.type||""}:a!=null&&(t[o]=a));i&&Array.isArray(i)&&(t.tag=i.map(o=>({id:o.id||o.tag_id,name:o.name,color:o.color||null}))),t.photo=[];let n=s.photos||[],r=await Promise.all(n.map(o=>this.api.getPhoto(o).catch(()=>null)));for(let o of r){if(!o)continue;let a={"@id":o.id,checksum:o.checksum,note:[],selection:[],transcription:[],metadata:null},l=[];this.options.syncPhotoAdjustments&&l.push(this.api.getMetadata(o.id).catch(()=>null).then(d=>{a.metadata=d}));let c=o.notes||[];for(let d of c)l.push(this.api.getNote(d,"html").catch(()=>null).then(f=>{f!=null&&a.note.push({"@id":d,text:typeof f=="string"?f.replace(/<[^>]*>/g,""):"",html:typeof f=="string"?f:"",language:null,photo:o.id})}));let h=o.selections||[];for(let d of h)l.push(this._enrichSelection(d,o.checksum).then(f=>{f&&a.selection.push(f)}));let u=o.transcriptions||[];for(let d of u)l.push(this.api.getTranscription(d,"json").catch(()=>null).then(f=>{f&&a.transcription.push(f)}));await Promise.all(l),t.photo.push(a)}return t},async _enrichSelection(s,t){try{let e=await this.api.getSelection(s);if(!e)return null;let i={"@id":e.id,x:e.x,y:e.y,width:e.width,height:e.height,angle:e.angle||0,note:[],metadata:null,transcription:[]},n=[];n.push(this.api.getMetadata(s).catch(()=>null).then(a=>{i.metadata=a}));let r=e.notes||[];for(let a of r)n.push(this.api.getNote(a,"html").catch(()=>null).then(l=>{l!=null&&i.note.push({"@id":a,text:typeof l=="string"?l.replace(/<[^>]*>/g,""):"",html:typeof l=="string"?l:"",language:null,selection:e.id})}));let o=e.transcriptions||[];for(let a of o)n.push(this.api.getTranscription(a,"json").catch(()=>null).then(l=>{l&&i.transcription.push(l)}));return await Promise.all(n),i}catch(e){return this.logger.warn("Failed to enrich selection",{error:String(e)}),null}}}});var bc=E((fg,_c)=>{"use strict";var up=require("fs"),wc=require("os"),dp=(Ts(),Us(ks)),{WebsocketProvider:fp}=(el(),Us(tl)),pp=Vl(),{ApiClient:gp}=Kl(),{StoreAdapter:mp}=zl(),bt=Fe(),q=Mi(),{BackupManager:yp}=ic(),{SyncVault:wp}=ac(),Ke=class{constructor(t,e,i=null){this.options=t,this.logger=e,this.debug=t.debug===!0,this.doc=null,this.provider=null,this.api=new gp(t.apiPort,e),this.adapter=i?new mp(i,e):null,this.backup=null,this.localIndex=new Map,this.previousSnapshot=new Map,this.safetyNetTimer=null,this.heartbeatTimer=null,this.unsubscribe=null,this._storeUnsubscribe=null,this.fileWatcher=null,this.projectPath=null,this.state="idle",this.lastSync=null,this.peerCount=0,this._syncing=!1,this._paused=!1,this._consecutiveErrors=0,this._localDebounceTimer=null,this._remoteDebounceTimer=null,this._pendingRemoteIdentities=new Set,this.vault=new wp,this.vault.loadFromFile(this.options.room),this._applyFailureCount=0,this._failedNoteKeys=new Set,this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._stopping=!1,this._remoteAnnotationsDirty=!0,this._syncLock=Promise.resolve(),this._lastWatcherEvent=0,this._watcherHealthTimer=null,this.LOCAL_ORIGIN="troparcel-local",this._listNameCache=new Map,this._listCacheRefreshedAt=0,this._stableUserId=t.userId||`${wc.userInfo().username}@${wc.hostname()}:${t.apiPort||2019}`}_log(t,e){e?this.logger.info(e,`[troparcel] ${t}`):this.logger.info(`[troparcel] ${t}`)}_debug(t,e){this.debug&&(e?this.logger.info(e,`[troparcel:debug] ${t}`):this.logger.info(`[troparcel:debug] ${t}`))}_formatAge(t){let e=Math.floor((Date.now()-t.getTime())/1e3);return e<60?`${e}s ago`:e<3600?`${Math.floor(e/60)}m ago`:`${Math.floor(e/3600)}h ${Math.floor(e%3600/60)}m ago`}_resetApplyStats(){this._applyStats={notesCreated:0,notesDeduped:0,notesUpdated:0,notesRetracted:0,notesFailed:0,tagsAdded:0,tagsDeduped:0,selectionsCreated:0,selectionsDeduped:0,metadataUpdated:0,transcriptionsCreated:0,listsAdded:0,itemsProcessed:0,itemsChanged:0}}_logApplyStats(){let t=this._applyStats;if(!t)return;let e=[];t.notesCreated&&e.push(`${t.notesCreated} notes created`),t.notesUpdated&&e.push(`${t.notesUpdated} notes updated`),t.notesRetracted&&e.push(`${t.notesRetracted} notes retracted`),t.tagsAdded&&e.push(`${t.tagsAdded} tags added`),t.selectionsCreated&&e.push(`${t.selectionsCreated} selections created`),t.metadataUpdated&&e.push(`${t.metadataUpdated} metadata fields`),t.transcriptionsCreated&&e.push(`${t.transcriptionsCreated} transcriptions`),t.listsAdded&&e.push(`${t.listsAdded} list memberships`),t.notesFailed&&e.push(`${t.notesFailed} notes failed`),e.length>0?this._log(`applied: ${e.join(", ")} across ${t.itemsChanged}/${t.itemsProcessed} items`):this._debug(`applied: nothing changed across ${t.itemsProcessed} items`)}readAllItemsFull(){return this.adapter?this.adapter.getAllItemsFull():[]}_acquireLock(){let t,e=this._syncLock;return this._syncLock=new Promise(i=>{t=i}),e.then(()=>t)}async start(t={}){if(!(this.state==="connected"||this.state==="connecting")){this.state="connecting",this.logger.info({server:this.options.serverUrl,room:this.options.room,syncMode:this.options.syncMode},"Sync engine v4.11 starting");try{this.doc=new dp.Doc,q.registerUser(this.doc,this.doc.clientID,this._stableUserId);let e=pp;if(this.provider=new fp(this.options.serverUrl,this.options.room,this.doc,{connect:!0,params:this.options.roomToken?{token:this.options.roomToken}:{},maxBackoffTime:1e4,resyncInterval:3e4,WebSocketPolyfill:e}),this.provider.on("status",r=>{r.status==="connected"?this.logger.info(`[troparcel] connected to ${this.options.serverUrl}`):r.status==="disconnected"&&this.logger.info("[troparcel] disconnected from server, reconnecting...")}),this.provider.on("connection-error",r=>{this.logger.warn(`[troparcel] connection error: ${r.message||String(r)} \u2014 check that the Troparcel server is running`)}),this.provider.on("connection-close",r=>{r.code!==1e3&&this.logger.info(`[troparcel] connection closed (code: ${r.code}${r.reason?", "+r.reason:""}), reconnecting...`)}),await this.waitForConnection(),this.backup=new yp(this.options.room,this.api,this.logger,{maxBackups:this.options.maxBackups,maxNoteSize:this.options.maxNoteSize,maxMetadataSize:this.options.maxMetadataSize,tombstoneFloodThreshold:this.options.tombstoneFloodThreshold}),this.options.syncMode==="auto"&&(this.unsubscribe=q.observeAnnotationsDeep(this.doc,r=>{this.handleRemoteChanges(r)},this.LOCAL_ORIGIN)),this._statusHandler=r=>{r.status==="connected"?(this.state="connected",this._log(`reconnected to room "${this.options.room}"`)):r.status==="disconnected"&&this.logger.warn("[troparcel] lost connection, will retry automatically")},this.provider.on("status",this._statusHandler),this.state="connected",this._log(`ready \u2014 room "${this.options.room}", client ${this.doc.clientID}`),!t.skipStartupDelay){let r=this.options.startupDelay;r>0&&await new Promise(o=>setTimeout(o,r))}if(this.options.clearTombstones&&this.purgeTombstones(),!t.skipInitialSync){await this.syncOnce();let o=q.getUsers(this.doc).filter(a=>a.clientID!==this.doc.clientID).length;this._log(`initial sync complete \u2014 ${this.localIndex.size} local items indexed, ${this.vault.annotationCount} shared items in CRDT, ${o} peer(s) online`)}this.options.autoSync&&!t.skipInitialSync&&await this.startWatching();let i=this.options.safetyNetInterval*1e3;i>0&&(this.safetyNetTimer=setInterval(()=>{this._scheduleSafetyNet()},i)),this.heartbeatTimer=setInterval(()=>{this.provider&&this.provider.wsconnected&&q.heartbeat(this.doc,this.doc.clientID)},3e4),this._statusLogCount=0;let n=this.debug?3e4:3e5;this._statusLogTimer=setInterval(()=>{if(this.state!=="connected")return;this._statusLogCount++;let o=(this.doc?q.getUsers(this.doc):[]).filter(a=>a.clientID!==this.doc?.clientID).length;this._log(`sync active \u2014 room "${this.options.room}", ${o} peer(s), ${this.localIndex.size} local / ${this.vault.annotationCount} shared items`+(this.lastSync?`, last sync ${this._formatAge(this.lastSync)}`:""))},n)}catch(e){throw this.state="error",this.logger.error({error:e.message,stack:e.stack},"Sync engine failed to start"),e}}}_scheduleSafetyNet(){if(this._consecutiveErrors>0){let e=1-1/Math.min(Math.pow(2,this._consecutiveErrors),16);if(Math.random()<e){this._log(`Safety-net skipped (backoff: ${this._consecutiveErrors} errors)`);return}}this.syncOnce()}async _persistVault(t=!1){if(!(!t&&!this.vault.isDirty))try{await this.vault.persistToFile(this.options.room)}catch(e){this.logger.warn("vault persist failed",{error:e.message})}}async stop(){if(this._stopping=!0,await this._persistVault(!0),this.logger.info("Sync engine stopping"),this._storeUnsubscribe&&(this._storeUnsubscribe(),this._storeUnsubscribe=null),this.stopWatching(),this.safetyNetTimer&&(clearInterval(this.safetyNetTimer),this.safetyNetTimer=null),this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this._statusLogTimer&&(clearInterval(this._statusLogTimer),this._statusLogTimer=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this._localDebounceTimer&&(clearTimeout(this._localDebounceTimer),this._localDebounceTimer=null),this._remoteDebounceTimer&&(clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.doc)try{q.deregisterUser(this.doc,this.doc.clientID)}catch(t){this._debug("Failed to deregister user",{error:t.message})}this.provider&&(this._statusHandler&&(this.provider.off("status",this._statusHandler),this._statusHandler=null),this.provider.destroy(),this.provider=null),this.doc&&(this.doc.destroy(),this.doc=null),this.localIndex.clear(),this.previousSnapshot.clear(),this._pendingRemoteIdentities.clear(),this._listNameCache.clear(),this.vault.clear(),this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._remoteAnnotationsDirty=!1,this.state="idle"}waitForConnection(){return new Promise((t,e)=>{if(this.provider.wsconnected){t();return}let i=r=>{r.status==="connected"&&(clearTimeout(n),this.provider.off("status",i),t())},n=setTimeout(()=>{this.provider.off("status",i),e(new Error("Connection timeout (15s)"))},15e3);this.provider.on("status",i)})}pause(){this._paused=!0,this._log("Sync paused")}resume(){this._paused=!1,this._log("Sync resumed")}async startWatching(){if(this.adapter){if(this._storeUnsubscribe)return;this._log("Using store.subscribe for change detection"),this._storeUnsubscribe=this.adapter.subscribe(()=>{this.handleLocalChange()});return}if(!this.fileWatcher){try{let t=await this.api.getProjectInfo();t&&t.project&&(this.projectPath=t.project,this._log(`Watching project file: ${this.projectPath}`))}catch(t){this._log("Could not get project path, file watching disabled",{error:t.message});return}this.projectPath&&(this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}}_startFileWatcher(){try{this.fileWatcher=up.watch(this.projectPath,{persistent:!1},t=>{t==="change"&&(this._lastWatcherEvent=Date.now(),this.handleLocalChange())}),this.fileWatcher.on("error",t=>{this._debug("File watcher error",{error:t.message}),this._restartFileWatcher()})}catch(t){this._debug("Could not start file watcher",{error:t.message})}}_restartFileWatcher(){if(this.fileWatcher){try{this.fileWatcher.close()}catch(t){this.logger.warn("Failed to close file watcher",{error:String(t.message||t)})}this.fileWatcher=null}this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this.projectPath&&(this._log("Restarting file watcher"),this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}_checkWatcherHealth(){if(!this.fileWatcher)return;Date.now()-this._lastWatcherEvent>5*60*1e3&&(this.logger.info("File watcher silent for >5min, restarting"),this._restartFileWatcher())}stopWatching(){this.fileWatcher&&(this.fileWatcher.close(),this.fileWatcher=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null)}handleLocalChange(){if(!this._paused&&!this._stopping){if(this._applyingRemote){this._queuedLocalChange=!0,this._debug("handleLocalChange: queued (applying remote)");return}this._debug("handleLocalChange: store change detected, debouncing"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this._debug("handleLocalChange: debounce fired"),this.syncOnce()},this.options.localDebounce)}}handleRemoteChanges(t){this._remoteAnnotationsDirty=!0;for(let e of t)this._pendingRemoteIdentities.add(e.identity);this._remoteDebounceTimer&&clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=setTimeout(()=>{this._remoteDebounceTimer=null,this.applyPendingRemote()},this.options.remoteDebounce)}async applyPendingRemote(){if(this._paused||this._pendingRemoteIdentities.size===0)return;if(this.localIndex.size===0){this._debug("applyPendingRemote: localIndex empty, deferring");return}let t=await this._acquireLock();try{let e=Array.from(this._pendingRemoteIdentities);this._pendingRemoteIdentities.clear();let i=null;try{i=this.adapter?this.adapter.getAllTags():await this.api.getTags()}catch(o){this.logger.warn("applyPendingRemote: failed to fetch tags",{error:String(o.message||o)})}let n=new Map;if(i&&Array.isArray(i))for(let o of i)n.set(o.name,o);let r=new Map;if(this.options.syncLists)try{let o=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(o))for(let a of o)r.set(a.name,a)}catch(o){this.logger.warn("applyPendingRemote: failed to fetch lists",{error:String(o.message||o)})}if(this.adapter){let o=this.readAllItemsFull();o.length>0&&(this.localIndex=bt.buildIdentityIndex(o))}await this._refreshListNameCache(),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();try{let o=new Set,a=new Set;for(let l of e){let c=bt.findLocalMatch(l,this.localIndex);if(c){if(a.add(l),o.add(c.localId),this.backup){let h=q.getItemSnapshot(this.doc,l);if(h){let u=this.backup.validateInbound(l,h,this._stableUserId);if(!u.valid){for(let d of u.warnings)this.logger.warn(`applyPendingRemote validation: ${d}`);continue}}}try{await this.applyRemoteAnnotations(l,c,n,r)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}for(let l of e){if(a.has(l))continue;let c=this._fuzzyMatchLocal(l);if(c&&!o.has(c.local.localId)){if(o.add(c.local.localId),this.backup){let h=q.getItemSnapshot(this.doc,l);if(h&&!this.backup.validateInbound(l,h,this._stableUserId).valid)continue}try{await this.applyRemoteAnnotations(l,c.local,n,r)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}finally{t()}}async syncOnce(){if(this.state!=="connected"||!this.doc||this._paused||this._stopping)return;if(this._syncing){this._syncRequested=!0;return}this._syncing=!0;let t=await this._acquireLock();if(this.state!=="connected"||!this.doc||this._paused||this._stopping){this._syncing=!1,t();return}let e=this.state;this.state="syncing";try{this._debug("syncOnce: starting cycle");let i;if(this.adapter){if(i=this.readAllItemsFull(),i.length===0){this._debug("syncOnce: no items in store"),this.state=e;return}this._debug(`syncOnce: got ${i.length} items from store`)}else{if(!await this.api.ping()){this._debug("syncOnce: API not reachable, skipping"),this.state=e;return}let l=await this.api.getItems();if(!l||!Array.isArray(l)){this._debug("syncOnce: no items from API"),this.state=e;return}this._debug(`syncOnce: got ${l.length} item summaries`),i=await this._enrichAll(l)}this.localIndex=bt.buildIdentityIndex(i),this._debug(`syncOnce: ${i.length} items, ${this.localIndex.size} identities`),await this._refreshListNameCache();let n=new Set,r=!1;if(this.options.syncMode==="auto"){let a=this.doc.getMap("annotations");if(this.vault.updateAnnotationCount(a.size),r=this._remoteAnnotationsDirty,r){if(this._debug("syncOnce: CRDT changed, applying remote"),n=await this.applyRemoteFromCRDT(),n.size>0){if(this.adapter){let l=new Set;for(let c of n){let h=this.localIndex.get(c);h&&l.add(h.localId)}i=i.map(c=>{let h=c["@id"]||c.id;return l.has(h)&&this.adapter.getItemFull(h)||c})}else{let l=await this.api.getItems();if(l&&Array.isArray(l)){let c=l.filter(h=>{let u=bt.computeIdentity({"@id":h.id,template:h.template,photo:[]});return u&&n.has(u)});if(c.length===0&&n.size>0)i=await this._enrichAll(l);else if(c.length>0){let h=await this._enrichAll(c),u=new Map;for(let d of h){let f=bt.computeIdentity(d);f&&u.set(f,d)}i=i.map(d=>{let f=bt.computeIdentity(d);return f&&u.has(f)?u.get(f):d})}}}this.localIndex=bt.buildIdentityIndex(i)}}else this._debug("syncOnce: CRDT unchanged, skip apply")}if(this.options.syncMode!=="pull"){this.adapter&&this.adapter.suppressChanges();try{await this.pushLocal(i)}finally{this.adapter&&this.adapter.resumeChanges()}}let o=!1;if(this._applyStats&&this._applyStats.notesFailed>0){let a=new Set(this._failedNoteKeys);this._failedNoteKeys.clear();let l=0;for(let h of a){let u=(this.vault.failedNoteKeys.get(h)||0)+1;this.vault.failedNoteKeys.set(h,u),u>=3&&(this.vault.appliedNoteKeys.add(h),this.vault.failedNoteKeys.delete(h),this._debug(`note key ${h.slice(0,8)} permanently given up after ${u} retries`),l++)}let c=this._applyStats.notesFailed-l;c>0&&(o=!0,this._debug(`apply had ${this._applyStats.notesFailed} note failures, ${c} will retry next cycle`))}else this._applyStats&&this._failedNoteKeys.clear();this.options.syncMode==="auto"&&!o&&(this._remoteAnnotationsDirty=!1),this.vault.pruneAppliedKeys(),this.vault.markDirty(),await this._persistVault(),this.vault._evictIfNeeded(this.previousSnapshot,5e3),this.lastSync=new Date,this._consecutiveErrors=0,this.state="connected",this._debug("syncOnce: cycle complete")}catch(i){this._consecutiveErrors++;let n=i instanceof Error?i.message:String(i||"");i&&(i.sqliteBusy||n.includes("SQLITE_BUSY"))?this.logger.warn({consecutiveErrors:this._consecutiveErrors},"Database busy, will back off"):this.logger.warn({error:n,stack:i&&i.stack},"Sync cycle failed"),this.state=e==="connected"?"connected":"error"}finally{this._syncing=!1,t();let i=this._queuedLocalChange||this._syncRequested;this._queuedLocalChange=!1,this._syncRequested=!1,i&&(this._debug("replaying queued sync trigger (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}_fuzzyMatchLocal(t){if(this.localIndex.size===0||!this.doc)return null;let e=q.getItemChecksums(this.doc,t);if(e.length===0)return null;let i=new Set(e),n=null,r=0;for(let[o,a]of this.localIndex){let l=a.item.photo||[];Array.isArray(l)||(l=[l]);let c=new Set;for(let u of l)u.checksum&&c.add(u.checksum);let h=!0;for(let u of i)if(!c.has(u)){h=!1;break}if(h&&c.size>0&&e.length>=Math.ceil(c.size*.5)){let u=e.length/c.size;u>r&&(r=u,n={local:a,localIdentity:o,checksumCount:e.length})}}return n}async applyRemoteFromCRDT(){let t=q.getIdentities(this.doc),e=new Set;if(t.length===0)return this._log("applyRemote: CRDT snapshot is empty"),e;this._debug(`applyRemote: scanning ${t.length} CRDT items`);let i=this.adapter?this.adapter.getAllTags():await this.api.getTags(),n=new Map;if(i&&Array.isArray(i))for(let h of i)n.set(h.name,h);let r=new Map;if(this.options.syncLists)try{let h=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(h))for(let u of h)r.set(u.name||String(u.id),u)}catch(h){this.logger.warn("applyRemoteFromCRDT: failed to fetch lists",{error:String(h.message||h)})}this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges();let o=[],a=new Set,l=new Set;for(let h of t){let u=bt.findLocalMatch(h,this.localIndex);if(!u)continue;let d=q.getItemSnapshot(this.doc,h);if(!d)continue;let f=this.backup.validateInbound(h,d,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning for ${h.slice(0,8)}: ${p}`);this.logger.warn(`Skipping apply for ${h.slice(0,8)} \u2014 validation failed`);continue}o.push({itemIdentity:h,local:u}),a.add(h),l.add(u.localId)}let c=t.filter(h=>!a.has(h));for(let h of c){let u=this._fuzzyMatchLocal(h);if(!u){this._debug(`no fuzzy match for CRDT item ${h.slice(0,8)}`);continue}if(l.has(u.local.localId)){this._debug(`fuzzy skip: CRDT ${h.slice(0,8)} \u2192 local ${u.localIdentity.slice(0,8)} (already has exact match)`);continue}this._log(`fuzzy match: CRDT ${h.slice(0,8)} \u2192 local ${u.localIdentity.slice(0,8)} (merged item, ${u.checksumCount} shared photo(s))`);let d=q.getItemSnapshot(this.doc,h);if(!d)continue;this.backup.validateInbound(h,d,this._stableUserId).valid&&(o.push({itemIdentity:h,local:u.local}),l.add(u.local.localId))}if(o.length===0)return this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._debug("applyRemote: no matched items"),e;try{let h=[];for(let{local:u,itemIdentity:d}of o)try{let f=this.adapter?this.backup.captureItemStateFromStore(this.adapter,u.localId,d):await this.backup.captureItemState(u.localId,d);h.push(f)}catch(f){this.logger.warn(`applyRemoteFromCRDT: backup capture failed for ${d.slice(0,8)}`,{error:String(f.message||f)})}h.length>0&&this.vault.shouldBackup(h)&&await this.backup.saveSnapshot(h)}catch(h){this.logger.warn("Batch backup failed",{error:h.message})}this._resetApplyStats();try{for(let{itemIdentity:h,local:u}of o)try{await this.applyRemoteAnnotations(h,u,n,r),e.add(h)}catch(d){this.logger.warn(`Failed to apply remote for ${h}`,{error:d.message})}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}return e}async applyOnDemand(){if(!this.doc)return null;let t=await this._acquireLock();try{return await this._applyOnDemandInner()}finally{t()}}async _applyOnDemandInner(){let t=q.getIdentities(this.doc),e=this._stableUserId,i={},n=this.adapter?this.adapter.getAllTags():await this.api.getTags(),r=new Map;if(n&&Array.isArray(n))for(let h of n)r.set(h.name,h);let o=new Map;if(this.options.syncLists)try{let h=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(h))for(let u of h)o.set(u.name||String(u.id),u)}catch(h){this.logger.warn("applyOnDemand: failed to fetch lists",{error:String(h.message||h)})}for(let h of t){let u=q.getItemSnapshot(this.doc,h);if(u)for(let d of["metadata","tags","notes","selections","transcriptions","lists"]){let f=u[d];if(!(!f||typeof f!="object"))for(let p of Object.values(f))p&&p.author&&p.author!==e&&!p.deleted&&(i[p.author]||(i[p.author]={metadata:0,tags:0,notes:0,selections:0,transcriptions:0,lists:0}),i[p.author][d]++)}}for(let[h,u]of Object.entries(i)){let d=Object.entries(u).filter(([,f])=>f>0).map(([f,p])=>`${p} ${f}`);d.length>0&&this.logger.info(`${h}: ${d.join(", ")}`)}let a=[],l=[];for(let h of t){let u=bt.findLocalMatch(h,this.localIndex);if(!u)continue;let d=q.getItemSnapshot(this.doc,h);if(!d)continue;let f=this.backup.validateInbound(h,d,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning: ${p}`);continue}l.push(h);try{let p=this.adapter?this.backup.captureItemStateFromStore(this.adapter,u.localId,h):await this.backup.captureItemState(u.localId,h);a.push(p)}catch(p){this.logger.warn(`applyOnDemand: backup capture failed for ${h.slice(0,8)}`,{error:String(p.message||p)})}}a.length>0&&this.vault.shouldBackup(a)&&await this.backup.saveSnapshot(a),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();let c=0;try{for(let h of l){let u=bt.findLocalMatch(h,this.localIndex);if(u)try{await this.applyRemoteAnnotations(h,u,r,o),c++}catch(d){this.logger.warn(`Import: failed to apply ${h}`,{error:d.message})}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges()}return{applied:c,summary:i}}async rollback(t){return this.backup.rollback(t,this.adapter)}purgeTombstones(){this.doc&&(this.logger.info("Purging tombstones from CRDT"),this.doc.transact(()=>{let t=q.purgeTombstones(this.doc);this.logger.info(`Purged ${t.purged} tombstone(s) across ${t.items} item(s)`)},this.LOCAL_ORIGIN))}getStatus(){return{state:this.state,lastSync:this.lastSync,room:this.options.room,server:this.options.serverUrl,syncMode:this.options.syncMode,clientId:this.doc?this.doc.clientID:null,localItems:this.localIndex.size,crdtItems:this.vault.annotationCount,users:this.doc?q.getUsers(this.doc):[],watching:this.fileWatcher!=null||this._storeUnsubscribe!=null,storeAvailable:this.adapter!=null,projectPath:this.projectPath,consecutiveErrors:this._consecutiveErrors}}};Object.assign(Ke.prototype,cc());Object.assign(Ke.prototype,gc());Object.assign(Ke.prototype,yc());_c.exports={SyncEngine:Ke}});var{SyncEngine:Ur}=bc(),Sc=Fe(),_p=new Set(["auto","review","push","pull"]),Er=class{constructor(t,e){if(this.context=e,this.options=this.mergeOptions(t),this.engine=null,this._isPrefsWindow()){this.context.logger.info("Troparcel: skipping sync in prefs window");return}this.context.logger.info(`Troparcel v4.11 \u2014 server: ${this.options.serverUrl}, mode: ${this.options.syncMode}, user: ${this.options.userId||"(anonymous)"}`),this.options.autoSync?(this.context.logger.info("Troparcel: auto-sync enabled, waiting for project to load..."),this._waitForProjectAndStart()):this.context.logger.info("Troparcel: auto-sync disabled \u2014 use File > Export/Import to sync manually")}_isPrefsWindow(){try{let t=this.context.logger;if(t.chindings&&t.chindings.includes('"name":"prefs"'))return!0;if(typeof t.bindings=="function"){let e=t.bindings();if(e&&e.name==="prefs")return!0}}catch{}return!1}async _waitForProjectAndStart(){let t=Date.now(),e=this.options.startupDelay,i=500;for(;Date.now()-t<e;){try{let r=this.context.window&&this.context.window.store;if(r){let o=r.getState(),a=o&&o.project;if(a&&a.path){let c=Date.now()-t;this.context.logger.info(`Troparcel: store + project available after ${c}ms`),!this.options._roomExplicit&&a.name&&(this.options.room=a.name),this.options.projectPath=a.path;break}let l=Date.now()-t;l>2e3&&l%2e3<i&&this.context.logger.info(`Troparcel: store ready, waiting for project state (${l}ms)`)}}catch{}await new Promise(r=>setTimeout(r,i))}let n=null;try{n=this.context.window&&this.context.window.store}catch{}n||this.context.logger.info(`Troparcel: store not available after ${this.options.startupDelay}ms \u2014 starting sync with API fallback`),await this.startBackgroundSync()}mergeOptions(t){let e="",i=(t.syncMode||"auto").trim().toLowerCase();_p.has(i)||(i="auto");let n=!!t.room;return{serverUrl:t.serverUrl||"ws://localhost:2468",room:t.room||e||"troparcel-default",userId:t.userId||"",roomToken:t.roomToken||"",apiPort:Number(t.apiPort)||2019,autoSync:t.autoSync!==!1,syncMode:i,syncMetadata:t.syncMetadata!==!1,syncTags:t.syncTags!==!1,syncNotes:t.syncNotes!==!1,syncSelections:t.syncSelections!==!1,syncTranscriptions:t.syncTranscriptions!==!1,syncPhotoAdjustments:t.syncPhotoAdjustments===!0||t.syncPhotoAdjustments==="true",syncLists:t.syncLists===!0||t.syncLists==="true",syncDeletions:t.syncDeletions===!0||t.syncDeletions==="true",clearTombstones:t.clearTombstones===!0||t.clearTombstones==="true",startupDelay:Number(t.startupDelay)||8e3,localDebounce:Number(t.localDebounce)||2e3,remoteDebounce:Number(t.remoteDebounce)||500,safetyNetInterval:Number(t.safetyNetInterval)||120,writeDelay:Number(t.writeDelay)||100,maxBackups:Number(t.maxBackups)||10,maxNoteSize:Number(t.maxNoteSize)||1048576,maxMetadataSize:Number(t.maxMetadataSize)||65536,tombstoneFloodThreshold:Number(t.tombstoneFloodThreshold)||.5,debug:t.debug===!0||t.debug==="true",_roomExplicit:n}}async startBackgroundSync(){if(this.engine)return;let t=null;try{t=this.context.window&&this.context.window.store}catch{}this.engine=new Ur(this.options,this.context.logger,t);try{await this.engine.start(),this.context.logger.info(`Troparcel: connected to room "${this.options.room}" (${t?"store":"API"} mode, sync: ${this.options.syncMode})`)}catch(e){let i=e.message||String(e);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.warn(`Troparcel: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running? Start it with: node server/index.js`):this.context.logger.warn(`Troparcel: sync failed to start \u2014 ${i}. Use File > Export/Import to sync manually.`),await this.engine.stop(),this.engine=null}}async export(t){if(!this._isPrefsWindow()){if(!t||t.length===0){this.context.logger.warn("Troparcel Export: no items selected \u2014 select items first, then File > Export > Troparcel");return}if(this.options.syncMode==="pull"){this.context.logger.warn('Troparcel Export: sync mode is "pull" \u2014 local changes are not shared in this mode');return}this.context.logger.info(`Troparcel Export: pushing ${t.length} item(s) to room "${this.options.room}"...`);try{if(this.engine&&this.engine.state==="connected"){this.engine.pushItems(t),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`);return}this.context.logger.info("Troparcel Export: connecting to server (no background sync active)...");let e=new Ur(this.options,this.context.logger);await e.start(),e.pushItems(t),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`),setTimeout(()=>{e.stop()},5e3)}catch(e){let i=e.message||String(e);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Export: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Export: failed \u2014 ${i}`)}}}async import(t){if(!this._isPrefsWindow()){if(this.options.syncMode==="push"){this.context.logger.warn('Troparcel Import: sync mode is "push" \u2014 remote changes are not applied in this mode');return}this.context.logger.info(`Troparcel Import: pulling changes from room "${this.options.room}"...`),this.engine&&this.engine.pause();try{let e,i=!1;if(this.engine&&this.engine.state==="connected"?e=this.engine:(e=new Ur(this.options,this.context.logger),await e.start(),await new Promise(r=>setTimeout(r,3e3)),i=!0),!e.adapter&&!await e.api.ping()){this.context.logger.warn("Import: Tropy API not reachable"),i&&await e.stop();return}if(e.localIndex.size===0)if(e.adapter){let r=e.readAllItemsFull();e.localIndex=Sc.buildIdentityIndex(r)}else{let r=await e.api.getItems();if(r&&Array.isArray(r)){let o=[];for(let a of r)try{o.push(await e.enrichItem(a))}catch{}e.localIndex=Sc.buildIdentityIndex(o)}}let n=await e.applyOnDemand();n?this.context.logger.info(`Troparcel Import: done \u2014 applied changes to ${n.applied} item(s) from "${this.options.room}"`):this.context.logger.info("Troparcel Import: done \u2014 no pending changes to apply"),i&&await e.stop()}catch(e){let i=e.message||String(e);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Import: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Import: failed \u2014 ${i}`)}finally{this.engine&&this.engine.resume()}}}getStatus(){let t={...this.options};return t.roomToken&&(t.roomToken="***"),delete t._roomExplicit,{version:"4.11.0",options:t,engine:this.engine?this.engine.getStatus():null,backgroundSync:this.engine!=null}}async unload(){this.context.logger.info("Troparcel unloading"),this.engine&&(await this.engine.stop(),this.engine=null)}};module.exports=Er;
