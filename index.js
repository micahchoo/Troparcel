"use strict";var Wi=Object.defineProperty;var $c=Object.getOwnPropertyDescriptor;var Mc=Object.getOwnPropertyNames;var Oc=Object.prototype.hasOwnProperty;var T=(s,e)=>()=>(s&&(e=s(s=0)),e);var E=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),Gi=(s,e)=>{for(var t in e)Wi(s,t,{get:e[t],enumerable:!0})},Rc=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Mc(e))!Oc.call(s,r)&&r!==t&&Wi(s,r,{get:()=>e[r],enumerable:!(i=$c(e,r))||i.enumerable});return s};var _t=s=>Rc(Wi({},"__esModule",{value:!0}),s);var V,Bs,P,Pn,Xt=T(()=>{V=()=>new Map,Bs=s=>{let e=V();return s.forEach((t,i)=>{e.set(i,t)}),e},P=(s,e,t)=>{let i=s.get(e);return i===void 0&&s.set(e,i=t()),i},Pn=(s,e)=>{for(let[t,i]of s)if(e(i,t))return!0;return!1}});var me,Ks=T(()=>{me=()=>new Set});var qs,Kn,fe,qn,Hn,Zt,Qt=T(()=>{qs=s=>s[s.length-1],Kn=(s,e)=>{for(let t=0;t<e.length;t++)s.push(e[t])},fe=Array.from,qn=(s,e)=>{for(let t=0;t<s.length;t++)if(e(s[t],t,s))return!0;return!1},Hn=(s,e)=>{let t=new Array(s);for(let i=0;i<s;i++)t[i]=e(i,t);return t},Zt=Array.isArray});var zn={};Gi(zn,{Observable:()=>Je,ObservableV2:()=>Ge});var Ge,Je,es=T(()=>{Xt();Ks();Qt();Ge=class{constructor(){this._observers=V()}on(e,t){return P(this._observers,e,me).add(t),t}once(e,t){let i=(...r)=>{this.off(e,i),t(...r)};this.on(e,i)}off(e,t){let i=this._observers.get(e);i!==void 0&&(i.delete(t),i.size===0&&this._observers.delete(e))}emit(e,t){return fe((this._observers.get(e)||V()).values()).forEach(i=>i(...t))}destroy(){this._observers=V()}},Je=class{constructor(){this._observers=V()}on(e,t){P(this._observers,e,me).add(t)}once(e,t){let i=(...r)=>{this.off(e,i),t(...r)};this.on(e,i)}off(e,t){let i=this._observers.get(e);i!==void 0&&(i.delete(t),i.size===0&&this._observers.delete(e))}emit(e,t){return fe((this._observers.get(e)||V()).values()).forEach(i=>i(...t))}destroy(){this._observers=V()}}});var ee,bt,St,Ie,jp,Wn,zs,Ye=T(()=>{ee=Math.floor,bt=Math.abs,St=(s,e)=>s<e?s:e,Ie=(s,e)=>s>e?s:e,jp=Number.isNaN,Wn=Math.pow,zs=s=>s!==0?s<0:1/s<0});var Yi,Bp,Pp,Gn,Kp,qp,Xi=T(()=>{Ye();Yi=Number.MAX_SAFE_INTEGER,Bp=Number.MIN_SAFE_INTEGER,Pp=1<<31,Gn=Number.isInteger||(s=>typeof s=="number"&&isFinite(s)&&ee(s)===s),Kp=Number.isNaN,qp=Number.parseInt});var Zi,Hp,zp,Fc,Vc,jc,Bc,Qi,Pc,vt,Kc,Yn,kt,Xn,Tt=T(()=>{Qt();Zi=String.fromCharCode,Hp=String.fromCodePoint,zp=Zi(65535),Fc=s=>s.toLowerCase(),Vc=/^\s*/g,jc=s=>s.replace(Vc,""),Bc=/([A-Z])/g,Qi=(s,e)=>jc(s.replace(Bc,t=>`${e}${Fc(t)}`)),Pc=s=>{let e=unescape(encodeURIComponent(s)),t=e.length,i=new Uint8Array(t);for(let r=0;r<t;r++)i[r]=e.codePointAt(r);return i},vt=typeof TextEncoder<"u"?new TextEncoder:null,Kc=s=>vt.encode(s),Yn=vt?Kc:Pc,kt=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});kt&&kt.decode(new Uint8Array).length===1&&(kt=null);Xn=(s,e)=>Hn(e,()=>s).join("")});var Xe,M,Gs,C,qc,K,Ut,w,is,er,Hc,zc,Wc,ye,so,Nt,D,tr,Gc,Jc,Yc,Qn,Xc,At,ss,eo,Ze,to,Ct,Ws,rs=T(()=>{Ye();Xi();Tt();Qt();Xe=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}},M=()=>new Xe,Gs=s=>{let e=s.cpos;for(let t=0;t<s.bufs.length;t++)e+=s.bufs[t].length;return e},C=s=>{let e=new Uint8Array(Gs(s)),t=0;for(let i=0;i<s.bufs.length;i++){let r=s.bufs[i];e.set(r,t),t+=r.length}return e.set(new Uint8Array(s.cbuf.buffer,0,s.cpos),t),e},qc=(s,e)=>{let t=s.cbuf.length;t-s.cpos<e&&(s.bufs.push(new Uint8Array(s.cbuf.buffer,0,s.cpos)),s.cbuf=new Uint8Array(Ie(t,e)*2),s.cpos=0)},K=(s,e)=>{let t=s.cbuf.length;s.cpos===t&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(t*2),s.cpos=0),s.cbuf[s.cpos++]=e},Ut=K,w=(s,e)=>{for(;e>127;)K(s,128|127&e),e=ee(e/128);K(s,127&e)},is=(s,e)=>{let t=zs(e);for(t&&(e=-e),K(s,(e>63?128:0)|(t?64:0)|63&e),e=ee(e/64);e>0;)K(s,(e>127?128:0)|127&e),e=ee(e/128)},er=new Uint8Array(3e4),Hc=er.length/3,zc=(s,e)=>{if(e.length<Hc){let t=vt.encodeInto(e,er).written||0;w(s,t);for(let i=0;i<t;i++)K(s,er[i])}else D(s,Yn(e))},Wc=(s,e)=>{let t=unescape(encodeURIComponent(e)),i=t.length;w(s,i);for(let r=0;r<i;r++)K(s,t.codePointAt(r))},ye=vt&&vt.encodeInto?zc:Wc,so=(s,e)=>Nt(s,C(e)),Nt=(s,e)=>{let t=s.cbuf.length,i=s.cpos,r=St(t-i,e.length),n=e.length-r;s.cbuf.set(e.subarray(0,r),i),s.cpos+=r,n>0&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(Ie(t*2,n)),s.cbuf.set(e.subarray(r)),s.cpos=n)},D=(s,e)=>{w(s,e.byteLength),Nt(s,e)},tr=(s,e)=>{qc(s,e);let t=new DataView(s.cbuf.buffer,s.cpos,e);return s.cpos+=e,t},Gc=(s,e)=>tr(s,4).setFloat32(0,e,!1),Jc=(s,e)=>tr(s,8).setFloat64(0,e,!1),Yc=(s,e)=>tr(s,8).setBigInt64(0,e,!1),Qn=new DataView(new ArrayBuffer(4)),Xc=s=>(Qn.setFloat32(0,s),Qn.getFloat32(0)===s),At=(s,e)=>{switch(typeof e){case"string":K(s,119),ye(s,e);break;case"number":Gn(e)&&bt(e)<=2147483647?(K(s,125),is(s,e)):Xc(e)?(K(s,124),Gc(s,e)):(K(s,123),Jc(s,e));break;case"bigint":K(s,122),Yc(s,e);break;case"object":if(e===null)K(s,126);else if(Zt(e)){K(s,117),w(s,e.length);for(let t=0;t<e.length;t++)At(s,e[t])}else if(e instanceof Uint8Array)K(s,116),D(s,e);else{K(s,118);let t=Object.keys(e);w(s,t.length);for(let i=0;i<t.length;i++){let r=t[i];ye(s,r),At(s,e[r])}}break;case"boolean":K(s,e?120:121);break;default:K(s,127)}},ss=class extends Xe{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&w(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}},eo=s=>{s.count>0&&(is(s.encoder,s.count===1?s.s:-s.s),s.count>1&&w(s.encoder,s.count-2))},Ze=class{constructor(){this.encoder=new Xe,this.s=0,this.count=0}write(e){this.s===e?this.count++:(eo(this),this.count=1,this.s=e)}toUint8Array(){return eo(this),C(this.encoder)}},to=s=>{if(s.count>0){let e=s.diff*2+(s.count===1?0:1);is(s.encoder,e),s.count>1&&w(s.encoder,s.count-2)}},Ct=class{constructor(){this.encoder=new Xe,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(to(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return to(this),C(this.encoder)}},Ws=class{constructor(){this.sarr=[],this.s="",this.lensE=new Ze}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){let e=new Xe;return this.sarr.push(this.s),this.s="",ye(e,this.sarr.join("")),Nt(e,this.lensE.toUint8Array()),C(e)}}});var we,pe,Z,sr=T(()=>{we=s=>new Error(s),pe=()=>{throw we("Method unimplemented")},Z=()=>{throw we("Unexpected case")}});var ro,no,Et,O,ir,Zc,B,Qe,x,os,Qc,eh,le,rr,th,sh,ih,rh,Dt,ns,et,Lt,Ys,$t=T(()=>{Ye();Xi();Tt();sr();ro=we("Unexpected end of array"),no=we("Integer out of Range"),Et=class{constructor(e){this.arr=e,this.pos=0}},O=s=>new Et(s),ir=s=>s.pos!==s.arr.length,Zc=(s,e)=>{let t=new Uint8Array(s.arr.buffer,s.pos+s.arr.byteOffset,e);return s.pos+=e,t},B=s=>Zc(s,x(s)),Qe=s=>s.arr[s.pos++],x=s=>{let e=0,t=1,i=s.arr.length;for(;s.pos<i;){let r=s.arr[s.pos++];if(e=e+(r&127)*t,t*=128,r<128)return e;if(e>Yi)throw no}throw ro},os=s=>{let e=s.arr[s.pos++],t=e&63,i=64,r=(e&64)>0?-1:1;if(!(e&128))return r*t;let n=s.arr.length;for(;s.pos<n;){if(e=s.arr[s.pos++],t=t+(e&127)*i,i*=128,e<128)return r*t;if(t>Yi)throw no}throw ro},Qc=s=>{let e=x(s);if(e===0)return"";{let t=String.fromCodePoint(Qe(s));if(--e<100)for(;e--;)t+=String.fromCodePoint(Qe(s));else for(;e>0;){let i=e<1e4?e:1e4,r=s.arr.subarray(s.pos,s.pos+i);s.pos+=i,t+=String.fromCodePoint.apply(null,r),e-=i}return decodeURIComponent(escape(t))}},eh=s=>kt.decode(B(s)),le=kt?eh:Qc,rr=(s,e)=>{let t=new DataView(s.arr.buffer,s.arr.byteOffset+s.pos,e);return s.pos+=e,t},th=s=>rr(s,4).getFloat32(0,!1),sh=s=>rr(s,8).getFloat64(0,!1),ih=s=>rr(s,8).getBigInt64(0,!1),rh=[s=>{},s=>null,os,th,sh,ih,s=>!1,s=>!0,le,s=>{let e=x(s),t={};for(let i=0;i<e;i++){let r=le(s);t[r]=Dt(s)}return t},s=>{let e=x(s),t=[];for(let i=0;i<e;i++)t.push(Dt(s));return t},B],Dt=s=>rh[127-Qe(s)](s),ns=class extends Et{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),ir(this)?this.count=x(this)+1:this.count=-1),this.count--,this.s}},et=class extends Et{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=os(this);let e=zs(this.s);this.count=1,e&&(this.s=-this.s,this.count=x(this)+2)}return this.count--,this.s}},Lt=class extends Et{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){let e=os(this),t=e&1;this.diff=ee(e/2),this.count=1,t&&(this.count=x(this)+2)}return this.s+=this.diff,this.count--,this.s}},Ys=class{constructor(e){this.decoder=new et(e),this.str=le(this.decoder),this.spos=0}read(){let e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}});var Xs,Jp,oo,ao=T(()=>{Xs=require("node:crypto"),Jp=Xs.webcrypto.subtle,oo=Xs.webcrypto.getRandomValues.bind(Xs.webcrypto)});var nr,nh,lo,co=T(()=>{ao();nr=()=>oo(new Uint32Array(1))[0],nh="10000000-1000-4000-8000"+-1e11,lo=()=>nh.replace(/[018]/g,s=>(s^nr()&15>>s/4).toString(16))});var re,ls=T(()=>{re=Date.now});var or,Zp,ho=T(()=>{or=s=>new Promise(s),Zp=Promise.all.bind(Promise)});var ar,uo=T(()=>{ar=s=>s===void 0?null:s});var lr,fo,cr,Qs,po,go,hr=T(()=>{lr=class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},fo=new lr,cr=!0;try{typeof localStorage<"u"&&localStorage&&(fo=localStorage,cr=!1)}catch{}Qs=fo,po=s=>cr||addEventListener("storage",s),go=s=>cr||removeEventListener("storage",s)});var ei,yo,dr=T(()=>{ei=Symbol("Equality"),yo=(s,e)=>s===e||!!s?.[ei]?.(e)||!1});var _o,ch,bo,So,cs,xo,hh,ur,fr,dh,pr,ti=T(()=>{dr();_o=Object.assign,ch=Object.keys,bo=(s,e)=>{for(let t in s)e(s[t],t)},So=(s,e)=>{let t=[];for(let i in s)t.push(e(s[i],i));return t},cs=s=>ch(s).length,xo=s=>{for(let e in s)return!1;return!0},hh=(s,e)=>{for(let t in s)if(!e(s[t],t))return!1;return!0},ur=(s,e)=>Object.prototype.hasOwnProperty.call(s,e),fr=(s,e)=>s===e||cs(s)===cs(e)&&hh(s,(t,i)=>(t!==void 0||ur(e,i))&&yo(e[i],t)),dh=Object.freeze,pr=s=>{for(let e in s){let t=s[e];(typeof t=="object"||typeof t=="function")&&pr(s[e])}return dh(s)}});var hs,mr,Mt,ko,ds=T(()=>{ti();dr();hs=(s,e,t=0)=>{try{for(;t<s.length;t++)s[t](...e)}finally{t<s.length&&hs(s,e,t+1)}},mr=s=>s,Mt=(s,e)=>{if(s===e)return!0;if(s==null||e==null||s.constructor!==e.constructor&&(s.constructor||Object)!==(e.constructor||Object))return!1;if(s[ei]!=null)return s[ei](e);switch(s.constructor){case ArrayBuffer:s=new Uint8Array(s),e=new Uint8Array(e);case Uint8Array:{if(s.byteLength!==e.byteLength)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;break}case Set:{if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;break}case Map:{if(s.size!==e.size)return!1;for(let t of s.keys())if(!e.has(t)||!Mt(s.get(t),e.get(t)))return!1;break}case void 0:case Object:if(cs(s)!==cs(e))return!1;for(let t in s)if(!ur(s,t)||!Mt(s[t],e[t]))return!1;break;case Array:if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!Mt(s[t],e[t]))return!1;break;default:return!1}return!0},ko=(s,e)=>e.includes(s)});var Ae,_r,Qp,_e,uh,fh,wr,us,vo,eg,ph,To,fs=T(()=>{Xt();Tt();uo();hr();ds();Ae=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",_r=typeof window<"u"&&typeof document<"u"&&!Ae,Qp=typeof navigator<"u"?/Mac/.test(navigator.platform):!1,uh=[],fh=()=>{if(_e===void 0)if(Ae){_e=V();let s=process.argv,e=null;for(let t=0;t<s.length;t++){let i=s[t];i[0]==="-"?(e!==null&&_e.set(e,""),e=i):e!==null?(_e.set(e,i),e=null):uh.push(i)}e!==null&&_e.set(e,"")}else typeof location=="object"?(_e=V(),(location.search||"?").slice(1).split("&").forEach(s=>{if(s.length!==0){let[e,t]=s.split("=");_e.set(`--${Qi(e,"-")}`,t),_e.set(`-${Qi(e,"-")}`,t)}})):_e=V();return _e},wr=s=>fh().has(s),us=s=>Ae?ar(process.env[s.toUpperCase().replaceAll("-","_")]):ar(Qs.getItem(s)),vo=s=>wr("--"+s)||us(s)!==null,eg=vo("production"),ph=Ae&&ko(process.env.FORCE_COLOR,["true","1","2"]),To=ph||!wr("--no-colors")&&!vo("no-color")&&(!Ae||process.stdout.isTTY)&&(!Ae||wr("--color")||us("COLORTERM")!==null||(us("TERM")||"").includes("color"))});var Io,gh,Ao,mh,yh,wh,_h,Co,Uo,No,br=T(()=>{Tt();fs();Io=s=>new Uint8Array(s),gh=(s,e,t)=>new Uint8Array(s,e,t),Ao=s=>new Uint8Array(s),mh=s=>{let e="";for(let t=0;t<s.byteLength;t++)e+=Zi(s[t]);return btoa(e)},yh=s=>Buffer.from(s.buffer,s.byteOffset,s.byteLength).toString("base64"),wh=s=>{let e=atob(s),t=Io(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t},_h=s=>{let e=Buffer.from(s,"base64");return gh(e.buffer,e.byteOffset,e.byteLength)},Co=_r?mh:yh,Uo=_r?wh:_h,No=s=>{let e=Io(s.byteLength);return e.set(s),e}});var be,Do=T(()=>{be=Symbol});var ps,gs,Sr,xr,kr,ms,vr,ys,Tr,Lo,tg,Ir=T(()=>{Do();ls();ps=be(),gs=be(),Sr=be(),xr=be(),kr=be(),ms=be(),vr=be(),ys=be(),Tr=be(),Lo=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let e=[],t=[],i=0;for(;i<s.length;i++){let r=s[i];if(r===void 0)break;if(r.constructor===String||r.constructor===Number)e.push(r);else if(r.constructor===Object)break}for(i>0&&t.push(e.join(""));i<s.length;i++){let r=s[i];r instanceof Symbol||t.push(r)}return t},tg=re()});var xh,kh,$o,ii,Ar,Mo=T(()=>{fs();Ir();Ir();xh={[ps]:"\x1B[1m",[gs]:"\x1B[2m",[Sr]:"\x1B[34m",[kr]:"\x1B[32m",[xr]:"\x1B[37m",[ms]:"\x1B[31m",[vr]:"\x1B[35m",[ys]:"\x1B[38;5;208m",[Tr]:"\x1B[0m"},kh=s=>{s.length===1&&s[0]?.constructor===Function&&(s=s[0]());let e=[],t=[],i=0;for(;i<s.length;i++){let r=s[i],n=xh[r];if(n!==void 0)e.push(n);else{if(r===void 0)break;if(r.constructor===String||r.constructor===Number)e.push(r);else break}}for(i>0&&(e.push("\x1B[0m"),t.push(e.join("")));i<s.length;i++){let r=s[i];r instanceof Symbol||t.push(r)}return t},$o=To?kh:Lo,ii=(...s)=>{console.log(...$o(s))},Ar=(...s)=>{console.warn(...$o(s))}});var Oo,Ro,ri,Fo=T(()=>{Oo=s=>({[Symbol.iterator](){return this},next:s}),Ro=(s,e)=>Oo(()=>{let t;do t=s.next();while(!t.done&&!e(t.value));return t}),ri=(s,e)=>Oo(()=>{let{done:t,value:i}=s.next();return{done:t,value:t?void 0:e(i)}})});var Pt={};Gi(Pt,{AbsolutePosition:()=>di,AbstractConnector:()=>Ur,AbstractStruct:()=>Vt,AbstractType:()=>R,Array:()=>at,ContentAny:()=>Be,ContentBinary:()=>dt,ContentDeleted:()=>jt,ContentDoc:()=>ut,ContentEmbed:()=>Ne,ContentFormat:()=>F,ContentJSON:()=>Us,ContentString:()=>ge,ContentType:()=>he,Doc:()=>Ve,GC:()=>Y,ID:()=>Ce,Item:()=>N,Map:()=>lt,PermanentUserData:()=>Er,RelativePosition:()=>Rt,Skip:()=>H,Snapshot:()=>xs,Text:()=>Ft,Transaction:()=>fi,UndoManager:()=>Or,UpdateDecoderV1:()=>te,UpdateDecoderV2:()=>Q,UpdateEncoderV1:()=>xe,UpdateEncoderV2:()=>ne,XmlElement:()=>ht,XmlFragment:()=>ct,XmlHook:()=>Cs,XmlText:()=>bi,YArrayEvent:()=>mi,YEvent:()=>ot,YMapEvent:()=>yi,YTextEvent:()=>wi,YXmlEvent:()=>_i,applyUpdate:()=>qr,applyUpdateV2:()=>ki,cleanupYTextFormatting:()=>Fa,compareIDs:()=>tt,compareRelativePositions:()=>Gh,convertUpdateFormatV1ToV2:()=>gd,convertUpdateFormatV2ToV1:()=>Sa,createAbsolutePositionFromRelativePosition:()=>Wh,createDeleteSet:()=>xi,createDeleteSetFromStructStore:()=>Br,createDocFromSnapshot:()=>ed,createID:()=>k,createRelativePositionFromJSON:()=>Vh,createRelativePositionFromTypeIndex:()=>Bh,createSnapshot:()=>Yr,decodeRelativePosition:()=>Hh,decodeSnapshot:()=>Xh,decodeSnapshotV2:()=>la,decodeStateVector:()=>zr,decodeUpdate:()=>ld,decodeUpdateV2:()=>ga,diffUpdate:()=>ud,diffUpdateV2:()=>Xr,emptySnapshot:()=>Zh,encodeRelativePosition:()=>Kh,encodeSnapshot:()=>Yh,encodeSnapshotV2:()=>aa,encodeStateAsUpdate:()=>Hr,encodeStateAsUpdateV2:()=>ra,encodeStateVector:()=>Gr,encodeStateVectorFromUpdate:()=>cd,encodeStateVectorFromUpdateV2:()=>ya,equalDeleteSets:()=>sa,equalSnapshots:()=>Jh,findIndexSS:()=>ce,findRootTypeKey:()=>Jr,getItem:()=>st,getItemCleanEnd:()=>$r,getItemCleanStart:()=>J,getState:()=>L,getTypeChildren:()=>_d,isDeleted:()=>ft,isParentOf:()=>Ss,iterateDeletedStructs:()=>it,logType:()=>Rh,logUpdate:()=>ad,logUpdateV2:()=>pa,mergeDeleteSets:()=>rt,mergeUpdates:()=>ma,mergeUpdatesV2:()=>vs,obfuscateUpdate:()=>fd,obfuscateUpdateV2:()=>pd,parseUpdateMeta:()=>hd,parseUpdateMetaV2:()=>wa,readUpdate:()=>Lh,readUpdateV2:()=>Kr,relativePositionToJSON:()=>Fh,snapshot:()=>Qh,snapshotContainsUpdate:()=>sd,transact:()=>U,tryGc:()=>nd,typeListToArraySnapshot:()=>bd,typeMapGetAllSnapshot:()=>La,typeMapGetSnapshot:()=>kd});function*od(s){let e=x(s.restDecoder);for(let t=0;t<e;t++){let i=x(s.restDecoder),r=s.readClient(),n=x(s.restDecoder);for(let o=0;o<i;o++){let a=s.readInfo();if(a===10){let l=x(s.restDecoder);yield new H(k(r,n),l),n+=l}else if(31&a){let l=(a&192)===0,c=new N(k(r,n),null,(a&128)===128?s.readLeftID():null,null,(a&64)===64?s.readRightID():null,l?s.readParentInfo()?s.readString():s.readLeftID():null,l&&(a&32)===32?s.readString():null,Ba(s,a));yield c,n+=c.length}else{let l=s.readLen();yield new Y(k(r,n),l),n+=l}}}}var Ur,_s,Fe,it,Ch,ft,jr,rt,bs,xi,Br,Se,Ue,Bo,sa,ia,Ve,nt,te,hi,Q,je,xe,Ot,ne,Uh,Pr,Nh,Eh,Dh,Kr,Lh,ki,qr,$h,ra,Hr,na,zr,Wr,Mh,Oh,Gr,Nr,Po,Ko,qo,oa,Ce,tt,k,Ho,zo,Jr,Ss,Rh,Er,Rt,Fh,Vh,di,jh,ni,Bh,Ph,Kh,qh,Hh,zh,Wh,Gh,xs,Jh,aa,Yh,la,Xh,Yr,Zh,Qh,Me,Dr,ed,td,sd,ui,Ns,L,ca,ce,id,st,Lr,J,$r,rd,ha,fi,Wo,Go,li,da,ua,nd,fa,U,Mr,Jo,Yo,Or,ke,ad,pa,ld,ga,ks,ma,ya,cd,wa,hd,dd,vs,Xr,ud,_a,Oe,Zr,vi,ba,fd,pd,gd,Sa,Xo,ot,md,z,xa,Qr,Rr,yd,ka,wd,Ti,Ts,_d,Ii,R,va,Ta,bd,Is,Ia,Sd,Aa,pi,Ca,Ua,xd,Na,gi,en,tn,Ea,Da,kd,La,oi,mi,at,vd,yi,lt,Td,Re,As,Zo,ai,$a,Bt,Ma,Oa,Cr,Qo,Ra,Id,Fa,Ad,ea,wi,Ft,Cd,ws,ct,Ud,ht,Nd,_i,Cs,Ed,bi,Dd,Vt,Ld,Y,dt,$d,jt,Md,Va,ut,Od,Ne,Rd,F,Fd,Us,Vd,jd,Be,Bd,ge,Pd,Kd,qd,Hd,zd,Wd,Gd,Jd,Yd,he,Xd,Fr,sn,Si,ta,ja,N,Ba,Zd,Qd,H,Pa,Ka,Kt=T(()=>{es();Qt();Ye();Xt();rs();$t();co();ho();br();sr();ds();ds();Ks();Mo();ls();Tt();Fo();ti();fs();Ur=class extends Ge{constructor(e,t){super(),this.doc=e,this.awareness=t}},_s=class{constructor(e,t){this.clock=e,this.len=t}},Fe=class{constructor(){this.clients=new Map}},it=(s,e,t)=>e.clients.forEach((i,r)=>{let n=s.doc.store.clients.get(r);if(n!=null){let o=n[n.length-1],a=o.id.clock+o.length;for(let l=0,c=i[l];l<i.length&&c.clock<a;c=i[++l])ha(s,n,c.clock,c.len,t)}}),Ch=(s,e)=>{let t=0,i=s.length-1;for(;t<=i;){let r=ee((t+i)/2),n=s[r],o=n.clock;if(o<=e){if(e<o+n.len)return r;t=r+1}else i=r-1}return null},ft=(s,e)=>{let t=s.clients.get(e.client);return t!==void 0&&Ch(t,e.clock)!==null},jr=s=>{s.clients.forEach(e=>{e.sort((r,n)=>r.clock-n.clock);let t,i;for(t=1,i=1;t<e.length;t++){let r=e[i-1],n=e[t];r.clock+r.len>=n.clock?r.len=Ie(r.len,n.clock+n.len-r.clock):(i<t&&(e[i]=n),i++)}e.length=i})},rt=s=>{let e=new Fe;for(let t=0;t<s.length;t++)s[t].clients.forEach((i,r)=>{if(!e.clients.has(r)){let n=i.slice();for(let o=t+1;o<s.length;o++)Kn(n,s[o].clients.get(r)||[]);e.clients.set(r,n)}});return jr(e),e},bs=(s,e,t,i)=>{P(s.clients,e,()=>[]).push(new _s(t,i))},xi=()=>new Fe,Br=s=>{let e=xi();return s.clients.forEach((t,i)=>{let r=[];for(let n=0;n<t.length;n++){let o=t[n];if(o.deleted){let a=o.id.clock,l=o.length;if(n+1<t.length)for(let c=t[n+1];n+1<t.length&&c.deleted;c=t[++n+1])l+=c.length;r.push(new _s(a,l))}}r.length>0&&e.clients.set(i,r)}),e},Se=(s,e)=>{w(s.restEncoder,e.clients.size),fe(e.clients.entries()).sort((t,i)=>i[0]-t[0]).forEach(([t,i])=>{s.resetDsCurVal(),w(s.restEncoder,t);let r=i.length;w(s.restEncoder,r);for(let n=0;n<r;n++){let o=i[n];s.writeDsClock(o.clock),s.writeDsLen(o.len)}})},Ue=s=>{let e=new Fe,t=x(s.restDecoder);for(let i=0;i<t;i++){s.resetDsCurVal();let r=x(s.restDecoder),n=x(s.restDecoder);if(n>0){let o=P(e.clients,r,()=>[]);for(let a=0;a<n;a++)o.push(new _s(s.readDsClock(),s.readDsLen()))}}return e},Bo=(s,e,t)=>{let i=new Fe,r=x(s.restDecoder);for(let n=0;n<r;n++){s.resetDsCurVal();let o=x(s.restDecoder),a=x(s.restDecoder),l=t.clients.get(o)||[],c=L(t,o);for(let h=0;h<a;h++){let d=s.readDsClock(),u=d+s.readDsLen();if(d<c){c<u&&bs(i,o,c,u-c);let f=ce(l,d),p=l[f];for(!p.deleted&&p.id.clock<d&&(l.splice(f+1,0,Si(e,p,d-p.id.clock)),f++);f<l.length&&(p=l[f++],p.id.clock<u);)p.deleted||(u<p.id.clock+p.length&&l.splice(f,0,Si(e,p,u-p.id.clock)),p.delete(e))}else bs(i,o,d,u-d)}}if(i.clients.size>0){let n=new ne;return w(n.restEncoder,0),Se(n,i),n.toUint8Array()}return null},sa=(s,e)=>{if(s.clients.size!==e.clients.size)return!1;for(let[t,i]of s.clients.entries()){let r=e.clients.get(t);if(r===void 0||i.length!==r.length)return!1;for(let n=0;n<i.length;n++){let o=i[n],a=r[n];if(o.clock!==a.clock||o.len!==a.len)return!1}}return!0},ia=nr,Ve=class s extends Ge{constructor({guid:e=lo(),collectionid:t=null,gc:i=!0,gcFilter:r=()=>!0,meta:n=null,autoLoad:o=!1,shouldLoad:a=!0}={}){super(),this.gc=i,this.gcFilter=r,this.clientID=ia(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new ui,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=a,this.autoLoad=o,this.meta=n,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=or(c=>{this.on("load",()=>{this.isLoaded=!0,c(this)})});let l=()=>or(c=>{let h=d=>{(d===void 0||d===!0)&&(this.off("sync",h),c())};this.on("sync",h)});this.on("sync",c=>{c===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=c===void 0||c===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){let e=this._item;e!==null&&!this.shouldLoad&&U(e.parent.doc,t=>{t.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(fe(this.subdocs).map(e=>e.guid))}transact(e,t=null){return U(this,e,t)}get(e,t=R){let i=P(this.share,e,()=>{let n=new t;return n._integrate(this,null),n}),r=i.constructor;if(t!==R&&r!==t)if(r===R){let n=new t;n._map=i._map,i._map.forEach(o=>{for(;o!==null;o=o.left)o.parent=n}),n._start=i._start;for(let o=n._start;o!==null;o=o.right)o.parent=n;return n._length=i._length,this.share.set(e,n),n._integrate(this,null),n}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return i}getArray(e=""){return this.get(e,at)}getText(e=""){return this.get(e,Ft)}getMap(e=""){return this.get(e,lt)}getXmlElement(e=""){return this.get(e,ht)}getXmlFragment(e=""){return this.get(e,ct)}toJSON(){let e={};return this.share.forEach((t,i)=>{e[i]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,fe(this.subdocs).forEach(t=>t.destroy());let e=this._item;if(e!==null){this._item=null;let t=e.content;t.doc=new s({guid:this.guid,...t.opts,shouldLoad:!1}),t.doc._item=e,U(e.parent.doc,i=>{let r=t.doc;e.deleted||i.subdocsAdded.add(r),i.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}},nt=class{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return x(this.restDecoder)}readDsLen(){return x(this.restDecoder)}},te=class extends nt{readLeftID(){return k(x(this.restDecoder),x(this.restDecoder))}readRightID(){return k(x(this.restDecoder),x(this.restDecoder))}readClient(){return x(this.restDecoder)}readInfo(){return Qe(this.restDecoder)}readString(){return le(this.restDecoder)}readParentInfo(){return x(this.restDecoder)===1}readTypeRef(){return x(this.restDecoder)}readLen(){return x(this.restDecoder)}readAny(){return Dt(this.restDecoder)}readBuf(){return No(B(this.restDecoder))}readJSON(){return JSON.parse(le(this.restDecoder))}readKey(){return le(this.restDecoder)}},hi=class{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=x(this.restDecoder),this.dsCurrVal}readDsLen(){let e=x(this.restDecoder)+1;return this.dsCurrVal+=e,e}},Q=class extends hi{constructor(e){super(e),this.keys=[],x(e),this.keyClockDecoder=new Lt(B(e)),this.clientDecoder=new et(B(e)),this.leftClockDecoder=new Lt(B(e)),this.rightClockDecoder=new Lt(B(e)),this.infoDecoder=new ns(B(e),Qe),this.stringDecoder=new Ys(B(e)),this.parentInfoDecoder=new ns(B(e),Qe),this.typeRefDecoder=new et(B(e)),this.lenDecoder=new et(B(e))}readLeftID(){return new Ce(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ce(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Dt(this.restDecoder)}readBuf(){return B(this.restDecoder)}readJSON(){return Dt(this.restDecoder)}readKey(){let e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{let t=this.stringDecoder.read();return this.keys.push(t),t}}},je=class{constructor(){this.restEncoder=M()}toUint8Array(){return C(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){w(this.restEncoder,e)}writeDsLen(e){w(this.restEncoder,e)}},xe=class extends je{writeLeftID(e){w(this.restEncoder,e.client),w(this.restEncoder,e.clock)}writeRightID(e){w(this.restEncoder,e.client),w(this.restEncoder,e.clock)}writeClient(e){w(this.restEncoder,e)}writeInfo(e){Ut(this.restEncoder,e)}writeString(e){ye(this.restEncoder,e)}writeParentInfo(e){w(this.restEncoder,e?1:0)}writeTypeRef(e){w(this.restEncoder,e)}writeLen(e){w(this.restEncoder,e)}writeAny(e){At(this.restEncoder,e)}writeBuf(e){D(this.restEncoder,e)}writeJSON(e){ye(this.restEncoder,JSON.stringify(e))}writeKey(e){ye(this.restEncoder,e)}},Ot=class{constructor(){this.restEncoder=M(),this.dsCurrVal=0}toUint8Array(){return C(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){let t=e-this.dsCurrVal;this.dsCurrVal=e,w(this.restEncoder,t)}writeDsLen(e){e===0&&Z(),w(this.restEncoder,e-1),this.dsCurrVal+=e}},ne=class extends Ot{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ct,this.clientEncoder=new Ze,this.leftClockEncoder=new Ct,this.rightClockEncoder=new Ct,this.infoEncoder=new ss(Ut),this.stringEncoder=new Ws,this.parentInfoEncoder=new ss(Ut),this.typeRefEncoder=new Ze,this.lenEncoder=new Ze}toUint8Array(){let e=M();return w(e,0),D(e,this.keyClockEncoder.toUint8Array()),D(e,this.clientEncoder.toUint8Array()),D(e,this.leftClockEncoder.toUint8Array()),D(e,this.rightClockEncoder.toUint8Array()),D(e,C(this.infoEncoder)),D(e,this.stringEncoder.toUint8Array()),D(e,C(this.parentInfoEncoder)),D(e,this.typeRefEncoder.toUint8Array()),D(e,this.lenEncoder.toUint8Array()),Nt(e,C(this.restEncoder)),C(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){At(this.restEncoder,e)}writeBuf(e){D(this.restEncoder,e)}writeJSON(e){At(this.restEncoder,e)}writeKey(e){let t=this.keyMap.get(e);t===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}},Uh=(s,e,t,i)=>{i=Ie(i,e[0].id.clock);let r=ce(e,i);w(s.restEncoder,e.length-r),s.writeClient(t),w(s.restEncoder,i);let n=e[r];n.write(s,i-n.id.clock);for(let o=r+1;o<e.length;o++)e[o].write(s,0)},Pr=(s,e,t)=>{let i=new Map;t.forEach((r,n)=>{L(e,n)>r&&i.set(n,r)}),Ns(e).forEach((r,n)=>{t.has(n)||i.set(n,0)}),w(s.restEncoder,i.size),fe(i.entries()).sort((r,n)=>n[0]-r[0]).forEach(([r,n])=>{Uh(s,e.clients.get(r),r,n)})},Nh=(s,e)=>{let t=V(),i=x(s.restDecoder);for(let r=0;r<i;r++){let n=x(s.restDecoder),o=new Array(n),a=s.readClient(),l=x(s.restDecoder);t.set(a,{i:0,refs:o});for(let c=0;c<n;c++){let h=s.readInfo();switch(31&h){case 0:{let d=s.readLen();o[c]=new Y(k(a,l),d),l+=d;break}case 10:{let d=x(s.restDecoder);o[c]=new H(k(a,l),d),l+=d;break}default:{let d=(h&192)===0,u=new N(k(a,l),null,(h&128)===128?s.readLeftID():null,null,(h&64)===64?s.readRightID():null,d?s.readParentInfo()?e.get(s.readString()):s.readLeftID():null,d&&(h&32)===32?s.readString():null,Ba(s,h));o[c]=u,l+=u.length}}}}return t},Eh=(s,e,t)=>{let i=[],r=fe(t.keys()).sort((f,p)=>f-p);if(r.length===0)return null;let n=()=>{if(r.length===0)return null;let f=t.get(r[r.length-1]);for(;f.refs.length===f.i;)if(r.pop(),r.length>0)f=t.get(r[r.length-1]);else return null;return f},o=n();if(o===null)return null;let a=new ui,l=new Map,c=(f,p)=>{let g=l.get(f);(g==null||g>p)&&l.set(f,p)},h=o.refs[o.i++],d=new Map,u=()=>{for(let f of i){let p=f.id.client,g=t.get(p);g?(g.i--,a.clients.set(p,g.refs.slice(g.i)),t.delete(p),g.i=0,g.refs=[]):a.clients.set(p,[f]),r=r.filter(m=>m!==p)}i.length=0};for(;;){if(h.constructor!==H){let p=P(d,h.id.client,()=>L(e,h.id.client))-h.id.clock;if(p<0)i.push(h),c(h.id.client,h.id.clock-1),u();else{let g=h.getMissing(s,e);if(g!==null){i.push(h);let m=t.get(g)||{refs:[],i:0};if(m.refs.length===m.i)c(g,L(e,g)),u();else{h=m.refs[m.i++];continue}}else(p===0||p<h.length)&&(h.integrate(s,p),d.set(h.id.client,h.id.clock+h.length))}}if(i.length>0)h=i.pop();else if(o!==null&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=n(),o===null)break;h=o.refs[o.i++]}}if(a.clients.size>0){let f=new ne;return Pr(f,a,new Map),w(f.restEncoder,0),{missing:l,update:f.toUint8Array()}}return null},Dh=(s,e)=>Pr(s,e.doc.store,e.beforeState),Kr=(s,e,t,i=new Q(s))=>U(e,r=>{r.local=!1;let n=!1,o=r.doc,a=o.store,l=Nh(i,o),c=Eh(r,a,l),h=a.pendingStructs;if(h){for(let[u,f]of h.missing)if(f<L(a,u)){n=!0;break}if(c){for(let[u,f]of c.missing){let p=h.missing.get(u);(p==null||p>f)&&h.missing.set(u,f)}h.update=vs([h.update,c.update])}}else a.pendingStructs=c;let d=Bo(i,r,a);if(a.pendingDs){let u=new Q(O(a.pendingDs));x(u.restDecoder);let f=Bo(u,r,a);d&&f?a.pendingDs=vs([d,f]):a.pendingDs=d||f}else a.pendingDs=d;if(n){let u=a.pendingStructs.update;a.pendingStructs=null,ki(r.doc,u)}},t,!1),Lh=(s,e,t)=>Kr(s,e,t,new te(s)),ki=(s,e,t,i=Q)=>{let r=O(e);Kr(r,s,t,new i(r))},qr=(s,e,t)=>ki(s,e,t,te),$h=(s,e,t=new Map)=>{Pr(s,e.store,t),Se(s,Br(e.store))},ra=(s,e=new Uint8Array([0]),t=new ne)=>{let i=zr(e);$h(t,s,i);let r=[t.toUint8Array()];if(s.store.pendingDs&&r.push(s.store.pendingDs),s.store.pendingStructs&&r.push(Xr(s.store.pendingStructs.update,e)),r.length>1){if(t.constructor===xe)return ma(r.map((n,o)=>o===0?n:Sa(n)));if(t.constructor===ne)return vs(r)}return r[0]},Hr=(s,e)=>ra(s,e,new xe),na=s=>{let e=new Map,t=x(s.restDecoder);for(let i=0;i<t;i++){let r=x(s.restDecoder),n=x(s.restDecoder);e.set(r,n)}return e},zr=s=>na(new nt(O(s))),Wr=(s,e)=>(w(s.restEncoder,e.size),fe(e.entries()).sort((t,i)=>i[0]-t[0]).forEach(([t,i])=>{w(s.restEncoder,t),w(s.restEncoder,i)}),s),Mh=(s,e)=>Wr(s,Ns(e.store)),Oh=(s,e=new Ot)=>(s instanceof Map?Wr(e,s):Mh(e,s),e.toUint8Array()),Gr=s=>Oh(s,new je),Nr=class{constructor(){this.l=[]}},Po=()=>new Nr,Ko=(s,e)=>s.l.push(e),qo=(s,e)=>{let t=s.l,i=t.length;s.l=t.filter(r=>e!==r),i===s.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},oa=(s,e,t)=>hs(s.l,[e,t]),Ce=class{constructor(e,t){this.client=e,this.clock=t}},tt=(s,e)=>s===e||s!==null&&e!==null&&s.client===e.client&&s.clock===e.clock,k=(s,e)=>new Ce(s,e),Ho=(s,e)=>{w(s,e.client),w(s,e.clock)},zo=s=>k(x(s),x(s)),Jr=s=>{for(let[e,t]of s.doc.share.entries())if(t===s)return e;throw Z()},Ss=(s,e)=>{for(;e!==null;){if(e.parent===s)return!0;e=e.parent._item}return!1},Rh=s=>{let e=[],t=s._start;for(;t;)e.push(t),t=t.right;console.log("Children: ",e),console.log("Children content: ",e.filter(i=>!i.deleted).map(i=>i.content))},Er=class{constructor(e,t=e.getMap("users")){let i=new Map;this.yusers=t,this.doc=e,this.clients=new Map,this.dss=i;let r=(n,o)=>{let a=n.get("ds"),l=n.get("ids"),c=h=>this.clients.set(h,o);a.observe(h=>{h.changes.added.forEach(d=>{d.content.getContent().forEach(u=>{u instanceof Uint8Array&&this.dss.set(o,rt([this.dss.get(o)||xi(),Ue(new nt(O(u)))]))})})}),this.dss.set(o,rt(a.map(h=>Ue(new nt(O(h)))))),l.observe(h=>h.changes.added.forEach(d=>d.content.getContent().forEach(c))),l.forEach(c)};t.observe(n=>{n.keysChanged.forEach(o=>r(t.get(o),o))}),t.forEach(r)}setUserMapping(e,t,i,{filter:r=()=>!0}={}){let n=this.yusers,o=n.get(i);o||(o=new lt,o.set("ids",new at),o.set("ds",new at),n.set(i,o)),o.get("ids").push([t]),n.observe(a=>{setTimeout(()=>{let l=n.get(i);if(l!==o){o=l,this.clients.forEach((d,u)=>{i===d&&o.get("ids").push([u])});let c=new je,h=this.dss.get(i);h&&(Se(c,h),o.get("ds").push([c.toUint8Array()]))}},0)}),e.on("afterTransaction",a=>{setTimeout(()=>{let l=o.get("ds"),c=a.deleteSet;if(a.local&&c.clients.size>0&&r(a,c)){let h=new je;Se(h,c),l.push([h.toUint8Array()])}})})}getUserByClientId(e){return this.clients.get(e)||null}getUserByDeletedId(e){for(let[t,i]of this.dss.entries())if(ft(i,e))return t;return null}},Rt=class{constructor(e,t,i,r=0){this.type=e,this.tname=t,this.item=i,this.assoc=r}},Fh=s=>{let e={};return s.type&&(e.type=s.type),s.tname&&(e.tname=s.tname),s.item&&(e.item=s.item),s.assoc!=null&&(e.assoc=s.assoc),e},Vh=s=>new Rt(s.type==null?null:k(s.type.client,s.type.clock),s.tname??null,s.item==null?null:k(s.item.client,s.item.clock),s.assoc==null?0:s.assoc),di=class{constructor(e,t,i=0){this.type=e,this.index=t,this.assoc=i}},jh=(s,e,t=0)=>new di(s,e,t),ni=(s,e,t)=>{let i=null,r=null;return s._item===null?r=Jr(s):i=k(s._item.id.client,s._item.id.clock),new Rt(i,r,e,t)},Bh=(s,e,t=0)=>{let i=s._start;if(t<0){if(e===0)return ni(s,null,t);e--}for(;i!==null;){if(!i.deleted&&i.countable){if(i.length>e)return ni(s,k(i.id.client,i.id.clock+e),t);e-=i.length}if(i.right===null&&t<0)return ni(s,i.lastId,t);i=i.right}return ni(s,null,t)},Ph=(s,e)=>{let{type:t,tname:i,item:r,assoc:n}=e;if(r!==null)w(s,0),Ho(s,r);else if(i!==null)Ut(s,1),ye(s,i);else if(t!==null)Ut(s,2),Ho(s,t);else throw Z();return is(s,n),s},Kh=s=>{let e=M();return Ph(e,s),C(e)},qh=s=>{let e=null,t=null,i=null;switch(x(s)){case 0:i=zo(s);break;case 1:t=le(s);break;case 2:e=zo(s)}let r=ir(s)?os(s):0;return new Rt(e,t,i,r)},Hh=s=>qh(O(s)),zh=(s,e)=>{let t=st(s,e),i=e.clock-t.id.clock;return{item:t,diff:i}},Wh=(s,e,t=!0)=>{let i=e.store,r=s.item,n=s.type,o=s.tname,a=s.assoc,l=null,c=0;if(r!==null){if(L(i,r.client)<=r.clock)return null;let h=t?Fr(i,r):zh(i,r),d=h.item;if(!(d instanceof N))return null;if(l=d.parent,l._item===null||!l._item.deleted){c=d.deleted||!d.countable?0:h.diff+(a>=0?0:1);let u=d.left;for(;u!==null;)!u.deleted&&u.countable&&(c+=u.length),u=u.left}}else{if(o!==null)l=e.get(o);else if(n!==null){if(L(i,n.client)<=n.clock)return null;let{item:h}=t?Fr(i,n):{item:st(i,n)};if(h instanceof N&&h.content instanceof he)l=h.content.type;else return null}else throw Z();a>=0?c=l._length:c=0}return jh(l,c,s.assoc)},Gh=(s,e)=>s===e||s!==null&&e!==null&&s.tname===e.tname&&tt(s.item,e.item)&&tt(s.type,e.type)&&s.assoc===e.assoc,xs=class{constructor(e,t){this.ds=e,this.sv=t}},Jh=(s,e)=>{let t=s.ds.clients,i=e.ds.clients,r=s.sv,n=e.sv;if(r.size!==n.size||t.size!==i.size)return!1;for(let[o,a]of r.entries())if(n.get(o)!==a)return!1;for(let[o,a]of t.entries()){let l=i.get(o)||[];if(a.length!==l.length)return!1;for(let c=0;c<a.length;c++){let h=a[c],d=l[c];if(h.clock!==d.clock||h.len!==d.len)return!1}}return!0},aa=(s,e=new Ot)=>(Se(e,s.ds),Wr(e,s.sv),e.toUint8Array()),Yh=s=>aa(s,new je),la=(s,e=new hi(O(s)))=>new xs(Ue(e),na(e)),Xh=s=>la(s,new nt(O(s))),Yr=(s,e)=>new xs(s,e),Zh=Yr(xi(),new Map),Qh=s=>Yr(Br(s.store),Ns(s.store)),Me=(s,e)=>e===void 0?!s.deleted:e.sv.has(s.id.client)&&(e.sv.get(s.id.client)||0)>s.id.clock&&!ft(e.ds,s.id),Dr=(s,e)=>{let t=P(s.meta,Dr,me),i=s.doc.store;t.has(e)||(e.sv.forEach((r,n)=>{r<L(i,n)&&J(s,k(n,r))}),it(s,e.ds,r=>{}),t.add(e))},ed=(s,e,t=new Ve)=>{if(s.gc)throw new Error("Garbage-collection must be disabled in `originDoc`!");let{sv:i,ds:r}=e,n=new ne;return s.transact(o=>{let a=0;i.forEach(l=>{l>0&&a++}),w(n.restEncoder,a);for(let[l,c]of i){if(c===0)continue;c<L(s.store,l)&&J(o,k(l,c));let h=s.store.clients.get(l)||[],d=ce(h,c-1);w(n.restEncoder,d+1),n.writeClient(l),w(n.restEncoder,0);for(let u=0;u<=d;u++)h[u].write(n,0)}Se(n,r)}),ki(t,n.toUint8Array(),"snapshot"),t},td=(s,e,t=Q)=>{let i=new t(O(e)),r=new ke(i,!1);for(let o=r.curr;o!==null;o=r.next())if((s.sv.get(o.id.client)||0)<o.id.clock+o.length)return!1;let n=rt([s.ds,Ue(i)]);return sa(s.ds,n)},sd=(s,e)=>td(s,e,te),ui=class{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}},Ns=s=>{let e=new Map;return s.clients.forEach((t,i)=>{let r=t[t.length-1];e.set(i,r.id.clock+r.length)}),e},L=(s,e)=>{let t=s.clients.get(e);if(t===void 0)return 0;let i=t[t.length-1];return i.id.clock+i.length},ca=(s,e)=>{let t=s.clients.get(e.id.client);if(t===void 0)t=[],s.clients.set(e.id.client,t);else{let i=t[t.length-1];if(i.id.clock+i.length!==e.id.clock)throw Z()}t.push(e)},ce=(s,e)=>{let t=0,i=s.length-1,r=s[i],n=r.id.clock;if(n===e)return i;let o=ee(e/(n+r.length-1)*i);for(;t<=i;){if(r=s[o],n=r.id.clock,n<=e){if(e<n+r.length)return o;t=o+1}else i=o-1;o=ee((t+i)/2)}throw Z()},id=(s,e)=>{let t=s.clients.get(e.client);return t[ce(t,e.clock)]},st=id,Lr=(s,e,t)=>{let i=ce(e,t),r=e[i];return r.id.clock<t&&r instanceof N?(e.splice(i+1,0,Si(s,r,t-r.id.clock)),i+1):i},J=(s,e)=>{let t=s.doc.store.clients.get(e.client);return t[Lr(s,t,e.clock)]},$r=(s,e,t)=>{let i=e.clients.get(t.client),r=ce(i,t.clock),n=i[r];return t.clock!==n.id.clock+n.length-1&&n.constructor!==Y&&i.splice(r+1,0,Si(s,n,t.clock-n.id.clock+1)),n},rd=(s,e,t)=>{let i=s.clients.get(e.id.client);i[ce(i,e.id.clock)]=t},ha=(s,e,t,i,r)=>{if(i===0)return;let n=t+i,o=Lr(s,e,t),a;do a=e[o++],n<a.id.clock+a.length&&Lr(s,e,n),r(a);while(o<e.length&&e[o].id.clock<n)},fi=class{constructor(e,t,i){this.doc=e,this.deleteSet=new Fe,this.beforeState=Ns(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=i,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}},Wo=(s,e)=>e.deleteSet.clients.size===0&&!Pn(e.afterState,(t,i)=>e.beforeState.get(i)!==t)?!1:(jr(e.deleteSet),Dh(s,e),Se(s,e.deleteSet),!0),Go=(s,e,t)=>{let i=e._item;(i===null||i.id.clock<(s.beforeState.get(i.id.client)||0)&&!i.deleted)&&P(s.changed,e,me).add(t)},li=(s,e)=>{let t=s[e],i=s[e-1],r=e;for(;r>0;t=i,i=s[--r-1]){if(i.deleted===t.deleted&&i.constructor===t.constructor&&i.mergeWith(t)){t instanceof N&&t.parentSub!==null&&t.parent._map.get(t.parentSub)===t&&t.parent._map.set(t.parentSub,i);continue}break}let n=e-r;return n&&s.splice(e+1-n,n),n},da=(s,e,t)=>{for(let[i,r]of s.clients.entries()){let n=e.clients.get(i);for(let o=r.length-1;o>=0;o--){let a=r[o],l=a.clock+a.len;for(let c=ce(n,a.clock),h=n[c];c<n.length&&h.id.clock<l;h=n[++c]){let d=n[c];if(a.clock+a.len<=d.id.clock)break;d instanceof N&&d.deleted&&!d.keep&&t(d)&&d.gc(e,!1)}}}},ua=(s,e)=>{s.clients.forEach((t,i)=>{let r=e.clients.get(i);for(let n=t.length-1;n>=0;n--){let o=t[n],a=St(r.length-1,1+ce(r,o.clock+o.len-1));for(let l=a,c=r[l];l>0&&c.id.clock>=o.clock;c=r[l])l-=1+li(r,l)}})},nd=(s,e,t)=>{da(s,e,t),ua(s,e)},fa=(s,e)=>{if(e<s.length){let t=s[e],i=t.doc,r=i.store,n=t.deleteSet,o=t._mergeStructs;try{jr(n),t.afterState=Ns(t.doc.store),i.emit("beforeObserverCalls",[t,i]);let a=[];t.changed.forEach((l,c)=>a.push(()=>{(c._item===null||!c._item.deleted)&&c._callObserver(t,l)})),a.push(()=>{t.changedParentTypes.forEach((l,c)=>{c._dEH.l.length>0&&(c._item===null||!c._item.deleted)&&(l=l.filter(h=>h.target._item===null||!h.target._item.deleted),l.forEach(h=>{h.currentTarget=c,h._path=null}),l.sort((h,d)=>h.path.length-d.path.length),a.push(()=>{oa(c._dEH,l,t)}))}),a.push(()=>i.emit("afterTransaction",[t,i])),a.push(()=>{t._needFormattingCleanup&&Ad(t)})}),hs(a,[])}finally{i.gc&&da(n,r,i.gcFilter),ua(n,r),t.afterState.forEach((h,d)=>{let u=t.beforeState.get(d)||0;if(u!==h){let f=r.clients.get(d),p=Ie(ce(f,u),1);for(let g=f.length-1;g>=p;)g-=1+li(f,g)}});for(let h=o.length-1;h>=0;h--){let{client:d,clock:u}=o[h].id,f=r.clients.get(d),p=ce(f,u);p+1<f.length&&li(f,p+1)>1||p>0&&li(f,p)}if(!t.local&&t.afterState.get(i.clientID)!==t.beforeState.get(i.clientID)&&(ii(ys,ps,"[yjs] ",gs,ms,"Changed the client-id because another client seems to be using it."),i.clientID=ia()),i.emit("afterTransactionCleanup",[t,i]),i._observers.has("update")){let h=new xe;Wo(h,t)&&i.emit("update",[h.toUint8Array(),t.origin,i,t])}if(i._observers.has("updateV2")){let h=new ne;Wo(h,t)&&i.emit("updateV2",[h.toUint8Array(),t.origin,i,t])}let{subdocsAdded:a,subdocsLoaded:l,subdocsRemoved:c}=t;(a.size>0||c.size>0||l.size>0)&&(a.forEach(h=>{h.clientID=i.clientID,h.collectionid==null&&(h.collectionid=i.collectionid),i.subdocs.add(h)}),c.forEach(h=>i.subdocs.delete(h)),i.emit("subdocs",[{loaded:l,added:a,removed:c},i,t]),c.forEach(h=>h.destroy())),s.length<=e+1?(i._transactionCleanups=[],i.emit("afterAllTransactions",[i,s])):fa(s,e+1)}}},U=(s,e,t=null,i=!0)=>{let r=s._transactionCleanups,n=!1,o=null;s._transaction===null&&(n=!0,s._transaction=new fi(s,t,i),r.push(s._transaction),r.length===1&&s.emit("beforeAllTransactions",[s]),s.emit("beforeTransaction",[s._transaction,s]));try{o=e(s._transaction)}finally{if(n){let a=s._transaction===r[0];s._transaction=null,a&&fa(r,0)}}return o},Mr=class{constructor(e,t){this.insertions=t,this.deletions=e,this.meta=new Map}},Jo=(s,e,t)=>{it(s,t.deletions,i=>{i instanceof N&&e.scope.some(r=>r===s.doc||Ss(r,i))&&sn(i,!1)})},Yo=(s,e,t)=>{let i=null,r=s.doc,n=s.scope;U(r,a=>{for(;e.length>0&&s.currStackItem===null;){let l=r.store,c=e.pop(),h=new Set,d=[],u=!1;it(a,c.insertions,f=>{if(f instanceof N){if(f.redone!==null){let{item:p,diff:g}=Fr(l,f.id);g>0&&(p=J(a,k(p.id.client,p.id.clock+g))),f=p}!f.deleted&&n.some(p=>p===a.doc||Ss(p,f))&&d.push(f)}}),it(a,c.deletions,f=>{f instanceof N&&n.some(p=>p===a.doc||Ss(p,f))&&!ft(c.insertions,f.id)&&h.add(f)}),h.forEach(f=>{u=ja(a,f,h,c.insertions,s.ignoreRemoteMapChanges,s)!==null||u});for(let f=d.length-1;f>=0;f--){let p=d[f];s.deleteFilter(p)&&(p.delete(a),u=!0)}s.currStackItem=u?c:null}a.changed.forEach((l,c)=>{l.has(null)&&c._searchMarker&&(c._searchMarker.length=0)}),i=a},s);let o=s.currStackItem;if(o!=null){let a=i.changedParentTypes;s.emit("stack-item-popped",[{stackItem:o,type:t,changedParentTypes:a,origin:s},s]),s.currStackItem=null}return o},Or=class extends Ge{constructor(e,{captureTimeout:t=500,captureTransaction:i=l=>!0,deleteFilter:r=()=>!0,trackedOrigins:n=new Set([null]),ignoreRemoteMapChanges:o=!1,doc:a=Zt(e)?e[0].doc:e instanceof Ve?e:e.doc}={}){super(),this.scope=[],this.doc=a,this.addToScope(e),this.deleteFilter=r,n.add(this),this.trackedOrigins=n,this.captureTransaction=i,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=o,this.captureTimeout=t,this.afterTransactionHandler=l=>{if(!this.captureTransaction(l)||!this.scope.some(m=>l.changedParentTypes.has(m)||m===this.doc)||!this.trackedOrigins.has(l.origin)&&(!l.origin||!this.trackedOrigins.has(l.origin.constructor)))return;let c=this.undoing,h=this.redoing,d=c?this.redoStack:this.undoStack;c?this.stopCapturing():h||this.clear(!1,!0);let u=new Fe;l.afterState.forEach((m,y)=>{let _=l.beforeState.get(y)||0,S=m-_;S>0&&bs(u,y,_,S)});let f=re(),p=!1;if(this.lastChange>0&&f-this.lastChange<this.captureTimeout&&d.length>0&&!c&&!h){let m=d[d.length-1];m.deletions=rt([m.deletions,l.deleteSet]),m.insertions=rt([m.insertions,u])}else d.push(new Mr(l.deleteSet,u)),p=!0;!c&&!h&&(this.lastChange=f),it(l,l.deleteSet,m=>{m instanceof N&&this.scope.some(y=>y===l.doc||Ss(y,m))&&sn(m,!0)});let g=[{stackItem:d[d.length-1],origin:l.origin,type:c?"redo":"undo",changedParentTypes:l.changedParentTypes},this];p?this.emit("stack-item-added",g):this.emit("stack-item-updated",g)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(e){let t=new Set(this.scope);e=Zt(e)?e:[e],e.forEach(i=>{t.has(i)||(t.add(i),(i instanceof R?i.doc!==this.doc:i!==this.doc)&&Ar("[yjs#509] Not same Y.Doc"),this.scope.push(i))})}addTrackedOrigin(e){this.trackedOrigins.add(e)}removeTrackedOrigin(e){this.trackedOrigins.delete(e)}clear(e=!0,t=!0){(e&&this.canUndo()||t&&this.canRedo())&&this.doc.transact(i=>{e&&(this.undoStack.forEach(r=>Jo(i,this,r)),this.undoStack=[]),t&&(this.redoStack.forEach(r=>Jo(i,this,r)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:e,redoStackCleared:t}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let e;try{e=Yo(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}redo(){this.redoing=!0;let e;try{e=Yo(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}};ke=class{constructor(e,t){this.gen=od(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===H);return this.curr}},ad=s=>pa(s,te),pa=(s,e=Q)=>{let t=[],i=new e(O(s)),r=new ke(i,!1);for(let o=r.curr;o!==null;o=r.next())t.push(o);ii("Structs: ",t);let n=Ue(i);ii("DeleteSet: ",n)},ld=s=>ga(s,te),ga=(s,e=Q)=>{let t=[],i=new e(O(s)),r=new ke(i,!1);for(let n=r.curr;n!==null;n=r.next())t.push(n);return{structs:t,ds:Ue(i)}},ks=class{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}},ma=s=>vs(s,te,xe),ya=(s,e=Ot,t=Q)=>{let i=new e,r=new ke(new t(O(s)),!1),n=r.curr;if(n!==null){let o=0,a=n.id.client,l=n.id.clock!==0,c=l?0:n.id.clock+n.length;for(;n!==null;n=r.next())a!==n.id.client&&(c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c)),a=n.id.client,c=0,l=n.id.clock!==0),n.constructor===H&&(l=!0),l||(c=n.id.clock+n.length);c!==0&&(o++,w(i.restEncoder,a),w(i.restEncoder,c));let h=M();return w(h,o),so(h,i.restEncoder),i.restEncoder=h,i.toUint8Array()}else return w(i.restEncoder,0),i.toUint8Array()},cd=s=>ya(s,je,te),wa=(s,e=Q)=>{let t=new Map,i=new Map,r=new ke(new e(O(s)),!1),n=r.curr;if(n!==null){let o=n.id.client,a=n.id.clock;for(t.set(o,a);n!==null;n=r.next())o!==n.id.client&&(i.set(o,a),t.set(n.id.client,n.id.clock),o=n.id.client),a=n.id.clock+n.length;i.set(o,a)}return{from:t,to:i}},hd=s=>wa(s,te),dd=(s,e)=>{if(s.constructor===Y){let{client:t,clock:i}=s.id;return new Y(k(t,i+e),s.length-e)}else if(s.constructor===H){let{client:t,clock:i}=s.id;return new H(k(t,i+e),s.length-e)}else{let t=s,{client:i,clock:r}=t.id;return new N(k(i,r+e),null,k(i,r+e-1),null,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e))}},vs=(s,e=Q,t=ne)=>{if(s.length===1)return s[0];let i=s.map(h=>new e(O(h))),r=i.map(h=>new ke(h,!0)),n=null,o=new t,a=new ks(o);for(;r=r.filter(u=>u.curr!==null),r.sort((u,f)=>{if(u.curr.id.client===f.curr.id.client){let p=u.curr.id.clock-f.curr.id.clock;return p===0?u.curr.constructor===f.curr.constructor?0:u.curr.constructor===H?1:-1:p}else return f.curr.id.client-u.curr.id.client}),r.length!==0;){let h=r[0],d=h.curr.id.client;if(n!==null){let u=h.curr,f=!1;for(;u!==null&&u.id.clock+u.length<=n.struct.id.clock+n.struct.length&&u.id.client>=n.struct.id.client;)u=h.next(),f=!0;if(u===null||u.id.client!==d||f&&u.id.clock>n.struct.id.clock+n.struct.length)continue;if(d!==n.struct.id.client)Oe(a,n.struct,n.offset),n={struct:u,offset:0},h.next();else if(n.struct.id.clock+n.struct.length<u.id.clock)if(n.struct.constructor===H)n.struct.length=u.id.clock+u.length-n.struct.id.clock;else{Oe(a,n.struct,n.offset);let p=u.id.clock-n.struct.id.clock-n.struct.length;n={struct:new H(k(d,n.struct.id.clock+n.struct.length),p),offset:0}}else{let p=n.struct.id.clock+n.struct.length-u.id.clock;p>0&&(n.struct.constructor===H?n.struct.length-=p:u=dd(u,p)),n.struct.mergeWith(u)||(Oe(a,n.struct,n.offset),n={struct:u,offset:0},h.next())}}else n={struct:h.curr,offset:0},h.next();for(let u=h.curr;u!==null&&u.id.client===d&&u.id.clock===n.struct.id.clock+n.struct.length&&u.constructor!==H;u=h.next())Oe(a,n.struct,n.offset),n={struct:u,offset:0}}n!==null&&(Oe(a,n.struct,n.offset),n=null),Zr(a);let l=i.map(h=>Ue(h)),c=rt(l);return Se(o,c),o.toUint8Array()},Xr=(s,e,t=Q,i=ne)=>{let r=zr(e),n=new i,o=new ks(n),a=new t(O(s)),l=new ke(a,!1);for(;l.curr;){let h=l.curr,d=h.id.client,u=r.get(d)||0;if(l.curr.constructor===H){l.next();continue}if(h.id.clock+h.length>u)for(Oe(o,h,Ie(u-h.id.clock,0)),l.next();l.curr&&l.curr.id.client===d;)Oe(o,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===d&&l.curr.id.clock+l.curr.length<=u;)l.next()}Zr(o);let c=Ue(a);return Se(n,c),n.toUint8Array()},ud=(s,e)=>Xr(s,e,te,xe),_a=s=>{s.written>0&&(s.clientStructs.push({written:s.written,restEncoder:C(s.encoder.restEncoder)}),s.encoder.restEncoder=M(),s.written=0)},Oe=(s,e,t)=>{s.written>0&&s.currClient!==e.id.client&&_a(s),s.written===0&&(s.currClient=e.id.client,s.encoder.writeClient(e.id.client),w(s.encoder.restEncoder,e.id.clock+t)),e.write(s.encoder,t),s.written++},Zr=s=>{_a(s);let e=s.encoder.restEncoder;w(e,s.clientStructs.length);for(let t=0;t<s.clientStructs.length;t++){let i=s.clientStructs[t];w(e,i.written),Nt(e,i.restEncoder)}},vi=(s,e,t,i)=>{let r=new t(O(s)),n=new ke(r,!1),o=new i,a=new ks(o);for(let c=n.curr;c!==null;c=n.next())Oe(a,e(c),0);Zr(a);let l=Ue(r);return Se(o,l),o.toUint8Array()},ba=({formatting:s=!0,subdocs:e=!0,yxml:t=!0}={})=>{let i=0,r=V(),n=V(),o=V(),a=V();return a.set(null,null),l=>{switch(l.constructor){case Y:case H:return l;case N:{let c=l,h=c.content;switch(h.constructor){case jt:break;case he:{if(t){let d=h.type;d instanceof ht&&(d.nodeName=P(n,d.nodeName,()=>"node-"+i)),d instanceof Cs&&(d.hookName=P(n,d.hookName,()=>"hook-"+i))}break}case Be:{let d=h;d.arr=d.arr.map(()=>i);break}case dt:{let d=h;d.content=new Uint8Array([i]);break}case ut:{let d=h;e&&(d.opts={},d.doc.guid=i+"");break}case Ne:{let d=h;d.embed={};break}case F:{let d=h;s&&(d.key=P(o,d.key,()=>i+""),d.value=P(a,d.value,()=>({i})));break}case Us:{let d=h;d.arr=d.arr.map(()=>i);break}case ge:{let d=h;d.str=Xn(i%10+"",d.str.length);break}default:Z()}return c.parentSub&&(c.parentSub=P(r,c.parentSub,()=>i+"")),i++,l}default:Z()}}},fd=(s,e)=>vi(s,ba(e),te,xe),pd=(s,e)=>vi(s,ba(e),Q,ne),gd=s=>vi(s,mr,te,ne),Sa=s=>vi(s,mr,Q,xe),Xo="You must not compute changes after the event-handler fired.",ot=class{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=md(this.currentTarget,this.target))}deletes(e){return ft(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw we(Xo);let e=new Map,t=this.target;this.transaction.changed.get(t).forEach(r=>{if(r!==null){let n=t._map.get(r),o,a;if(this.adds(n)){let l=n.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(n))if(l!==null&&this.deletes(l))o="delete",a=qs(l.content.getContent());else return;else l!==null&&this.deletes(l)?(o="update",a=qs(l.content.getContent())):(o="add",a=void 0)}else if(this.deletes(n))o="delete",a=qs(n.content.getContent());else return;e.set(r,{action:o,oldValue:a})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw we(Xo);let t=this.target,i=me(),r=me(),n=[];if(e={added:i,deleted:r,delta:n,keys:this.keys},this.transaction.changed.get(t).has(null)){let a=null,l=()=>{a&&n.push(a)};for(let c=t._start;c!==null;c=c.right)c.deleted?this.deletes(c)&&!this.adds(c)&&((a===null||a.delete===void 0)&&(l(),a={delete:0}),a.delete+=c.length,r.add(c)):this.adds(c)?((a===null||a.insert===void 0)&&(l(),a={insert:[]}),a.insert=a.insert.concat(c.content.getContent()),i.add(c)):((a===null||a.retain===void 0)&&(l(),a={retain:0}),a.retain+=c.length);a!==null&&a.retain===void 0&&l()}this._changes=e}return e}},md=(s,e)=>{let t=[];for(;e._item!==null&&e!==s;){if(e._item.parentSub!==null)t.unshift(e._item.parentSub);else{let i=0,r=e._item.parent._start;for(;r!==e._item&&r!==null;)!r.deleted&&r.countable&&(i+=r.length),r=r.right;t.unshift(i)}e=e._item.parent}return t},z=()=>{Ar("Invalid access: Add Yjs type to a document before reading data.")},xa=80,Qr=0,Rr=class{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=Qr++}},yd=s=>{s.timestamp=Qr++},ka=(s,e,t)=>{s.p.marker=!1,s.p=e,e.marker=!0,s.index=t,s.timestamp=Qr++},wd=(s,e,t)=>{if(s.length>=xa){let i=s.reduce((r,n)=>r.timestamp<n.timestamp?r:n);return ka(i,e,t),i}else{let i=new Rr(e,t);return s.push(i),i}},Ti=(s,e)=>{if(s._start===null||e===0||s._searchMarker===null)return null;let t=s._searchMarker.length===0?null:s._searchMarker.reduce((n,o)=>bt(e-n.index)<bt(e-o.index)?n:o),i=s._start,r=0;for(t!==null&&(i=t.p,r=t.index,yd(t));i.right!==null&&r<e;){if(!i.deleted&&i.countable){if(e<r+i.length)break;r+=i.length}i=i.right}for(;i.left!==null&&r>e;)i=i.left,!i.deleted&&i.countable&&(r-=i.length);for(;i.left!==null&&i.left.id.client===i.id.client&&i.left.id.clock+i.left.length===i.id.clock;)i=i.left,!i.deleted&&i.countable&&(r-=i.length);return t!==null&&bt(t.index-r)<i.parent.length/xa?(ka(t,i,r),t):wd(s._searchMarker,i,r)},Ts=(s,e,t)=>{for(let i=s.length-1;i>=0;i--){let r=s[i];if(t>0){let n=r.p;for(n.marker=!1;n&&(n.deleted||!n.countable);)n=n.left,n&&!n.deleted&&n.countable&&(r.index-=n.length);if(n===null||n.marker===!0){s.splice(i,1);continue}r.p=n,n.marker=!0}(e<r.index||t>0&&e===r.index)&&(r.index=Ie(e,r.index+t))}},_d=s=>{s.doc??z();let e=s._start,t=[];for(;e;)t.push(e),e=e.right;return t},Ii=(s,e,t)=>{let i=s,r=e.changedParentTypes;for(;P(r,s,()=>[]).push(t),s._item!==null;)s=s._item.parent;oa(i._eH,t,e)},R=class{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Po(),this._dEH=Po(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw pe()}clone(){throw pe()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){Ko(this._eH,e)}observeDeep(e){Ko(this._dEH,e)}unobserve(e){qo(this._eH,e)}unobserveDeep(e){qo(this._dEH,e)}toJSON(){}},va=(s,e,t)=>{s.doc??z(),e<0&&(e=s._length+e),t<0&&(t=s._length+t);let i=t-e,r=[],n=s._start;for(;n!==null&&i>0;){if(n.countable&&!n.deleted){let o=n.content.getContent();if(o.length<=e)e-=o.length;else{for(let a=e;a<o.length&&i>0;a++)r.push(o[a]),i--;e=0}}n=n.right}return r},Ta=s=>{s.doc??z();let e=[],t=s._start;for(;t!==null;){if(t.countable&&!t.deleted){let i=t.content.getContent();for(let r=0;r<i.length;r++)e.push(i[r])}t=t.right}return e},bd=(s,e)=>{let t=[],i=s._start;for(;i!==null;){if(i.countable&&Me(i,e)){let r=i.content.getContent();for(let n=0;n<r.length;n++)t.push(r[n])}i=i.right}return t},Is=(s,e)=>{let t=0,i=s._start;for(s.doc??z();i!==null;){if(i.countable&&!i.deleted){let r=i.content.getContent();for(let n=0;n<r.length;n++)e(r[n],t++,s)}i=i.right}},Ia=(s,e)=>{let t=[];return Is(s,(i,r)=>{t.push(e(i,r,s))}),t},Sd=s=>{let e=s._start,t=null,i=0;return{[Symbol.iterator](){return this},next:()=>{if(t===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};t=e.content.getContent(),i=0,e=e.right}let r=t[i++];return t.length<=i&&(t=null),{done:!1,value:r}}}},Aa=(s,e)=>{s.doc??z();let t=Ti(s,e),i=s._start;for(t!==null&&(i=t.p,e-=t.index);i!==null;i=i.right)if(!i.deleted&&i.countable){if(e<i.length)return i.content.getContent()[e];e-=i.length}},pi=(s,e,t,i)=>{let r=t,n=s.doc,o=n.clientID,a=n.store,l=t===null?e._start:t.right,c=[],h=()=>{c.length>0&&(r=new N(k(o,L(a,o)),r,r&&r.lastId,l,l&&l.id,e,null,new Be(c)),r.integrate(s,0),c=[])};i.forEach(d=>{if(d===null)c.push(d);else switch(d.constructor){case Number:case Object:case Boolean:case Array:case String:c.push(d);break;default:switch(h(),d.constructor){case Uint8Array:case ArrayBuffer:r=new N(k(o,L(a,o)),r,r&&r.lastId,l,l&&l.id,e,null,new dt(new Uint8Array(d))),r.integrate(s,0);break;case Ve:r=new N(k(o,L(a,o)),r,r&&r.lastId,l,l&&l.id,e,null,new ut(d)),r.integrate(s,0);break;default:if(d instanceof R)r=new N(k(o,L(a,o)),r,r&&r.lastId,l,l&&l.id,e,null,new he(d)),r.integrate(s,0);else throw new Error("Unexpected content type in insert operation")}}}),h()},Ca=()=>we("Length exceeded!"),Ua=(s,e,t,i)=>{if(t>e._length)throw Ca();if(t===0)return e._searchMarker&&Ts(e._searchMarker,t,i.length),pi(s,e,null,i);let r=t,n=Ti(e,t),o=e._start;for(n!==null&&(o=n.p,t-=n.index,t===0&&(o=o.prev,t+=o&&o.countable&&!o.deleted?o.length:0));o!==null;o=o.right)if(!o.deleted&&o.countable){if(t<=o.length){t<o.length&&J(s,k(o.id.client,o.id.clock+t));break}t-=o.length}return e._searchMarker&&Ts(e._searchMarker,r,i.length),pi(s,e,o,i)},xd=(s,e,t)=>{let r=(e._searchMarker||[]).reduce((n,o)=>o.index>n.index?o:n,{index:0,p:e._start}).p;if(r)for(;r.right;)r=r.right;return pi(s,e,r,t)},Na=(s,e,t,i)=>{if(i===0)return;let r=t,n=i,o=Ti(e,t),a=e._start;for(o!==null&&(a=o.p,t-=o.index);a!==null&&t>0;a=a.right)!a.deleted&&a.countable&&(t<a.length&&J(s,k(a.id.client,a.id.clock+t)),t-=a.length);for(;i>0&&a!==null;)a.deleted||(i<a.length&&J(s,k(a.id.client,a.id.clock+i)),a.delete(s),i-=a.length),a=a.right;if(i>0)throw Ca();e._searchMarker&&Ts(e._searchMarker,r,-n+i)},gi=(s,e,t)=>{let i=e._map.get(t);i!==void 0&&i.delete(s)},en=(s,e,t,i)=>{let r=e._map.get(t)||null,n=s.doc,o=n.clientID,a;if(i==null)a=new Be([i]);else switch(i.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:a=new Be([i]);break;case Uint8Array:a=new dt(i);break;case Ve:a=new ut(i);break;default:if(i instanceof R)a=new he(i);else throw new Error("Unexpected content type")}new N(k(o,L(n.store,o)),r,r&&r.lastId,null,null,e,t,a).integrate(s,0)},tn=(s,e)=>{s.doc??z();let t=s._map.get(e);return t!==void 0&&!t.deleted?t.content.getContent()[t.length-1]:void 0},Ea=s=>{let e={};return s.doc??z(),s._map.forEach((t,i)=>{t.deleted||(e[i]=t.content.getContent()[t.length-1])}),e},Da=(s,e)=>{s.doc??z();let t=s._map.get(e);return t!==void 0&&!t.deleted},kd=(s,e,t)=>{let i=s._map.get(e)||null;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;return i!==null&&Me(i,t)?i.content.getContent()[i.length-1]:void 0},La=(s,e)=>{let t={};return s._map.forEach((i,r)=>{let n=i;for(;n!==null&&(!e.sv.has(n.id.client)||n.id.clock>=(e.sv.get(n.id.client)||0));)n=n.left;n!==null&&Me(n,e)&&(t[r]=n.content.getContent()[n.length-1])}),t},oi=s=>(s.doc??z(),Ro(s._map.entries(),e=>!e[1].deleted)),mi=class extends ot{},at=class s extends R{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){let t=new s;return t.push(e),t}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return e.insert(0,this.toArray().map(t=>t instanceof R?t.clone():t)),e}get length(){return this.doc??z(),this._length}_callObserver(e,t){super._callObserver(e,t),Ii(this,e,new mi(this,e))}insert(e,t){this.doc!==null?U(this.doc,i=>{Ua(i,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){this.doc!==null?U(this.doc,t=>{xd(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){this.doc!==null?U(this.doc,i=>{Na(i,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return Aa(this,e)}toArray(){return Ta(this)}slice(e=0,t=this.length){return va(this,e,t)}toJSON(){return this.map(e=>e instanceof R?e.toJSON():e)}map(e){return Ia(this,e)}forEach(e){Is(this,e)}[Symbol.iterator](){return Sd(this)}_write(e){e.writeTypeRef(qd)}},vd=s=>new at,yi=class extends ot{constructor(e,t,i){super(e,t),this.keysChanged=i}},lt=class s extends R{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((i,r)=>{this.set(r,i)}),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return this.forEach((t,i)=>{e.set(i,t instanceof R?t.clone():t)}),e}_callObserver(e,t){Ii(this,e,new yi(this,e,t))}toJSON(){this.doc??z();let e={};return this._map.forEach((t,i)=>{if(!t.deleted){let r=t.content.getContent()[t.length-1];e[i]=r instanceof R?r.toJSON():r}}),e}get size(){return[...oi(this)].length}keys(){return ri(oi(this),e=>e[0])}values(){return ri(oi(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return ri(oi(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??z(),this._map.forEach((t,i)=>{t.deleted||e(t.content.getContent()[t.length-1],i,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?U(this.doc,t=>{gi(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return this.doc!==null?U(this.doc,i=>{en(i,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return tn(this,e)}has(e){return Da(this,e)}clear(){this.doc!==null?U(this.doc,e=>{this.forEach(function(t,i,r){gi(e,r,i)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Hd)}},Td=s=>new lt,Re=(s,e)=>s===e||typeof s=="object"&&typeof e=="object"&&s&&e&&fr(s,e),As=class{constructor(e,t,i,r){this.left=e,this.right=t,this.index=i,this.currentAttributes=r}forward(){switch(this.right===null&&Z(),this.right.content.constructor){case F:this.right.deleted||Bt(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}},Zo=(s,e,t)=>{for(;e.right!==null&&t>0;){switch(e.right.content.constructor){case F:e.right.deleted||Bt(e.currentAttributes,e.right.content);break;default:e.right.deleted||(t<e.right.length&&J(s,k(e.right.id.client,e.right.id.clock+t)),e.index+=e.right.length,t-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},ai=(s,e,t,i)=>{let r=new Map,n=i?Ti(e,t):null;if(n){let o=new As(n.p.left,n.p,n.index,r);return Zo(s,o,t-n.index)}else{let o=new As(null,e._start,0,r);return Zo(s,o,t)}},$a=(s,e,t,i)=>{for(;t.right!==null&&(t.right.deleted===!0||t.right.content.constructor===F&&Re(i.get(t.right.content.key),t.right.content.value));)t.right.deleted||i.delete(t.right.content.key),t.forward();let r=s.doc,n=r.clientID;i.forEach((o,a)=>{let l=t.left,c=t.right,h=new N(k(n,L(r.store,n)),l,l&&l.lastId,c,c&&c.id,e,null,new F(a,o));h.integrate(s,0),t.right=h,t.forward()})},Bt=(s,e)=>{let{key:t,value:i}=e;i===null?s.delete(t):s.set(t,i)},Ma=(s,e)=>{for(;s.right!==null;){if(!(s.right.deleted||s.right.content.constructor===F&&Re(e[s.right.content.key]??null,s.right.content.value)))break;s.forward()}},Oa=(s,e,t,i)=>{let r=s.doc,n=r.clientID,o=new Map;for(let a in i){let l=i[a],c=t.currentAttributes.get(a)??null;if(!Re(c,l)){o.set(a,c);let{left:h,right:d}=t;t.right=new N(k(n,L(r.store,n)),h,h&&h.lastId,d,d&&d.id,e,null,new F(a,l)),t.right.integrate(s,0),t.forward()}}return o},Cr=(s,e,t,i,r)=>{t.currentAttributes.forEach((u,f)=>{r[f]===void 0&&(r[f]=null)});let n=s.doc,o=n.clientID;Ma(t,r);let a=Oa(s,e,t,r),l=i.constructor===String?new ge(i):i instanceof R?new he(i):new Ne(i),{left:c,right:h,index:d}=t;e._searchMarker&&Ts(e._searchMarker,t.index,l.getLength()),h=new N(k(o,L(n.store,o)),c,c&&c.lastId,h,h&&h.id,e,null,l),h.integrate(s,0),t.right=h,t.index=d,t.forward(),$a(s,e,t,a)},Qo=(s,e,t,i,r)=>{let n=s.doc,o=n.clientID;Ma(t,r);let a=Oa(s,e,t,r);e:for(;t.right!==null&&(i>0||a.size>0&&(t.right.deleted||t.right.content.constructor===F));){if(!t.right.deleted)switch(t.right.content.constructor){case F:{let{key:l,value:c}=t.right.content,h=r[l];if(h!==void 0){if(Re(h,c))a.delete(l);else{if(i===0)break e;a.set(l,c)}t.right.delete(s)}else t.currentAttributes.set(l,c);break}default:i<t.right.length&&J(s,k(t.right.id.client,t.right.id.clock+i)),i-=t.right.length;break}t.forward()}if(i>0){let l="";for(;i>0;i--)l+=`
`;t.right=new N(k(o,L(n.store,o)),t.left,t.left&&t.left.lastId,t.right,t.right&&t.right.id,e,null,new ge(l)),t.right.integrate(s,0),t.forward()}$a(s,e,t,a)},Ra=(s,e,t,i,r)=>{let n=e,o=V();for(;n&&(!n.countable||n.deleted);){if(!n.deleted&&n.content.constructor===F){let c=n.content;o.set(c.key,c)}n=n.right}let a=0,l=!1;for(;e!==n;){if(t===e&&(l=!0),!e.deleted){let c=e.content;switch(c.constructor){case F:{let{key:h,value:d}=c,u=i.get(h)??null;(o.get(h)!==c||u===d)&&(e.delete(s),a++,!l&&(r.get(h)??null)===d&&u!==d&&(u===null?r.delete(h):r.set(h,u))),!l&&!e.deleted&&Bt(r,c);break}}}e=e.right}return a},Id=(s,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;let t=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===F){let i=e.content.key;t.has(i)?e.delete(s):t.add(i)}e=e.left}},Fa=s=>{let e=0;return U(s.doc,t=>{let i=s._start,r=s._start,n=V(),o=Bs(n);for(;r;){if(r.deleted===!1)switch(r.content.constructor){case F:Bt(o,r.content);break;default:e+=Ra(t,i,r,n,o),n=Bs(o),i=r;break}r=r.right}}),e},Ad=s=>{let e=new Set,t=s.doc;for(let[i,r]of s.afterState.entries()){let n=s.beforeState.get(i)||0;r!==n&&ha(s,t.store.clients.get(i),n,r,o=>{!o.deleted&&o.content.constructor===F&&o.constructor!==Y&&e.add(o.parent)})}U(t,i=>{it(s,s.deleteSet,r=>{if(r instanceof Y||!r.parent._hasFormatting||e.has(r.parent))return;let n=r.parent;r.content.constructor===F?e.add(n):Id(i,r)});for(let r of e)Fa(r)})},ea=(s,e,t)=>{let i=t,r=Bs(e.currentAttributes),n=e.right;for(;t>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case he:case Ne:case ge:t<e.right.length&&J(s,k(e.right.id.client,e.right.id.clock+t)),t-=e.right.length,e.right.delete(s);break}e.forward()}n&&Ra(s,n,e.right,r,e.currentAttributes);let o=(e.left||e.right).parent;return o._searchMarker&&Ts(o._searchMarker,e.index,-i+t),e},wi=class extends ot{constructor(e,t,i){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,i.forEach(r=>{r===null?this.childListChanged=!0:this.keysChanged.add(r)})}get changes(){if(this._changes===null){let e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){let e=this.target.doc,t=[];U(e,i=>{let r=new Map,n=new Map,o=this.target._start,a=null,l={},c="",h=0,d=0,u=()=>{if(a!==null){let f=null;switch(a){case"delete":d>0&&(f={delete:d}),d=0;break;case"insert":(typeof c=="object"||c.length>0)&&(f={insert:c},r.size>0&&(f.attributes={},r.forEach((p,g)=>{p!==null&&(f.attributes[g]=p)}))),c="";break;case"retain":h>0&&(f={retain:h},xo(l)||(f.attributes=_o({},l))),h=0;break}f&&t.push(f),a=null}};for(;o!==null;){switch(o.content.constructor){case he:case Ne:this.adds(o)?this.deletes(o)||(u(),a="insert",c=o.content.getContent()[0],u()):this.deletes(o)?(a!=="delete"&&(u(),a="delete"),d+=1):o.deleted||(a!=="retain"&&(u(),a="retain"),h+=1);break;case ge:this.adds(o)?this.deletes(o)||(a!=="insert"&&(u(),a="insert"),c+=o.content.str):this.deletes(o)?(a!=="delete"&&(u(),a="delete"),d+=o.length):o.deleted||(a!=="retain"&&(u(),a="retain"),h+=o.length);break;case F:{let{key:f,value:p}=o.content;if(this.adds(o)){if(!this.deletes(o)){let g=r.get(f)??null;Re(g,p)?p!==null&&o.delete(i):(a==="retain"&&u(),Re(p,n.get(f)??null)?delete l[f]:l[f]=p)}}else if(this.deletes(o)){n.set(f,p);let g=r.get(f)??null;Re(g,p)||(a==="retain"&&u(),l[f]=g)}else if(!o.deleted){n.set(f,p);let g=l[f];g!==void 0&&(Re(g,p)?g!==null&&o.delete(i):(a==="retain"&&u(),p===null?delete l[f]:l[f]=p))}o.deleted||(a==="insert"&&u(),Bt(r,o.content));break}}o=o.right}for(u();t.length>0;){let f=t[t.length-1];if(f.retain!==void 0&&f.attributes===void 0)t.pop();else break}}),this._delta=t}return this._delta}},Ft=class s extends R{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??z(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(i=>i())}catch(i){console.error(i)}this._pending=null}_copy(){return new s}clone(){let e=new s;return e.applyDelta(this.toDelta()),e}_callObserver(e,t){super._callObserver(e,t);let i=new wi(this,e,t);Ii(this,e,i),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??z();let e="",t=this._start;for(;t!==null;)!t.deleted&&t.countable&&t.content.constructor===ge&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){this.doc!==null?U(this.doc,i=>{let r=new As(null,this._start,0,new Map);for(let n=0;n<e.length;n++){let o=e[n];if(o.insert!==void 0){let a=!t&&typeof o.insert=="string"&&n===e.length-1&&r.right===null&&o.insert.slice(-1)===`
`?o.insert.slice(0,-1):o.insert;(typeof a!="string"||a.length>0)&&Cr(i,this,r,a,o.attributes||{})}else o.retain!==void 0?Qo(i,this,r,o.retain,o.attributes||{}):o.delete!==void 0&&ea(i,r,o.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,i){this.doc??z();let r=[],n=new Map,o=this.doc,a="",l=this._start;function c(){if(a.length>0){let d={},u=!1;n.forEach((p,g)=>{u=!0,d[g]=p});let f={insert:a};u&&(f.attributes=d),r.push(f),a=""}}let h=()=>{for(;l!==null;){if(Me(l,e)||t!==void 0&&Me(l,t))switch(l.content.constructor){case ge:{let d=n.get("ychange");e!==void 0&&!Me(l,e)?(d===void 0||d.user!==l.id.client||d.type!=="removed")&&(c(),n.set("ychange",i?i("removed",l.id):{type:"removed"})):t!==void 0&&!Me(l,t)?(d===void 0||d.user!==l.id.client||d.type!=="added")&&(c(),n.set("ychange",i?i("added",l.id):{type:"added"})):d!==void 0&&(c(),n.delete("ychange")),a+=l.content.str;break}case he:case Ne:{c();let d={insert:l.content.getContent()[0]};if(n.size>0){let u={};d.attributes=u,n.forEach((f,p)=>{u[p]=f})}r.push(d);break}case F:Me(l,e)&&(c(),Bt(n,l.content));break}l=l.right}c()};return e||t?U(o,d=>{e&&Dr(d,e),t&&Dr(d,t),h()},"cleanup"):h(),r}insert(e,t,i){if(t.length<=0)return;let r=this.doc;r!==null?U(r,n=>{let o=ai(n,this,e,!i);i||(i={},o.currentAttributes.forEach((a,l)=>{i[l]=a})),Cr(n,this,o,t,i)}):this._pending.push(()=>this.insert(e,t,i))}insertEmbed(e,t,i){let r=this.doc;r!==null?U(r,n=>{let o=ai(n,this,e,!i);Cr(n,this,o,t,i||{})}):this._pending.push(()=>this.insertEmbed(e,t,i||{}))}delete(e,t){if(t===0)return;let i=this.doc;i!==null?U(i,r=>{ea(r,ai(r,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,i){if(t===0)return;let r=this.doc;r!==null?U(r,n=>{let o=ai(n,this,e,!1);o.right!==null&&Qo(n,this,o,t,i)}):this._pending.push(()=>this.format(e,t,i))}removeAttribute(e){this.doc!==null?U(this.doc,t=>{gi(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){this.doc!==null?U(this.doc,i=>{en(i,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return tn(this,e)}getAttributes(){return Ea(this)}_write(e){e.writeTypeRef(zd)}},Cd=s=>new Ft,ws=class{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??z()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(t)))do if(t=e.content.type,!e.deleted&&(t.constructor===ht||t.constructor===ct)&&t._start!==null)e=t._start;else for(;e!==null;){let i=e.next;if(i!==null){e=i;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}},ct=class s extends R{constructor(){super(),this._prelimContent=[]}get firstChild(){let e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new s}clone(){let e=new s;return e.insert(0,this.toArray().map(t=>t instanceof R?t.clone():t)),e}get length(){return this.doc??z(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new ws(this,e)}querySelector(e){e=e.toUpperCase();let i=new ws(this,r=>r.nodeName&&r.nodeName.toUpperCase()===e).next();return i.done?null:i.value}querySelectorAll(e){return e=e.toUpperCase(),fe(new ws(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){Ii(this,e,new _i(this,t,e))}toString(){return Ia(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},i){let r=e.createDocumentFragment();return i!==void 0&&i._createAssociation(r,this),Is(this,n=>{r.insertBefore(n.toDOM(e,t,i),null)}),r}insert(e,t){this.doc!==null?U(this.doc,i=>{Ua(i,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(this.doc!==null)U(this.doc,i=>{let r=e&&e instanceof R?e._item:e;pi(i,this,r,t)});else{let i=this._prelimContent,r=e===null?0:i.findIndex(n=>n===e)+1;if(r===0&&e!==null)throw we("Reference item not found");i.splice(r,0,...t)}}delete(e,t=1){this.doc!==null?U(this.doc,i=>{Na(i,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return Ta(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Aa(this,e)}slice(e=0,t=this.length){return va(this,e,t)}forEach(e){Is(this,e)}_write(e){e.writeTypeRef(Gd)}},Ud=s=>new ct,ht=class s extends ct{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){let e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){let e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((i,r)=>{this.setAttribute(r,i)}),this._prelimAttrs=null}_copy(){return new s(this.nodeName)}clone(){let e=new s(this.nodeName),t=this.getAttributes();return bo(t,(i,r)=>{e.setAttribute(r,i)}),e.insert(0,this.toArray().map(i=>i instanceof R?i.clone():i)),e}toString(){let e=this.getAttributes(),t=[],i=[];for(let a in e)i.push(a);i.sort();let r=i.length;for(let a=0;a<r;a++){let l=i[a];t.push(l+'="'+e[l]+'"')}let n=this.nodeName.toLocaleLowerCase(),o=t.length>0?" "+t.join(" "):"";return`<${n}${o}>${super.toString()}</${n}>`}removeAttribute(e){this.doc!==null?U(this.doc,t=>{gi(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){this.doc!==null?U(this.doc,i=>{en(i,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return tn(this,e)}hasAttribute(e){return Da(this,e)}getAttributes(e){return e?La(this,e):Ea(this)}toDOM(e=document,t={},i){let r=e.createElement(this.nodeName),n=this.getAttributes();for(let o in n){let a=n[o];typeof a=="string"&&r.setAttribute(o,a)}return Is(this,o=>{r.appendChild(o.toDOM(e,t,i))}),i!==void 0&&i._createAssociation(r,this),r}_write(e){e.writeTypeRef(Wd),e.writeKey(this.nodeName)}},Nd=s=>new ht(s.readKey()),_i=class extends ot{constructor(e,t,i){super(e,i),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(r=>{r===null?this.childListChanged=!0:this.attributesChanged.add(r)})}},Cs=class s extends lt{constructor(e){super(),this.hookName=e}_copy(){return new s(this.hookName)}clone(){let e=new s(this.hookName);return this.forEach((t,i)=>{e.set(i,t)}),e}toDOM(e=document,t={},i){let r=t[this.hookName],n;return r!==void 0?n=r.createDom(this):n=document.createElement(this.hookName),n.setAttribute("data-yjs-hook",this.hookName),i!==void 0&&i._createAssociation(n,this),n}_write(e){e.writeTypeRef(Jd),e.writeKey(this.hookName)}},Ed=s=>new Cs(s.readKey()),bi=class s extends Ft{get nextSibling(){let e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){let e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new s}clone(){let e=new s;return e.applyDelta(this.toDelta()),e}toDOM(e=document,t,i){let r=e.createTextNode(this.toString());return i!==void 0&&i._createAssociation(r,this),r}toString(){return this.toDelta().map(e=>{let t=[];for(let r in e.attributes){let n=[];for(let o in e.attributes[r])n.push({key:o,value:e.attributes[r][o]});n.sort((o,a)=>o.key<a.key?-1:1),t.push({nodeName:r,attrs:n})}t.sort((r,n)=>r.nodeName<n.nodeName?-1:1);let i="";for(let r=0;r<t.length;r++){let n=t[r];i+=`<${n.nodeName}`;for(let o=0;o<n.attrs.length;o++){let a=n.attrs[o];i+=` ${a.key}="${a.value}"`}i+=">"}i+=e.insert;for(let r=t.length-1;r>=0;r--)i+=`</${t[r].nodeName}>`;return i}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(Yd)}},Dd=s=>new bi,Vt=class{constructor(e,t){this.id=e,this.length=t}get deleted(){throw pe()}mergeWith(e){return!1}write(e,t,i){throw pe()}integrate(e,t){throw pe()}},Ld=0,Y=class extends Vt{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),ca(e.doc.store,this)}write(e,t){e.writeInfo(Ld),e.writeLen(this.length-t)}getMissing(e,t){return null}},dt=class s{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new s(this.content)}splice(e){throw pe()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}},$d=s=>new dt(s.readBuf()),jt=class s{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.len)}splice(e){let t=new s(this.len-e);return this.len=e,t}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){bs(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}},Md=s=>new jt(s.readLen()),Va=(s,e)=>new Ve({guid:s,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1}),ut=class s{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;let t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),e.meta!==null&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new s(Va(this.doc.guid,this.opts))}splice(e){throw pe()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}},Od=s=>new ut(Va(s.readString(),s.readAny())),Ne=class s{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new s(this.embed)}splice(e){throw pe()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}},Rd=s=>new Ne(s.readJSON()),F=class s{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new s(this.key,this.value)}splice(e){throw pe()}mergeWith(e){return!1}integrate(e,t){let i=t.parent;i._searchMarker=null,i._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}},Fd=s=>new F(s.readKey(),s.readJSON()),Us=class s{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(e){let t=new s(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){let i=this.arr.length;e.writeLen(i-t);for(let r=t;r<i;r++){let n=this.arr[r];e.writeString(n===void 0?"undefined":JSON.stringify(n))}}getRef(){return 2}},Vd=s=>{let e=s.readLen(),t=[];for(let i=0;i<e;i++){let r=s.readString();r==="undefined"?t.push(void 0):t.push(JSON.parse(r))}return new Us(t)},jd=us("node_env")==="development",Be=class s{constructor(e){this.arr=e,jd&&pr(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new s(this.arr)}splice(e){let t=new s(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){let i=this.arr.length;e.writeLen(i-t);for(let r=t;r<i;r++){let n=this.arr[r];e.writeAny(n)}}getRef(){return 8}},Bd=s=>{let e=s.readLen(),t=[];for(let i=0;i<e;i++)t.push(s.readAny());return new Be(t)},ge=class s{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new s(this.str)}splice(e){let t=new s(this.str.slice(e));this.str=this.str.slice(0,e);let i=this.str.charCodeAt(e-1);return i>=55296&&i<=56319&&(this.str=this.str.slice(0,e-1)+"\uFFFD",t.str="\uFFFD"+t.str.slice(1)),t}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(t===0?this.str:this.str.slice(t))}getRef(){return 4}},Pd=s=>new ge(s.readString()),Kd=[vd,Td,Cd,Nd,Ud,Ed,Dd],qd=0,Hd=1,zd=2,Wd=3,Gd=4,Jd=5,Yd=6,he=class s{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new s(this.type._copy())}splice(e){throw pe()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;t!==null;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(i=>{i.deleted?i.id.clock<(e.beforeState.get(i.id.client)||0)&&e._mergeStructs.push(i):i.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;t!==null;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(i=>{for(;i!==null;)i.gc(e,!0),i=i.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}},Xd=s=>new he(Kd[s.readTypeRef()](s)),Fr=(s,e)=>{let t=e,i=0,r;do i>0&&(t=k(t.client,t.clock+i)),r=st(s,t),i=t.clock-r.id.clock,t=r.redone;while(t!==null&&r instanceof N);return{item:r,diff:i}},sn=(s,e)=>{for(;s!==null&&s.keep!==e;)s.keep=e,s=s.parent._item},Si=(s,e,t)=>{let{client:i,clock:r}=e.id,n=new N(k(i,r+t),e,k(i,r+t-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t));return e.deleted&&n.markDeleted(),e.keep&&(n.keep=!0),e.redone!==null&&(n.redone=k(e.redone.client,e.redone.clock+t)),e.right=n,n.right!==null&&(n.right.left=n),s._mergeStructs.push(n),n.parentSub!==null&&n.right===null&&n.parent._map.set(n.parentSub,n),e.length=t,n},ta=(s,e)=>qn(s,t=>ft(t.deletions,e)),ja=(s,e,t,i,r,n)=>{let o=s.doc,a=o.store,l=o.clientID,c=e.redone;if(c!==null)return J(s,c);let h=e.parent._item,d=null,u;if(h!==null&&h.deleted===!0){if(h.redone===null&&(!t.has(h)||ja(s,h,t,i,r,n)===null))return null;for(;h.redone!==null;)h=J(s,h.redone)}let f=h===null?e.parent:h.content.type;if(e.parentSub===null){for(d=e.left,u=e;d!==null;){let y=d;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:J(s,y.redone);if(y!==null&&y.parent._item===h){d=y;break}d=d.left}for(;u!==null;){let y=u;for(;y!==null&&y.parent._item!==h;)y=y.redone===null?null:J(s,y.redone);if(y!==null&&y.parent._item===h){u=y;break}u=u.right}}else if(u=null,e.right&&!r){for(d=e;d!==null&&d.right!==null&&(d.right.redone||ft(i,d.right.id)||ta(n.undoStack,d.right.id)||ta(n.redoStack,d.right.id));)for(d=d.right;d.redone;)d=J(s,d.redone);if(d&&d.right!==null)return null}else d=f._map.get(e.parentSub)||null;let p=L(a,l),g=k(l,p),m=new N(g,d,d&&d.lastId,u,u&&u.id,f,e.parentSub,e.content.copy());return e.redone=g,sn(m,!0),m.integrate(s,0),m},N=class s extends Vt{constructor(e,t,i,r,n,o,a,l){super(e,l.getLength()),this.origin=i,this.left=t,this.right=r,this.rightOrigin=n,this.parent=o,this.parentSub=a,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(e){(this.info&8)>0!==e&&(this.info^=8)}get marker(){return(this.info&8)>0}get keep(){return(this.info&1)>0}set keep(e){this.keep!==e&&(this.info^=1)}get countable(){return(this.info&2)>0}get deleted(){return(this.info&4)>0}set deleted(e){this.deleted!==e&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=L(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=L(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ce&&this.id.client!==this.parent.client&&this.parent.clock>=L(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=$r(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=J(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Y||this.right&&this.right.constructor===Y)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===s?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===s&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ce){let i=st(t,this.parent);i.constructor===Y?this.parent=null:this.parent=i.content.type}return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=$r(e,e.doc.store,k(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let i=this.left,r;if(i!==null)r=i.right;else if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start;let n=new Set,o=new Set;for(;r!==null&&r!==this.right;){if(o.add(r),n.add(r),tt(this.origin,r.origin)){if(r.id.client<this.id.client)i=r,n.clear();else if(tt(this.rightOrigin,r.rightOrigin))break}else if(r.origin!==null&&o.has(st(e.doc.store,r.origin)))n.has(st(e.doc.store,r.origin))||(i=r,n.clear());else break;r=r.right}this.left=i}if(this.left!==null){let i=this.left.right;this.right=i,this.left.right=this}else{let i;if(this.parentSub!==null)for(i=this.parent._map.get(this.parentSub)||null;i!==null&&i.left!==null;)i=i.left;else i=this.parent._start,this.parent._start=this;this.right=i}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),ca(e.doc.store,this),this.content.integrate(e,this),Go(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Y(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:k(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&tt(e.origin,this.lastId)&&this.right===e&&tt(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){let t=this.parent._searchMarker;return t&&t.forEach(i=>{i.p===e&&(i.p=this,!this.deleted&&this.countable&&(i.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){let t=this.parent;this.countable&&this.parentSub===null&&(t._length-=this.length),this.markDeleted(),bs(e.deleteSet,this.id.client,this.id.clock,this.length),Go(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw Z();this.content.gc(e),t?rd(e,this,new Y(this.id,this.length)):this.content=new jt(this.length)}write(e,t){let i=t>0?k(this.id.client,this.id.clock+t-1):this.origin,r=this.rightOrigin,n=this.parentSub,o=this.content.getRef()&31|(i===null?0:128)|(r===null?0:64)|(n===null?0:32);if(e.writeInfo(o),i!==null&&e.writeLeftID(i),r!==null&&e.writeRightID(r),i===null&&r===null){let a=this.parent;if(a._item!==void 0){let l=a._item;if(l===null){let c=Jr(a);e.writeParentInfo(!0),e.writeString(c)}else e.writeParentInfo(!1),e.writeLeftID(l.id)}else a.constructor===String?(e.writeParentInfo(!0),e.writeString(a)):a.constructor===Ce?(e.writeParentInfo(!1),e.writeLeftID(a)):Z();n!==null&&e.writeString(n)}this.content.write(e,t)}},Ba=(s,e)=>Zd[e&31](s),Zd=[()=>{Z()},Md,Vd,$d,Pd,Rd,Fd,Xd,Bd,Od,()=>{Z()}],Qd=10,H=class extends Vt{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){Z()}write(e,t){e.writeInfo(Qd),w(e.restEncoder,this.length-t)}getMissing(e,t){return null}},Pa=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},Ka="__ $YJS$ __";Pa[Ka]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Pa[Ka]=!0});var qa,rn,eu,nn,Ha,za,pt,Wa=T(()=>{Xt();Ks();br();hr();qa=new Map,rn=class{constructor(e){this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&this.onmessage!==null&&this.onmessage({data:Uo(t.newValue||"")}),po(this._onChange)}postMessage(e){Qs.setItem(this.room,Co(Ao(e)))}close(){go(this._onChange)}},eu=typeof BroadcastChannel>"u"?rn:BroadcastChannel,nn=s=>P(qa,s,()=>{let e=me(),t=new eu(s);return t.onmessage=i=>e.forEach(r=>r(i.data,"broadcastchannel")),{bc:t,subs:e}}),Ha=(s,e)=>(nn(s).subs.add(e),e),za=(s,e)=>{let t=nn(s),i=t.subs.delete(e);return i&&t.subs.size===0&&(t.bc.close(),qa.delete(s)),i},pt=(s,e,t=null)=>{let i=nn(s);i.bc.postMessage(e),i.subs.forEach(r=>r(e,t))}});var Ga,Ai,Ja,Ci,on,su,Ya,Xa,iu,Za,Qa=T(()=>{rs();$t();Kt();Ga=0,Ai=1,Ja=2,Ci=(s,e)=>{w(s,Ga);let t=Gr(e);D(s,t)},on=(s,e,t)=>{w(s,Ai),D(s,Hr(e,t))},su=(s,e,t)=>on(e,t,B(s)),Ya=(s,e,t,i)=>{try{qr(e,B(s),t)}catch(r){i?.(r),console.error("Caught error while handling a Yjs update",r)}},Xa=(s,e)=>{w(s,Ja),D(s,e)},iu=Ya,Za=(s,e,t,i,r)=>{let n=x(s);switch(n){case Ga:su(s,e,t);break;case Ai:Ya(s,t,i,r);break;case Ja:iu(s,t,i,r);break;default:throw new Error("Unknown message type")}return n}});var nu,el,tl=T(()=>{$t();nu=0,el=(s,e,t)=>{switch(x(s)){case nu:t(e,le(s))}}});var an,Ui,Ni,qt,sl,il=T(()=>{rs();$t();ls();Ye();es();ds();an=3e4,Ui=class extends Je{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{let t=re();this.getLocalState()!==null&&an/2<=t-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());let i=[];this.meta.forEach((r,n)=>{n!==this.clientID&&an<=t-r.lastUpdated&&this.states.has(n)&&i.push(n)}),i.length>0&&Ni(this,i,"timeout")},ee(an/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){let t=this.clientID,i=this.meta.get(t),r=i===void 0?0:i.clock+1,n=this.states.get(t);e===null?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:r,lastUpdated:re()});let o=[],a=[],l=[],c=[];e===null?c.push(t):n==null?e!=null&&o.push(t):(a.push(t),Mt(n,e)||l.push(t)),(o.length>0||l.length>0||c.length>0)&&this.emit("change",[{added:o,updated:l,removed:c},"local"]),this.emit("update",[{added:o,updated:a,removed:c},"local"])}setLocalStateField(e,t){let i=this.getLocalState();i!==null&&this.setLocalState({...i,[e]:t})}getStates(){return this.states}},Ni=(s,e,t)=>{let i=[];for(let r=0;r<e.length;r++){let n=e[r];if(s.states.has(n)){if(s.states.delete(n),n===s.clientID){let o=s.meta.get(n);s.meta.set(n,{clock:o.clock+1,lastUpdated:re()})}i.push(n)}}i.length>0&&(s.emit("change",[{added:[],updated:[],removed:i},t]),s.emit("update",[{added:[],updated:[],removed:i},t]))},qt=(s,e,t=s.states)=>{let i=e.length,r=M();w(r,i);for(let n=0;n<i;n++){let o=e[n],a=t.get(o)||null,l=s.meta.get(o).clock;w(r,o),w(r,l),ye(r,JSON.stringify(a))}return C(r)},sl=(s,e,t)=>{let i=O(e),r=re(),n=[],o=[],a=[],l=[],c=x(i);for(let h=0;h<c;h++){let d=x(i),u=x(i),f=JSON.parse(le(i)),p=s.meta.get(d),g=s.states.get(d),m=p===void 0?0:p.clock;(m<u||m===u&&f===null&&s.states.has(d))&&(f===null?d===s.clientID&&s.getLocalState()!=null?u++:s.states.delete(d):s.states.set(d,f),s.meta.set(d,{clock:u,lastUpdated:r}),p===void 0&&f!==null?n.push(d):p!==void 0&&f===null?l.push(d):f!==null&&(Mt(f,g)||a.push(d),o.push(d)))}(n.length>0||a.length>0||l.length>0)&&s.emit("change",[{added:n,updated:a,removed:l},t]),(n.length>0||o.length>0||l.length>0)&&s.emit("update",[{added:n,updated:o,removed:l},t])}});var rl,nl=T(()=>{ti();rl=s=>So(s,(e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`).join("&")});var hl={};Gi(hl,{WebsocketProvider:()=>cn,messageAuth:()=>al,messageAwareness:()=>gt,messageQueryAwareness:()=>hn,messageSync:()=>Pe});var Pe,hn,gt,al,Es,ol,cu,ll,cl,ln,cn,dl=T(()=>{Wa();ls();rs();$t();Qa();tl();il();es();Ye();nl();fs();Pe=0,hn=3,gt=1,al=2,Es=[];Es[Pe]=(s,e,t,i,r)=>{w(s,Pe);let n=Za(e,s,t.doc,t);i&&n===Ai&&!t.synced&&(t.synced=!0)};Es[hn]=(s,e,t,i,r)=>{w(s,gt),D(s,qt(t.awareness,Array.from(t.awareness.getStates().keys())))};Es[gt]=(s,e,t,i,r)=>{sl(t.awareness,B(e),t)};Es[al]=(s,e,t,i,r)=>{el(e,t.doc,(n,o)=>cu(t,o))};ol=3e4,cu=(s,e)=>console.warn(`Permission denied to access ${s.url}.
${e}`),ll=(s,e,t)=>{let i=O(e),r=M(),n=x(i),o=s.messageHandlers[n];return o?o(r,i,s,t,n):console.error("Unable to compute message"),r},cl=s=>{if(s.shouldConnect&&s.ws===null){let e=new s._WS(s.url);e.binaryType="arraybuffer",s.ws=e,s.wsconnecting=!0,s.wsconnected=!1,s.synced=!1,e.onmessage=t=>{s.wsLastMessageReceived=re();let i=ll(s,new Uint8Array(t.data),!0);Gs(i)>1&&e.send(C(i))},e.onerror=t=>{s.emit("connection-error",[t,s])},e.onclose=t=>{s.emit("connection-close",[t,s]),s.ws=null,s.wsconnecting=!1,s.wsconnected?(s.wsconnected=!1,s.synced=!1,Ni(s.awareness,Array.from(s.awareness.getStates().keys()).filter(i=>i!==s.doc.clientID),s),s.emit("status",[{status:"disconnected"}])):s.wsUnsuccessfulReconnects++,setTimeout(cl,St(Wn(2,s.wsUnsuccessfulReconnects)*100,s.maxBackoffTime),s)},e.onopen=()=>{s.wsLastMessageReceived=re(),s.wsconnecting=!1,s.wsconnected=!0,s.wsUnsuccessfulReconnects=0,s.emit("status",[{status:"connected"}]);let t=M();if(w(t,Pe),Ci(t,s.doc),e.send(C(t)),s.awareness.getLocalState()!==null){let i=M();w(i,gt),D(i,qt(s.awareness,[s.doc.clientID])),e.send(C(i))}},s.emit("status",[{status:"connecting"}])}},ln=(s,e)=>{let t=s.ws;s.wsconnected&&t&&t.readyState===t.OPEN&&t.send(e),s.bcconnected&&pt(s.bcChannel,e,s)},cn=class extends Je{constructor(e,t,i,{connect:r=!0,awareness:n=new Ui(i),params:o={},WebSocketPolyfill:a=WebSocket,resyncInterval:l=-1,maxBackoffTime:c=2500,disableBc:h=!1}={}){for(super();e[e.length-1]==="/";)e=e.slice(0,e.length-1);let d=rl(o);this.maxBackoffTime=c,this.bcChannel=e+"/"+t,this.url=e+"/"+t+(d.length===0?"":"?"+d),this.roomname=t,this.doc=i,this._WS=a,this.awareness=n,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Es.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=r,this._resyncInterval=0,l>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){let u=M();w(u,Pe),Ci(u,i),this.ws.send(C(u))}},l)),this._bcSubscriber=(u,f)=>{if(f!==this){let p=ll(this,new Uint8Array(u),!1);Gs(p)>1&&pt(this.bcChannel,C(p),this)}},this._updateHandler=(u,f)=>{if(f!==this){let p=M();w(p,Pe),Xa(p,u),ln(this,C(p))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:u,updated:f,removed:p},g)=>{let m=u.concat(f).concat(p),y=M();w(y,gt),D(y,qt(n,m)),ln(this,C(y))},this._exitHandler=()=>{Ni(this.awareness,[i.clientID],"app closed")},Ae&&typeof process<"u"&&process.on("exit",this._exitHandler),n.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&ol<re()-this.wsLastMessageReceived&&this.ws.close()},ol/10),r&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),Ae&&typeof process<"u"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(Ha(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);let e=M();w(e,Pe),Ci(e,this.doc),pt(this.bcChannel,C(e),this);let t=M();w(t,Pe),on(t,this.doc),pt(this.bcChannel,C(t),this);let i=M();w(i,hn),pt(this.bcChannel,C(i),this);let r=M();w(r,gt),D(r,qt(this.awareness,[this.doc.clientID])),pt(this.bcChannel,C(r),this)}disconnectBc(){let e=M();w(e,gt),D(e,qt(this.awareness,[this.doc.clientID],new Map)),ln(this,C(e)),this.bcconnected&&(za(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(cl(this),this.connectBc())}}});var fl=E((lg,ul)=>{"use strict";function mt(s){if(!(this instanceof mt))return new mt(s);s=s||{},this.concurrency=s.concurrency||1/0,this.pending=0,this.jobs=[],this.cbs=[],this._done=du.bind(this)}var hu=["push","unshift","splice"];hu.forEach(function(s){mt.prototype[s]=function(){var e=Array.prototype[s].apply(this.jobs,arguments);return this._run(),e}});Object.defineProperty(mt.prototype,"length",{get:function(){return this.pending+this.jobs.length}});mt.prototype._run=function(){if(this.pending!==this.concurrency){if(this.jobs.length){var s=this.jobs.shift();this.pending++,s(this._done),this._run()}if(this.pending===0)for(;this.cbs.length!==0;){var e=this.cbs.pop();process.nextTick(e)}}};mt.prototype.onDone=function(s){typeof s=="function"&&(this.cbs.push(s),this._run())};function du(){this.pending--,this._run()}ul.exports=mt});var yt=E((cg,pl)=>{"use strict";pl.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}}});var Di=E((hg,dn)=>{"use strict";var{EMPTY_BUFFER:uu}=yt();function gl(s,e){if(s.length===0)return uu;if(s.length===1)return s[0];let t=Buffer.allocUnsafe(e);for(var i=0,r=0;r<s.length;r++){let n=s[r];n.copy(t,i),i+=n.length}return t}function ml(s,e,t,i,r){for(var n=0;n<r;n++)t[i+n]=s[n]^e[n&3]}function yl(s,e){let t=s.length;for(var i=0;i<t;i++)s[i]^=e[i&3]}function wl(s){return s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)}function Ei(s){if(Ei.readOnly=!0,Buffer.isBuffer(s))return s;var e;return s instanceof ArrayBuffer?e=Buffer.from(s):ArrayBuffer.isView(s)?e=fu(s):(e=Buffer.from(s),Ei.readOnly=!1),e}function fu(s){let e=Buffer.from(s.buffer);return s.byteLength!==s.buffer.byteLength?e.slice(s.byteOffset,s.byteOffset+s.byteLength):e}try{let s=require("bufferutil"),e=s.BufferUtil||s;dn.exports={concat:gl,mask(t,i,r,n,o){o<48?ml(t,i,r,n,o):e.mask(t,i,r,n,o)},toArrayBuffer:wl,toBuffer:Ei,unmask(t,i){t.length<32?yl(t,i):e.unmask(t,i)}}}catch{dn.exports={concat:gl,mask:ml,toArrayBuffer:wl,toBuffer:Ei,unmask:yl}}});var Ls=E((dg,kl)=>{"use strict";var pu=fl(),Ds=require("zlib"),_l=Di(),{kStatusCode:bl,NOOP:gu}=yt(),mu=Buffer.from([0,0,255,255]),yu=Buffer.from([0]),$i=Symbol("permessage-deflate"),Ee=Symbol("total-length"),Sl=Symbol("callback"),Ke=Symbol("buffers"),un=Symbol("error"),Li,fn=class{constructor(e,t,i){if(this._maxPayload=i|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Li){let r=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Li=new pu({concurrency:r})}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate&&(this._deflate.close(),this._deflate=null)}acceptAsServer(e){let t=this._options,i=e.find(r=>!(t.serverNoContextTakeover===!1&&r.server_no_context_takeover||r.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>r.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!r.client_max_window_bits));if(!i)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(i.server_no_context_takeover=!0),t.clientNoContextTakeover&&(i.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(i.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?i.client_max_window_bits=t.clientMaxWindowBits:(i.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete i.client_max_window_bits,i}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(i=>{var r=t[i];if(r.length>1)throw new Error(`Parameter "${i}" must have only a single value`);if(r=r[0],i==="client_max_window_bits"){if(r!==!0){let n=+r;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${i}": ${r}`);r=n}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${i}": ${r}`)}else if(i==="server_max_window_bits"){let n=+r;if(!Number.isInteger(n)||n<8||n>15)throw new TypeError(`Invalid value for parameter "${i}": ${r}`);r=n}else if(i==="client_no_context_takeover"||i==="server_no_context_takeover"){if(r!==!0)throw new TypeError(`Invalid value for parameter "${i}": ${r}`)}else throw new Error(`Unknown parameter "${i}"`);t[i]=r})}),e}decompress(e,t,i){Li.push(r=>{this._decompress(e,t,(n,o)=>{r(),i(n,o)})})}compress(e,t,i){Li.push(r=>{this._compress(e,t,(n,o)=>{r(),i(n,o)})})}_decompress(e,t,i){let r=this._isServer?"client":"server";if(!this._inflate){let n=`${r}_max_window_bits`,o=typeof this.params[n]!="number"?Ds.Z_DEFAULT_WINDOWBITS:this.params[n];this._inflate=Ds.createInflateRaw(Object.assign({},this._options.zlibInflateOptions,{windowBits:o})),this._inflate[$i]=this,this._inflate[Ee]=0,this._inflate[Ke]=[],this._inflate.on("error",_u),this._inflate.on("data",xl)}this._inflate[Sl]=i,this._inflate.write(e),t&&this._inflate.write(mu),this._inflate.flush(()=>{let n=this._inflate[un];if(n){this._inflate.close(),this._inflate=null,i(n);return}let o=_l.concat(this._inflate[Ke],this._inflate[Ee]);t&&this.params[`${r}_no_context_takeover`]?(this._inflate.close(),this._inflate=null):(this._inflate[Ee]=0,this._inflate[Ke]=[]),i(null,o)})}_compress(e,t,i){if(!e||e.length===0){process.nextTick(i,null,yu);return}let r=this._isServer?"server":"client";if(!this._deflate){let n=`${r}_max_window_bits`,o=typeof this.params[n]!="number"?Ds.Z_DEFAULT_WINDOWBITS:this.params[n];this._deflate=Ds.createDeflateRaw(Object.assign({},this._options.zlibDeflateOptions,{windowBits:o})),this._deflate[Ee]=0,this._deflate[Ke]=[],this._deflate.on("error",gu),this._deflate.on("data",wu)}this._deflate.write(e),this._deflate.flush(Ds.Z_SYNC_FLUSH,()=>{if(this._deflate){var n=_l.concat(this._deflate[Ke],this._deflate[Ee]);t&&(n=n.slice(0,n.length-4)),t&&this.params[`${r}_no_context_takeover`]?(this._deflate.close(),this._deflate=null):(this._deflate[Ee]=0,this._deflate[Ke]=[]),i(null,n)}})}};kl.exports=fn;function wu(s){this[Ke].push(s),this[Ee]+=s.length}function xl(s){if(this[Ee]+=s.length,this[$i]._maxPayload<1||this[Ee]<=this[$i]._maxPayload){this[Ke].push(s);return}this[un]=new RangeError("Max payload size exceeded"),this[un][bl]=1009,this.removeListener("data",xl),this.reset()}function _u(s){this[$i]._inflate=null,s[bl]=1007,this[Sl](s)}});var Tl=E((ug,vl)=>{"use strict";var Ht=class{constructor(e,t){this.target=t,this.type=e}},pn=class extends Ht{constructor(e,t){super("message",t),this.data=e}},gn=class extends Ht{constructor(e,t,i){super("close",i),this.wasClean=i._closeFrameReceived&&i._closeFrameSent,this.reason=t,this.code=e}},mn=class extends Ht{constructor(e){super("open",e)}},yn=class extends Ht{constructor(e,t){super("error",t),this.message=e.message,this.error=e}},bu={addEventListener(s,e){if(typeof e!="function")return;function t(o){e.call(this,new pn(o,this))}function i(o,a){e.call(this,new gn(o,a,this))}function r(o){e.call(this,new yn(o,this))}function n(){e.call(this,new mn(this))}s==="message"?(t._listener=e,this.on(s,t)):s==="close"?(i._listener=e,this.on(s,i)):s==="error"?(r._listener=e,this.on(s,r)):s==="open"?(n._listener=e,this.on(s,n)):this.on(s,e)},removeEventListener(s,e){let t=this.listeners(s);for(var i=0;i<t.length;i++)(t[i]===e||t[i]._listener===e)&&this.removeListener(s,t[i])}};vl.exports=bu});var wn=E((fg,Il)=>{"use strict";var $s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function ve(s,e,t){Object.prototype.hasOwnProperty.call(s,e)?s[e].push(t):s[e]=[t]}function Su(s){let e={};if(s===void 0||s==="")return e;for(var t={},i=!1,r=!1,n=!1,o,a,l=-1,c=-1,h=0;h<s.length;h++){let f=s.charCodeAt(h);if(o===void 0)if(c===-1&&$s[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);let p=s.slice(l,c);f===44?(ve(e,p,t),t={}):o=p,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(c===-1&&$s[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h),ve(t,s.slice(l,c),!0),f===44&&(ve(e,o,t),t={},o=void 0),l=c=-1}else if(f===61&&l!==-1&&c===-1)a=s.slice(l,h),l=c=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(r){if($s[f]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:i||(i=!0),r=!1}else if(n)if($s[f]===1)l===-1&&(l=h);else if(f===34&&l!==-1)n=!1,c=h;else if(f===92)r=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(f===34&&s.charCodeAt(h-1)===61)n=!0;else if(c===-1&&$s[f]===1)l===-1&&(l=h);else if(l!==-1&&(f===32||f===9))c===-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);var d=s.slice(l,c);i&&(d=d.replace(/\\/g,""),i=!1),ve(t,a,d),f===44&&(ve(e,o,t),t={},o=void 0),a=void 0,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`)}if(l===-1||n)throw new SyntaxError("Unexpected end of input");c===-1&&(c=h);let u=s.slice(l,c);return o===void 0?ve(e,u,{}):(a===void 0?ve(t,u,!0):i?ve(t,a,u.replace(/\\/g,"")):ve(t,a,u),ve(e,o,t)),e}function xu(s){return Object.keys(s).map(e=>{var t=s[e];return Array.isArray(t)||(t=[t]),t.map(i=>[e].concat(Object.keys(i).map(r=>{var n=i[r];return Array.isArray(n)||(n=[n]),n.map(o=>o===!0?r:`${r}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}Il.exports={format:xu,parse:Su}});var _n=E(Mi=>{"use strict";try{let s=require("utf-8-validate");Mi.isValidUTF8=typeof s=="object"?s.Validation.isValidUTF8:s}catch{Mi.isValidUTF8=()=>!0}Mi.isValidStatusCode=s=>s>=1e3&&s<=1013&&s!==1004&&s!==1005&&s!==1006||s>=3e3&&s<=4999});var kn=E((gg,Dl)=>{"use strict";var{Writable:ku}=require("stream"),Al=Ls(),{BINARY_TYPES:vu,EMPTY_BUFFER:Tu,kStatusCode:Iu,kWebSocket:Au}=yt(),{concat:bn,toArrayBuffer:Cu,unmask:Uu}=Di(),{isValidStatusCode:Nu,isValidUTF8:Cl}=_n(),Ms=0,Ul=1,Nl=2,El=3,Sn=4,Eu=5,xn=class extends ku{constructor(e,t,i){super(),this._binaryType=e||vu[0],this[Au]=void 0,this._extensions=t||{},this._maxPayload=i|0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=Ms,this._loop=!1}_write(e,t,i){if(this._opcode===8&&this._state==Ms)return i();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(i)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let i=this._buffers[0];return this._buffers[0]=i.slice(e),i.slice(0,e)}let t=Buffer.allocUnsafe(e);do{let i=this._buffers[0];e>=i.length?this._buffers.shift().copy(t,t.length-e):(i.copy(t,t.length-e,0,e),this._buffers[0]=i.slice(e)),e-=i.length}while(e>0);return t}startLoop(e){var t;this._loop=!0;do switch(this._state){case Ms:t=this.getInfo();break;case Ul:t=this.getPayloadLength16();break;case Nl:t=this.getPayloadLength64();break;case El:this.getMask();break;case Sn:t=this.getData(e);break;default:this._loop=!1;return}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let e=this.consume(2);if(e[0]&48)return this._loop=!1,W(RangeError,"RSV2 and RSV3 must be clear",!0,1002);let t=(e[0]&64)===64;if(t&&!this._extensions[Al.extensionName])return this._loop=!1,W(RangeError,"RSV1 must be clear",!0,1002);if(this._fin=(e[0]&128)===128,this._opcode=e[0]&15,this._payloadLength=e[1]&127,this._opcode===0){if(t)return this._loop=!1,W(RangeError,"RSV1 must be clear",!0,1002);if(!this._fragmented)return this._loop=!1,W(RangeError,"invalid opcode 0",!0,1002);this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,W(RangeError,`invalid opcode ${this._opcode}`,!0,1002);this._compressed=t}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,W(RangeError,"FIN must be set",!0,1002);if(t)return this._loop=!1,W(RangeError,"RSV1 must be clear",!0,1002);if(this._payloadLength>125)return this._loop=!1,W(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002)}else return this._loop=!1,W(RangeError,`invalid opcode ${this._opcode}`,!0,1002);if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(e[1]&128)===128,this._payloadLength===126)this._state=Ul;else if(this._payloadLength===127)this._state=Nl;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let e=this.consume(8),t=e.readUInt32BE(0);return t>Math.pow(2,21)-1?(this._loop=!1,W(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009)):(this._payloadLength=t*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,W(RangeError,"Max payload size exceeded",!1,1009);this._masked?this._state=El:this._state=Sn}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=Sn}getData(e){var t=Tu;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&Uu(t,this._mask)}if(this._opcode>7)return this.controlMessage(t);if(this._compressed){this._state=Eu,this.decompress(t,e);return}return t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage()}decompress(e,t){this._extensions[Al.extensionName].decompress(e,this._fin,(r,n)=>{if(r)return t(r);if(n.length){if(this._messageLength+=n.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return t(W(RangeError,"Max payload size exceeded",!1,1009));this._fragments.push(n)}let o=this.dataMessage();if(o)return t(o);this.startLoop(t)})}dataMessage(){if(this._fin){let t=this._messageLength,i=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){var e;this._binaryType==="nodebuffer"?e=bn(i,t):this._binaryType==="arraybuffer"?e=Cu(bn(i,t)):e=i,this.emit("message",e)}else{let r=bn(i,t);if(!Cl(r))return this._loop=!1,W(Error,"invalid UTF-8 sequence",!0,1007);this.emit("message",r.toString())}}this._state=Ms}controlMessage(e){if(this._opcode===8)if(this._loop=!1,e.length===0)this.emit("conclude",1005,""),this.end();else{if(e.length===1)return W(RangeError,"invalid payload length 1",!0,1002);{let t=e.readUInt16BE(0);if(!Nu(t))return W(RangeError,`invalid status code ${t}`,!0,1002);let i=e.slice(2);if(!Cl(i))return W(Error,"invalid UTF-8 sequence",!0,1007);this.emit("conclude",t,i.toString()),this.end()}}else this._opcode===9?this.emit("ping",e):this.emit("pong",e);this._state=Ms}};Dl.exports=xn;function W(s,e,t,i){let r=new s(t?`Invalid WebSocket frame: ${e}`:e);return Error.captureStackTrace(r,W),r[Iu]=i,r}});var Tn=E((mg,Ml)=>{"use strict";var{randomBytes:Du}=require("crypto"),Ll=Ls(),{EMPTY_BUFFER:Lu}=yt(),{isValidStatusCode:$u}=_n(),{mask:$l,toBuffer:De}=Di(),vn=class s{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let i=t.mask&&t.readOnly;var r=t.mask?6:2,n=e.length;e.length>=65536?(r+=8,n=127):e.length>125&&(r+=2,n=126);let o=Buffer.allocUnsafe(i?e.length+r:r);if(o[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(o[0]|=64),o[1]=n,n===126?o.writeUInt16BE(e.length,2):n===127&&(o.writeUInt32BE(0,2),o.writeUInt32BE(e.length,6)),!t.mask)return[o,e];let a=Du(4);return o[1]|=128,o[r-4]=a[0],o[r-3]=a[1],o[r-2]=a[2],o[r-1]=a[3],i?($l(e,a,o,r,e.length),[o]):($l(e,a,e,0,e.length),[o,e])}close(e,t,i,r){var n;if(e===void 0)n=Lu;else{if(typeof e!="number"||!$u(e))throw new TypeError("First argument must be a valid error code number");t===void 0||t===""?(n=Buffer.allocUnsafe(2),n.writeUInt16BE(e,0)):(n=Buffer.allocUnsafe(2+Buffer.byteLength(t)),n.writeUInt16BE(e,0),n.write(t,2))}this._deflating?this.enqueue([this.doClose,n,i,r]):this.doClose(n,i,r)}doClose(e,t,i){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),i)}ping(e,t,i){let r=De(e);this._deflating?this.enqueue([this.doPing,r,t,De.readOnly,i]):this.doPing(r,t,De.readOnly,i)}doPing(e,t,i,r){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:i}),r)}pong(e,t,i){let r=De(e);this._deflating?this.enqueue([this.doPong,r,t,De.readOnly,i]):this.doPong(r,t,De.readOnly,i)}doPong(e,t,i,r){this.sendFrame(s.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:i}),r)}send(e,t,i){let r=De(e),n=this._extensions[Ll.extensionName];var o=t.binary?2:1,a=t.compress;if(this._firstFragment?(this._firstFragment=!1,a&&n&&(a=r.length>=n._threshold),this._compress=a):(a=!1,o=0),t.fin&&(this._firstFragment=!0),n){let l={fin:t.fin,rsv1:a,opcode:o,mask:t.mask,readOnly:De.readOnly};this._deflating?this.enqueue([this.dispatch,r,this._compress,l,i]):this.dispatch(r,this._compress,l,i)}else this.sendFrame(s.frame(r,{fin:t.fin,rsv1:!1,opcode:o,mask:t.mask,readOnly:De.readOnly}),i)}dispatch(e,t,i,r){if(!t){this.sendFrame(s.frame(e,i),r);return}let n=this._extensions[Ll.extensionName];this._deflating=!0,n.compress(e,i.fin,(o,a)=>{this._deflating=!1,i.readOnly=!1,this.sendFrame(s.frame(a,i),r),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[1].length,e[0].apply(this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Ml.exports=vn});var Cn=E((yg,zl)=>{"use strict";var Mu=require("events"),Ol=require("crypto"),Ou=require("https"),Ru=require("http"),Fu=require("net"),Vu=require("tls"),zt=require("url"),qe=Ls(),jl=Tl(),Rl=wn(),ju=kn(),Bu=Tn(),{BINARY_TYPES:Fl,EMPTY_BUFFER:In,GUID:Pu,kStatusCode:Ku,kWebSocket:se,NOOP:Bl}=yt(),Oi=["CONNECTING","OPEN","CLOSING","CLOSED"],An=[8,13],qu=30*1e3,ie=class s extends Mu{constructor(e,t,i){super(),this.readyState=s.CONNECTING,this.protocol="",this._binaryType=Fl[0],this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._closeCode=1006,this._extensions={},this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._isServer=!1,this._redirects=0,Array.isArray(t)?t=t.join(", "):typeof t=="object"&&t!==null&&(i=t,t=void 0),Pl(this,e,t,i)):this._isServer=!0}get CONNECTING(){return s.CONNECTING}get CLOSING(){return s.CLOSING}get CLOSED(){return s.CLOSED}get OPEN(){return s.OPEN}get binaryType(){return this._binaryType}set binaryType(e){Fl.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?(this._socket.bufferSize||0)+this._sender._bufferedBytes:0}get extensions(){return Object.keys(this._extensions).join()}setSocket(e,t,i){let r=new ju(this._binaryType,this._extensions,i);this._sender=new Bu(e,this._extensions),this._receiver=r,this._socket=e,r[se]=this,e[se]=this,r.on("conclude",Wu),r.on("drain",Gu),r.on("error",Ju),r.on("message",Yu),r.on("ping",Xu),r.on("pong",Zu),e.setTimeout(0),e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Kl),e.on("data",Ri),e.on("end",ql),e.on("error",Hl),this.readyState=s.OPEN,this.emit("open")}emitClose(){if(this.readyState=s.CLOSED,!this._socket){this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[qe.extensionName]&&this._extensions[qe.extensionName].cleanup(),this._receiver.removeAllListeners(),this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Le(this,this._req,"WebSocket was closed before the connection was established");if(this.readyState===s.CLOSING){this._closeFrameSent&&this._closeFrameReceived&&this._socket.end();return}this.readyState=s.CLOSING,this._sender.close(e,t,!this._isServer,i=>{i||(this._closeFrameSent=!0,this._closeFrameReceived&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),qu)}}ping(e,t,i){if(typeof e=="function"?(i=e,e=t=void 0):typeof t=="function"&&(i=t,t=void 0),this.readyState!==s.OPEN){let r=new Error(`WebSocket is not open: readyState ${this.readyState} (${Oi[this.readyState]})`);if(i)return i(r);throw r}typeof e=="number"&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.ping(e||In,t,i)}pong(e,t,i){if(typeof e=="function"?(i=e,e=t=void 0):typeof t=="function"&&(i=t,t=void 0),this.readyState!==s.OPEN){let r=new Error(`WebSocket is not open: readyState ${this.readyState} (${Oi[this.readyState]})`);if(i)return i(r);throw r}typeof e=="number"&&(e=e.toString()),t===void 0&&(t=!this._isServer),this._sender.pong(e||In,t,i)}send(e,t,i){if(typeof t=="function"&&(i=t,t={}),this.readyState!==s.OPEN){let n=new Error(`WebSocket is not open: readyState ${this.readyState} (${Oi[this.readyState]})`);if(i)return i(n);throw n}typeof e=="number"&&(e=e.toString());let r=Object.assign({binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0},t);this._extensions[qe.extensionName]||(r.compress=!1),this._sender.send(e||In,r,i)}terminate(){if(this.readyState!==s.CLOSED){if(this.readyState===s.CONNECTING)return Le(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this.readyState=s.CLOSING,this._socket.destroy())}}};Oi.forEach((s,e)=>{ie[s]=e});["open","error","close","message"].forEach(s=>{Object.defineProperty(ie.prototype,`on${s}`,{get(){let e=this.listeners(s);for(var t=0;t<e.length;t++)if(e[t]._listener)return e[t]._listener},set(e){let t=this.listeners(s);for(var i=0;i<t.length;i++)t[i]._listener&&this.removeListener(s,t[i]);this.addEventListener(s,e)}})});ie.prototype.addEventListener=jl.addEventListener;ie.prototype.removeEventListener=jl.removeEventListener;zl.exports=ie;function Pl(s,e,t,i){let r=Object.assign({protocolVersion:An[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10},i,{createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,auth:void 0,host:void 0,path:void 0,port:void 0});if(!An.includes(r.protocolVersion))throw new RangeError(`Unsupported protocol version: ${r.protocolVersion} (supported versions: ${An.join(", ")})`);var n;typeof e=="object"&&e.href!==void 0?(n=e,s.url=e.href):(n=zt.URL?new zt.URL(e):zt.parse(e),s.url=e);let o=n.protocol==="ws+unix:";if(!n.host&&(!o||!n.pathname))throw new Error(`Invalid URL: ${s.url}`);let a=n.protocol==="wss:"||n.protocol==="https:",l=a?443:80,c=Ol.randomBytes(16).toString("base64"),h=a?Ou.get:Ru.get,d=n.search?`${n.pathname||"/"}${n.search}`:n.pathname||"/";var u;if(r.createConnection=a?zu:Hu,r.defaultPort=r.defaultPort||l,r.port=n.port||l,r.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname,r.headers=Object.assign({"Sec-WebSocket-Version":r.protocolVersion,"Sec-WebSocket-Key":c,Connection:"Upgrade",Upgrade:"websocket"},r.headers),r.path=d,r.timeout=r.handshakeTimeout,r.perMessageDeflate&&(u=new qe(r.perMessageDeflate!==!0?r.perMessageDeflate:{},!1,r.maxPayload),r.headers["Sec-WebSocket-Extensions"]=Rl.format({[qe.extensionName]:u.offer()})),t&&(r.headers["Sec-WebSocket-Protocol"]=t),r.origin&&(r.protocolVersion<13?r.headers["Sec-WebSocket-Origin"]=r.origin:r.headers.Origin=r.origin),n.auth?r.auth=n.auth:(n.username||n.password)&&(r.auth=`${n.username}:${n.password}`),o){let p=d.split(":");r.socketPath=p[0],r.path=p[1]}var f=s._req=h(r);r.timeout&&f.on("timeout",()=>{Le(s,f,"Opening handshake has timed out")}),f.on("error",p=>{s._req.aborted||(f=s._req=null,s.readyState=ie.CLOSING,s.emit("error",p),s.emitClose())}),f.on("response",p=>{let g=p.headers.location,m=p.statusCode;if(g&&r.followRedirects&&m>=300&&m<400){if(++s._redirects>r.maxRedirects){Le(s,f,"Maximum redirects exceeded");return}f.abort();let y=zt.URL?new zt.URL(g,e):zt.resolve(e,g);Pl(s,y,t,i)}else s.emit("unexpected-response",f,p)||Le(s,f,`Unexpected server response: ${p.statusCode}`)}),f.on("upgrade",(p,g,m)=>{if(s.emit("upgrade",p),s.readyState!==ie.CONNECTING)return;f=s._req=null;let y=Ol.createHash("sha1").update(c+Pu).digest("base64");if(p.headers["sec-websocket-accept"]!==y){Le(s,g,"Invalid Sec-WebSocket-Accept header");return}let _=p.headers["sec-websocket-protocol"],S=(t||"").split(/, */);var b;if(!t&&_?b="Server sent a subprotocol but none was requested":t&&!_?b="Server sent no subprotocol":_&&!S.includes(_)&&(b="Server sent an invalid subprotocol"),b){Le(s,g,b);return}if(_&&(s.protocol=_),u)try{let v=Rl.parse(p.headers["sec-websocket-extensions"]);v[qe.extensionName]&&(u.accept(v[qe.extensionName]),s._extensions[qe.extensionName]=u)}catch{Le(s,g,"Invalid Sec-WebSocket-Extensions header");return}s.setSocket(g,m,r.maxPayload)})}function Hu(s){return s.protocolVersion&&(s.path=s.socketPath),Fu.connect(s)}function zu(s){return s.path=void 0,s.servername=s.servername||s.host,Vu.connect(s)}function Le(s,e,t){s.readyState=ie.CLOSING;let i=new Error(t);Error.captureStackTrace(i,Le),e.setHeader?(e.abort(),e.once("abort",s.emitClose.bind(s)),s.emit("error",i)):(e.destroy(i),e.once("error",s.emit.bind(s,"error")),e.once("close",s.emitClose.bind(s)))}function Wu(s,e){let t=this[se];t._socket.removeListener("data",Ri),t._socket.resume(),t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=s,s===1005?t.close():t.close(s,e)}function Gu(){this[se]._socket.resume()}function Ju(s){let e=this[se];e._socket.removeListener("data",Ri),e.readyState=ie.CLOSING,e._closeCode=s[Ku],e.emit("error",s),e._socket.destroy()}function Vl(){this[se].emitClose()}function Yu(s){this[se].emit("message",s)}function Xu(s){let e=this[se];e.pong(s,!e._isServer,Bl),e.emit("ping",s)}function Zu(s){this[se].emit("pong",s)}function Kl(){let s=this[se];this.removeListener("close",Kl),this.removeListener("end",ql),s.readyState=ie.CLOSING,s._socket.read(),s._receiver.end(),this.removeListener("data",Ri),this[se]=void 0,clearTimeout(s._closeTimer),s._receiver._writableState.finished||s._receiver._writableState.errorEmitted?s.emitClose():(s._receiver.on("error",Vl),s._receiver.on("finish",Vl))}function Ri(s){this[se]._receiver.write(s)||this.pause()}function ql(){let s=this[se];s.readyState=ie.CLOSING,s._receiver.end(),this.end()}function Hl(){let s=this[se];this.removeListener("error",Hl),this.on("error",Bl),s.readyState=ie.CLOSING,this.destroy()}});var Jl=E((wg,Gl)=>{"use strict";var Qu=require("events"),ef=require("crypto"),Vi=require("http"),wt=Ls(),Wl=wn(),tf=Cn(),{GUID:sf}=yt(),rf=/^[+/0-9A-Za-z]{22}==$/,Un=class extends Qu{constructor(e,t){if(super(),e=Object.assign({maxPayload:100*1024*1024,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null},e),e.port==null&&!e.server&&!e.noServer)throw new TypeError('One of the "port", "server", or "noServer" options must be specified');e.port!=null?(this._server=Vi.createServer((i,r)=>{let n=Vi.STATUS_CODES[426];r.writeHead(426,{"Content-Length":n.length,"Content-Type":"text/plain"}),r.end(n)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server&&(this._removeListeners=nf(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,r,n)=>{this.handleUpgrade(i,r,n,o=>{this.emit("connection",o,i)})}})),e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this.clients)for(let i of this.clients)i.terminate();let t=this._server;if(t&&(this._removeListeners(),this._removeListeners=this._server=null,this.options.port!=null)){t.close(()=>this.emit("close"));return}process.nextTick(of,this)}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,i,r){t.on("error",Nn);let n=e.headers["sec-websocket-key"]!==void 0?e.headers["sec-websocket-key"].trim():!1,o=e.headers.upgrade,a=+e.headers["sec-websocket-version"],l={};if(e.method!=="GET"||o===void 0||o.toLowerCase()!=="websocket"||!n||!rf.test(n)||a!==8&&a!==13||!this.shouldHandle(e))return Fi(t,400);if(this.options.perMessageDeflate){let c=new wt(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let h=Wl.parse(e.headers["sec-websocket-extensions"]);h[wt.extensionName]&&(c.accept(h[wt.extensionName]),l[wt.extensionName]=c)}catch{return Fi(t,400)}}if(this.options.verifyClient){let c={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.connection.authorized||e.connection.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(c,(h,d,u,f)=>{if(!h)return Fi(t,d||401,u,f);this.completeUpgrade(n,l,e,t,i,r)});return}if(!this.options.verifyClient(c))return Fi(t,401)}this.completeUpgrade(n,l,e,t,i,r)}completeUpgrade(e,t,i,r,n,o){if(!r.readable||!r.writable)return r.destroy();let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${ef.createHash("sha1").update(e+sf).digest("base64")}`],c=new tf(null);var h=i.headers["sec-websocket-protocol"];if(h&&(h=h.split(",").map(af),this.options.handleProtocols?h=this.options.handleProtocols(h,i):h=h[0],h&&(l.push(`Sec-WebSocket-Protocol: ${h}`),c.protocol=h)),t[wt.extensionName]){let d=t[wt.extensionName].params,u=Wl.format({[wt.extensionName]:[d]});l.push(`Sec-WebSocket-Extensions: ${u}`),c._extensions=t}this.emit("headers",l,i),r.write(l.concat(`\r
`).join(`\r
`)),r.removeListener("error",Nn),c.setSocket(r,n,this.options.maxPayload),this.clients&&(this.clients.add(c),c.on("close",()=>this.clients.delete(c))),o(c)}};Gl.exports=Un;function nf(s,e){for(let t of Object.keys(e))s.on(t,e[t]);return function(){for(let i of Object.keys(e))s.removeListener(i,e[i])}}function of(s){s.emit("close")}function Nn(){this.destroy()}function Fi(s,e,t,i){s.writable&&(t=t||Vi.STATUS_CODES[e],i=Object.assign({Connection:"close","Content-type":"text/html","Content-Length":Buffer.byteLength(t)},i),s.write(`HTTP/1.1 ${e} ${Vi.STATUS_CODES[e]}\r
`+Object.keys(i).map(r=>`${r}: ${i[r]}`).join(`\r
`)+`\r
\r
`+t)),s.removeListener("error",Nn),s.destroy()}function af(s){return s.trim()}});var Xl=E((_g,Yl)=>{"use strict";var ji=Cn();ji.Server=Jl();ji.Receiver=kn();ji.Sender=Tn();Yl.exports=ji});var Ql=E((bg,Zl)=>{"use strict";var lf=require("http"),En=class{constructor(e=2019,t=null){this.port=e,this.host="127.0.0.1",this.logger=t}async ping(){try{let e=await this.get("/");return e&&e.status==="ok"}catch{return!1}}async getProjectInfo(){return this.get("/")}async getItems(e={}){let t=new URLSearchParams;e.q&&t.set("q",e.q),e.tag&&t.set("tag",e.tag),e.sort&&t.set("sort",e.sort);let i=t.toString();return this.get(`/project/items${i?"?"+i:""}`)}async getItem(e){return this.get(`/project/items/${e}`)}async getPhotos(e){return this.get(`/project/items/${e}/photos`)}async getItemTags(e){return this.get(`/project/items/${e}/tags`)}async getMetadata(e){return this.get(`/project/data/${e}`)}async saveMetadata(e,t){return this.postJson(`/project/data/${e}`,t)}async getTags(){return this.get("/project/tags")}async createTag(e,t=null,i=null){return this.post("/project/tags",{name:e,color:t,item:i})}async deleteTags(e){let t=new URLSearchParams;for(let i of e)t.append("id",i);return this.request("DELETE",`/project/tags?${t.toString()}`)}async addTagsToItem(e,t){return this.post(`/project/items/${e}/tags`,{tag:t})}async removeTagsFromItem(e,t){let i=new URLSearchParams;for(let r of t)i.append("tag",r);return this.request("DELETE",`/project/items/${e}/tags?${i.toString()}`)}async getNote(e,t="html"){return this.get(`/project/notes/${e}?format=${t}`)}async createNote(e){return this.postJson("/project/notes",e)}async updateNote(e,t){return this.putJson(`/project/notes/${e}`,t)}async deleteNote(e){return this.request("DELETE",`/project/notes/${e}`)}async getPhoto(e){return this.get(`/project/photos/${e}`)}async getSelection(e){return this.get(`/project/selections/${e}`)}async createSelection(e){return this.postJson("/project/selections",e)}async updateSelection(e,t){return this.putJson(`/project/selections/${e}`,t)}async deleteSelection(e){return this.request("DELETE",`/project/selections/${e}`)}async getTranscription(e,t="json"){return this.get(`/project/transcriptions/${e}?format=${t}`)}async getItemTranscriptions(e){return this.get(`/project/items/${e}/transcriptions`)}async createTranscription(e){return this.postJson("/project/transcriptions",e)}async updateTranscription(e,t){return this.putJson(`/project/transcriptions/${e}`,t)}async deleteTranscription(e){return this.request("DELETE",`/project/transcriptions/${e}`)}async getLists(){return this.get("/project/lists")}async getList(e){return this.get(`/project/lists/${e}`)}async getListItems(e){return this.get(`/project/lists/${e}/items`)}async addItemsToList(e,t){return this.post(`/project/lists/${e}/items`,{item:t})}async removeItemsFromList(e,t){let i=new URLSearchParams;for(let r of t)i.append("item",r);return this.request("DELETE",`/project/lists/${e}/items?${i.toString()}`)}async importItems(e){if(e.file)throw new Error("File path import is blocked for security \u2014 use data parameter with JSON-LD");let t=new URLSearchParams;return e.data&&t.set("data",JSON.stringify(e.data)),e.list&&t.set("list",e.list),this.request("POST","/project/import",t.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async getVersion(){return this.get("/version")}async get(e){return this.request("GET",e)}async post(e,t){let i=new URLSearchParams;for(let[r,n]of Object.entries(t))if(n!=null)if(Array.isArray(n))for(let o of n)i.append(r,o);else i.set(r,n);return this.request("POST",e,i.toString(),{"Content-Type":"application/x-www-form-urlencoded"})}async postJson(e,t){return this.request("POST",e,JSON.stringify(t),{"Content-Type":"application/json"})}async putJson(e,t){return this.request("PUT",e,JSON.stringify(t),{"Content-Type":"application/json"})}request(e,t,i=null,r={},n=3){return this._doRequest(e,t,i,r,n,0)}_doRequest(e,t,i,r,n,o){return new Promise((a,l)=>{let c={hostname:this.host,port:this.port,path:t,method:e,headers:{Accept:"application/json",...r}};i&&(c.headers["Content-Length"]=Buffer.byteLength(i));let h=lf.request(c,d=>{let u=[];d.on("data",f=>u.push(f)),d.on("end",()=>{let f=Buffer.concat(u).toString();if(d.statusCode>=400){let p=new Error(`API ${e} ${t}: ${d.statusCode}`);if(p.status=d.statusCode,p.body=f,p.sqliteBusy=f.includes("SQLITE_BUSY"),p.sqliteBusy&&n>0){let g=Math.min(1e3*Math.pow(2,o),8e3);this.logger&&this.logger.debug(`SQLITE_BUSY on ${e} ${t}, retry ${o+1} in ${g}ms`),setTimeout(()=>{this._doRequest(e,t,i,r,n-1,o+1).then(a,l)},g);return}l(p);return}if(!f||f.length===0){a(null);return}try{a(JSON.parse(f))}catch{l(new Error(`API ${e} ${t}: invalid JSON response`))}})});h.on("error",d=>{this.logger&&this.logger.debug(`API request failed: ${e} ${t}`,{error:d.message}),l(d)}),h.setTimeout(1e4,()=>{h.destroy(new Error(`API timeout: ${e} ${t}`))}),i&&h.write(i),h.end()})}};Zl.exports={ApiClient:En}});var tc=E((Sg,ec)=>{"use strict";var Dn=class s{static EXPECTED_SLICES=["items","photos","selections","notes","metadata","tags","lists"];constructor(e,t){this.store=e,this.logger=t,this._suppressChangeDetection=!1,this._validateStateShape()}_validateStateShape(){try{let e=this._getState(),t=s.EXPECTED_SLICES.filter(i=>!(i in e));t.length>0&&this.logger.warn(`StoreAdapter: Redux state missing expected slices: ${t.join(", ")}. Tropy version may be incompatible \u2014 some sync features may not work.`)}catch(e){this.logger.warn(`StoreAdapter: failed to validate state shape: ${e.message}`)}}_getState(){return this.store.getState()}getAllItems(){let{items:e,photos:t}=this._getState(),i=[];for(let r of Object.keys(e)){let n=e[r];i.push({id:Number(r),template:n.template,photos:n.photos||[],lists:n.lists||[],tags:n.tags||[]})}return i}getItemFull(e){return this._buildItemFull(this._getState(),e)}getAllItemsFull(){let e=this._getState(),t=[];for(let i of Object.keys(e.items)){let r=this._buildItemFull(e,Number(i));r&&t.push(r)}return t}_buildItemFull(e,t){let i=e.items[t];if(!i)return null;let r={"@id":t,template:i.template,lists:i.lists||[]},n=e.metadata[t];if(n)for(let[l,c]of Object.entries(n))l!=="id"&&(typeof c=="object"&&c!==null?r[l]={"@value":c.text||"","@type":c.type||""}:c!=null&&(r[l]=c));let o=i.tags||[];r.tag=[];for(let l of o){let c=e.tags[l];c&&r.tag.push({id:l,name:c.name,color:c.color||null})}r.photo=[];let a=i.photos||[];for(let l of a){let c=e.photos[l];if(!c)continue;let h={"@id":l,checksum:c.checksum,note:[],selection:[],transcription:[],metadata:null},d=e.metadata[l];if(d){h.metadata={};for(let[u,f]of Object.entries(d))u!=="id"&&(h.metadata[u]=f)}for(let u of c.notes||[]){let f=e.notes[u];if(!f)continue;let p=this._noteStateToHtml(f);h.note.push({"@id":u,text:f.text||"",html:p,language:f.language||null,photo:l})}if(e.transcriptions)for(let u of c.transcriptions||[]){let f=e.transcriptions[u];f&&h.transcription.push(f)}for(let u of c.selections||[]){let f=e.selections[u];if(!f)continue;let p={"@id":u,x:f.x,y:f.y,width:f.width,height:f.height,angle:f.angle||0,note:[],metadata:null,transcription:[]},g=e.metadata[u];if(g){p.metadata={};for(let[m,y]of Object.entries(g))m!=="id"&&(p.metadata[m]=y)}for(let m of f.notes||[]){let y=e.notes[m];if(!y)continue;let _=this._noteStateToHtml(y);p.note.push({"@id":m,text:y.text||"",html:_,language:y.language||null,selection:u})}if(e.transcriptions)for(let m of f.transcriptions||[]){let y=e.transcriptions[m];y&&p.transcription.push(y)}h.selection.push(p)}r.photo.push(h)}return r}getAllTags(){let{tags:e}=this._getState();return Object.values(e||{}).map(t=>({id:t.id,name:t.name,color:t.color||null}))}getAllLists(){let{lists:e}=this._getState();return Object.values(e||{}).map(t=>({id:t.id,name:t.name,parent:t.parent||null}))}ping(){return!!this.store}async createSelection({photo:e,x:t,y:i,width:r,height:n,angle:o}){let a=new Set(Object.keys(this._getState().selections)),l=this.store.dispatch({type:"selection.create",payload:{photo:e,x:t,y:i,width:r,height:n,angle:o||0},meta:{cmd:"project"}});await this._waitForAction(l);let c=this._getState(),h=Object.keys(c.selections),d=[];for(let u of h)if(!a.has(u)){let f=c.selections[u];f&&f.photo===e&&d.push(u)}if(d.length>0){let u=d[d.length-1];return{id:Number(u),"@id":Number(u)}}return null}async createNote({photo:e,selection:t,html:i,language:r}){if(!e&&!t)return this.logger.warn("createNote: no photo or selection \u2014 skipping"),null;let n=new Set(Object.keys(this._getState().notes)),o={text:i||""};e&&(o.photo=e),t&&(o.selection=t),r&&(o.language=r);let a=this.store.dispatch({type:"note.create",payload:o,meta:{cmd:"project",history:"add"}});await this._waitForAction(a);let l=this._getState(),c=Object.keys(l.notes),h=[];for(let d of c)if(!n.has(d)){let u=l.notes[d];u&&(e&&u.photo===e||t&&u.selection===t)&&h.push(d)}if(h.length>0){let d=h[h.length-1];return{id:Number(d),"@id":Number(d)}}for(let d of c)if(!n.has(d))return{id:Number(d),"@id":Number(d)};return null}async updateNote(e,{html:t,language:i}){let n=this._getState().notes[e];if(!n)throw new Error(`Note ${e} not found in store`);let o=n.photo||void 0,a=n.selection||void 0,l=i||n.language||null,c=this._noteStateToHtml(n);try{await this.deleteNote(e)}catch{}let h;try{h=await this.createNote({photo:o,selection:a,html:t,language:l})}catch(d){this.logger.warn(`updateNote: create threw after delete for note ${e}`,{error:d.message});try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(u){throw this.logger.warn(`updateNote: restore also failed for note ${e}`,{error:u.message}),d}return h}if(!h){this.logger.warn(`updateNote: create returned null after delete, restoring original for note ${e}`);try{h=await this.createNote({photo:o,selection:a,html:c,language:l})}catch(d){throw this.logger.warn(`updateNote: restore also failed for note ${e}`,{error:d.message}),new Error(`updateNote: note ${e} deleted but both create and restore failed`)}if(!h)throw new Error(`updateNote: note ${e} deleted but both create and restore returned null`)}return h}async deleteNote(e){let t=this.store.dispatch({type:"note.delete",payload:[e],meta:{cmd:"project",history:"add"}});await this._waitForAction(t)}async addItemsToList(e,t){let i=this.store.dispatch({type:"list.item.add",payload:{id:e,items:Array.isArray(t)?t:[t]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}async removeItemsFromList(e,t){let i=this.store.dispatch({type:"list.item.remove",payload:{id:e,items:Array.isArray(t)?t:[t]},meta:{cmd:"project",history:"add",search:!0}});await this._waitForAction(i)}subscribe(e){this._prevState=this._getState();let t=["items","photos","selections","notes","metadata","tags","lists"];return this.store.subscribe(()=>{if(this._suppressChangeDetection)return;let i=this._getState(),r=!1;for(let n of t)if(i[n]!==this._prevState[n]){r=!0;break}if(this._prevState=i,r)try{e()}catch(n){this.logger.warn(`subscribe callback error: ${String(n.message||n)}`)}})}suppressChanges(){this._suppressChangeDetection=!0}resumeChanges(){this._prevState=this._getState(),this._suppressChangeDetection=!1}_waitForAction(e,t=15e3){if(!e||!e.meta||!e.meta.seq)return Promise.resolve();let i=e.meta.seq;return new Promise((r,n)=>{let o=!1,a=setTimeout(()=>{o||(o=!0,l(),n(new Error(`waitForAction: ${e.type} seq=${i} timed out after ${t}ms`)))},t),l=this.store.subscribe(()=>{if(o)return;let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),r())});if(!o){let c=this._getState();(!c.activities||!c.activities[i])&&(o=!0,clearTimeout(a),l(),r())}})}_noteStateToHtml(e){return e.html?e.html:e.state&&e.state.doc?this._renderDoc(e.state.doc):e.text?`<p>${this._esc(e.text)}</p>`:""}_renderDoc(e){if(!e||!e.content||(typeof e.toJSON=="function"&&(e=e.toJSON()),!e.content))return"";let t=e.content;if(!Array.isArray(t))if(Array.isArray(t.content))t=t.content;else return"";return t.map(i=>this._renderNode(i)).join("")}_renderNode(e){if(!e)return"";typeof e.toJSON=="function"&&(e=e.toJSON());let t="";if(e.content){let r=e.content;Array.isArray(r)||(Array.isArray(r.content)?r=r.content:r=[]),t=r.map(n=>this._renderNode(n)).join("")}switch(typeof e.type=="string"?e.type:e.type&&e.type.name||""){case"paragraph":{let r=e.attrs&&e.attrs.align;return r&&r!=="left"?`<p style="text-align: ${r==="right"?"end":r}">${t}</p>`:`<p>${t}</p>`}case"blockquote":return`<blockquote>${t}</blockquote>`;case"ordered_list":return`<ol>${t}</ol>`;case"bullet_list":return`<ul>${t}</ul>`;case"list_item":return`<li>${t}</li>`;case"heading":{let r=e.attrs&&e.attrs.level||1;return`<h${r}>${t}</h${r}>`}case"horizontal_rule":return"<hr>";case"code_block":return`<pre><code>${t}</code></pre>`;case"hard_break":return'<span class="line-break"><br></span>';case"text":{let r=this._esc(e.text||"");if(e.marks)for(let n of e.marks)switch(typeof n.type=="string"?n.type:n.type&&n.type.name||""){case"bold":case"strong":r=`<strong>${r}</strong>`;break;case"italic":case"em":r=`<em>${r}</em>`;break;case"link":r=`<a href="${this._esc(n.attrs&&n.attrs.href||"")}">${r}</a>`;break;case"superscript":case"sup":r=`<sup>${r}</sup>`;break;case"subscript":case"sub":r=`<sub>${r}</sub>`;break;case"strikethrough":r=`<span style="text-decoration: line-through">${r}</span>`;break;case"underline":r=`<span style="text-decoration: underline">${r}</span>`;break;case"overline":r=`<span style="text-decoration: overline">${r}</span>`;break}return r}default:return t}}_esc(e){let t=String(e),i="";for(let r=0;r<t.length;r++){let n=t[r];switch(n){case"&":i+="&amp;";break;case"<":i+="&lt;";break;case">":i+="&gt;";break;case'"':i+="&quot;";break;case"'":i+="&#x27;";break;default:i+=n}}return i}};ec.exports={StoreAdapter:Dn}});var Wt=E((xg,rc)=>{"use strict";var Rs=require("crypto");function Os(s,e=24){let t=[2166136261,16777619,668265261],i="";for(let r of t){let n=r;for(let o=0;o<s.length;o++)n^=s.charCodeAt(o),n=n*16777619>>>0;i+=(n>>>0).toString(16).padStart(8,"0")}return i.slice(0,e)}function sc(s){let e=ic(s);return e.length>0?cf(e):null}function ic(s){let e=[],t=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(t)||(t=[t]);for(let i of t){let r=i.checksum||i["https://tropy.org/v1/tropy#checksum"];r&&e.push(typeof r=="object"&&r["@value"]||String(r));let n=i.selection||i["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(n)||(n=[n]);for(let o of n){let a=o.checksum||o["https://tropy.org/v1/tropy#checksum"];a&&e.push(typeof a=="object"&&a["@value"]||String(a))}}return e}function cf(s){let e=s.slice().sort();return Rs.createHash("sha256").update(e.join(":")).digest("hex").slice(0,32)}function hf(s,e){let t=Math.round(e.x??0),i=Math.round(e.y??0),r=Math.round(e.width??e.w??0),n=Math.round(e.height??e.h??0);return Os(`sel:${s}:${t}:${i}:${r}:${n}`)}function df(s,e){let t=s.text||"",i=s.html||"",r=e||s.photo||s.selection||"orphan",n=i||t,o=n.slice(0,200),a=n.length>200?Os(n,8):"";return Os(`note:${r}:${o}:${a}`)}function uf(s,e,t){let i=t?`${s}:${t}`:s;return Os(`tx:${i}:${e}`)}function ff(s){let e=new Map;for(let t of s){let i=sc(t);i&&e.set(i,{localId:t["@id"]||t.id,item:t})}return e}function pf(s,e){return e.get(s)||null}function gf(s){let e=new Map,t=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(t)||(t=[t]);for(let i of t){let r=i["@id"]||i.id,n=i.checksum||i["https://tropy.org/v1/tropy#checksum"];r&&n&&(typeof n=="object"&&(n=n["@value"]||String(n)),e.set(r,String(n)))}return e}function mf(){return"n_"+Rs.randomUUID()}function yf(){return"s_"+Rs.randomUUID()}function wf(){return"t_"+Rs.randomUUID()}function _f(){return"l_"+Rs.randomUUID()}function bf(s,e){let t=Math.round(e.x??0),i=Math.round(e.y??0),r=Math.round(e.width??e.w??0),n=Math.round(e.height??e.h??0);return Os(`selfp:${s}:${t}:${i}:${r}:${n}`)}rc.exports={computeIdentity:sc,extractChecksums:ic,buildIdentityIndex:ff,findLocalMatch:pf,computeSelectionKey:hf,computeNoteKey:df,computeTranscriptionKey:uf,generateNoteUUID:mf,generateSelectionUUID:yf,generateTranscriptionUUID:wf,generateListUUID:_f,computeSelectionFingerprint:bf,buildPhotoChecksumMap:gf}});var nc=E($n=>{"use strict";Object.defineProperty($n,"__esModule",{value:!0});Kt();var Sf=(es(),_t(zn)),Ln=class extends Sf.Observable{constructor(e){super(),this.yarray=e,this.doc=e.doc,this.map=new Map;{let t=e.toArray();this.doc.transact(()=>{for(let i=t.length-1;i>=0;i--){let r=t[i];this.map.has(r.key)?e.delete(i):this.map.set(r.key,r)}})}e.observe((t,i)=>{let r=new Map,n=Array.from(t.changes.added);t.changes.deleted.forEach(c=>{c.content.getContent().forEach(h=>{this.map.get(h.key)===h&&(this.map.delete(h.key),r.set(h.key,{action:"delete",oldValue:h.val}))})});let o=new Map;n.map(c=>c.content.getContent()).flat().forEach(c=>{o.set(c.key,c)});let a=new Set,l=e.toArray();this.doc.transact(c=>{for(let h=l.length-1;h>=0&&(o.size>0||a.size>0);h--){let d=l[h];if(a.has(d.key))a.delete(d.key),e.delete(h,1);else if(o.get(d.key)===d){let u=this.map.get(d.key);if(u)a.add(d.key),r.set(d.key,{action:"update",oldValue:u.val,newValue:d.val});else{let f=r.get(d.key);f&&f.action==="delete"?r.set(d.key,{action:"update",newValue:d.val,oldValue:f.oldValue}):r.set(d.key,{action:"add",newValue:d.val})}o.delete(d.key),this.map.set(d.key,d)}else o.has(d.key)&&(a.add(d.key),o.delete(d.key))}}),r.size>0&&this.emit("change",[r,i])})}set(e,t){this.doc.transact(i=>{this.map.has(e)&&this.delete(e),this.yarray.push([{key:e,val:t}])})}delete(e){let t=0;for(let i of this.yarray){if(i.key===e){this.yarray.delete(t);break}t++}}get(e){let t=this.map.get(e);return t&&t.val}has(e){return this.map.has(e)}};$n.YKeyValue=Ln});var qi=E((vg,uc)=>{"use strict";var j=(Kt(),_t(Pt)),{YKeyValue:xf}=nc(),Pi=["metadata","tags","notes","photos","selections","selectionMeta","selectionNotes","transcriptions","lists","uuids","aliases"],Ki=["metadata","selectionMeta"];function ac(s){return s.toLowerCase()}var oc=new WeakMap;function Te(s){let e=oc.get(s);if(e)return e;let t=new xf(s);return oc.set(s,t),t}function G(s,e){return s.getMap("annotations").get(e)||null}function Mn(s,e){let t=s.getMap("annotations"),i=t.get(e);return i||(i=new j.Map,t.set(e,i)),i}function X(s,e,t){let i=Mn(s,e);if(Ki.includes(t)){let n=i.get(t);return(!n||!(n instanceof j.Array))&&(n=new j.Array,i.set(t,n)),Te(n)}let r=i.get(t);return r||(r=new j.Map,i.set(t,r)),r}function kf(s,e){let t=s.getMap("annotations"),i=t.get(e),r=!i;r&&(i=new j.Map);let n={};for(let o of Pi)if(Ki.includes(o)){let a=i.get(o);(!a||!(a instanceof j.Array))&&(a=new j.Array,i.set(o,a)),n[o]=Te(a)}else{let a=i.get(o);a||(a=new j.Map,i.set(o,a)),n[o]=a}return r&&t.set(e,i),n}function vf(s,e,t,i,r,n){X(s,e,"metadata").set(t,{text:i.text||"",type:i.type||"http://www.w3.org/2001/XMLSchema#string",language:i.language||null,author:r,pushSeq:n||0})}function Tf(s,e){let t=G(s,e);if(!t)return{};let i=t.get("metadata");if(!i||!(i instanceof j.Array))return{};let r=Te(i),n={};return r.map.forEach((o,a)=>{n[a]=o}),n}function If(s,e,t,i,r){let n=X(s,e,"tags"),o=ac(t.name),a=n.get(o);(!a||a.deleted||t.color!==a.color)&&n.set(o,{name:t.name,color:t.color||null,author:i,pushSeq:r||0})}function Af(s,e,t,i,r){let n=X(s,e,"tags"),o=ac(t),a=n.get(o);a&&!a.deleted&&n.set(o,{...a,deleted:!0,author:i,pushSeq:r||0,deletedAt:Date.now()})}function On(s,e){let t=G(s,e);if(!t)return[];let i=t.get("tags");if(!i)return[];let r=[];return i.forEach(n=>{r.push(n)}),r}function Cf(s,e){return On(s,e).filter(t=>!t.deleted)}function Uf(s,e){return On(s,e).filter(t=>t.deleted)}function Nf(s,e,t,i,r,n){X(s,e,"notes").set(t,{uuid:t,text:i.text||"",html:i.html||"",language:i.language||null,photo:i.photo||null,selection:i.selection||null,author:r,pushSeq:n||0}),Fs(s,e,t,"note",i.photo||i.selection)}function Ef(s,e,t,i,r){let n=X(s,e,"notes"),o=n.get(t);o&&!o.deleted&&n.set(t,{...o,deleted:!0,author:i,pushSeq:r||0,deletedAt:Date.now()})}function lc(s,e){let t=G(s,e);if(!t)return{};let i=t.get("notes");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function Df(s,e){let t=lc(s,e),i={};for(let[r,n]of Object.entries(t))n.deleted||(i[r]=n);return i}function Lf(s,e,t){let i=G(s,e);if(!i)return;let r=i.get("notes");r&&r.delete(t)}function $f(s,e,t,i,r,n,o){let a=X(s,e,"photos"),l=a.get(t);l||(l=new j.Map,l.set("metadata",new j.Array),a.set(t,l));let c=l.get("metadata");(!c||!(c instanceof j.Array))&&(c=new j.Array,l.set("metadata",c)),Te(c).set(i,{text:r.text||"",type:r.type||"http://www.w3.org/2001/XMLSchema#string",language:r.language||null,author:n,pushSeq:o||0})}function Mf(s,e,t){let i=G(s,e);if(!i)return{};let r=i.get("photos");if(!r)return{};let n=r.get(t);if(!n)return{};let o=n.get("metadata");if(!o||!(o instanceof j.Array))return{};let a=Te(o),l={};return a.map.forEach((c,h)=>{l[h]=c}),l}function Of(s,e){let t=G(s,e);if(!t)return[];let i=t.get("photos");if(!i)return[];let r=[];return i.forEach((n,o)=>{r.push(o)}),r}function Rf(s,e,t,i,r,n){let o=X(s,e,"selections"),a=i.x??0,l=i.y??0,c=i.width??i.w,h=i.height??i.h;!Number.isFinite(a)||!Number.isFinite(l)||c==null||h==null||!Number.isFinite(c)||!Number.isFinite(h)||c<=0||h<=0||(o.set(t,{uuid:t,x:a,y:l,w:c,h,angle:i.angle??0,photo:i.photo||null,author:r,pushSeq:n||0}),Fs(s,e,t,"selection",i.photo))}function Ff(s,e,t,i,r){let n=X(s,e,"selections"),o=n.get(t);o&&!o.deleted&&n.set(t,{...o,deleted:!0,author:i,pushSeq:r||0,deletedAt:Date.now()})}function cc(s,e){let t=G(s,e);if(!t)return{};let i=t.get("selections");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function Vf(s,e){let t=cc(s,e),i={};for(let[r,n]of Object.entries(t))n.deleted||(i[r]=n);return i}function jf(s,e,t,i,r,n,o){let a=X(s,e,"selectionMeta"),l=`${t}:${i}`;a.set(l,{text:r.text||"",type:r.type||"http://www.w3.org/2001/XMLSchema#string",language:r.language||null,author:n,pushSeq:o||0})}function Bf(s,e,t){let i=G(s,e);if(!i)return{};let r=i.get("selectionMeta");if(!r||!(r instanceof j.Array))return{};let n=Te(r),o=`${t}:`,a={};return n.map.forEach((l,c)=>{if(c.startsWith(o)){let h=c.slice(o.length);a[h]=l}}),a}function Pf(s,e,t,i,r,n,o){let a=X(s,e,"selectionNotes"),l=`${t}:${i}`;a.set(l,{noteUUID:i,selUUID:t,text:r.text||"",html:r.html||"",language:r.language||null,author:n,pushSeq:o||0}),Fs(s,e,i,"selectionNote",t)}function Kf(s,e,t,i,r,n){let o=X(s,e,"selectionNotes"),a=`${t}:${i}`,l=o.get(a);l&&!l.deleted&&o.set(a,{...l,deleted:!0,author:r,pushSeq:n||0,deletedAt:Date.now()})}function qf(s,e,t){let i=G(s,e);if(!i)return{};let r=i.get("selectionNotes");if(!r)return{};let n=`${t}:`,o={};return r.forEach((a,l)=>{l.startsWith(n)&&(a.deleted||(o[l]=a))}),o}function Hf(s,e){let t=G(s,e);if(!t)return{};let i=t.get("selectionNotes");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function zf(s,e,t){let i=G(s,e);if(!i)return;let r=i.get("selectionNotes");r&&r.delete(t)}function Wf(s,e,t,i,r,n){X(s,e,"transcriptions").set(t,{uuid:t,text:i.text||"",data:i.data||null,photo:i.photo||null,selection:i.selection||null,author:r,pushSeq:n||0}),Fs(s,e,t,"transcription",i.photo||i.selection)}function Gf(s,e,t,i,r){let n=X(s,e,"transcriptions"),o=n.get(t);o&&!o.deleted&&n.set(t,{...o,deleted:!0,author:i,pushSeq:r||0,deletedAt:Date.now()})}function hc(s,e){let t=G(s,e);if(!t)return{};let i=t.get("transcriptions");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function Jf(s,e){let t=hc(s,e),i={};for(let[r,n]of Object.entries(t))n.deleted||(i[r]=n);return i}function Yf(s,e,t,i,r,n){X(s,e,"lists").set(t,{uuid:t,name:i,member:!0,author:r,pushSeq:n||0}),Fs(s,e,t,"list",i)}function Xf(s,e,t,i,r){let n=X(s,e,"lists"),o=n.get(t);o&&!o.deleted&&n.set(t,{...o,member:!1,deleted:!0,author:i,pushSeq:r||0,deletedAt:Date.now()})}function dc(s,e){let t=G(s,e);if(!t)return{};let i=t.get("lists");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function Zf(s,e){let t=dc(s,e),i={};for(let[r,n]of Object.entries(t))!n.deleted&&n.member&&(i[r]=n);return i}function Fs(s,e,t,i,r){let n=X(s,e,"uuids");n.has(t)||n.set(t,{type:i,localRef:r||null,author:null})}function Qf(s,e){let t=G(s,e);if(!t)return{};let i=t.get("uuids");if(!i)return{};let r={};return i.forEach((n,o)=>{r[o]=n}),r}function ep(s,e,t){let i=G(s,t);i||(i=Mn(s,t));let r=i.get("aliases");r||(r=new j.Map,i.set("aliases",r)),r.set(e,{target:t,createdAt:Date.now()})}function tp(s,e){let t=s.getMap("annotations"),i=null;return t.forEach((r,n)=>{if(i)return;let o=r.get("aliases");if(o){let a=o.get(e);a&&(i=typeof a=="string"?a:a.target)}}),i}function sp(s,e){let t=s.getMap("annotations"),i=["tags","notes","selections","selectionNotes","transcriptions","lists"],r=0,n=0,o=0,a=0,l=e?Date.now()-e:null;return t.forEach(c=>{a++;for(let u of i){let f=c.get(u);if(!f)continue;let p=[];f.forEach((g,m)=>{g&&g.deleted&&(!l||!g.deletedAt||g.deletedAt<l)&&p.push(m)});for(let g of p)f.delete(g),r++}let h=c.get("uuids");if(h&&typeof h.forEach=="function"){let u=new Set,f=c.get("notes");f&&f.forEach((S,b)=>u.add(b));let p=c.get("selections");p&&p.forEach((S,b)=>u.add(b));let g=c.get("selectionNotes");g&&g.forEach((S,b)=>{let v=b.indexOf(":");v>0&&(u.add(b.slice(0,v)),u.add(b.slice(v+1)))});let m=c.get("transcriptions");m&&m.forEach((S,b)=>u.add(b));let y=c.get("lists");y&&y.forEach((S,b)=>u.add(b));let _=[];h.forEach((S,b)=>{u.has(b)||_.push(b)});for(let S of _)h.delete(S),n++}let d=c.get("aliases");if(d&&typeof d.forEach=="function"){let u=[];d.forEach((f,p)=>{let g=f&&typeof f=="object"?f.createdAt:0;(!l||!g||g<l)&&u.push(p)});for(let f of u)d.delete(f),o++}}),{items:a,purged:r,uuidsPurged:n,aliasesPurged:o}}function ip(s,e,t){let i=Mn(s,e),r=t.join(",");i.get("checksums")!==r&&i.set("checksums",r)}function rp(s,e){let t=G(s,e);if(!t)return[];let i=t.get("checksums");return i?i.split(",").filter(Boolean):[]}function np(s){let t=s.getMap("room").get("schemaVersion");return{version:t||null,compatible:!t||t===4}}function op(s){s.getMap("room").set("schemaVersion",4)}function ap(s,e){let t=G(s,e);if(!t)return null;let i={};for(let r of Pi)if(Ki.includes(r)){let n=t.get(r);if(!n||!(n instanceof j.Array)){i[r]={};continue}let o=Te(n),a={};o.map.forEach((l,c)=>{a[c]=l}),i[r]=a}else if(r==="photos"){let n=t.get(r),o={};n&&n.forEach((a,l)=>{let c=a.get("metadata"),h={};c&&c instanceof j.Array?Te(c).map.forEach((u,f)=>{h[f]=u}):c&&c.forEach((d,u)=>{h[u]=d}),o[l]={metadata:h}}),i[r]=o}else{let n=t.get(r);if(!n){i[r]={};continue}let o={};n.forEach((a,l)=>{o[l]=a}),i[r]=o}return i}function lp(s){let e=s.getMap("annotations"),t=[];return e.forEach((i,r)=>{t.push(r)}),t}function Bi(s){if(s&&typeof s=="object"){let{pushSeq:e,author:t,ts:i,...r}=s;return r}return s}function cp(s){let e=s.getMap("annotations"),t={};return e.forEach((i,r)=>{let n={};for(let o of Pi)if(Ki.includes(o)){let a=i.get(o);if(!a||!(a instanceof j.Array)){n[o]={};continue}let l=Te(a),c={};l.map.forEach((h,d)=>{c[d]=Bi(h)}),n[o]=c}else if(o==="photos"){let a=i.get(o),l={};a&&a.forEach((c,h)=>{let d=c.get("metadata"),u={};d&&d instanceof j.Array?Te(d).map.forEach((p,g)=>{u[g]=Bi(p)}):d&&d.forEach((f,p)=>{u[p]=Bi(f)}),l[h]={metadata:u}}),n[o]=l}else{let a=i.get(o);if(!a){n[o]={};continue}let l={};a.forEach((c,h)=>{l[h]=Bi(c)}),n[o]=l}t[r]=n}),t}function hp(s,e){let t=s.getMap("room");for(let[i,r]of Object.entries(e))t.set(i,r)}function dp(s){let e=s.getMap("room"),t={};return e.forEach((i,r)=>{t[r]=i}),t}function up(s,e){let t=s.getMap("annotations"),i=r=>{let n=new Set;r.forEach(o=>{o.target===t&&o.changes.keys.forEach((a,l)=>{n.add(l)})}),n.size>0&&e(Array.from(n))};return t.observeDeep(i),()=>t.unobserveDeep(i)}function fp(s,e,t){let i=s.getMap("annotations"),r=(n,o)=>{if(t!=null&&o.origin===t)return;let a=[];for(let l of n){let c=l.path;if(c.length>=2){let h=c[0],d=c[1];a.push({identity:h,type:d,event:l})}else l.target===i&&l.changes.keys.forEach((h,d)=>{a.push({identity:d,type:"item",event:l})})}a.length>0&&e(a)};return i.observeDeep(r),()=>i.unobserveDeep(r)}uc.exports={ITEM_SECTIONS:Pi,getItemAnnotations:kf,setMetadata:vf,getMetadata:Tf,setTag:If,removeTag:Af,getTags:On,getActiveTags:Cf,getDeletedTags:Uf,setNote:Nf,removeNote:Ef,deleteNoteEntry:Lf,getNotes:lc,getActiveNotes:Df,setPhotoMetadata:$f,getPhotoMetadata:Mf,getAllPhotoChecksums:Of,setSelection:Rf,removeSelection:Ff,getSelections:cc,getActiveSelections:Vf,setSelectionMeta:jf,getSelectionMeta:Bf,setSelectionNote:Pf,removeSelectionNote:Kf,deleteSelectionNoteEntry:zf,getSelectionNotes:qf,getAllSelectionNotes:Hf,setTranscription:Wf,removeTranscription:Gf,getTranscriptions:hc,getActiveTranscriptions:Jf,setListMembership:Yf,removeListMembership:Xf,getLists:dc,getActiveLists:Zf,getUUIDRegistry:Qf,setAlias:ep,resolveAlias:tp,setItemChecksums:ip,getItemChecksums:rp,checkSchemaVersion:np,setSchemaVersion:op,getSnapshot:cp,getItemSnapshot:ap,getIdentities:lp,purgeTombstones:sp,setRoomConfig:hp,getRoomConfig:dp,observeAnnotations:up,observeAnnotationsDeep:fp}});var pc=E((Tg,fc)=>{"use strict";var Gt=require("fs"),Hi=require("path"),pp=require("os"),gp={maxBackups:10,maxBackupSize:10*1024*1024,maxNoteSize:1*1024*1024,maxMetadataSize:64*1024,tombstoneFloodThreshold:.5},Rn=class{constructor(e,t,i,r={}){this.room=e,this.api=t,this.logger=i,this.options={...gp,...r},this.backupDir=Hi.join(pp.homedir(),".troparcel","backups",this.sanitizeDir(e)),this._fileCounter=0}sanitizeDir(e){return e.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}async ensureDir(){await Gt.promises.mkdir(this.backupDir,{recursive:!0})}async saveSnapshot(e){await this.ensureDir();let t=new Date().toISOString().replace(/[:.]/g,"-");this._fileCounter++;let i=`${t}-${String(this._fileCounter).padStart(4,"0")}.json`,r=Hi.join(this.backupDir,i),n={room:this.room,timestamp:new Date().toISOString(),version:"4.0",items:e},o=JSON.stringify(n);return o.length>this.options.maxBackupSize?(this.logger.warn(`Backup skipped: snapshot size ${o.length} bytes exceeds limit (${this.options.maxBackupSize} bytes) for ${e.length} item(s)`),null):(await Gt.promises.writeFile(r,o),this.logger.info(`Backup saved: ${r}`,{items:e.length}),await this.pruneOldBackups(),r)}async pruneOldBackups(){try{let t=(await Gt.promises.readdir(this.backupDir)).filter(r=>r.endsWith(".json")).sort(),i=[];for(;t.length>this.options.maxBackups;)i.push(t.shift());if(i.length>0){await Promise.allSettled(i.map(r=>Gt.promises.unlink(Hi.join(this.backupDir,r))));for(let r of i)this.logger.debug(`Pruned old backup: ${r}`)}}catch(e){this.logger.warn("Failed to prune backups",{error:e.message})}}async captureItemState(e,t){let i={identity:t,localId:e};try{i.metadata=await this.api.getMetadata(e)}catch(r){this.logger.warn(`captureItemState: failed to get metadata for ${e}`,{error:String(r.message||r)}),i.metadata=null}try{i.tags=await this.api.getItemTags(e)}catch(r){this.logger.warn(`captureItemState: failed to get tags for ${e}`,{error:String(r.message||r)}),i.tags=[]}i.photos=[];try{let r=await this.api.getPhotos(e);if(Array.isArray(r)){let n=r.map(a=>typeof a=="object"?a.id:a),o=await Promise.allSettled(n.map(a=>this.api.getPhoto(a)));for(let a of o)a.status==="fulfilled"&&a.value&&i.photos.push(a.value)}}catch(r){this.logger.warn(`captureItemState: failed to get photos for ${e}`,{error:String(r.message||r)})}return i}captureItemStateFromStore(e,t,i){let r=e.getItemFull(t);if(!r)return{identity:i,localId:t,metadata:null,tags:[],photos:[]};let n={},o=new Set(["id","photo","template","list","lists","tag","tags","photos","selections","notes","transcriptions"]);for(let[a,l]of Object.entries(r))a.startsWith("@")||a.startsWith("_")||o.has(a)||(n[a]=l);return{identity:i,localId:t,metadata:n,tags:r.tag||[],photos:r.photo||[]}}validateInbound(e,t,i){let r=[];if(t.notes)for(let[a,l]of Object.entries(t.notes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&r.push(`Note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.selectionNotes)for(let[a,l]of Object.entries(t.selectionNotes)){if(l.deleted)continue;let c=(l.html||"").length+(l.text||"").length;c>this.options.maxNoteSize&&r.push(`Selection note ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.transcriptions)for(let[a,l]of Object.entries(t.transcriptions)){if(l.deleted)continue;let c=(l.text||"").length+JSON.stringify(l.data||"").length;c>this.options.maxNoteSize&&r.push(`Transcription ${a} exceeds max size (${c} > ${this.options.maxNoteSize})`)}if(t.metadata)for(let[a,l]of Object.entries(t.metadata)){let c=(l.text||"").length;c>this.options.maxMetadataSize&&r.push(`Metadata ${a} exceeds max size (${c} > ${this.options.maxMetadataSize})`)}let n=0,o=0;for(let a of["tags","notes","selectionNotes","selections","transcriptions","lists"]){let l=t[a];if(l&&typeof l=="object")for(let c of Object.values(l))n++,c&&c.deleted&&(!i||c.author!==i)&&o++}return n>=20&&o/n>this.options.tombstoneFloodThreshold&&this.logger.info(`Tombstone ratio for ${e.slice(0,8)}: ${o}/${n} (${Math.round(o/n*100)}%) \u2014 not blocking`),{valid:r.length===0,warnings:r}}shouldOverwrite(e,t){return t&&t.deleted?!0:!((!t||!t.text)&&e&&e.text)}async rollback(e,t=null){let i=JSON.parse(await Gt.promises.readFile(e,"utf8")),r=0,n=[];for(let o of i.items){let a=[];try{if(o.metadata)try{await this.api.saveMetadata(o.localId,o.metadata)}catch(l){a.push(`metadata for ${o.localId}: ${l.message}`)}if(o.tags&&Array.isArray(o.tags))try{let l=o.tags.map(c=>c.id||c.tag_id).filter(Boolean);l.length>0&&await this.api.addTagsToItem(o.localId,l)}catch(l){a.push(`tags for ${o.localId}: ${l.message}`)}if(o.photos&&Array.isArray(o.photos))for(let l of o.photos){let c=l.notes||[];for(let d of c)try{let u=await this.api.getNote(d,"json");u&&u.html&&(t?await t.updateNote(d,{html:u.html}):this.logger.warn(`Rollback: note ${d} update skipped (no store adapter, HTTP PUT not supported)`))}catch(u){a.push(`note ${d}: ${u.message}`)}let h=l.selections||[];for(let d of h)this.logger.warn(`Rollback: selection ${d} update skipped (selection coordinate update not supported)`)}a.length>0&&(this.logger.warn(`Rollback: item ${o.localId} partially restored with ${a.length} error(s)`),n.push(...a)),r++}catch(l){n.push(`Failed to restore item ${o.localId}: ${l.message}`),n.push(...a)}}return this.logger.info(`Rollback complete: ${r} items restored`,{backup:e,errors:n.length}),{restored:r,errors:n}}listBackups(){try{return Gt.readdirSync(this.backupDir).filter(e=>e.endsWith(".json")).sort().reverse().map(e=>Hi.join(this.backupDir,e))}catch{return[]}}};fc.exports={BackupManager:Rn}});var wc=E((Ig,yc)=>{"use strict";var gc=require("crypto"),Vs=require("fs"),js=require("path"),mc=require("os"),mp=(Kt(),_t(Pt)),yp=5e3,Fn=5e4,He=5e4,Vn=class{constructor(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes=new Map,this.appliedNoteKeys=new Set,this.appliedSelectionKeys=new Set,this.appliedTranscriptionKeys=new Set,this.noteIdToCrdtKey=new Map,this.crdtKeyToNoteId=new Map,this.txIdToCrdtKey=new Map,this.crdtKeyToTxId=new Map,this.selIdToCrdtKey=new Map,this.crdtKeyToSelId=new Map,this.listNameToCrdtKey=new Map,this.crdtKeyToListName=new Map,this._cachedAnnotationCount=0,this.failedNoteKeys=new Map,this._dirty=!1,this.pushSeq=0,this.pushedFieldValues=new Map,this.dismissedKeys=new Set,this.retractedNoteKeys=new Set,this.appliedNoteHashes=new Map}markDirty(){this._dirty=!0}get isDirty(){return this._dirty}nextPushSeq(){return++this.pushSeq}hasLocalEdit(e,t,i){let r=`${e}:${t}`,n=this.pushedFieldValues.get(r);return n?n!==i:!0}markFieldPushed(e,t,i){let r=`${e}:${t}`;this.pushedFieldValues.set(r,i)}hasCRDTChanged(e){let t;if(e instanceof Uint8Array)t=e;else if(e&&typeof e.store<"u")t=mp.encodeStateVector(e);else{let r=this.hashObject(e);return r===this.lastCRDTHash?!1:(this.lastCRDTHash=r,!0)}let i=gc.createHash("sha256").update(Buffer.from(t)).digest("hex").slice(0,16);return i===this.lastCRDTHash?!1:(this.lastCRDTHash=i,!0)}shouldBackup(e){let t=this.hashObject(e);return t===this.lastBackupHash?!1:(this.lastBackupHash=t,!0)}hasItemChanged(e,t){let i=this._fastHash(t);return{changed:this.pushedHashes.get(e)!==i,hash:i}}markPushed(e,t){this._evictIfNeeded(this.pushedHashes,yp),this.pushedHashes.set(e,t)}_fastHash(e){let t=JSON.stringify(e),i=2166136261;for(let r=0;r<t.length;r++)i^=t.charCodeAt(r),i=i*16777619>>>0;return i.toString(36)}getNoteKey(e,t){let i=String(e),r=this.noteIdToCrdtKey.get(i);return r||(this._evictIfNeeded(this.noteIdToCrdtKey,He),this.noteIdToCrdtKey.set(i,t),this.crdtKeyToNoteId.set(t,i),this._dirty=!0,t)}mapAppliedNote(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToNoteId,He),this.crdtKeyToNoteId.set(e,i),this.noteIdToCrdtKey.set(i,e),this._dirty=!0}getLocalNoteId(e){return this.crdtKeyToNoteId.get(e)||null}getTxKey(e,t){let i=String(e),r=this.txIdToCrdtKey.get(i);return r||(this._evictIfNeeded(this.txIdToCrdtKey,He),this.txIdToCrdtKey.set(i,t),this.crdtKeyToTxId.set(t,i),t)}mapAppliedTranscription(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToTxId,He),this.crdtKeyToTxId.set(e,i),this.txIdToCrdtKey.set(i,e)}getLocalTxId(e){return this.crdtKeyToTxId.get(e)||null}getSelectionKey(e,t){let i=String(e),r=this.selIdToCrdtKey.get(i);return r||(this._evictIfNeeded(this.selIdToCrdtKey,He),this.selIdToCrdtKey.set(i,t),this.crdtKeyToSelId.set(t,i),this._dirty=!0,t)}mapAppliedSelection(e,t){let i=String(t);this._evictIfNeeded(this.crdtKeyToSelId,He),this.crdtKeyToSelId.set(e,i),this.selIdToCrdtKey.set(i,e),this._dirty=!0}getLocalSelId(e){return this.crdtKeyToSelId.get(e)||null}getListKey(e){return this.listNameToCrdtKey.get(e)||null}mapAppliedList(e,t){this._evictIfNeeded(this.listNameToCrdtKey,He),this.listNameToCrdtKey.set(t,e),this.crdtKeyToListName.set(e,t),this._dirty=!0}getLocalListName(e){return this.crdtKeyToListName.get(e)||null}markNoteApplied(e,t){this._evictIfNeeded(this.appliedNoteHashes,He),this.appliedNoteHashes.set(e,this._fastHash(t)),this._dirty=!0}hasLocalNoteEdit(e,t){let i=this.appliedNoteHashes.get(e);return i?i!==this._fastHash(t):!1}recoverFromCRDT(e,t,i){let r=i.getUUIDRegistry(e,t),n=0;for(let[o,a]of Object.entries(r))if(!(!a||!a.type))switch(a.type){case"note":a.localRef&&!this.crdtKeyToNoteId.has(o)&&(this.appliedNoteKeys.add(o),n++);break;case"selection":this.crdtKeyToSelId.has(o)||(this.appliedSelectionKeys.add(o),n++);break;case"transcription":this.crdtKeyToTxId.has(o)||(this.appliedTranscriptionKeys.add(o),n++);break;case"list":a.localRef&&!this.crdtKeyToListName.has(o)&&(this.mapAppliedList(o,a.localRef),n++);break}return n}updateAnnotationCount(e){this._cachedAnnotationCount=e}get annotationCount(){return this._cachedAnnotationCount}hashObject(e){let t=this._sortedStringify(e);return gc.createHash("sha256").update(t).digest("hex").slice(0,16)}_sortedStringify(e){return JSON.stringify(e,(t,i)=>{if(i&&typeof i=="object"&&!Array.isArray(i)){let r={};for(let n of Object.keys(i).sort())r[n]=i[n];return r}return i})}_evictIfNeeded(e,t){if(e.size<t)return;let i=Math.floor(t*.2),r=e.keys();for(let n=0;n<i;n++){let o=r.next();if(o.done)break;e.delete(o.value)}}pruneAppliedKeys(){this._truncateSetInPlace(this.appliedNoteKeys,Fn),this._truncateSetInPlace(this.appliedSelectionKeys,Fn),this._truncateSetInPlace(this.appliedTranscriptionKeys,Fn)}_truncateSetInPlace(e,t){if(e.size<=t)return;let i=e.size-t,r=e.values();for(let n=0;n<i;n++){let o=r.next();if(o.done)break;e.delete(o.value)}}async persistToFile(e,t){if(e)try{let i=js.join(mc.homedir(),".troparcel","vault");await Vs.promises.mkdir(i,{recursive:!0});let r=t?"_"+this._sanitizeRoom(t):"",n=js.join(i,this._sanitizeRoom(e)+r+".json"),o=n+".tmp",a={version:4,timestamp:new Date().toISOString(),pushSeq:this.pushSeq,appliedNoteKeys:Array.from(this.appliedNoteKeys),appliedSelectionKeys:Array.from(this.appliedSelectionKeys),appliedTranscriptionKeys:Array.from(this.appliedTranscriptionKeys),failedNoteKeys:Array.from(this.failedNoteKeys.entries()).map(([l,c])=>({key:l,count:c})),noteMappings:Array.from(this.crdtKeyToNoteId.entries()).map(([l,c])=>[l,c]),txMappings:Array.from(this.crdtKeyToTxId.entries()).map(([l,c])=>[l,c]),selMappings:Array.from(this.crdtKeyToSelId.entries()).map(([l,c])=>[l,c]),listMappings:Array.from(this.crdtKeyToListName.entries()).map(([l,c])=>[l,c]),dismissedKeys:Array.from(this.dismissedKeys),retractedNoteKeys:Array.from(this.retractedNoteKeys),appliedNoteHashes:Array.from(this.appliedNoteHashes.entries())};await Vs.promises.writeFile(o,JSON.stringify(a)),await Vs.promises.rename(o,n),this._dirty=!1}catch(i){throw i}}loadFromFile(e,t){if(!e)return!1;try{let i=js.join(mc.homedir(),".troparcel","vault"),r=t?"_"+this._sanitizeRoom(t):"",n=js.join(i,this._sanitizeRoom(e)+r+".json"),o;try{o=Vs.readFileSync(n,"utf8")}catch{if(r){let l=js.join(i,this._sanitizeRoom(e)+".json");o=Vs.readFileSync(l,"utf8")}else throw new Error("no vault file")}let a=JSON.parse(o);if(a.version!==1&&a.version!==2&&a.version!==3&&a.version!==4)return!1;if(Array.isArray(a.appliedNoteKeys))for(let l of a.appliedNoteKeys)this.appliedNoteKeys.add(l);if(Array.isArray(a.appliedSelectionKeys))for(let l of a.appliedSelectionKeys)this.appliedSelectionKeys.add(l);if(Array.isArray(a.appliedTranscriptionKeys))for(let l of a.appliedTranscriptionKeys)this.appliedTranscriptionKeys.add(l);if(Array.isArray(a.failedNoteKeys))for(let l of a.failedNoteKeys)typeof l=="string"?this.failedNoteKeys.set(l,3):Array.isArray(l)?this.failedNoteKeys.set(l[0],l[1]||3):l&&l.key&&this.failedNoteKeys.set(l.key,l.count||3);if(Array.isArray(a.noteMappings))for(let[l,c]of a.noteMappings)this.crdtKeyToNoteId.set(l,String(c)),this.noteIdToCrdtKey.set(String(c),l);if(Array.isArray(a.txMappings))for(let[l,c]of a.txMappings)this.crdtKeyToTxId.set(l,String(c)),this.txIdToCrdtKey.set(String(c),l);if(Array.isArray(a.selMappings))for(let[l,c]of a.selMappings)this.crdtKeyToSelId.set(l,String(c)),this.selIdToCrdtKey.set(String(c),l);if(Array.isArray(a.listMappings))for(let[l,c]of a.listMappings)this.crdtKeyToListName.set(l,c),this.listNameToCrdtKey.set(c,l);if(typeof a.pushSeq=="number"&&(this.pushSeq=a.pushSeq),Array.isArray(a.dismissedKeys))for(let l of a.dismissedKeys)this.dismissedKeys.add(l);if(Array.isArray(a.retractedNoteKeys))for(let l of a.retractedNoteKeys)this.retractedNoteKeys.add(l);if(Array.isArray(a.appliedNoteHashes))for(let[l,c]of a.appliedNoteHashes)this.appliedNoteHashes.set(l,c);return!0}catch{return!1}}_sanitizeRoom(e){return e.replace(/[^a-zA-Z0-9_.-]/g,"_").slice(0,128)||"default"}clear(){this.lastCRDTHash=null,this.lastBackupHash=null,this.pushedHashes.clear(),this.appliedNoteKeys.clear(),this.appliedSelectionKeys.clear(),this.appliedTranscriptionKeys.clear(),this.noteIdToCrdtKey.clear(),this.crdtKeyToNoteId.clear(),this.txIdToCrdtKey.clear(),this.crdtKeyToTxId.clear(),this.selIdToCrdtKey.clear(),this.crdtKeyToSelId.clear(),this.listNameToCrdtKey.clear(),this.crdtKeyToListName.clear(),this._cachedAnnotationCount=0,this.failedNoteKeys.clear(),this.pushedFieldValues.clear(),this.dismissedKeys.clear(),this.retractedNoteKeys.clear(),this.appliedNoteHashes.clear(),this.pushSeq=0}};yc.exports={SyncVault:Vn}});var bc=E((Ag,_c)=>{"use strict";var A=Wt(),I=qi();_c.exports={async pushLocal(s,e){let t=this._stableUserId,i=0,r=0,n=new Map;for(let o of s){let a=A.computeIdentity(o);a&&n.set(a,o)}for(let[o,a]of n){let l=this.vault.hasItemChanged(o,a);if(!l.changed){r++;continue}i++;let c=A.buildPhotoChecksumMap(a);this._debug(`pushLocal: ${o.slice(0,8)} \u2014 ${c.size} photo(s), first checksum: ${[...c.values()][0]?.slice(0,12)||"none"}...`);try{let h={};this.doc.transact(()=>{let d=Array.from(c.values());d.length>0&&I.setItemChecksums(this.doc,o,d),this.pushMetadata(a,o,t,e),this.pushTags(a,o,t,e),h.noteKeys=this.pushNotes(a,o,t,c,e),this.pushPhotoMetadata(a,o,t,e),h.selectionKeys=this.pushSelections(a,o,t,c,e),h.transcriptionKeys=this.pushTranscriptions(a,o,t,c,e),this.options.syncLists&&this.pushLists(a,o,t,e),this.pushDeletions(a,o,t,c,h,e)},this.LOCAL_ORIGIN),this.saveItemSnapshot(a,o,c,h),this.vault.markPushed(o,l.hash),this._pushFailCounts&&this._pushFailCounts.has(o)&&this._pushFailCounts.delete(o)}catch(h){this.logger.warn(`Failed to push item ${o}`,{error:h.message});let d=this._pushFailCounts&&this._pushFailCounts.get(o)||0;this._pushFailCounts||(this._pushFailCounts=new Map),this._pushFailCounts.set(o,d+1),d+1>=3&&(this.vault.markPushed(o,l.hash),this._pushFailCounts.delete(o),this.logger.warn(`Item ${o} push permanently skipped after ${d+1} failures`))}}i>0?this._log(`pushed ${i} item(s) to CRDT`):this._debug(`pushLocal: ${r} item(s) unchanged`)},pushMetadata(s,e,t,i){if(!this.options.syncMetadata)return;let r=I.getMetadata(this.doc,e);for(let[n,o]of Object.entries(s)){if(n.startsWith("@")||n.startsWith("_")||["photo","template","list","lists","tag"].includes(n)||!n.includes(":")&&!n.includes("/"))continue;let a="",l="http://www.w3.org/2001/XMLSchema#string",c=null;typeof o=="string"?a=o:o&&typeof o=="object"?(a=o["@value"]||o.text||"",l=o["@type"]||o.type||l,c=o["@language"]||o.language||null):o!=null&&(a=String(o));let h=r[n];if(!(!a&&!h)){if(h){if(h.text===a&&h.type===l)continue;if(h.author!==t){let d=this.vault._fastHash(`${a}|${l}`);if(!this.vault.hasLocalEdit(e,n,d)){this._logConflict("metadata",e,n,{local:a?.slice(0,50),remote:h.text?.slice(0,50),remoteAuthor:h.author});continue}}}I.setMetadata(this.doc,e,n,{text:a,type:l,language:c},t,i),this.vault.markFieldPushed(e,n,this.vault._fastHash(`${a}|${l}`))}}},pushTags(s,e,t,i){if(!this.options.syncTags)return;let r=s.tag||s["https://tropy.org/v1/tropy#tag"]||[];Array.isArray(r)||(r=[r]);let n=I.getTags(this.doc,e),o=new Map(n.map(a=>[a.name.toLowerCase(),a]));for(let a of r){let l=typeof a=="string"?a:a.name||a["@value"]||"",c=typeof a=="object"?a.color:null;if(!l)continue;let h=o.get(l.toLowerCase());if(h&&!h.deleted){if((h.color||null)===(c||null))continue;if(h.author!==t){let d=this.vault._fastHash(`tag:${l.toLowerCase()}:${c||""}`);if(!this.vault.hasLocalEdit(e,`tag:${l.toLowerCase()}`,d))continue}}h&&h.deleted&&h.author!==t||(I.setTag(this.doc,e,{name:l,color:c},t,i),this.vault.markFieldPushed(e,`tag:${l.toLowerCase()}`,this.vault._fastHash(`tag:${l.toLowerCase()}:${c||""}`)))}},pushNotes(s,e,t,i,r){if(!this.options.syncNotes)return{noteKeys:new Set,selectionNoteKeys:new Set};let n=s.photo||s["https://tropy.org/v1/tropy#photo"]||[];Array.isArray(n)||(n=[n]);let o=I.getNotes(this.doc,e),a=new Set,l=new Set;for(let c of n){let h=c.checksum||i.get(c["@id"]||c.id),d=c.note||c["https://tropy.org/v1/tropy#note"]||[];Array.isArray(d)||(d=[d]);for(let f of d){if(!f)continue;let p=f["@value"]||f.text||f["https://schema.org/text"]||"",g=f.html||f["https://tropy.org/v1/tropy#html"]||"";if(typeof p=="object"&&(p=p["@value"]||""),typeof g=="object"&&(g=g["@value"]||""),!this._isSyncedNote(p,g)&&(p||g)){let m=f["@id"]||f.id,y=m?this.vault.getNoteKey(m,A.generateNoteUUID()):A.generateNoteUUID();a.add(y);let _=o[y];if(_&&!_.deleted&&_.text===p&&_.html===g){this.vault.appliedNoteKeys.add(y);continue}if(_&&!_.deleted&&_.author!==t){let S=this.vault._fastHash(`note:${g||p}`);if(!this.vault.hasLocalEdit(e,`note:${y}`,S))continue}I.setNote(this.doc,e,y,{text:p,html:g,language:f.language||null,photo:h||null},t,r),this.vault.appliedNoteKeys.add(y),this.vault.markFieldPushed(e,`note:${y}`,this.vault._fastHash(`note:${g||p}`))}}let u=c.selection||c["https://tropy.org/v1/tropy#selection"]||[];Array.isArray(u)||(u=[u]);for(let f of u){if(!f||!h)continue;let p=f["@id"]||f.id,g=p?this.vault.getSelectionKey(p,A.generateSelectionUUID()):A.computeSelectionFingerprint(h,f),m=f.note||f["https://tropy.org/v1/tropy#note"]||[];Array.isArray(m)||(m=[m]);let y=I.getSelectionNotes(this.doc,e,g);for(let _ of m){if(!_)continue;let S=_["@value"]||_.text||_["https://schema.org/text"]||"",b=_.html||_["https://tropy.org/v1/tropy#html"]||"";if(typeof S=="object"&&(S=S["@value"]||""),typeof b=="object"&&(b=b["@value"]||""),!this._isSyncedNote(S,b)&&(S||b)){let v=_["@id"]||_.id,$=v?this.vault.getNoteKey(v,A.generateNoteUUID()):A.generateNoteUUID(),oe=`${g}:${$}`;l.add(oe);let We=y[oe];if(We&&We.text===S&&We.html===b){this.vault.appliedNoteKeys.add(oe);continue}if(We&&!We.deleted&&We.author!==t){let Lc=this.vault._fastHash(`selnote:${b||S}`);if(!this.vault.hasLocalEdit(e,`selnote:${oe}`,Lc))continue}I.setSelectionNote(this.doc,e,g,$,{text:S,html:b,language:_.language||null},t,r),this.vault.appliedNoteKeys.add(oe)}}}}return this._cleanupStaleNotes(e,t,a,l),{noteKeys:a,selectionNoteKeys:l}},_cleanupStaleNotes(s,e,t,i){if(!this.options.syncDeletions)return;let r=this.previousSnapshot.get(s),n=r&&r.noteKeys?r.noteKeys:null,o=r&&r.selectionNoteKeys?r.selectionNoteKeys:null,a=I.getNotes(this.doc,s),l=0;for(let[h,d]of Object.entries(a))d.author===e&&(d.deleted||t.has(h)||n&&n.has(h)||(I.deleteNoteEntry(this.doc,s,h),l++));let c=I.getAllSelectionNotes(this.doc,s);for(let[h,d]of Object.entries(c))d.author===e&&(d.deleted||i.has(h)||o&&o.has(h)||(I.deleteSelectionNoteEntry(this.doc,s,h),l++));l>0&&this._log(`cleanupStaleNotes: removed ${l} stale entry(s) for ${s.slice(0,8)}`)},pushPhotoMetadata(s,e,t,i){if(!this.options.syncPhotoAdjustments)return;let r=s.photo||[];Array.isArray(r)||(r=[r]);for(let n of r){let o=n.checksum;if(!o||!n.metadata)continue;let a=I.getPhotoMetadata(this.doc,e,o);for(let[l,c]of Object.entries(n.metadata)){if(l==="id")continue;let h="",d="http://www.w3.org/2001/XMLSchema#string";typeof c=="object"&&c!==null?(h=c.text||"",d=c.type||d):c!=null&&(h=String(c));let u=a[l];if(!(!h&&!u)){if(u){if(u.text===h&&u.type===d)continue;if(u.author!==t){let f=this.vault._fastHash(`${h}|${d}`);if(!this.vault.hasLocalEdit(e,`photo:${o}:${l}`,f))continue}}I.setPhotoMetadata(this.doc,e,o,l,{text:h,type:d},t,i),this.vault.markFieldPushed(e,`photo:${o}:${l}`,this.vault._fastHash(`${h}|${d}`))}}}},pushSelections(s,e,t,i,r){if(!this.options.syncSelections)return new Set;let n=s.photo||[];Array.isArray(n)||(n=[n]);let o=I.getSelections(this.doc,e),a=new Set;for(let l of n){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.selection||[];Array.isArray(h)||(h=[h]);for(let d of h){if(!d)continue;let u=d["@id"]||d.id,f=u?this.vault.getSelectionKey(u,A.generateSelectionUUID()):A.generateSelectionUUID();a.add(f);let p=o[f],g=p&&!p.deleted&&p.x===d.x&&p.y===d.y&&p.w===d.width&&p.h===d.height&&(p.angle||0)===(d.angle||0),m=!1;if(p&&!p.deleted&&p.author!==t){let y=this.vault._fastHash(`sel:${d.x}:${d.y}:${d.width}:${d.height}`);m=!this.vault.hasLocalEdit(e,`sel:${f}`,y)}if(!g&&!m?(I.setSelection(this.doc,e,f,{x:d.x,y:d.y,width:d.width,height:d.height,angle:d.angle||0,photo:c},t,r),this.vault.appliedSelectionKeys.add(f),this.vault.markFieldPushed(e,`sel:${f}`,this.vault._fastHash(`sel:${d.x}:${d.y}:${d.width}:${d.height}`))):g&&this.vault.appliedSelectionKeys.add(f),d.metadata){let y=I.getSelectionMeta(this.doc,e,f);for(let[_,S]of Object.entries(d.metadata)){if(_==="id")continue;let b="",v="http://www.w3.org/2001/XMLSchema#string";typeof S=="object"&&S!==null?(b=S.text||"",v=S.type||v):S!=null&&(b=String(S));let $=y[_];if(!(!b&&!$)){if($){if($.text===b&&$.type===v)continue;if($.author!==t){let oe=this.vault._fastHash(`${b}|${v}`);if(!this.vault.hasLocalEdit(e,`selmeta:${f}:${_}`,oe))continue}}I.setSelectionMeta(this.doc,e,f,_,{text:b,type:v},t,r),this.vault.markFieldPushed(e,`selmeta:${f}:${_}`,this.vault._fastHash(`${b}|${v}`))}}}}}return a},pushTranscriptions(s,e,t,i,r){if(!this.options.syncTranscriptions)return new Set;let n=s.photo||[];Array.isArray(n)||(n=[n]);let o=new Set,a=I.getTranscriptions(this.doc,e);for(let l of n){let c=l.checksum||i.get(l["@id"]||l.id);if(!c)continue;let h=l.transcription||[];Array.isArray(h)||(h=[h]),h.forEach((u,f)=>{if(!u)return;let p=(u.text||"").length+JSON.stringify(u.data||"").length;if(p>this.options.maxNoteSize){this.logger.warn(`Skipping oversized transcription (${p} bytes > ${this.options.maxNoteSize}) on photo ${c.slice(0,12)}`);return}let g=u["@id"]||u.id,m=g?this.vault.getTxKey(g,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();o.add(m),this.vault.appliedTranscriptionKeys.add(m);let y=a[m];if(!(y&&!y.deleted&&y.text===(u.text||""))){if(y&&!y.deleted&&y.author!==t){let _=this.vault._fastHash(`tx:${u.text||""}`);if(!this.vault.hasLocalEdit(e,`tx:${m}`,_))return}I.setTranscription(this.doc,e,m,{text:u.text||"",data:u.data||null,photo:c},t,r),this.vault.markFieldPushed(e,`tx:${m}`,this.vault._fastHash(`tx:${u.text||""}`))}});let d=l.selection||[];Array.isArray(d)||(d=[d]);for(let u of d){if(!u)continue;let f=u["@id"]||u.id,p=f?this.vault.getSelectionKey(f,A.generateSelectionUUID()):A.computeSelectionFingerprint(c,u),g=u.transcription||[];Array.isArray(g)||(g=[g]),g.forEach((m,y)=>{if(!m)return;let _=(m.text||"").length+JSON.stringify(m.data||"").length;if(_>this.options.maxNoteSize){this.logger.warn(`Skipping oversized selection transcription (${_} bytes > ${this.options.maxNoteSize})`);return}let S=m["@id"]||m.id,b=S?this.vault.getTxKey(S,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();o.add(b),this.vault.appliedTranscriptionKeys.add(b);let v=a[b];if(!(v&&!v.deleted&&v.text===(m.text||""))){if(v&&!v.deleted&&v.author!==t){let $=this.vault._fastHash(`tx:${m.text||""}`);if(!this.vault.hasLocalEdit(e,`tx:${b}`,$))return}I.setTranscription(this.doc,e,b,{text:m.text||"",data:m.data||null,photo:c,selection:p},t,r),this.vault.markFieldPushed(e,`tx:${b}`,this.vault._fastHash(`tx:${m.text||""}`))}})}}return o},pushLists(s,e,t,i){let r=s.lists||[];if(!Array.isArray(r))return;let n=I.getLists(this.doc,e);for(let o of r){let a=this._listNameCache.get(o)||this._listNameCache.get(String(o));if(!a){this._debug(`pushLists: skipping list ${o} (name not in cache)`);continue}let l=this.vault.getListKey(a);if(!l){let h=Object.entries(n).find(([d,u])=>u.name===a&&!u.deleted);h?(l=h[0],this.vault.mapAppliedList(l,a)):(l=A.generateListUUID(),this.vault.mapAppliedList(l,a))}let c=n[l];if(!(c&&!c.deleted&&c.member)){if(c&&c.author!==t){let h=this.vault._fastHash(`list:${a}`);if(!this.vault.hasLocalEdit(e,`list:${l}`,h))continue}I.setListMembership(this.doc,e,l,a,t,i),this.vault.markFieldPushed(e,`list:${l}`,this.vault._fastHash(`list:${a}`))}}},async _refreshListNameCache(){if(!this.options.syncLists)return;let s=Date.now();if(!(s-this._listCacheRefreshedAt<5e3))try{let e=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(e)){this._listNameCache.clear();for(let t of e)t.id&&t.name&&(this._listNameCache.set(t.id,t.name),this._listNameCache.set(String(t.id),t.name));this._listCacheRefreshedAt=s}}catch(e){this.logger.warn("Failed to refresh list name cache",{error:e.message})}},_computeItemKeys(s,e){let t=new Set,i=new Set,r=new Set,n=new Set,o=new Set,a=s.photo||[];Array.isArray(a)||(a=[a]);for(let c of a){let h=c.checksum||e.get(c["@id"]||c.id),d=c.note||[];Array.isArray(d)||(d=[d]);for(let p of d){if(!p)continue;let g=p["@value"]||p.text||p["https://schema.org/text"]||"",m=p.html||p["https://tropy.org/v1/tropy#html"]||"";if(typeof g=="object"&&(g=g["@value"]||""),typeof m=="object"&&(m=m["@value"]||""),!this._isSyncedNote(g,m)&&(g||m)){let y=p["@id"]||p.id,_=y?this.vault.getNoteKey(y,A.generateNoteUUID()):A.generateNoteUUID();t.add(_)}}let u=c.transcription||[];Array.isArray(u)||(u=[u]),u.forEach((p,g)=>{if(!p)return;let m=p["@id"]||p.id,y=m?this.vault.getTxKey(m,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();r.add(y)});let f=c.selection||[];Array.isArray(f)||(f=[f]);for(let p of f){if(!p||!h)continue;let g=p["@id"]||p.id,m=g?this.vault.getSelectionKey(g,A.generateSelectionUUID()):A.generateSelectionUUID();i.add(m);let y=p.note||[];Array.isArray(y)||(y=[y]);for(let S of y){if(!S)continue;let b=S["@value"]||S.text||S["https://schema.org/text"]||"",v=S.html||S["https://tropy.org/v1/tropy#html"]||"";if(typeof b=="object"&&(b=b["@value"]||""),typeof v=="object"&&(v=v["@value"]||""),!this._isSyncedNote(b,v)&&(b||v)){let $=S["@id"]||S.id,oe=$?this.vault.getNoteKey($,A.generateNoteUUID()):A.generateNoteUUID();n.add(`${m}:${oe}`)}}let _=p.transcription||[];Array.isArray(_)||(_=[_]),_.forEach((S,b)=>{if(!S)return;let v=S["@id"]||S.id,$=v?this.vault.getTxKey(v,A.generateTranscriptionUUID()):A.generateTranscriptionUUID();r.add($)})}}let l=s.lists||[];if(Array.isArray(l))for(let c of l){let h=this._listNameCache.get(c)||this._listNameCache.get(String(c));h&&o.add(h)}return{noteKeys:t,selectionKeys:i,transcriptionKeys:r,selectionNoteKeys:n,listNames:o}},saveItemSnapshot(s,e,t,i){let r=Array.from(this._resolveTagNames(s));if(i&&i.noteKeys&&i.selectionKeys&&i.transcriptionKeys){let n=this._resolveListNames(s);this.previousSnapshot.set(e,{tags:r,noteKeys:i.noteKeys.noteKeys,selectionNoteKeys:i.noteKeys.selectionNoteKeys,selectionKeys:i.selectionKeys,transcriptionKeys:i.transcriptionKeys,listNames:n})}else{let n=this._computeItemKeys(s,t);this.previousSnapshot.set(e,{tags:r,...n})}},_resolveListNames(s){let e=new Set,t=s.lists||[];if(Array.isArray(t))for(let i of t){let r=this._listNameCache.get(i)||this._listNameCache.get(String(i));r&&e.add(r)}return e},_resolveTagNames(s){return new Set((s.tag||[]).map(e=>typeof e=="string"?e:e.name||"").filter(Boolean))},pushDeletions(s,e,t,i,r,n){if(!this.options.syncDeletions)return;let o=this.previousSnapshot.get(e);if(!o)return;if(this.options.syncTags){let l=this._resolveTagNames(s),c=new Set([...l].map(h=>h.toLowerCase()));for(let h of o.tags)c.has(h.toLowerCase())||I.removeTag(this.doc,e,h,t,n)}let a;if(r&&r.noteKeys&&r.selectionKeys&&r.transcriptionKeys){let l=this._resolveListNames(s);a={noteKeys:r.noteKeys.noteKeys,selectionNoteKeys:r.noteKeys.selectionNoteKeys,selectionKeys:r.selectionKeys,transcriptionKeys:r.transcriptionKeys,listNames:l}}else a=this._computeItemKeys(s,i);if(this.options.syncNotes&&o.noteKeys)for(let l of o.noteKeys)a.noteKeys.has(l)||I.removeNote(this.doc,e,l,t,n);if(this.options.syncSelections&&o.selectionKeys)for(let l of o.selectionKeys)a.selectionKeys.has(l)||I.removeSelection(this.doc,e,l,t,n);if(this.options.syncTranscriptions&&o.transcriptionKeys)for(let l of o.transcriptionKeys)a.transcriptionKeys.has(l)||I.removeTranscription(this.doc,e,l,t,n);if(this.options.syncNotes&&o.selectionNoteKeys){for(let l of o.selectionNoteKeys)if(!a.selectionNoteKeys.has(l)){let c=l.indexOf(":");if(c>0){let h=l.slice(0,c),d=l.slice(c+1);I.removeSelectionNote(this.doc,e,h,d,t,n)}}}if(o.listNames&&this.options.syncLists){for(let l of o.listNames)if(!a.listNames.has(l)){let c=this.vault.getListKey(l);c&&I.removeListMembership(this.doc,e,c,t,n)}}},_isSyncedNote(s,e){return!e&&!s?!1:!!(e&&e.includes("[troparcel:")||s&&s.includes("[troparcel:")||e&&e.includes("<blockquote><p><em>troparcel:")||e&&e.includes("<p><strong>[troparcel:"))},_expandJsonLdItem(s,e){if(!e)return s;let t={};for(let[i,r]of Object.entries(s)){if(i.startsWith("@")){t[i]=r;continue}if(i.includes("/")){t[i]=r;continue}if(["photo","template","list","lists","tag","note","selection","transcription","id","type"].includes(i)){t[i]=r;continue}if(i.includes(":")){let[o,a]=i.split(":",2),l=e[o];typeof l=="string"&&l.includes("/")?t[l+a]=r:t[i]=r;continue}let n=e[i];if(n){let o=typeof n=="string"?n:n["@id"]||null;if(o){typeof n=="object"&&n["@type"]&&typeof r=="string"?t[o]={"@value":r,"@type":n["@type"]}:t[o]=r;continue}}if(e["@vocab"]){t[e["@vocab"]+i]=r;continue}t[i]=r}return t},pushItems(s,e){if(!this.doc)return;let t=this._stableUserId,i=this.vault.nextPushSeq();this.doc.transact(()=>{for(let r of s){let n=e?this._expandJsonLdItem(r,e):r,o=A.computeIdentity(n);if(!o){this._debug(`pushItems: skipped photo-less item ${(n["@id"]||n.id||"?").toString().slice(0,20)}`);continue}let a=A.buildPhotoChecksumMap(n);this.pushMetadata(n,o,t,i),this.pushTags(n,o,t,i),this.pushNotes(n,o,t,a,i),this.pushPhotoMetadata(n,o,t,i),this.pushSelections(n,o,t,a,i),this.pushTranscriptions(n,o,t,a,i),this.options.syncLists&&this.pushLists(n,o,t,i)}},this.LOCAL_ORIGIN)}}});var vc=E((Cg,kc)=>{"use strict";var wp=new Set(["p","br","em","i","strong","b","u","s","a","ul","ol","li","blockquote","hr","h1","h2","h3","h4","h5","h6","code","pre","sup","sub","span","div"]),_p=new Set(["script","style","iframe","object","embed","form","input","textarea","select","button","link","meta","base","applet","math","svg","template","noscript","xmp","listing","plaintext","noembed","noframes"]),Sc={a:new Set(["href","title"]),"*":new Set(["class","style"])},bp={"text-decoration":new Set(["underline","overline","line-through","none"]),"text-align":new Set(["left","right","center","justify","end","start"])},Sp=new Set(["http:","https:","mailto:"]);function xp(s){if(!s||typeof s!="string")return"";let e="",t=0,i=s.length;for(;t<i;){let r=s.indexOf("<",t);if(r===-1){e+=s.slice(t);break}if(r>t&&(e+=s.slice(t,r)),s.slice(r,r+4)==="<!--"){let d=s.indexOf("-->",r+4);t=d===-1?i:d+3;continue}let n=kp(s,r);if(!n){e+="&lt;",t=r+1;continue}let{tagName:o,isClosing:a,isSelfClosing:l,attrs:c,end:h}=n;if(_p.has(o)&&!a){let d="</"+o,u=h,f=-1;for(;u<i;){let p=s.indexOf("</",u);if(p===-1)break;let g=s.slice(p+2,p+2+o.length+1);if(g.toLowerCase().startsWith(o)&&(g[o.length]===">"||/\s/.test(g[o.length]))){f=p;break}u=p+2}if(f!==-1){let p=s.indexOf(">",f);t=p===-1?i:p+1}else t=i;continue}if(!wp.has(o)){t=h;continue}if(a)e+=`</${o}>`;else{let d=vp(c,o);e+=`<${o}${d}${l?" /":""}>`}t=h}return e}function kp(s,e){let t=e+1,i=s.length;if(t>=i)return null;let r=!1;if(s[t]==="/"&&(r=!0,t++),t>=i||!/[a-zA-Z]/.test(s[t]))return null;let n=t;for(;t<i&&/[a-zA-Z0-9]/.test(s[t]);)t++;if(t-n>32)return null;let o=s.slice(n,t).toLowerCase();if(!o)return null;let a=[];if(r)for(;t<i&&s[t]!==">";)t++;else for(;t<i;){for(;t<i&&/\s/.test(s[t]);)t++;if(t>=i||s[t]===">"||s[t]==="/"&&t+1<i&&s[t+1]===">")break;let c=t;for(;t<i&&/[a-zA-Z0-9_\-:]/.test(s[t]);)t++;let h=s.slice(c,t).toLowerCase();if(!h){t++;continue}for(;t<i&&/\s/.test(s[t]);)t++;let d="";if(t<i&&s[t]==="="){for(t++;t<i&&/\s/.test(s[t]);)t++;if(t<i&&(s[t]==='"'||s[t]==="'")){let u=s[t];t++;let f=t;for(;t<i&&s[t]!==u;)t++;d=s.slice(f,t),t<i&&t++}else{let u=t;for(;t<i&&!/[\s>]/.test(s[t]);)t++;d=s.slice(u,t)}}a.push({name:h,value:d})}let l=!1;if(t<i&&s[t]==="/"&&(l=!0,t++),t<i&&s[t]===">")t++;else{let c=s.indexOf(">",t);t=c===-1?i:c+1}return{tagName:o,isClosing:r,isSelfClosing:l,attrs:a,end:t}}function vp(s,e){let t=Sc[e]||new Set,i=Sc["*"]||new Set,r="";for(let{name:n,value:o}of s){if(n.startsWith("on")||n.startsWith("data-")||!t.has(n)&&!i.has(n))continue;let a=Ip(o);if(!(n==="href"&&(a=Cp(a),!a))){if(n==="style"){let l=Ap(a);if(!l)continue;r+=` style="${xc(l)}"`;continue}r+=` ${n}="${xc(a)}"`}}return r}var Tp={lt:"<",gt:">",amp:"&",quot:'"',apos:"'"};function Ip(s){return s.replace(/&(?:#x([0-9a-fA-F]+)|#(\d+)|(lt|gt|amp|quot|apos));/g,(e,t,i,r)=>{if(t){let n=parseInt(t,16);return n>0&&n<1114111?String.fromCodePoint(n):""}if(i){let n=parseInt(i,10);return n>0&&n<1114111?String.fromCodePoint(n):""}return Tp[r]})}function Ap(s){if(!s)return"";let e=[];for(let t of s.split(";")){let i=t.trim();if(!i)continue;let r=i.indexOf(":");if(r<0)continue;let n=i.slice(0,r).trim().toLowerCase(),o=i.slice(r+1).trim().toLowerCase(),a=bp[n];a&&a.has(o)&&e.push(`${n}: ${o}`)}return e.join("; ")}function Cp(s){if(!s)return"";let e=s.trim().replace(/[\x00-\x1f\x7f]/g,"");if(e=e.replace(/\s+/g,""),e.startsWith("//"))return"";if(e.startsWith("/")||e.startsWith("#")||e.startsWith("?"))return e;try{let t=new URL(e);return Sp.has(t.protocol)?e:""}catch{return/^[a-z][a-z0-9+.-]*:/i.test(e)?"":e}}function xc(s){return s.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Up(s){return!s||typeof s!="string"?"":s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}kc.exports={sanitizeHtml:xp,escapeHtml:Up}});var Ic=E((Ug,Tc)=>{"use strict";var ze=Wt(),de=qi(),{sanitizeHtml:jn,escapeHtml:Jt}=vc();Tc.exports={_writeDelay(){return this.adapter?Promise.resolve():new Promise(s=>setTimeout(s,this.options.writeDelay))},_applyStrikethrough(s){return s.replace(/(<(?:p|li|h[1-6])>)/gi,'$1<span style="text-decoration: line-through">').replace(/(<\/(?:p|li|h[1-6])>)/gi,"</span>$1")},async applyRemoteAnnotations(s,e,t,i){let r=e.localId,n=this._stableUserId;this._debug(`applyAnnotations: item ${r}, identity ${s.slice(0,8)}...`);let o=this._applyStats,a=o?o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted:0;await this.applyMetadata(s,r,n,e.item),await this._writeDelay(),await this.applyTags(s,r,n,t,e.item),await this._writeDelay(),await this.applyNotes(s,e,n),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applyPhotoMetadata(s,e,n),await this._writeDelay()),await this.applySelections(s,e,n),await this._writeDelay(),await this.applySelectionNotes(s,e,n),await this._writeDelay(),this.options.syncPhotoAdjustments&&(await this.applySelectionMetadata(s,e,n),await this._writeDelay()),await this.applyTranscriptions(s,e,n),this.options.syncLists&&(await this._writeDelay(),await this.applyLists(s,e,n,i)),o&&(o.itemsProcessed++,o.notesCreated+o.notesUpdated+o.tagsAdded+o.selectionsCreated+o.metadataUpdated+o.transcriptionsCreated+o.listsAdded+o.notesRetracted>a&&o.itemsChanged++)},async applyMetadata(s,e,t,i){if(!this.options.syncMetadata)return;let r=de.getMetadata(this.doc,s),n={};for(let[a,l]of Object.entries(r)){if(l.author===t)continue;let c=i[a];if(c!=null){let h=typeof c=="object"?c["@value"]||c.text||"":String(c);if(h===(l.text||""))continue;let d=this.vault._fastHash(`${h}|${l.type||""}`);if(this.vault.hasLocalEdit(s,a,d)){this._logConflict("metadata-apply",s,a,{localValue:h?.slice(0,50),remoteValue:(l.text||"").slice(0,50),remoteAuthor:l.author,resolution:"local-wins"});continue}}n[a]={text:l.text,type:l.type}}let o=Object.keys(n);if(o.length>0)try{await this.api.saveMetadata(e,n),this._applyStats&&(this._applyStats.metadataUpdated+=o.length),this._debug(`metadata: ${o.length} field(s) on item ${e}`)}catch(a){this.logger.warn({error:a.message},`Failed to save metadata batch on ${e}`)}},async applyTags(s,e,t,i,r){if(!this.options.syncTags)return;let n=new Set,o=r.tag||[];for(let c of o)c&&c.name&&n.add(c.name.toLowerCase());let a=de.getActiveTags(this.doc,s);for(let c of a){if(c.author===t||n.has(c.name.toLowerCase()))continue;let h=i.get(c.name.toLowerCase());if(!h)try{let d=await this.api.createTag(c.name,c.color,[e]);n.add(c.name.toLowerCase()),d&&(d.id||d.tag_id)&&i.set(c.name.toLowerCase(),d),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag created: "${c.name}" on item ${e}`);continue}catch(d){this.logger.warn({error:d.message},`Failed to create tag "${c.name}"`);continue}try{await this.api.addTagsToItem(e,[h.id||h.tag_id]),n.add(c.name.toLowerCase()),this._applyStats&&this._applyStats.tagsAdded++,this._debug(`tag added: "${c.name}" on item ${e}`)}catch(d){this.logger.warn({error:d.message},`Failed to add tag "${c.name}" to item ${e}`)}}if(!this.options.syncDeletions)return;let l=de.getDeletedTags(this.doc,s);for(let c of l){if(c.author===t||!n.has(c.name.toLowerCase())||this.vault.dismissedKeys.has(`tag:${c.name.toLowerCase()}:${s}`))continue;let h=i.get(c.name.toLowerCase());if(h)try{await this.api.removeTagsFromItem(e,[h.id||h.tag_id])}catch(d){this.logger.warn({error:d.message},`Failed to remove tag "${c.name}" from item ${e}`)}}},_buildExistingNoteTexts(s){let e=new Set;for(let t of s){if(t&&t.text){e.add(t.text.trim());let i=t.text.replace(/^troparcel:\s*[^\n]*\n?/,"").replace(/^\[(?:troparcel:)?[^\]]{1,80}\]\s*/,"").replace(/\n?\[troparcel:[^\]]*\]\s*$/,"").trim();i&&e.add(i)}if(t&&t.html){e.add(t.html.trim());let i=t.html.replace(/^<blockquote><p><em>troparcel:[^<]*<\/em><\/p><\/blockquote>/,"").replace(/^<p><strong>\[[^\]]*\]<\/strong><\/p>/,"").replace(/<p><sub>\[troparcel:[^\]]*\]<\/sub><\/p>\s*$/,"").trim();i&&e.add(i)}}return e},_makeFooter(s,e){return`<p><sub>[troparcel:${s} from ${e} \u2014 safe to delete, do not edit]</sub></p>`},_extractNoteKey(s){let e=s&&s.match(/\[troparcel:([\w:-]+)\s/);return e?e[1]:null},_findLocalNoteByUUID(s){if(!this.adapter)return null;let e=this.adapter._getState();for(let[t,i]of Object.entries(e.notes)){if(!i)continue;if(i.text&&i.text.includes(`troparcel:${s}`))return Number(t);let r=i.state&&JSON.stringify(i.state);if(r&&r.includes(`troparcel:${s}`))return Number(t)}return null},async _applyRemoteNote(s,e,t,i,r,n){let o=e.html?jn(e.html):`<p>${Jt(e.text)}</p>`,a=Jt(e.author||"unknown");o=`${o}${this._makeFooter(s,a)}`;let l=this._findLocalNoteByUUID(s);if(!l){let c=this.vault.getLocalNoteId(s);c&&this.adapter&&this.adapter._getState().notes[c]&&(l=c)}if(l){if(this.adapter){let h=this.adapter._getState().notes[l];if(h){let d=this.adapter._noteStateToHtml(h);if(this.vault.hasLocalNoteEdit(s,d))return this._logConflict("note-apply",s,`note:${s}`,{localLength:d.length,remoteLength:o.length,remoteAuthor:e.author,resolution:"local-wins"}),this.vault.appliedNoteKeys.add(s),this._applyStats&&(this._applyStats.notesSkipped=(this._applyStats.notesSkipped||0)+1),!1}}try{if(this.adapter){let c=await this.adapter.updateNote(l,{html:o});if(c&&(c.id||c["@id"])){let h=c.id||c["@id"];this.vault.mapAppliedNote(s,h),this.vault.appliedNoteKeys.add(s),this.vault.markNoteApplied(s,o)}}else await this.api.updateNote(l,{html:o}),this.vault.appliedNoteKeys.add(s),this.vault.markNoteApplied(s,o);return this._applyStats&&this._applyStats.notesUpdated++,this._debug(`${n} updated: ${s.slice(0,8)}`),!0}catch(c){this.logger.warn({error:String(c.message||c)},`${n} update failed for ${s.slice(0,8)}, falling through to create`)}}if(i.has(o.trim()))return this.vault.appliedNoteKeys.add(s),this._applyStats&&this._applyStats.notesDeduped++,!1;try{let c,h={html:o,language:e.language,photo:t.photo||null,selection:t.selection||null};if(this.adapter?c=await this.adapter.createNote(h):c=await this.api.createNote(h),c&&(c.id||c["@id"]))return this.vault.mapAppliedNote(s,c.id||c["@id"]),this.vault.appliedNoteKeys.add(s),this.vault.markNoteApplied(s,o),i.add(o.trim()),this._applyStats&&this._applyStats.notesCreated++,this._debug(`${n} created: ${s.slice(0,8)} by ${e.author}`),!0;this.logger.warn({...t,noteKey:s.slice(0,8),author:e.author},`${n}.create returned null`),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}catch(c){this.logger.warn({error:c.message,...t,noteKey:s.slice(0,8)},`Failed to create ${n}`),this._applyStats&&this._applyStats.notesFailed++,this._failedNoteKeys.add(s)}return!1},async applyNotes(s,e,t){if(!this.options.syncNotes)return;let i=e.localId,r=e.item.photo||[];Array.isArray(r)||(r=[r]);let n=[];for(let h of r)for(let d of h.note||[])n.push(d);let o=this._buildExistingNoteTexts(n),a=de.getNotes(this.doc,s),l={},c={};for(let[h,d]of Object.entries(a))d.deleted?c[h]=d:l[h]=d;for(let[h,d]of Object.entries(l)){if(d.author===t||!d.html&&!d.text)continue;let u=this._findLocalNoteByUUID(h);if(u){let p=this.adapter?this.adapter._getState():null,g=p&&p.notes[u];if(g){let m=g.text||"",y=d.text||"",_=d.html||"";if(m.includes(y)&&y.length>0&&!m.includes("[retracted")){this.vault.appliedNoteKeys.add(h);continue}}}let f=null;if(d.photo){for(let p of r)if(p.checksum===d.photo){f=p["@id"]||p.id;break}if(!f)continue}else if(f=r[0]&&(r[0]["@id"]||r[0].id),!f)continue;await this._applyRemoteNote(h,d,{photo:Number(f)||null},o,t,"note")}for(let[h,d]of Object.entries(c)){if(d.author===t||this.vault.dismissedKeys.has(h)||this.vault.retractedNoteKeys.has(h))continue;let u=this._findLocalNoteByUUID(h);if(u||(u=this.vault.getLocalNoteId(h)),!u)continue;if(this.adapter&&!this.adapter._getState().notes[u]){this.vault.retractedNoteKeys.add(h),this.vault.markDirty(),this._debug(`note ${h.slice(0,8)}: local note ${u} already deleted, marking retracted`);continue}let f=Jt(d.author||"unknown"),p=d.html?jn(d.html):d.text?`<p>${Jt(d.text)}</p>`:"",g=`${this._applyStrikethrough(p)}<p><sub>[troparcel:${h} retracted by ${f} \u2014 safe to delete, do not edit]</sub></p>`;try{let m=!1;if(this.adapter){let y=await this.adapter.updateNote(u,{html:g});if(y&&(y.id||y["@id"])){let _=y.id||y["@id"];if(String(_)!==String(u)&&this.adapter._getState().notes[u])try{await this.adapter.deleteNote(u)}catch{}this.vault.mapAppliedNote(h,_),m=!0}}else this._debug(`note retraction skipped (no adapter) for ${h.slice(0,8)}`),this.vault.retractedNoteKeys.add(h);m&&(this.vault.retractedNoteKeys.add(h),this.vault.markDirty(),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`note retracted: ${h.slice(0,8)} by ${d.author}`))}catch(m){this.logger.warn({error:String(m.message||m)},`Failed to retract note ${h.slice(0,8)}`)}}},async applyPhotoMetadata(s,e,t){let i=e.item.photo||[];Array.isArray(i)||(i=[i]);for(let r of i){let n=r.checksum,o=r["@id"]||r.id;if(!n||!o)continue;let a=de.getPhotoMetadata(this.doc,s,n),l=r.metadata||{},c={};for(let[d,u]of Object.entries(a)){if(u.author===t)continue;let f=l[d];if(f!=null){let p=typeof f=="object"?f["@value"]||f.text||"":String(f);if(p===(u.text||""))continue;let g=this.vault._fastHash(`${p}|${u.type||""}`);if(this.vault.hasLocalEdit(s,`photo:${n}:${d}`,g)){this._logConflict("photo-meta-apply",s,`photo:${n}:${d}`,{localValue:p?.slice(0,50),remoteValue:(u.text||"").slice(0,50),remoteAuthor:u.author,resolution:"local-wins"});continue}}c[d]={text:u.text,type:u.type}}let h=Object.keys(c);if(h.length>0)try{await this.api.saveMetadata(o,c),this._applyStats&&(this._applyStats.metadataUpdated+=h.length)}catch(d){this.logger.warn({error:d.message},"Failed to save photo metadata batch")}}},async applySelections(s,e,t){if(!this.options.syncSelections)return;let i=de.getActiveSelections(this.doc,s),r=e.item.photo||[];Array.isArray(r)||(r=[r]);let n=new Set;for(let o of r){if(!o.checksum)continue;let a=o.selection||[];Array.isArray(a)||(a=[a]);for(let l of a)l&&n.add(ze.computeSelectionFingerprint(o.checksum,l))}for(let[o,a]of Object.entries(i)){if(a.author===t||this.vault.appliedSelectionKeys.has(o))continue;let l=Number(a.x),c=Number(a.y),h=Number(a.w),d=Number(a.h);if(!Number.isFinite(l)||!Number.isFinite(c)||!Number.isFinite(h)||!Number.isFinite(d)||h<=0||d<=0){this._log(`Skipping selection ${o}: invalid coordinates`,{x:l,y:c,w:h,h:d});continue}let u=null;for(let g of r)if(g.checksum===a.photo){u=g["@id"]||g.id;break}if(!u)continue;let f=ze.computeSelectionFingerprint(a.photo,a);if(n.has(f)){for(let g of r){if(g.checksum!==a.photo)continue;let m=g.selection||[];Array.isArray(m)||(m=[m]);for(let y of m){if(!y)continue;if(ze.computeSelectionFingerprint(g.checksum,y)===f){let S=y["@id"]||y.id;S&&this.vault.mapAppliedSelection(o,S);break}}}this.vault.appliedSelectionKeys.add(o)}else try{let g;if(this.adapter?g=await this.adapter.createSelection({photo:Number(u),x:l,y:c,width:h,height:d,angle:a.angle||0}):g=await this.api.createSelection({photo:Number(u),x:l,y:c,width:h,height:d,angle:a.angle||0}),g&&(g.id||g["@id"])){let m=g.id||g["@id"];this.vault.mapAppliedSelection(o,m)}this.vault.appliedSelectionKeys.add(o),this._applyStats&&this._applyStats.selectionsCreated++,this._debug(`selection created: ${o.slice(0,8)} on photo ${u}`)}catch(g){this.logger.warn({error:g.message},`Failed to create selection on photo ${u}`)}}},async applySelectionNotes(s,e,t){if(!this.options.syncNotes)return;let i=e.item.photo||[];Array.isArray(i)||(i=[i]);let r=de.getAllSelectionNotes(this.doc,s),n=new Map;for(let[o,a]of Object.entries(r)){if(!a.deleted)continue;let l=o.indexOf(":");if(l>0){let c=o.slice(0,l);n.has(c)||n.set(c,[]),n.get(c).push([o,a])}}for(let o of i){let a=o.checksum;if(!a)continue;let l=o.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=this._buildExistingNoteTexts(c.note||[]),d=c["@id"]||c.id,u=d?this.vault.getSelectionKey(d,ze.generateSelectionUUID()):ze.computeSelectionFingerprint(a,c),f=de.getSelectionNotes(this.doc,s,u);for(let[g,m]of Object.entries(f)){if(m.author===t||!m.html&&!m.text)continue;let y=this._findLocalNoteByUUID(g);if(y){let _=this.adapter?this.adapter._getState():null,S=_&&_.notes[y];if(S){let b=S.text||"",v=m.text||"";if(b.includes(v)&&v.length>0&&!b.includes("[retracted")){this.vault.appliedNoteKeys.add(g);continue}}}d&&await this._applyRemoteNote(g,m,{selection:Number(d)||null},h,t,"sel note")}let p=n.get(u)||[];for(let[g,m]of p){if(m.author===t||this.vault.dismissedKeys.has(g)||this.vault.retractedNoteKeys.has(g))continue;let y=this._findLocalNoteByUUID(g);if(y||(y=this.vault.getLocalNoteId(g)),!y)continue;if(this.adapter&&!this.adapter._getState().notes[y]){this.vault.retractedNoteKeys.add(g),this.vault.markDirty(),this._debug(`sel note ${g.slice(0,8)}: local note ${y} already deleted, marking retracted`);continue}let _=Jt(m.author||"unknown"),S=m.html?jn(m.html):m.text?`<p>${Jt(m.text)}</p>`:"",b=`${this._applyStrikethrough(S)}<p><sub>[troparcel:${g} retracted by ${_} \u2014 safe to delete, do not edit]</sub></p>`;try{let v=!1;if(this.adapter){let $=await this.adapter.updateNote(y,{html:b});if($&&($.id||$["@id"])){let oe=$.id||$["@id"];if(String(oe)!==String(y)&&this.adapter._getState().notes[y])try{await this.adapter.deleteNote(y)}catch{}this.vault.mapAppliedNote(g,oe),v=!0}}else this._debug(`sel note retraction skipped (no adapter) for ${g.slice(0,8)}`),this.vault.retractedNoteKeys.add(g);v&&(this.vault.retractedNoteKeys.add(g),this.vault.markDirty(),this._applyStats&&this._applyStats.notesRetracted++,this._debug(`sel note retracted: ${g.slice(0,8)} by ${m.author}`))}catch(v){this.logger.warn({error:String(v.message||v)},`Failed to retract sel note ${g.slice(0,8)}`)}}}}},async applySelectionMetadata(s,e,t){let i=e.item.photo||[];Array.isArray(i)||(i=[i]);for(let r of i){let n=r.checksum;if(!n)continue;let o=r.selection||[];Array.isArray(o)||(o=[o]);for(let a of o){if(!a)continue;let l=a["@id"]||a.id,c=l?this.vault.getSelectionKey(l,ze.generateSelectionUUID()):ze.computeSelectionFingerprint(n,a);if(!l)continue;let h=de.getSelectionMeta(this.doc,s,c),d=a.metadata||{},u={};for(let[p,g]of Object.entries(h)){if(g.author===t)continue;let m=d[p];if(m!=null){let y=typeof m=="object"?m["@value"]||m.text||"":String(m);if(y===(g.text||""))continue;let _=this.vault._fastHash(`${y}|${g.type||""}`);if(this.vault.hasLocalEdit(s,`selmeta:${c}:${p}`,_)){this._logConflict("sel-meta-apply",s,`selmeta:${c}:${p}`,{localValue:y?.slice(0,50),remoteValue:(g.text||"").slice(0,50),remoteAuthor:g.author,resolution:"local-wins"});continue}}u[p]={text:g.text,type:g.type}}let f=Object.keys(u);if(f.length>0)try{await this.api.saveMetadata(l,u),this._applyStats&&(this._applyStats.metadataUpdated+=f.length)}catch(p){this.logger.warn({error:p.message},"Failed to save selection metadata")}}}},async applyTranscriptions(s,e,t){if(!this.options.syncTranscriptions)return;let i=de.getActiveTranscriptions(this.doc,s),r=e.item.photo||[];Array.isArray(r)||(r=[r]);let n=new Map,o=new Map;for(let a of r)if(a.checksum){n.set(a.checksum,a["@id"]||a.id);let l=a.selection||[];Array.isArray(l)||(l=[l]);for(let c of l){if(!c)continue;let h=c["@id"]||c.id;if(h){let d=this.vault.getSelectionKey(h,ze.generateSelectionUUID());o.set(d,h)}}}for(let[a,l]of Object.entries(i)){if(l.author===t||!l.text&&!l.data||this.vault.appliedTranscriptionKeys.has(a))continue;let c=n.get(l.photo)||null;if(!c)continue;let h=l.selection&&o.get(l.selection)||null,d=this.vault.getLocalTxId(a);if(d)try{let u=null;try{u=await this.api.getTranscription(d)}catch{}try{await this.api.deleteTranscription(d)}catch(p){this.logger.warn({error:String(p.message||p)},`Failed to delete transcription ${d}`)}let f=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});if(f&&(f.id||f["@id"]))this.vault.mapAppliedTranscription(a,f.id||f["@id"]),this.vault.appliedTranscriptionKeys.add(a);else if(u){this.logger.warn(`Transcription update returned null for ${a.slice(0,8)}, restoring original`);try{let p=await this.api.createTranscription({text:u.text||"",data:u.data||null,photo:Number(c)||null,selection:h?Number(h):null});p&&(p.id||p["@id"])&&this.vault.mapAppliedTranscription(a,p.id||p["@id"])}catch(p){this.logger.warn({error:String(p.message||p)},`Transcription restore also failed for ${a.slice(0,8)}`)}}continue}catch(u){this.logger.warn({error:String(u.message||u)},`Failed to update transcription ${a.slice(0,8)}`)}try{let u=await this.api.createTranscription({text:l.text,data:l.data,photo:Number(c)||null,selection:h?Number(h):null});u&&(u.id||u["@id"])&&(this.vault.mapAppliedTranscription(a,u.id||u["@id"]),this.vault.appliedTranscriptionKeys.add(a),this._applyStats&&this._applyStats.transcriptionsCreated++,this._debug(`transcription created: ${a.slice(0,8)} by ${l.author}`))}catch(u){this.logger.warn({error:u.message},"Failed to create transcription")}}},async applyLists(s,e,t,i){let r=de.getActiveLists(this.doc,s),n=e.localId,o=new Set;for(let a of e.item.lists||[]){let l=this._listNameCache.get(a)||this._listNameCache.get(String(a));l&&o.add(l)}for(let[a,l]of Object.entries(r)){if(l.author===t)continue;let c=l.name||a;if(o.has(c))continue;this.vault.mapAppliedList(a,c);let h=i.get(c);if(h)try{this.adapter?await this.adapter.addItemsToList(h.id,[n]):await this.api.addItemsToList(h.id,[n]),o.add(c),this._applyStats&&this._applyStats.listsAdded++,this._debug(`list add: item ${n} \u2192 "${c}"`)}catch(d){this.logger.warn({error:d.message},`Failed to add item ${n} to list "${c}"`)}}if(this.options.syncDeletions){let a=de.getLists(this.doc,s);for(let[l,c]of Object.entries(a)){if(!c.deleted||c.author===t||this.vault.dismissedKeys.has(`list:${l}:${s}`))continue;let h=c.name||l,d=i.get(h);if(d)try{this.adapter?await this.adapter.removeItemsFromList(d.id,[n]):await this.api.removeItemsFromList(d.id,[n])}catch(u){this.logger.warn({error:u.message},`Failed to remove item ${n} from list "${h}"`)}}}}}});var Cc=E((Eg,Ac)=>{"use strict";var Ng=Wt();Ac.exports={async _enrichAll(s){let e=[],t=5;for(let i=0;i<s.length;i+=t){let r=s.slice(i,i+t),n=await Promise.all(r.map(o=>this.enrichItem(o).catch(a=>(this.logger.warn(`Failed to enrich item ${o.id}`,{error:a.message}),null))));for(let o of n)o&&e.push(o)}return e},async enrichItem(s){let e={"@id":s.id,template:s.template,lists:s.lists||[]},[t,i]=await Promise.all([this.api.getMetadata(s.id).catch(()=>null),this.api.getItemTags(s.id).catch(()=>null)]);if(t)for(let[o,a]of Object.entries(t))o!=="id"&&(typeof a=="object"&&a!==null?e[o]={"@value":a.text||"","@type":a.type||""}:a!=null&&(e[o]=a));i&&Array.isArray(i)&&(e.tag=i.map(o=>({id:o.id||o.tag_id,name:o.name,color:o.color||null}))),e.photo=[];let r=s.photos||[],n=await Promise.all(r.map(o=>this.api.getPhoto(o).catch(()=>null)));for(let o of n){if(!o)continue;let a={"@id":o.id,checksum:o.checksum,note:[],selection:[],transcription:[],metadata:null},l=[];this.options.syncPhotoAdjustments&&l.push(this.api.getMetadata(o.id).catch(()=>null).then(u=>{a.metadata=u}));let c=o.notes||[];for(let u of c)l.push(this.api.getNote(u,"html").catch(()=>null).then(f=>{f!=null&&a.note.push({"@id":u,text:typeof f=="string"?f.replace(/<[^>]*>/g,""):"",html:typeof f=="string"?f:"",language:null,photo:o.id})}));let h=o.selections||[];for(let u of h)l.push(this._enrichSelection(u,o.checksum).then(f=>{f&&a.selection.push(f)}));let d=o.transcriptions||[];for(let u of d)l.push(this.api.getTranscription(u,"json").catch(()=>null).then(f=>{f&&a.transcription.push(f)}));await Promise.all(l),e.photo.push(a)}return e},async _enrichSelection(s,e){try{let t=await this.api.getSelection(s);if(!t)return null;let i={"@id":t.id,x:t.x,y:t.y,width:t.width,height:t.height,angle:t.angle||0,note:[],metadata:null,transcription:[]},r=[];r.push(this.api.getMetadata(s).catch(()=>null).then(a=>{i.metadata=a}));let n=t.notes||[];for(let a of n)r.push(this.api.getNote(a,"html").catch(()=>null).then(l=>{l!=null&&i.note.push({"@id":a,text:typeof l=="string"?l.replace(/<[^>]*>/g,""):"",html:typeof l=="string"?l:"",language:null,selection:t.id})}));let o=t.transcriptions||[];for(let a of o)r.push(this.api.getTranscription(a,"json").catch(()=>null).then(l=>{l&&i.transcription.push(l)}));return await Promise.all(r),i}catch(t){return this.logger.warn("Failed to enrich selection",{error:String(t)}),null}}}});var Ec=E((Dg,Nc)=>{"use strict";var Np=require("fs"),Uc=require("os"),Ep=(Kt(),_t(Pt)),{WebsocketProvider:Dp}=(dl(),_t(hl)),Lp=Xl(),{ApiClient:$p}=Ql(),{StoreAdapter:Mp}=tc(),ue=Wt(),q=qi(),{BackupManager:Op}=pc(),{SyncVault:Rp}=wc(),Yt=class{constructor(e,t,i=null){this.options=e,this.logger=t,this.debug=e.debug===!0,this.doc=null,this.provider=null,this.api=new $p(e.apiPort,t),this.adapter=i?new Mp(i,t):null,this.backup=null,this.localIndex=new Map,this.previousSnapshot=new Map,this.safetyNetTimer=null,this.unsubscribe=null,this._storeUnsubscribe=null,this.fileWatcher=null,this.projectPath=null,this.state="idle",this.lastSync=null,this.peerCount=0,this._syncing=!1,this._paused=!1,this._consecutiveErrors=0,this._localDebounceTimer=null,this._remoteDebounceTimer=null,this._pendingRemoteIdentities=new Set,this._stableUserId=e.userId||`${Uc.userInfo().username}@${Uc.hostname()}:${e.apiPort||2019}`,this.vault=new Rp,this.vault.loadFromFile(this.options.room,this._stableUserId),this._applyFailureCount=0,this._failedNoteKeys=new Set,this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._stopping=!1,this._remoteAnnotationsDirty=!0,this._syncLock=Promise.resolve(),this._lastWatcherEvent=0,this._watcherHealthTimer=null,this.LOCAL_ORIGIN="troparcel-local",this._listNameCache=new Map,this._listCacheRefreshedAt=0}_log(e,t){t?this.logger.info(t,`[troparcel] ${e}`):this.logger.info(`[troparcel] ${e}`)}_debug(e,t){this.debug&&(t?this.logger.info(t,`[troparcel:debug] ${e}`):this.logger.info(`[troparcel:debug] ${e}`))}_formatAge(e){let t=Math.floor((Date.now()-e.getTime())/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:`${Math.floor(t/3600)}h ${Math.floor(t%3600/60)}m ago`}_resetApplyStats(){this._applyStats={notesCreated:0,notesDeduped:0,notesUpdated:0,notesRetracted:0,notesFailed:0,tagsAdded:0,tagsDeduped:0,selectionsCreated:0,selectionsDeduped:0,metadataUpdated:0,transcriptionsCreated:0,listsAdded:0,itemsProcessed:0,itemsChanged:0}}_logApplyStats(){let e=this._applyStats;if(!e)return;let t=[];e.notesCreated&&t.push(`${e.notesCreated} notes created`),e.notesUpdated&&t.push(`${e.notesUpdated} notes updated`),e.notesRetracted&&t.push(`${e.notesRetracted} notes retracted`),e.tagsAdded&&t.push(`${e.tagsAdded} tags added`),e.selectionsCreated&&t.push(`${e.selectionsCreated} selections created`),e.metadataUpdated&&t.push(`${e.metadataUpdated} metadata fields`),e.transcriptionsCreated&&t.push(`${e.transcriptionsCreated} transcriptions`),e.listsAdded&&t.push(`${e.listsAdded} list memberships`),e.notesFailed&&t.push(`${e.notesFailed} notes failed`),t.length>0?this._log(`applied: ${t.join(", ")} across ${e.itemsChanged}/${e.itemsProcessed} items`):this._debug(`applied: nothing changed across ${e.itemsProcessed} items`)}readAllItemsFull(){return this.adapter?this.adapter.getAllItemsFull():[]}_acquireLock(){let e,t=this._syncLock;return this._syncLock=new Promise(i=>{e=i}),t.then(()=>e)}async start(e={}){if(!(this.state==="connected"||this.state==="connecting")){this.state="connecting",this.logger.info({server:this.options.serverUrl,room:this.options.room,syncMode:this.options.syncMode},"Sync engine v5.0 (schema v4) starting");try{this.doc=new Ep.Doc;let t=Lp;if(this.provider=new Dp(this.options.serverUrl,this.options.room,this.doc,{connect:!0,params:this.options.roomToken?{token:this.options.roomToken}:{},maxBackoffTime:1e4,resyncInterval:3e4,WebSocketPolyfill:t}),this.provider.on("status",n=>{n.status==="connected"?this.logger.info(`[troparcel] connected to ${this.options.serverUrl}`):n.status==="disconnected"&&this.logger.info("[troparcel] disconnected from server, reconnecting...")}),this.provider.on("connection-error",n=>{this.logger.warn(`[troparcel] connection error: ${n.message||String(n)} \u2014 check that the Troparcel server is running`)}),this.provider.on("connection-close",n=>{n.code!==1e3&&this.logger.info(`[troparcel] connection closed (code: ${n.code}${n.reason?", "+n.reason:""}), reconnecting...`)}),await this.waitForConnection(),q.setSchemaVersion(this.doc),this._migrateTagKeysToLowercase(),this.provider.awareness&&(this.provider.awareness.setLocalStateField("user",{userId:this._stableUserId,name:this._stableUserId,joinedAt:Date.now()}),this._awarenessHandler=({added:n,updated:o,removed:a})=>{this.peerCount=0,this.provider.awareness.getStates().forEach((l,c)=>{c!==this.doc.clientID&&l.user&&this.peerCount++})},this.provider.awareness.on("change",this._awarenessHandler)),this.backup=new Op(this.options.room,this.api,this.logger,{maxBackups:this.options.maxBackups,maxNoteSize:this.options.maxNoteSize,maxMetadataSize:this.options.maxMetadataSize,tombstoneFloodThreshold:this.options.tombstoneFloodThreshold}),this.options.syncMode==="auto"&&(this.unsubscribe=q.observeAnnotationsDeep(this.doc,n=>{this.handleRemoteChanges(n)},this.LOCAL_ORIGIN)),this._statusHandler=n=>{n.status==="connected"?(this.state="connected",this._log(`reconnected to room "${this.options.room}"`)):n.status==="disconnected"&&this.logger.warn("[troparcel] lost connection, will retry automatically")},this.provider.on("status",this._statusHandler),this.state="connected",this._log(`ready \u2014 room "${this.options.room}", client ${this.doc.clientID}`),!e.skipStartupDelay){let n=this.options.startupDelay;n>0&&await new Promise(o=>setTimeout(o,n))}this.options.clearTombstones&&this.purgeTombstones(),e.skipInitialSync||(await this.syncOnce(),this._log(`initial sync complete \u2014 ${this.localIndex.size} local items indexed, ${this.vault.annotationCount} shared items in CRDT, ${this.peerCount} peer(s) online`)),this.options.autoSync&&!e.skipInitialSync&&await this.startWatching();let i=this.options.safetyNetInterval*1e3;i>0&&(this.safetyNetTimer=setInterval(()=>{this._scheduleSafetyNet()},i)),this._statusLogCount=0;let r=this.debug?3e4:3e5;this._statusLogTimer=setInterval(()=>{this.state==="connected"&&(this._statusLogCount++,this._log(`sync active \u2014 room "${this.options.room}", ${this.peerCount} peer(s), ${this.localIndex.size} local / ${this.vault.annotationCount} shared items`+(this.lastSync?`, last sync ${this._formatAge(this.lastSync)}`:"")))},r)}catch(t){throw this.state="error",this.logger.error({error:t.message,stack:t.stack},"Sync engine failed to start"),t}}}_scheduleSafetyNet(){if(this._consecutiveErrors>0){let t=1-1/Math.min(Math.pow(2,this._consecutiveErrors),16);if(Math.random()<t){this._log(`Safety-net skipped (backoff: ${this._consecutiveErrors} errors)`);return}}this.syncOnce()}async _persistVault(e=!1){if(!(!e&&!this.vault.isDirty))try{await this.vault.persistToFile(this.options.room,this._stableUserId)}catch(t){this.logger.warn("vault persist failed",{error:t.message})}}async stop(){if(this._stopping=!0,await this._persistVault(!0),this.logger.info("Sync engine stopping"),this._storeUnsubscribe&&(this._storeUnsubscribe(),this._storeUnsubscribe=null),this.stopWatching(),this.safetyNetTimer&&(clearInterval(this.safetyNetTimer),this.safetyNetTimer=null),this._statusLogTimer&&(clearInterval(this._statusLogTimer),this._statusLogTimer=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this._localDebounceTimer&&(clearTimeout(this._localDebounceTimer),this._localDebounceTimer=null),this._remoteDebounceTimer&&(clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.provider&&this.provider.awareness)try{this._awarenessHandler&&(this.provider.awareness.off("change",this._awarenessHandler),this._awarenessHandler=null),this.provider.awareness.setLocalState(null)}catch(e){this._debug("Failed to clean up awareness",{error:e.message})}this.provider&&(this._statusHandler&&(this.provider.off("status",this._statusHandler),this._statusHandler=null),this.provider.destroy(),this.provider=null),this.doc&&(this.doc.destroy(),this.doc=null),this.localIndex.clear(),this.previousSnapshot.clear(),this._pendingRemoteIdentities.clear(),this._listNameCache.clear(),this.vault.clear(),this._applyingRemote=!1,this._queuedLocalChange=!1,this._syncRequested=!1,this._remoteAnnotationsDirty=!1,this.state="idle"}waitForConnection(){return new Promise((e,t)=>{if(this.provider.wsconnected){e();return}let i=n=>{n.status==="connected"&&(clearTimeout(r),this.provider.off("status",i),e())},r=setTimeout(()=>{this.provider.off("status",i),t(new Error("Connection timeout (15s)"))},15e3);this.provider.on("status",i)})}pause(){this._paused=!0,this._log("Sync paused")}resume(){this._paused=!1,this._log("Sync resumed")}async startWatching(){if(this.adapter){if(this._storeUnsubscribe)return;this._log("Using store.subscribe for change detection"),this._storeUnsubscribe=this.adapter.subscribe(()=>{this.handleLocalChange()});return}if(!this.fileWatcher){try{let e=await this.api.getProjectInfo();e&&e.project&&(this.projectPath=e.project,this._log(`Watching project file: ${this.projectPath}`))}catch(e){this._log("Could not get project path, file watching disabled",{error:e.message});return}this.projectPath&&(this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}}_startFileWatcher(){try{this.fileWatcher=Np.watch(this.projectPath,{persistent:!1},e=>{e==="change"&&(this._lastWatcherEvent=Date.now(),this.handleLocalChange())}),this.fileWatcher.on("error",e=>{this._debug("File watcher error",{error:e.message}),this._restartFileWatcher()})}catch(e){this._debug("Could not start file watcher",{error:e.message})}}_restartFileWatcher(){if(this.fileWatcher){try{this.fileWatcher.close()}catch(e){this.logger.warn("Failed to close file watcher",{error:String(e.message||e)})}this.fileWatcher=null}this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null),this.projectPath&&(this._log("Restarting file watcher"),this._startFileWatcher(),this._lastWatcherEvent=Date.now(),this._watcherHealthTimer=setInterval(()=>{this._checkWatcherHealth()},6e4))}_checkWatcherHealth(){if(!this.fileWatcher)return;Date.now()-this._lastWatcherEvent>5*60*1e3&&(this.logger.info("File watcher silent for >5min, restarting"),this._restartFileWatcher())}stopWatching(){this.fileWatcher&&(this.fileWatcher.close(),this.fileWatcher=null),this._watcherHealthTimer&&(clearInterval(this._watcherHealthTimer),this._watcherHealthTimer=null)}handleLocalChange(){if(!this._paused&&!this._stopping){if(this._applyingRemote){this._queuedLocalChange=!0,this._debug("handleLocalChange: queued (applying remote)");return}this._localDebounceTimer||this._debug("handleLocalChange: store change detected, debouncing"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this._debug("handleLocalChange: debounce fired"),this.syncOnce()},this.options.localDebounce)}}handleRemoteChanges(e){this._remoteAnnotationsDirty=!0;for(let t of e)this._pendingRemoteIdentities.add(t.identity);this._remoteDebounceTimer&&clearTimeout(this._remoteDebounceTimer),this._remoteDebounceTimer=setTimeout(()=>{this._remoteDebounceTimer=null,this.applyPendingRemote()},this.options.remoteDebounce)}async applyPendingRemote(){if(this._paused||this._pendingRemoteIdentities.size===0)return;if(this.localIndex.size===0){this._debug("applyPendingRemote: localIndex empty, deferring");return}let e=await this._acquireLock();try{let t=Array.from(this._pendingRemoteIdentities);this._pendingRemoteIdentities.clear();let i=null;try{i=this.adapter?this.adapter.getAllTags():await this.api.getTags()}catch(o){this.logger.warn("applyPendingRemote: failed to fetch tags",{error:String(o.message||o)})}let r=new Map;if(i&&Array.isArray(i))for(let o of i)r.set(o.name.toLowerCase(),o);let n=new Map;if(this.options.syncLists)try{let o=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(o))for(let a of o)n.set(a.name,a)}catch(o){this.logger.warn("applyPendingRemote: failed to fetch lists",{error:String(o.message||o)})}if(this.adapter){let o=this.readAllItemsFull().filter(a=>(a.photo||[]).some(l=>l.checksum));o.length>0&&(this.localIndex=ue.buildIdentityIndex(o))}await this._refreshListNameCache(),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();try{let o=new Set,a=new Set;for(let l of t){let c=ue.findLocalMatch(l,this.localIndex);if(c){if(a.add(l),o.add(c.localId),this.backup){let h=q.getItemSnapshot(this.doc,l);if(h){let d=this.backup.validateInbound(l,h,this._stableUserId);if(!d.valid){for(let u of d.warnings)this.logger.warn(`applyPendingRemote validation: ${u}`);continue}}}try{await this.applyRemoteAnnotations(l,c,r,n)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}for(let l of t){if(a.has(l))continue;let c=q.resolveAlias(this.doc,l);if(!c)continue;let h=ue.findLocalMatch(c,this.localIndex);if(!(!h||o.has(h.localId))){if(this.backup){let d=q.getItemSnapshot(this.doc,l);if(d&&!this.backup.validateInbound(l,d,this._stableUserId).valid)continue}a.add(l),o.add(h.localId),this._debug(`alias resolved: ${l.slice(0,8)} \u2192 ${c.slice(0,8)}`);try{await this.applyRemoteAnnotations(l,h,r,n)}catch(d){this.logger.warn(`Failed to apply remote (alias) for ${l}`,{error:d.message})}}}for(let l of t){if(a.has(l))continue;let c=this._fuzzyMatchLocal(l);if(c&&!o.has(c.local.localId)){if(o.add(c.local.localId),this.backup){let h=q.getItemSnapshot(this.doc,l);if(h&&!this.backup.validateInbound(l,h,this._stableUserId).valid)continue}try{await this.applyRemoteAnnotations(l,c.local,r,n)}catch(h){this.logger.warn(`Failed to apply remote for ${l}`,{error:h.message})}}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}finally{e()}}async syncOnce(){if(this.state!=="connected"||!this.doc||this._paused||this._stopping)return;if(this._syncing){this._syncRequested=!0;return}this._syncing=!0;let e=await this._acquireLock();if(this.state!=="connected"||!this.doc||this._paused||this._stopping){this._syncing=!1,e();return}let t=this.state;this.state="syncing";try{this._debug("syncOnce: starting cycle");let i;if(this.adapter){i=this.readAllItemsFull();let c=i.length;if(i=i.filter(h=>(h.photo||[]).some(u=>u.checksum)),c!==i.length){let h=c-i.length;this._log(`syncOnce: skipped ${h} photo-less item(s) \u2014 items need at least one photo to sync`)}if(i.length===0){this._debug("syncOnce: no items in store"),this.state=t;return}this._debug(`syncOnce: got ${i.length} items from store`)}else{if(!await this.api.ping()){this._debug("syncOnce: API not reachable, skipping"),this.state=t;return}let h=await this.api.getItems();if(!h||!Array.isArray(h)){this._debug("syncOnce: no items from API"),this.state=t;return}this._debug(`syncOnce: got ${h.length} item summaries`),i=await this._enrichAll(h),i=i.filter(d=>{let u=d.photo||[];return Array.isArray(u)||(u=[u]),u.some(f=>f.checksum)})}let r=new Map;for(let[c,{localId:h}]of this.localIndex)r.set(h,c);let n=new Set(this.localIndex.keys());if(this.localIndex=ue.buildIdentityIndex(i),r.size>0&&this.doc&&this.doc.transact(()=>{for(let[c,{localId:h}]of this.localIndex){let d=r.get(h);d&&d!==c&&(q.setAlias(this.doc,d,c),this._log(`alias created: ${d.slice(0,8)} \u2192 ${c.slice(0,8)}`))}},this.LOCAL_ORIGIN),this._debug(`syncOnce: ${i.length} items, ${this.localIndex.size} identities`),!this._remoteAnnotationsDirty&&n.size>0){for(let c of this.localIndex.keys())if(!n.has(c)){this._remoteAnnotationsDirty=!0,this._debug("syncOnce: new local identities detected, forcing apply");break}}await this._refreshListNameCache();let o=new Set,a=!1;if(this.options.syncMode==="auto"){let c=this.doc.getMap("annotations");if(this.vault.updateAnnotationCount(c.size),a=this._remoteAnnotationsDirty,a){if(this._debug("syncOnce: CRDT changed, applying remote"),o=await this.applyRemoteFromCRDT(),o.size>0){if(this.adapter){let h=new Set;for(let d of o){let u=this.localIndex.get(d);u&&h.add(u.localId)}i=i.map(d=>{let u=d["@id"]||d.id;return h.has(u)&&this.adapter.getItemFull(u)||d})}else{let h=await this.api.getItems();if(h&&Array.isArray(h)){let d=h.filter(u=>{let f=ue.computeIdentity({"@id":u.id,template:u.template,photo:[]});return f&&o.has(f)});if(d.length===0&&o.size>0)i=await this._enrichAll(h);else if(d.length>0){let u=await this._enrichAll(d),f=new Map;for(let p of u){let g=ue.computeIdentity(p);g&&f.set(g,p)}i=i.map(p=>{let g=ue.computeIdentity(p);return g&&f.has(g)?f.get(g):p})}}}this.localIndex=ue.buildIdentityIndex(i)}}else this._debug("syncOnce: CRDT unchanged, skip apply")}if(this.options.syncMode!=="pull"){let c=this.vault.nextPushSeq();this.adapter&&this.adapter.suppressChanges();try{await this.pushLocal(i,c)}finally{this.adapter&&this.adapter.resumeChanges()}}let l=!1;if(this._applyStats&&this._applyStats.notesFailed>0){let c=new Set(this._failedNoteKeys);this._failedNoteKeys.clear();let h=0;for(let u of c){let f=(this.vault.failedNoteKeys.get(u)||0)+1;this.vault.failedNoteKeys.set(u,f),f>=3&&(this.vault.appliedNoteKeys.add(u),this.vault.failedNoteKeys.delete(u),this._debug(`note key ${u.slice(0,8)} permanently given up after ${f} retries`),h++)}let d=this._applyStats.notesFailed-h;d>0&&(l=!0,this._debug(`apply had ${this._applyStats.notesFailed} note failures, ${d} will retry next cycle`))}else this._applyStats&&this._failedNoteKeys.clear();this.options.syncMode==="auto"&&!l&&(this._remoteAnnotationsDirty=!1),this.vault.pruneAppliedKeys(),this.vault.markDirty(),await this._persistVault(),this.vault._evictIfNeeded(this.previousSnapshot,5e3),this.lastSync=new Date,this._consecutiveErrors=0,this.state="connected",this._debug("syncOnce: cycle complete")}catch(i){this._consecutiveErrors++;let r=i instanceof Error?i.message:String(i||"");i&&(i.sqliteBusy||r.includes("SQLITE_BUSY"))?this.logger.warn({consecutiveErrors:this._consecutiveErrors},"Database busy, will back off"):this.logger.warn({error:r,stack:i&&i.stack},"Sync cycle failed"),this.state=t==="connected"?"connected":"error"}finally{this._syncing=!1,e();let i=this._queuedLocalChange||this._syncRequested;this._queuedLocalChange=!1,this._syncRequested=!1,i&&(this._debug("replaying queued sync trigger (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}_migrateTagKeysToLowercase(){if(!this.doc)return;let e=this.doc.getMap("annotations"),t=0;this.doc.transact(()=>{e.forEach(i=>{let r=i.get("tags");if(!r)return;let n=[];r.forEach((o,a)=>{let l=a.toLowerCase();l!==a&&n.push({oldKey:a,newKey:l,value:o})});for(let{oldKey:o,newKey:a,value:l}of n){let c=r.get(a);(!c||c.deleted)&&r.set(a,l),r.delete(o),t++}})},this.LOCAL_ORIGIN),t>0&&this._log(`tag key migration: rewrote ${t} mixed-case key(s) to lowercase`)}_logConflict(e,t,i,r){this.logger.info({event:"conflict",type:e,identity:t.slice(0,8),field:i,...r},`[troparcel] Conflict: ${e} ${i} on ${t.slice(0,8)}`)}_fuzzyMatchLocal(e){if(this.localIndex.size===0||!this.doc)return null;let t=q.getItemChecksums(this.doc,e);if(t.length===0)return null;let i=new Set(t),r=null,n=0;for(let[o,a]of this.localIndex){let l=a.item.photo||[];Array.isArray(l)||(l=[l]);let c=new Set;for(let f of l)f.checksum&&c.add(f.checksum);if(c.size===0)continue;let h=0;for(let f of i)c.has(f)&&h++;if(h===0)continue;let d=new Set([...i,...c]).size,u=h/d;u>n&&u>=.5&&(n=u,r={local:a,localIdentity:o,checksumCount:h,score:u})}return r}async applyRemoteFromCRDT(){let e=q.getIdentities(this.doc),t=new Set;if(e.length===0)return this._log("applyRemote: CRDT snapshot is empty"),t;this._debug(`applyRemote: scanning ${e.length} CRDT items`);let i=this.adapter?this.adapter.getAllTags():await this.api.getTags(),r=new Map;if(i&&Array.isArray(i))for(let o of i)r.set(o.name.toLowerCase(),o);let n=new Map;if(this.options.syncLists)try{let o=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(o))for(let a of o)n.set(a.name||String(a.id),a)}catch(o){this.logger.warn("applyRemoteFromCRDT: failed to fetch lists",{error:String(o.message||o)})}this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges();try{let o=[],a=new Set,l=new Set;for(let h of e){let d=ue.findLocalMatch(h,this.localIndex);if(!d)continue;let u=q.getItemSnapshot(this.doc,h);if(!u)continue;let f=this.backup.validateInbound(h,u,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning for ${h.slice(0,8)}: ${p}`);this.logger.warn(`Skipping apply for ${h.slice(0,8)} \u2014 validation failed`);continue}o.push({itemIdentity:h,local:d}),a.add(h),l.add(d.localId)}let c=e.filter(h=>!a.has(h));for(let h of c){let d=q.resolveAlias(this.doc,h);if(!d)continue;let u=ue.findLocalMatch(d,this.localIndex);if(!u||l.has(u.localId))continue;let f=q.getItemSnapshot(this.doc,h);!f||!this.backup.validateInbound(h,f,this._stableUserId).valid||(this._debug(`alias resolved: ${h.slice(0,8)} \u2192 ${d.slice(0,8)}`),o.push({itemIdentity:h,local:u}),a.add(h),l.add(u.localId))}c=e.filter(h=>!a.has(h));for(let h of c){let d=this._fuzzyMatchLocal(h);if(!d){this._debug(`no fuzzy match for CRDT item ${h.slice(0,8)}`);continue}if(l.has(d.local.localId)){this._debug(`fuzzy skip: CRDT ${h.slice(0,8)} \u2192 local ${d.localIdentity.slice(0,8)} (already has exact match)`);continue}let u=q.getItemChecksums(this.doc,h).length,f=d.local.item.photo||[],p=(Array.isArray(f)?f:[f]).filter(y=>y.checksum).length;this._log(`fuzzy match: CRDT ${h.slice(0,8)} \u2192 local ${d.localIdentity.slice(0,8)} (score=${d.score.toFixed(2)}, ${d.checksumCount} shared of ${u} CRDT / ${p} local photo(s))`);let g=q.getItemSnapshot(this.doc,h);if(!g)continue;this.backup.validateInbound(h,g,this._stableUserId).valid&&(o.push({itemIdentity:h,local:d.local}),l.add(d.local.localId))}if(o.length===0)return this._debug("applyRemote: no matched items"),t;try{let h=[];for(let{local:d,itemIdentity:u}of o)try{let f=this.adapter?this.backup.captureItemStateFromStore(this.adapter,d.localId,u):await this.backup.captureItemState(d.localId,u);h.push(f)}catch(f){this.logger.warn(`applyRemoteFromCRDT: backup capture failed for ${u.slice(0,8)}`,{error:String(f.message||f)})}h.length>0&&this.vault.shouldBackup(h)&&await this.backup.saveSnapshot(h)}catch(h){this.logger.warn("Batch backup failed",{error:h.message})}this._resetApplyStats();try{for(let{itemIdentity:h,local:d}of o)try{await this.applyRemoteAnnotations(h,d,r,n),t.add(h)}catch(u){this.logger.warn(`Failed to apply remote for ${h}`,{error:u.message})}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault()}return t}finally{this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges(),this._queuedLocalChange&&(this._queuedLocalChange=!1,this._debug("replaying queued local change (debounced)"),this._localDebounceTimer&&clearTimeout(this._localDebounceTimer),this._localDebounceTimer=setTimeout(()=>{this._localDebounceTimer=null,this.syncOnce()},Math.max(100,this.options.localDebounce)))}}async applyOnDemand(){if(!this.doc)return null;let e=await this._acquireLock();try{return await this._applyOnDemandInner()}finally{e()}}async _applyOnDemandInner(){let e=q.getIdentities(this.doc),t=this._stableUserId,i={},r=this.adapter?this.adapter.getAllTags():await this.api.getTags(),n=new Map;if(r&&Array.isArray(r))for(let h of r)n.set(h.name.toLowerCase(),h);let o=new Map;if(this.options.syncLists)try{let h=this.adapter?this.adapter.getAllLists():await this.api.getLists();if(Array.isArray(h))for(let d of h)o.set(d.name||String(d.id),d)}catch(h){this.logger.warn("applyOnDemand: failed to fetch lists",{error:String(h.message||h)})}for(let h of e){let d=q.getItemSnapshot(this.doc,h);if(d)for(let u of["metadata","tags","notes","selections","transcriptions","lists"]){let f=d[u];if(!(!f||typeof f!="object"))for(let p of Object.values(f))p&&p.author&&p.author!==t&&!p.deleted&&(i[p.author]||(i[p.author]={metadata:0,tags:0,notes:0,selections:0,transcriptions:0,lists:0}),i[p.author][u]++)}}for(let[h,d]of Object.entries(i)){let u=Object.entries(d).filter(([,f])=>f>0).map(([f,p])=>`${p} ${f}`);u.length>0&&this.logger.info(`${h}: ${u.join(", ")}`)}let a=[],l=[];for(let h of e){let d=ue.findLocalMatch(h,this.localIndex);if(!d)continue;let u=q.getItemSnapshot(this.doc,h);if(!u)continue;let f=this.backup.validateInbound(h,u,this._stableUserId);if(!f.valid){for(let p of f.warnings)this.logger.warn(`Validation warning: ${p}`);continue}l.push(h);try{let p=this.adapter?this.backup.captureItemStateFromStore(this.adapter,d.localId,h):await this.backup.captureItemState(d.localId,h);a.push(p)}catch(p){this.logger.warn(`applyOnDemand: backup capture failed for ${h.slice(0,8)}`,{error:String(p.message||p)})}}a.length>0&&this.vault.shouldBackup(a)&&await this.backup.saveSnapshot(a),this._applyingRemote=!0,this.adapter&&this.adapter.suppressChanges(),this._resetApplyStats();let c=0;try{for(let h of l){let d=ue.findLocalMatch(h,this.localIndex);if(d)try{await this.applyRemoteAnnotations(h,d,n,o),c++}catch(u){this.logger.warn(`Import: failed to apply ${h}`,{error:u.message})}}}finally{this._logApplyStats(),this.vault.markDirty(),await this._persistVault(),this._applyingRemote=!1,this.adapter&&this.adapter.resumeChanges()}return{applied:c,summary:i}}async rollback(e){return this.backup.rollback(e,this.adapter)}purgeTombstones(){this.doc&&(this.logger.info("Purging tombstones from CRDT"),this.doc.transact(()=>{let e=q.purgeTombstones(this.doc),t=[`${e.purged} tombstone(s)`];e.uuidsPurged&&t.push(`${e.uuidsPurged} orphaned UUID(s)`),e.aliasesPurged&&t.push(`${e.aliasesPurged} expired alias(es)`),this.logger.info(`Purged ${t.join(", ")} across ${e.items} item(s)`)},this.LOCAL_ORIGIN))}getStatus(){return{state:this.state,lastSync:this.lastSync,room:this.options.room,server:this.options.serverUrl,syncMode:this.options.syncMode,clientId:this.doc?this.doc.clientID:null,localItems:this.localIndex.size,crdtItems:this.vault.annotationCount,peerCount:this.peerCount,watching:this.fileWatcher!=null||this._storeUnsubscribe!=null,storeAvailable:this.adapter!=null,projectPath:this.projectPath,consecutiveErrors:this._consecutiveErrors}}};Object.assign(Yt.prototype,bc());Object.assign(Yt.prototype,Ic());Object.assign(Yt.prototype,Cc());Nc.exports={SyncEngine:Yt}});var{SyncEngine:zi}=Ec(),Dc=Wt(),Fp=new Set(["auto","review","push","pull"]),Bn=class{constructor(e,t){if(this.context=t,this.options=this.mergeOptions(e),this.engine=null,this._isPrefsWindow()){this.context.logger.info("Troparcel: skipping sync in prefs window");return}this.context.logger.info(`Troparcel v5.0 \u2014 server: ${this.options.serverUrl}, mode: ${this.options.syncMode}, user: ${this.options.userId||"(anonymous)"}`),this.options.autoSync?(this.context.logger.info("Troparcel: auto-sync enabled, waiting for project to load..."),this._waitForProjectAndStart()):this.context.logger.info("Troparcel: auto-sync disabled \u2014 use File > Export/Import to sync manually")}_isPrefsWindow(){try{let e=this.context.logger;if(e.chindings&&e.chindings.includes('"name":"prefs"'))return!0;if(typeof e.bindings=="function"){let t=e.bindings();if(t&&t.name==="prefs")return!0}}catch{}return!1}async _waitForProjectAndStart(){let e=Date.now(),t=this.options.startupDelay,i=500;for(;Date.now()-e<t;){try{let n=this.context.window&&this.context.window.store;if(n){let o=n.getState(),a=o&&o.project;if(a&&a.path){let c=Date.now()-e;this.context.logger.info(`Troparcel: store + project available after ${c}ms`),!this.options._roomExplicit&&a.name&&(this.options.room=a.name),this.options.projectPath=a.path;break}let l=Date.now()-e;l>2e3&&l%2e3<i&&this.context.logger.info(`Troparcel: store ready, waiting for project state (${l}ms)`)}}catch{}await new Promise(n=>setTimeout(n,i))}let r=null;try{r=this.context.window&&this.context.window.store}catch{}r||this.context.logger.info(`Troparcel: store not available after ${this.options.startupDelay}ms \u2014 starting sync with API fallback`),await this.startBackgroundSync()}mergeOptions(e){let t="",i=(e.syncMode||"auto").trim().toLowerCase();Fp.has(i)||(i="auto");let r=!!e.room;return{serverUrl:e.serverUrl||"ws://localhost:2468",room:e.room||t||"troparcel-default",userId:e.userId||"",roomToken:e.roomToken||"",apiPort:Number(e.apiPort)||2019,autoSync:e.autoSync!==!1,syncMode:i,syncMetadata:e.syncMetadata!==!1,syncTags:e.syncTags!==!1,syncNotes:e.syncNotes!==!1,syncSelections:e.syncSelections!==!1,syncTranscriptions:e.syncTranscriptions!==!1,syncPhotoAdjustments:e.syncPhotoAdjustments===!0||e.syncPhotoAdjustments==="true",syncLists:e.syncLists===!0||e.syncLists==="true",syncDeletions:e.syncDeletions===!0||e.syncDeletions==="true",clearTombstones:e.clearTombstones===!0||e.clearTombstones==="true",startupDelay:Number(e.startupDelay)||8e3,localDebounce:Number(e.localDebounce)||2e3,remoteDebounce:Number(e.remoteDebounce)||500,safetyNetInterval:Number(e.safetyNetInterval)||120,writeDelay:Number(e.writeDelay)||100,maxBackups:Number(e.maxBackups)||10,maxNoteSize:Number(e.maxNoteSize)||1048576,maxMetadataSize:Number(e.maxMetadataSize)||65536,tombstoneFloodThreshold:Number(e.tombstoneFloodThreshold)||.5,debug:e.debug===!0||e.debug==="true",_roomExplicit:r}}async startBackgroundSync(){if(this.engine)return;let e=null;try{e=this.context.window&&this.context.window.store}catch{}this.engine=new zi(this.options,this.context.logger,e);try{await this.engine.start(),this.context.logger.info(`Troparcel: connected to room "${this.options.room}" (${e?"store":"API"} mode, sync: ${this.options.syncMode})`)}catch(t){let i=t.message||String(t),r=i.includes("timeout")||i.includes("ECONNREFUSED");if(r?this.context.logger.warn(`Troparcel: could not reach server at ${this.options.serverUrl} \u2014 will retry with exponential backoff`):this.context.logger.warn(`Troparcel: sync failed to start \u2014 ${i}. Use File > Export/Import to sync manually.`),await this.engine.stop(),this.engine=null,r&&!this._retryTimer){let n=5e3,o=5*60*1e3,a=()=>{this._retryTimer=setTimeout(async()=>{if(this._retryTimer=null,!(this.engine||this._unloading))try{this.engine=new zi(this.options,this.context.logger,e),await this.engine.start(),this.context.logger.info(`Troparcel: connected to room "${this.options.room}" (after retry)`)}catch{if(this.engine){try{await this.engine.stop()}catch{}this.engine=null}n=Math.min(n*2,o),this.context.logger.info(`Troparcel: server still unreachable, next retry in ${Math.round(n/1e3)}s`),a()}},n)};a()}}}async export(e){if(this._isPrefsWindow())return;let t=Array.isArray(e)?e:e&&e["@graph"]||[],i=!Array.isArray(e)&&e?e["@context"]:null;if(t.length===0){this.context.logger.warn("Troparcel Export: no items selected \u2014 select items first, then File > Export > Troparcel");return}if(this.options.syncMode==="pull"){this.context.logger.warn('Troparcel Export: sync mode is "pull" \u2014 local changes are not shared in this mode');return}this.context.logger.info(`Troparcel Export: pushing ${t.length} item(s) to room "${this.options.room}"...`);try{if(this.engine&&this.engine.state==="connected"){this.engine.pushItems(t,i),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`);return}this.context.logger.info("Troparcel Export: connecting to server (no background sync active)...");let r=new zi(this.options,this.context.logger);await r.start(),r.pushItems(t,i),this.context.logger.info(`Troparcel Export: done \u2014 ${t.length} item(s) pushed to "${this.options.room}"`),setTimeout(()=>{r.stop()},5e3)}catch(r){let n=r.message||String(r);n.includes("timeout")||n.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Export: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Export: failed \u2014 ${n}`)}}async import(e){if(!this._isPrefsWindow()){if(this.options.syncMode==="push"){this.context.logger.warn('Troparcel Import: sync mode is "push" \u2014 remote changes are not applied in this mode');return}this.context.logger.info(`Troparcel Import: pulling changes from room "${this.options.room}"...`),this.engine&&this.engine.pause();try{let t,i=!1;if(this.engine&&this.engine.state==="connected"?t=this.engine:(t=new zi(this.options,this.context.logger),await t.start(),await new Promise(n=>setTimeout(n,3e3)),i=!0),!t.adapter&&!await t.api.ping()){this.context.logger.warn("Import: Tropy API not reachable"),i&&await t.stop();return}if(t.localIndex.size===0)if(t.adapter){let n=t.readAllItemsFull().filter(o=>(o.photo||[]).some(a=>a.checksum));t.localIndex=Dc.buildIdentityIndex(n)}else{let n=await t.api.getItems();if(n&&Array.isArray(n)){let o=[];for(let a of n)try{o.push(await t.enrichItem(a))}catch{}t.localIndex=Dc.buildIdentityIndex(o)}}let r=await t.applyOnDemand();r?this.context.logger.info(`Troparcel Import: done \u2014 applied changes to ${r.applied} item(s) from "${this.options.room}"`):this.context.logger.info("Troparcel Import: done \u2014 no pending changes to apply"),i&&await t.stop()}catch(t){let i=t.message||String(t);i.includes("timeout")||i.includes("ECONNREFUSED")?this.context.logger.error(`Troparcel Import: could not reach server at ${this.options.serverUrl} \u2014 is the Troparcel server running?`):this.context.logger.error(`Troparcel Import: failed \u2014 ${i}`)}finally{this.engine&&this.engine.resume()}}}getStatus(){let e={...this.options};return e.roomToken&&(e.roomToken="***"),delete e._roomExplicit,{version:"5.0.0",options:e,engine:this.engine?this.engine.getStatus():null,backgroundSync:this.engine!=null}}async unload(){this._unloading=!0,this.context.logger.info("Troparcel unloading"),this._retryTimer&&(clearTimeout(this._retryTimer),this._retryTimer=null),this.engine&&(await this.engine.stop(),this.engine=null)}};module.exports=Bn;
